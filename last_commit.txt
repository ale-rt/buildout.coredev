Repository: plone.app.content


Branch: refs/heads/master
Date: 2016-09-19T11:17:31+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.content/commit/ab6f71df4fb5d76d001cfe6c685a6344a2446133

Apply security hotfix 20160830 for folder factories redirection.

Files changed:
M CHANGES.rst
M plone/app/content/browser/folderfactories.py
M plone/app/content/tests/test_folder.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 52eb8e0..2efff9b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Apply security hotfix 20160830 for folder factories redirection.  [maurits]
 
 
 3.3 (2016-09-14)
diff --git a/plone/app/content/browser/folderfactories.py b/plone/app/content/browser/folderfactories.py
index 7d505ad..523939d 100644
--- a/plone/app/content/browser/folderfactories.py
+++ b/plone/app/content/browser/folderfactories.py
@@ -27,7 +27,10 @@ class FolderFactoriesView(BrowserView):
 
     def __call__(self):
         if 'form.button.Add' in self.request.form:
+            urltool = getToolByName(self.context, 'portal_url')
             url = self.request.form.get('url')
+            if not urltool.isURLInPortal(url):
+                url = self.context.absolute_url()
             self.request.response.redirect(url)
             return ''
         else:
diff --git a/plone/app/content/tests/test_folder.py b/plone/app/content/tests/test_folder.py
index 058b17b..6e3b816 100644
--- a/plone/app/content/tests/test_folder.py
+++ b/plone/app/content/tests/test_folder.py
@@ -2,6 +2,7 @@
 from DateTime import DateTime
 from plone.app.content.testing import PLONE_APP_CONTENT_AT_INTEGRATION_TESTING
 from plone.app.content.testing import PLONE_APP_CONTENT_DX_INTEGRATION_TESTING
+from plone.app.content.testing import PLONE_APP_CONTENT_DX_FUNCTIONAL_TESTING
 from plone.app.testing import login
 from plone.app.testing import setRoles
 from plone.app.testing import TEST_USER_ID
@@ -473,3 +474,37 @@ def test_item_order_move_by_delta(self):
 class RearrangeATTest(RearrangeDXTest):
 
     layer = PLONE_APP_CONTENT_AT_INTEGRATION_TESTING
+
+
+class FolderFactoriesTest(unittest.TestCase):
+    layer = PLONE_APP_CONTENT_DX_FUNCTIONAL_TESTING
+
+    def setUp(self):
+        self.portal = self.layer['portal']
+        self.request = self.layer['request']
+        login(self.portal, TEST_USER_NAME)
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+
+    def test_folder_factories_regression(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': self.portal.absolute_url()
+        })
+        view()
+        self.assertEqual(self.request.response.headers.get('location'),
+                         self.portal.absolute_url())
+
+    def test_folder_factories(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': 'http://www.foobar.com'
+        })
+        view()
+        self.assertNotEqual(self.request.response.headers.get('location'),
+                            'http://www.foobar.com')


Repository: plone.app.content


Branch: refs/heads/master
Date: 2016-09-19T12:43:14+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.content/commit/7e72ab71ddd41c8bd8bbc0572c48279cdc1dd0a3

Merge pull request #108 from plone/apply-hotfix-20160830-master

Apply security hotfix 20160830 for folder factories redirection. [master]

Files changed:
M CHANGES.rst
M plone/app/content/browser/folderfactories.py
M plone/app/content/tests/test_folder.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 52eb8e0..2efff9b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Apply security hotfix 20160830 for folder factories redirection.  [maurits]
 
 
 3.3 (2016-09-14)
diff --git a/plone/app/content/browser/folderfactories.py b/plone/app/content/browser/folderfactories.py
index 7d505ad..523939d 100644
--- a/plone/app/content/browser/folderfactories.py
+++ b/plone/app/content/browser/folderfactories.py
@@ -27,7 +27,10 @@ class FolderFactoriesView(BrowserView):
 
     def __call__(self):
         if 'form.button.Add' in self.request.form:
+            urltool = getToolByName(self.context, 'portal_url')
             url = self.request.form.get('url')
+            if not urltool.isURLInPortal(url):
+                url = self.context.absolute_url()
             self.request.response.redirect(url)
             return ''
         else:
diff --git a/plone/app/content/tests/test_folder.py b/plone/app/content/tests/test_folder.py
index 058b17b..6e3b816 100644
--- a/plone/app/content/tests/test_folder.py
+++ b/plone/app/content/tests/test_folder.py
@@ -2,6 +2,7 @@
 from DateTime import DateTime
 from plone.app.content.testing import PLONE_APP_CONTENT_AT_INTEGRATION_TESTING
 from plone.app.content.testing import PLONE_APP_CONTENT_DX_INTEGRATION_TESTING
+from plone.app.content.testing import PLONE_APP_CONTENT_DX_FUNCTIONAL_TESTING
 from plone.app.testing import login
 from plone.app.testing import setRoles
 from plone.app.testing import TEST_USER_ID
@@ -473,3 +474,37 @@ def test_item_order_move_by_delta(self):
 class RearrangeATTest(RearrangeDXTest):
 
     layer = PLONE_APP_CONTENT_AT_INTEGRATION_TESTING
+
+
+class FolderFactoriesTest(unittest.TestCase):
+    layer = PLONE_APP_CONTENT_DX_FUNCTIONAL_TESTING
+
+    def setUp(self):
+        self.portal = self.layer['portal']
+        self.request = self.layer['request']
+        login(self.portal, TEST_USER_NAME)
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+
+    def test_folder_factories_regression(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': self.portal.absolute_url()
+        })
+        view()
+        self.assertEqual(self.request.response.headers.get('location'),
+                         self.portal.absolute_url())
+
+    def test_folder_factories(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': 'http://www.foobar.com'
+        })
+        view()
+        self.assertNotEqual(self.request.response.headers.get('location'),
+                            'http://www.foobar.com')


