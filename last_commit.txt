Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-09T10:55:56+02:00
Author: Franz Gerhard Reinisch (fgrcon) <franz@fgrcon.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/d204dbc9f988f1392a3e6ca67e32cd63bd3013a0

Recover missing dashboard (user actions)
  https://github.com/plone/Products.CMFPlone/issues/1132

Files changed:
A plone/app/upgrade/v51/profiles/to_beta5/actions.xml
M CHANGES.rst
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index ebbd69a..ea9651b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Recover missing dashboard (user actions)
+  https://github.com/plone/Products.CMFPlone/issues/1132
+  [fgrcon]
 
 
 2.0.6 (2017-08-05)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index bf76bec..7d491f7 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -164,7 +164,8 @@ Add image scaling options to image handling control panel.
         <gs:upgradeDepends
             title="Run to51beta5 upgrade profile."
             description="Fix safe_html in PortalTransforms.
-                         Add 'Show Toolbar' permission."
+                         Add 'Show Toolbar' permission.
+                         Recover Dashboard in useractions."
             import_profile="plone.app.upgrade.v51:to51beta5"
             />
 
diff --git a/plone/app/upgrade/v51/profiles/to_beta5/actions.xml b/plone/app/upgrade/v51/profiles/to_beta5/actions.xml
new file mode 100644
index 0000000..8409622
--- /dev/null
+++ b/plone/app/upgrade/v51/profiles/to_beta5/actions.xml
@@ -0,0 +1,18 @@
+<object name="portal_actions" meta_type="Plone Actions Tool"
+   xmlns:i18n="http://xml.zope.org/namespaces/i18n">  
+ <object name="user" meta_type="CMF Action Category">
+  <property name="title" i18n:translate="">User actions</property>  
+  <object name="dashboard" meta_type="CMF Action" i18n:domain="plone">
+   <property name="title" i18n:translate="">Dashboard</property>
+   <property name="description" i18n:translate=""></property>
+   <property
+      name="url_expr">string:${portal_url}/dashboard</property>
+   <property name="icon_expr"></property>
+   <property name="available_expr">python:member is not None</property>
+   <property name="permissions">
+    <element value="Portlets: Manage own portlets"/>
+   </property>
+   <property name="visible">True</property>
+  </object> 
+ </object> 
+</object> 


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-09-06T15:54:45+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/fe07624ae9f01998b403d8625aa5ab14e072cbf2

Merge branch 'master' into fgrcon-fix-1132-dashboard

Files changed:
A plone/app/upgrade/v50/profiles/to_5010/registry.xml
M CHANGES.rst
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/configure.zcml
M plone/app/upgrade/v50/final.py
M plone/app/upgrade/v50/profiles.zcml
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/profiles/to_beta5/registry.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index ea9651b..9f280b0 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,11 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Add jqtree-contextmenu to the resource registry for Plone 5.0 and 5.1
+  [b4oshany]
+
+- Add js-shortcuts to the resource registry for Plone 5.0 and 5.1
+  [b4oshany]
 
 Bug fixes:
 
@@ -18,6 +22,12 @@ Bug fixes:
   https://github.com/plone/Products.CMFPlone/issues/1132
   [fgrcon]
 
+- Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
+  [pbauer]
+
+- Cleanup duplicate iterate settings. See also https://github.com/plone/plone.app.iterate/pull/47
+  [pbauer]
+
 
 2.0.6 (2017-08-05)
 ------------------
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index d3ac232..d246b8c 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -17,7 +17,9 @@
 from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
+
 import logging
+import pkg_resources
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -364,6 +366,18 @@ def to50rc1(context):
         qi = get_installer(portal)
         if not qi.is_product_installed('plone.app.linkintegrity'):
             qi.install_product('plone.app.linkintegrity')
+
+    # If Products.PortalTransforms is >= 3.0.1.dev0 it has the new safe_html.
+    # Register and migrate the registry settings needed for it.
+    # Linkintegrity calls the transform when retrieving links from html-fields.
+    pt = pkg_resources.get_distribution('Products.PortalTransforms')
+    if pt.version >= '3.0.1.dev0':
+        from plone.app.upgrade.v51.betas import move_safe_html_settings_to_registry  # noqa: E501
+        from Products.CMFPlone.interfaces import IFilterSchema
+        registry = getUtility(IRegistry)
+        registry.registerInterface(IFilterSchema, prefix='plone')
+        move_safe_html_settings_to_registry(context)
+
     migrate_linkintegrity_relations(portal)
 
     upgrade_usergroups_controlpanel_settings(context)
diff --git a/plone/app/upgrade/v50/configure.zcml b/plone/app/upgrade/v50/configure.zcml
index 4ffc78a..a6ddf60 100644
--- a/plone/app/upgrade/v50/configure.zcml
+++ b/plone/app/upgrade/v50/configure.zcml
@@ -376,9 +376,9 @@
         profile="Products.CMFPlone:plone">
 
         <gs:upgradeStep
-            title="Miscellaneous"
+            title="Add jqTree contextual menu and JS Shortcuts to the resource registry"
             description=""
-            handler="..utils.null_upgrade_step"
+            handler=".final.to5010"
             />
 
     </gs:upgradeSteps>
diff --git a/plone/app/upgrade/v50/final.py b/plone/app/upgrade/v50/final.py
index 0f4b44a..7785528 100644
--- a/plone/app/upgrade/v50/final.py
+++ b/plone/app/upgrade/v50/final.py
@@ -104,6 +104,11 @@ def to507(context):
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to507')
 
 
+def to5010(context):
+    """5.0.9 -> 5.0.10"""
+    loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to5010')
+
+
 def fix_double_smaxage(context):
     """Fix caching definition.
 
diff --git a/plone/app/upgrade/v50/profiles.zcml b/plone/app/upgrade/v50/profiles.zcml
index c45f02c..e1f874b 100644
--- a/plone/app/upgrade/v50/profiles.zcml
+++ b/plone/app/upgrade/v50/profiles.zcml
@@ -129,4 +129,13 @@
       provides="Products.GenericSetup.interfaces.EXTENSION"
       />
 
+  <genericsetup:registerProfile
+      name="to5010"
+      title="Upgrade profile for Plone 5.0.9 to Plone 5.0.10"
+      description=""
+      directory="profiles/to_5010"
+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
 </configure>
diff --git a/plone/app/upgrade/v50/profiles/to_5010/registry.xml b/plone/app/upgrade/v50/profiles/to_5010/registry.xml
new file mode 100644
index 0000000..f8f18bd
--- /dev/null
+++ b/plone/app/upgrade/v50/profiles/to_5010/registry.xml
@@ -0,0 +1,13 @@
+<?xml version="1.0"?>
+<registry>
+  <records prefix="plone.resources/jqtree-contextmenu"
+           interface='Products.CMFPlone.interfaces.IResourceRegistry'>
+      <value key="js">++plone++static/components/cs-jqtree-contextmenu/src/jqTreeContextMenu.js</value>
+      <value key="deps">jqtree</value>
+  </records>
+  <records prefix="plone.resources/js-shortcuts"
+           interface='Products.CMFPlone.interfaces.IResourceRegistry'>
+      <value key="js">++plone++static/components/js-shortcuts/js-shortcuts.js</value>
+      <value key="deps">jquery</value>
+  </records>
+</registry>
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 0333b2c..1799348 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -14,8 +14,7 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.IUserGroupsSettingsSchema"
            prefix="plone" />
-  <records interface="plone.app.iterate.interfaces.IIterateSettings"
-           prefix="plone" />
+  <records interface="plone.app.iterate.interfaces.IIterateSettings" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 59a516a..46f959b 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -198,3 +198,25 @@ def move_safe_html_settings_to_registry(context):
     settings.disable_filtering = disable_filtering
     settings.valid_tags = sorted(valid_tags)
     settings.nasty_tags = sorted(nasty_tags)
+
+
+def remove_duplicate_iterate_settings(context):
+    """When migrating from Plone 5 to 5.1 there might be
+    duplicate settings for plone.app.iterate in the registry.
+    One with the prefix 'plone' and one without.
+
+    See https://github.com/plone/plone.app.iterate/pull/47
+    """
+    registry = getUtility(IRegistry)
+    from plone.app.iterate.interfaces import IIterateSettings
+    try:
+        registry.forInterface(IIterateSettings, prefix='plone')
+        del registry['plone.checkout_workflow_policy']
+        del registry['plone.enable_checkout_workflow']
+    except KeyError:
+        pass
+    # Make sure the correct settings are actually initialized
+    from Products.CMFPlone.utils import get_installer
+    qi = get_installer(context)
+    if qi.is_product_installed('plone.app.iterate'):
+        registry.registerInterface(IIterateSettings)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 7d491f7..370f797 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -165,6 +165,7 @@ Add image scaling options to image handling control panel.
             title="Run to51beta5 upgrade profile."
             description="Fix safe_html in PortalTransforms.
                          Add 'Show Toolbar' permission.
+                         Add JQTree Contextual Menu and JS Shortcuts to the resource registry. 
                          Recover Dashboard in useractions."
             import_profile="plone.app.upgrade.v51:to51beta5"
             />
@@ -174,5 +175,10 @@ Add image scaling options to image handling control panel.
             handler=".betas.move_safe_html_settings_to_registry"
             />
 
+        <gs:upgradeStep
+            title="Cleanup duplicate settings from placefiul workflow from Plone registry"
+            handler=".betas.remove_duplicate_iterate_settings"
+            />
+
     </gs:upgradeSteps>
 </configure>
diff --git a/plone/app/upgrade/v51/profiles/to_beta5/registry.xml b/plone/app/upgrade/v51/profiles/to_beta5/registry.xml
index f63487b..d413416 100644
--- a/plone/app/upgrade/v51/profiles/to_beta5/registry.xml
+++ b/plone/app/upgrade/v51/profiles/to_beta5/registry.xml
@@ -4,4 +4,15 @@
   <records interface="Products.CMFPlone.interfaces.IFilterSchema"
            prefix="plone" />
 
+  <records prefix="plone.resources/jqtree-contextmenu"
+           interface='Products.CMFPlone.interfaces.IResourceRegistry'>
+      <value key="js">++plone++static/components/cs-jqtree-contextmenu/src/jqTreeContextMenu.js</value>
+      <value key="deps">jqtree</value>
+  </records>
+  <records prefix="plone.resources/js-shortcuts"
+           interface='Products.CMFPlone.interfaces.IResourceRegistry'>
+      <value key="js">++plone++static/components/js-shortcuts/js-shortcuts.js</value>
+      <value key="deps">jquery</value>
+  </records>
+
 </registry>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-09-07T09:25:45+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/6e1e391a517ed03ec87ba57cdec841585e8b22eb

Merge pull request #130 from plone/fgrcon-fix-1132-dashboard

Recover missing dashboard (user actions)

Files changed:
A plone/app/upgrade/v51/profiles/to_beta5/actions.xml
M CHANGES.rst
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 5ea51e9..f233a3c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,10 @@ New features:
 
 Bug fixes:
 
+- Recover missing dashboard (user actions)
+  https://github.com/plone/Products.CMFPlone/issues/1132
+  [fgrcon]
+
 - Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
   Fixes https://github.com/plone/Products.CMFPlone/issues/2129
   [pbauer]
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 6f95cc5..370f797 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -165,7 +165,8 @@ Add image scaling options to image handling control panel.
             title="Run to51beta5 upgrade profile."
             description="Fix safe_html in PortalTransforms.
                          Add 'Show Toolbar' permission.
-                         Add JQTree Contextual Menu and JS Shortcuts to the resource registry."
+                         Add JQTree Contextual Menu and JS Shortcuts to the resource registry. 
+                         Recover Dashboard in useractions."
             import_profile="plone.app.upgrade.v51:to51beta5"
             />
 
diff --git a/plone/app/upgrade/v51/profiles/to_beta5/actions.xml b/plone/app/upgrade/v51/profiles/to_beta5/actions.xml
new file mode 100644
index 0000000..8409622
--- /dev/null
+++ b/plone/app/upgrade/v51/profiles/to_beta5/actions.xml
@@ -0,0 +1,18 @@
+<object name="portal_actions" meta_type="Plone Actions Tool"
+   xmlns:i18n="http://xml.zope.org/namespaces/i18n">  
+ <object name="user" meta_type="CMF Action Category">
+  <property name="title" i18n:translate="">User actions</property>  
+  <object name="dashboard" meta_type="CMF Action" i18n:domain="plone">
+   <property name="title" i18n:translate="">Dashboard</property>
+   <property name="description" i18n:translate=""></property>
+   <property
+      name="url_expr">string:${portal_url}/dashboard</property>
+   <property name="icon_expr"></property>
+   <property name="available_expr">python:member is not None</property>
+   <property name="permissions">
+    <element value="Portlets: Manage own portlets"/>
+   </property>
+   <property name="visible">True</property>
+  </object> 
+ </object> 
+</object> 


