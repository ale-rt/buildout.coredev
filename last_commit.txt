Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-29T21:33:39+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/351022db520c764881f47ffb38fe53794a5bf1d3

Cleanup duplicate iterate settings.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index f8d1055..3ea71a9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -21,6 +21,9 @@ Bug fixes:
 - Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
   [pbauer]
 
+- Cleanup duplicate iterate settings. See also https://github.com/plone/plone.app.iterate/pull/47
+  [pbauer]
+
 
 2.0.6 (2017-08-05)
 ------------------
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 0333b2c..1799348 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -14,8 +14,7 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.IUserGroupsSettingsSchema"
            prefix="plone" />
-  <records interface="plone.app.iterate.interfaces.IIterateSettings"
-           prefix="plone" />
+  <records interface="plone.app.iterate.interfaces.IIterateSettings" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 59a516a..46f959b 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -198,3 +198,25 @@ def move_safe_html_settings_to_registry(context):
     settings.disable_filtering = disable_filtering
     settings.valid_tags = sorted(valid_tags)
     settings.nasty_tags = sorted(nasty_tags)
+
+
+def remove_duplicate_iterate_settings(context):
+    """When migrating from Plone 5 to 5.1 there might be
+    duplicate settings for plone.app.iterate in the registry.
+    One with the prefix 'plone' and one without.
+
+    See https://github.com/plone/plone.app.iterate/pull/47
+    """
+    registry = getUtility(IRegistry)
+    from plone.app.iterate.interfaces import IIterateSettings
+    try:
+        registry.forInterface(IIterateSettings, prefix='plone')
+        del registry['plone.checkout_workflow_policy']
+        del registry['plone.enable_checkout_workflow']
+    except KeyError:
+        pass
+    # Make sure the correct settings are actually initialized
+    from Products.CMFPlone.utils import get_installer
+    qi = get_installer(context)
+    if qi.is_product_installed('plone.app.iterate'):
+        registry.registerInterface(IIterateSettings)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 8dbb15b..6f95cc5 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -174,5 +174,10 @@ Add image scaling options to image handling control panel.
             handler=".betas.move_safe_html_settings_to_registry"
             />
 
+        <gs:upgradeStep
+            title="Cleanup duplicate settings from placefiul workflow from Plone registry"
+            handler=".betas.remove_duplicate_iterate_settings"
+            />
+
     </gs:upgradeSteps>
 </configure>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-30T21:23:46-04:00
Author: Eric Steele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/e2c58737a3b429f166e344a3d0cd8265bd17e86f

Merge pull request #133 from plone/fix_duplicate_iterate_settings

Cleanup duplicate iterate settings.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index f8d1055..3ea71a9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -21,6 +21,9 @@ Bug fixes:
 - Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
   [pbauer]
 
+- Cleanup duplicate iterate settings. See also https://github.com/plone/plone.app.iterate/pull/47
+  [pbauer]
+
 
 2.0.6 (2017-08-05)
 ------------------
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 0333b2c..1799348 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -14,8 +14,7 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.IUserGroupsSettingsSchema"
            prefix="plone" />
-  <records interface="plone.app.iterate.interfaces.IIterateSettings"
-           prefix="plone" />
+  <records interface="plone.app.iterate.interfaces.IIterateSettings" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 59a516a..46f959b 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -198,3 +198,25 @@ def move_safe_html_settings_to_registry(context):
     settings.disable_filtering = disable_filtering
     settings.valid_tags = sorted(valid_tags)
     settings.nasty_tags = sorted(nasty_tags)
+
+
+def remove_duplicate_iterate_settings(context):
+    """When migrating from Plone 5 to 5.1 there might be
+    duplicate settings for plone.app.iterate in the registry.
+    One with the prefix 'plone' and one without.
+
+    See https://github.com/plone/plone.app.iterate/pull/47
+    """
+    registry = getUtility(IRegistry)
+    from plone.app.iterate.interfaces import IIterateSettings
+    try:
+        registry.forInterface(IIterateSettings, prefix='plone')
+        del registry['plone.checkout_workflow_policy']
+        del registry['plone.enable_checkout_workflow']
+    except KeyError:
+        pass
+    # Make sure the correct settings are actually initialized
+    from Products.CMFPlone.utils import get_installer
+    qi = get_installer(context)
+    if qi.is_product_installed('plone.app.iterate'):
+        registry.registerInterface(IIterateSettings)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 8dbb15b..6f95cc5 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -174,5 +174,10 @@ Add image scaling options to image handling control panel.
             handler=".betas.move_safe_html_settings_to_registry"
             />
 
+        <gs:upgradeStep
+            title="Cleanup duplicate settings from placefiul workflow from Plone registry"
+            handler=".betas.remove_duplicate_iterate_settings"
+            />
+
     </gs:upgradeSteps>
 </configure>


