Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-06-23T20:07:44+03:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/790b1ae45e524ab3f3820bb9fe001165839fef5f

Fix upgrade step for ISocialMediaSchema

Files changed:
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/profiles/to_beta4/registry.xml

diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index dad633d..3478566 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -5,8 +5,8 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import ISearchSchema
 from zope.component import getUtility
-
 import logging
+import unicodedata
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -124,15 +124,26 @@ def update_social_media_fields(context):
     field values as they are now declared as ASCIILine instead of
     TextLine.
     """
+    twitter_username = ''
+    facebook_app_id = ''
+    facebook_username = ''
     from Products.CMFPlone.interfaces.controlpanel import ISocialMediaSchema
     registry = getUtility(IRegistry)
     settings = registry.forInterface(ISocialMediaSchema, prefix='plone')
     if settings.twitter_username:
-        settings.twitter_username = str(settings.twitter_username)
+        twitter_username = unicodedata.normalize(
+            'NFKD', settings.twitter_username).encode('ascii', 'ignore')
     if settings.facebook_app_id:
-        settings.facebook_app_id = str(settings.facebook_app_id)
+        facebook_app_id = unicodedata.normalize(
+            'NFKD', settings.facebook_app_id).encode('ascii', 'ignore')
     if settings.facebook_username:
-        settings.facebook_username = str(settings.facebook_username)
+        facebook_username = unicodedata.normalize(
+            'NFKD', settings.facebook_username).encode('ascii', 'ignore')
+    loadMigrationProfile(context, 'profile-plone.app.upgrade.v51:to51beta4')
+    settings.twitter_username = twitter_username
+    settings.facebook_app_id = facebook_app_id
+    settings.facebook_username = facebook_username
+
     logger.log(logging.INFO, 'Field types updated on social media schema')
 
 
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 6fad905..b51ea07 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -120,12 +120,6 @@ Add image scaling options to image handling control panel.
             import_profile="plone.app.upgrade.v51:to51beta3"
             />
 
-        <gs:upgradeStep
-            title="Update social media fields"
-            description=""
-            handler=".betas.update_social_media_fields"
-            />
-
     </gs:upgradeSteps>
 
     <gs:upgradeSteps
@@ -133,6 +127,12 @@ Add image scaling options to image handling control panel.
         destination="5107"
         profile="Products.CMFPlone:plone">
 
+        <gs:upgradeStep
+            title="Update social media fields"
+            description=""
+            handler=".betas.update_social_media_fields"
+            />
+
         <gs:upgradeDepends
             title="Run to51beta4 upgrade profile."
             description="Add options for icon- and thumb-handling to Site control panel.
diff --git a/plone/app/upgrade/v51/profiles/to_beta4/registry.xml b/plone/app/upgrade/v51/profiles/to_beta4/registry.xml
index 97a6897..d3506f9 100644
--- a/plone/app/upgrade/v51/profiles/to_beta4/registry.xml
+++ b/plone/app/upgrade/v51/profiles/to_beta4/registry.xml
@@ -33,4 +33,6 @@
   <!-- add missing render_body field -->
   <records interface="Products.CMFPlone.interfaces.syndication.ISiteSyndicationSettings" />
 
+  <records interface="Products.CMFPlone.interfaces.ISocialMediaSchema"
+           prefix="plone" />
 </registry>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-06-23T20:12:43+03:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/2a4cc67fc1be9de5e7cd8482316ff82e8316d8c1

add changelog entry

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 667525f..73348ae 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix upgrade step for ISocialMediaSchema
+  [MrTango]
 
 
 2.0.4 (2017-06-04)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-06-26T11:52:15+03:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/c8d8f892dfdb6fe64eaa7dc54413b2c708a1f4b9

remove unneeded normalization in ISocialMediaSchema upgrade

Files changed:
M plone/app/upgrade/v51/betas.py

diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 3478566..0000bbf 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -6,7 +6,6 @@
 from Products.CMFPlone.interfaces import ISearchSchema
 from zope.component import getUtility
 import logging
-import unicodedata
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -131,14 +130,12 @@ def update_social_media_fields(context):
     registry = getUtility(IRegistry)
     settings = registry.forInterface(ISocialMediaSchema, prefix='plone')
     if settings.twitter_username:
-        twitter_username = unicodedata.normalize(
-            'NFKD', settings.twitter_username).encode('ascii', 'ignore')
+        twitter_username = settings.twitter_username.encode('ascii', 'ignore')
     if settings.facebook_app_id:
-        facebook_app_id = unicodedata.normalize(
-            'NFKD', settings.facebook_app_id).encode('ascii', 'ignore')
+        facebook_app_id = settings.facebook_app_id.encode('ascii', 'ignore')
     if settings.facebook_username:
-        facebook_username = unicodedata.normalize(
-            'NFKD', settings.facebook_username).encode('ascii', 'ignore')
+        facebook_username = settings.facebook_username.encode(
+            'ascii', 'ignore')
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v51:to51beta4')
     settings.twitter_username = twitter_username
     settings.facebook_app_id = facebook_app_id


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-06-27T15:25:36+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/7d77c2f80d740fece318d3ae8e57cde657eb4894

Merge pull request #124 from plone/MrTango_fix_update_social_media_fields

Fix upgrade step for ISocialMediaSchema

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/profiles/to_beta4/registry.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index 667525f..73348ae 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix upgrade step for ISocialMediaSchema
+  [MrTango]
 
 
 2.0.4 (2017-06-04)
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index dad633d..0000bbf 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -5,7 +5,6 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import ISearchSchema
 from zope.component import getUtility
-
 import logging
 
 
@@ -124,15 +123,24 @@ def update_social_media_fields(context):
     field values as they are now declared as ASCIILine instead of
     TextLine.
     """
+    twitter_username = ''
+    facebook_app_id = ''
+    facebook_username = ''
     from Products.CMFPlone.interfaces.controlpanel import ISocialMediaSchema
     registry = getUtility(IRegistry)
     settings = registry.forInterface(ISocialMediaSchema, prefix='plone')
     if settings.twitter_username:
-        settings.twitter_username = str(settings.twitter_username)
+        twitter_username = settings.twitter_username.encode('ascii', 'ignore')
     if settings.facebook_app_id:
-        settings.facebook_app_id = str(settings.facebook_app_id)
+        facebook_app_id = settings.facebook_app_id.encode('ascii', 'ignore')
     if settings.facebook_username:
-        settings.facebook_username = str(settings.facebook_username)
+        facebook_username = settings.facebook_username.encode(
+            'ascii', 'ignore')
+    loadMigrationProfile(context, 'profile-plone.app.upgrade.v51:to51beta4')
+    settings.twitter_username = twitter_username
+    settings.facebook_app_id = facebook_app_id
+    settings.facebook_username = facebook_username
+
     logger.log(logging.INFO, 'Field types updated on social media schema')
 
 
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 6fad905..b51ea07 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -120,12 +120,6 @@ Add image scaling options to image handling control panel.
             import_profile="plone.app.upgrade.v51:to51beta3"
             />
 
-        <gs:upgradeStep
-            title="Update social media fields"
-            description=""
-            handler=".betas.update_social_media_fields"
-            />
-
     </gs:upgradeSteps>
 
     <gs:upgradeSteps
@@ -133,6 +127,12 @@ Add image scaling options to image handling control panel.
         destination="5107"
         profile="Products.CMFPlone:plone">
 
+        <gs:upgradeStep
+            title="Update social media fields"
+            description=""
+            handler=".betas.update_social_media_fields"
+            />
+
         <gs:upgradeDepends
             title="Run to51beta4 upgrade profile."
             description="Add options for icon- and thumb-handling to Site control panel.
diff --git a/plone/app/upgrade/v51/profiles/to_beta4/registry.xml b/plone/app/upgrade/v51/profiles/to_beta4/registry.xml
index 97a6897..d3506f9 100644
--- a/plone/app/upgrade/v51/profiles/to_beta4/registry.xml
+++ b/plone/app/upgrade/v51/profiles/to_beta4/registry.xml
@@ -33,4 +33,6 @@
   <!-- add missing render_body field -->
   <records interface="Products.CMFPlone.interfaces.syndication.ISiteSyndicationSettings" />
 
+  <records interface="Products.CMFPlone.interfaces.ISocialMediaSchema"
+           prefix="plone" />
 </registry>


