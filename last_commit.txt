Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2016-08-30T23:52:26+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/a188417429816d8f769ec91ae447ae3785499480

Apply security hotfix 20160830 for isURLInPortal.

Files changed:
M Products/CMFPlone/URLTool.py
M Products/CMFPlone/tests/testURLTool.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/URLTool.py b/Products/CMFPlone/URLTool.py
index 34259fd..e6a43f7 100644
--- a/Products/CMFPlone/URLTool.py
+++ b/Products/CMFPlone/URLTool.py
@@ -30,8 +30,12 @@ def isURLInPortal(self, url, context=None):
 
         # sanitize url
         url = re.sub('^[\x00-\x20]+', '', url).strip()
-        if ('<script' in url or '%3Cscript' in url or 'javascript:' in url or
-                'javascript%3A' in url):
+        cmp_url = url.lower()
+        if ('\\\\' in cmp_url or
+                '<script' in cmp_url or
+                '%3cscript' in cmp_url or
+                'javascript:' in cmp_url or
+                'javascript%3a' in cmp_url):
             return False
 
         p_url = self()
diff --git a/Products/CMFPlone/tests/testURLTool.py b/Products/CMFPlone/tests/testURLTool.py
index d9ec743..1a0d0e1 100644
--- a/Products/CMFPlone/tests/testURLTool.py
+++ b/Products/CMFPlone/tests/testURLTool.py
@@ -43,6 +43,11 @@ def _makeOne(self, *args, **kw):
         return url_tool.__of__(self.site)
 
     def test_isURLInPortal(self):
+        # First test what the absolute url of the site is, otherwise these
+        # tests look really weird.  Apparently our domain is www.foobar.com.
+        self.assertEqual(self.site.absolute_url(),
+                         'http://www.foobar.com/bar/foo')
+
         url_tool = self._makeOne()
         iURLiP = url_tool.isURLInPortal
         self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))
@@ -101,11 +106,21 @@ def test_script_tag_url_not_in_portal(self):
         url_tool = self._makeOne()
         iURLiP = url_tool.isURLInPortal
         self.assertFalse(iURLiP('<script>alert("hi");</script>'))
+        self.assertFalse(iURLiP('<sCript>alert("hi");</script>'))
         self.assertFalse(
             iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))
+        self.assertFalse(
+            iURLiP('%3CsCript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))
 
     def test_inline_url_not_in_portal(self):
         url_tool = self._makeOne()
         iURLiP = url_tool.isURLInPortal
         self.assertFalse(iURLiP('javascript%3Aalert(3)'))
+        self.assertFalse(iURLiP('jaVascript%3Aalert(3)'))
         self.assertFalse(iURLiP('javascript:alert(3)'))
+        self.assertFalse(iURLiP('jaVascript:alert(3)'))
+
+    def test_double_back_slash(self):
+        url_tool = self._makeOne()
+        iURLiP = url_tool.isURLInPortal
+        self.assertFalse(iURLiP('\\\\www.example.com'))
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index c85ef52..b851303 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,7 +19,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Apply security hotfix 20160830 for ``isURLInPortal``.  [maurits]
 
 
 4.3.11 (2016-08-15)


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2016-08-30T23:52:26+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/92312df5492c4aa736a9a00bea94eddab15e129d

Apply security hotfix 20160830 for @@plone-root-login.

Files changed:
A Products/CMFPlone/tests/testBrowserAdmin.py
M Products/CMFPlone/browser/admin.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py
index 789b5a5..2244030 100644
--- a/Products/CMFPlone/browser/admin.py
+++ b/Products/CMFPlone/browser/admin.py
@@ -1,4 +1,6 @@
 from operator import itemgetter
+from urlparse import urljoin
+from urlparse import urlparse
 
 from plone.i18n.locales.interfaces import IContentLanguageAvailability
 from plone.protect.interfaces import IDisableCSRFProtection
@@ -86,6 +88,16 @@ class RootLoginRedirect(BrowserView):
     """
 
     def __call__(self, came_from=None):
+        if came_from is not None:
+            # see if this is a relative url or an absolute
+            if len(urlparse(came_from)[1]) == 0:
+                # No host specified, so url is relative.  Get an absolute url.
+                # Note: '\\domain.org' is not recognised as host, which is good.
+                came_from = urljoin(self.context.absolute_url() + '/', came_from)
+            elif not came_from.startswith(self.context.absolute_url()):
+                # Note: we cannot use portal_url.isURLInPortal here, because we are
+                # not in a Plone portal, but in the Zope root.
+                came_from = None
         if came_from is None:
             came_from = self.context.absolute_url()
         self.request.response.redirect(came_from)
diff --git a/Products/CMFPlone/tests/testBrowserAdmin.py b/Products/CMFPlone/tests/testBrowserAdmin.py
new file mode 100644
index 0000000..512d47a
--- /dev/null
+++ b/Products/CMFPlone/tests/testBrowserAdmin.py
@@ -0,0 +1,44 @@
+import urlparse
+import os
+from Products.CMFPlone.tests import PloneTestCase
+
+from Products.CMFCore.permissions import AddPortalContent
+from Products.CMFCore.permissions import ModifyPortalContent
+from Products.PluggableAuthService.interfaces.plugins import IChallengePlugin
+
+from AccessControl import Permissions
+from AccessControl import getSecurityManager
+portal_owner = PloneTestCase.portal_owner
+default_password = PloneTestCase.default_password
+
+
+class TestPloneRootLoginURL(PloneTestCase.FunctionalTestCase):
+
+    def test_normal_redirect(self):
+        url = '@@plone-root-login?came_from=%s' % self.portal.absolute_url()
+        response = self.publish(
+            url,
+            basic='%s:%s' % (portal_owner, default_password),
+            handle_errors=False,
+        )
+        self.assertNotEqual(response.headers.get('location'), None)
+        self.assertEqual(response.headers.get('location'),
+                         self.portal.absolute_url())
+
+    def test_attacker_redirect(self):
+        attackers = (
+            'http://attacker.com',
+            '\\attacker.com',
+        )
+        for attacker in attackers:
+            url = '@@plone-root-login?came_from=%s' % attacker
+            response = self.publish(
+                url,
+                basic='%s:%s' % (portal_owner, default_password),
+                handle_errors=False,
+            )
+            self.assertNotEqual(response.headers.get('location'), None)
+            self.assertNotEqual(response.headers.get('location'), attacker)
+            # Whatever the url is, it starts with the Zope root url.
+            self.assertTrue(response.headers.get('location').startswith(
+                self.app.absolute_url()), response.headers.get('location'))
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index b851303..511cd4a 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,6 +19,8 @@ New features:
 
 Bug fixes:
 
+- Apply security hotfix 20160830 for ``@@plone-root-login``.  [maurits]
+
 - Apply security hotfix 20160830 for ``isURLInPortal``.  [maurits]
 
 


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2016-08-31T11:14:09+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/754a6d6a42871ed778205b669692245641e355ad

Merge pull request #1736 from plone/apply-hotfix-20168030-43

Apply hotfix 20168030 [4.3]

Files changed:
A Products/CMFPlone/tests/testBrowserAdmin.py
M Products/CMFPlone/URLTool.py
M Products/CMFPlone/browser/admin.py
M Products/CMFPlone/tests/testURLTool.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/URLTool.py b/Products/CMFPlone/URLTool.py
index 34259fd..e6a43f7 100644
--- a/Products/CMFPlone/URLTool.py
+++ b/Products/CMFPlone/URLTool.py
@@ -30,8 +30,12 @@ def isURLInPortal(self, url, context=None):
 
         # sanitize url
         url = re.sub('^[\x00-\x20]+', '', url).strip()
-        if ('<script' in url or '%3Cscript' in url or 'javascript:' in url or
-                'javascript%3A' in url):
+        cmp_url = url.lower()
+        if ('\\\\' in cmp_url or
+                '<script' in cmp_url or
+                '%3cscript' in cmp_url or
+                'javascript:' in cmp_url or
+                'javascript%3a' in cmp_url):
             return False
 
         p_url = self()
diff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py
index 789b5a5..2244030 100644
--- a/Products/CMFPlone/browser/admin.py
+++ b/Products/CMFPlone/browser/admin.py
@@ -1,4 +1,6 @@
 from operator import itemgetter
+from urlparse import urljoin
+from urlparse import urlparse
 
 from plone.i18n.locales.interfaces import IContentLanguageAvailability
 from plone.protect.interfaces import IDisableCSRFProtection
@@ -86,6 +88,16 @@ class RootLoginRedirect(BrowserView):
     """
 
     def __call__(self, came_from=None):
+        if came_from is not None:
+            # see if this is a relative url or an absolute
+            if len(urlparse(came_from)[1]) == 0:
+                # No host specified, so url is relative.  Get an absolute url.
+                # Note: '\\domain.org' is not recognised as host, which is good.
+                came_from = urljoin(self.context.absolute_url() + '/', came_from)
+            elif not came_from.startswith(self.context.absolute_url()):
+                # Note: we cannot use portal_url.isURLInPortal here, because we are
+                # not in a Plone portal, but in the Zope root.
+                came_from = None
         if came_from is None:
             came_from = self.context.absolute_url()
         self.request.response.redirect(came_from)
diff --git a/Products/CMFPlone/tests/testBrowserAdmin.py b/Products/CMFPlone/tests/testBrowserAdmin.py
new file mode 100644
index 0000000..512d47a
--- /dev/null
+++ b/Products/CMFPlone/tests/testBrowserAdmin.py
@@ -0,0 +1,44 @@
+import urlparse
+import os
+from Products.CMFPlone.tests import PloneTestCase
+
+from Products.CMFCore.permissions import AddPortalContent
+from Products.CMFCore.permissions import ModifyPortalContent
+from Products.PluggableAuthService.interfaces.plugins import IChallengePlugin
+
+from AccessControl import Permissions
+from AccessControl import getSecurityManager
+portal_owner = PloneTestCase.portal_owner
+default_password = PloneTestCase.default_password
+
+
+class TestPloneRootLoginURL(PloneTestCase.FunctionalTestCase):
+
+    def test_normal_redirect(self):
+        url = '@@plone-root-login?came_from=%s' % self.portal.absolute_url()
+        response = self.publish(
+            url,
+            basic='%s:%s' % (portal_owner, default_password),
+            handle_errors=False,
+        )
+        self.assertNotEqual(response.headers.get('location'), None)
+        self.assertEqual(response.headers.get('location'),
+                         self.portal.absolute_url())
+
+    def test_attacker_redirect(self):
+        attackers = (
+            'http://attacker.com',
+            '\\attacker.com',
+        )
+        for attacker in attackers:
+            url = '@@plone-root-login?came_from=%s' % attacker
+            response = self.publish(
+                url,
+                basic='%s:%s' % (portal_owner, default_password),
+                handle_errors=False,
+            )
+            self.assertNotEqual(response.headers.get('location'), None)
+            self.assertNotEqual(response.headers.get('location'), attacker)
+            # Whatever the url is, it starts with the Zope root url.
+            self.assertTrue(response.headers.get('location').startswith(
+                self.app.absolute_url()), response.headers.get('location'))
diff --git a/Products/CMFPlone/tests/testURLTool.py b/Products/CMFPlone/tests/testURLTool.py
index d9ec743..1a0d0e1 100644
--- a/Products/CMFPlone/tests/testURLTool.py
+++ b/Products/CMFPlone/tests/testURLTool.py
@@ -43,6 +43,11 @@ def _makeOne(self, *args, **kw):
         return url_tool.__of__(self.site)
 
     def test_isURLInPortal(self):
+        # First test what the absolute url of the site is, otherwise these
+        # tests look really weird.  Apparently our domain is www.foobar.com.
+        self.assertEqual(self.site.absolute_url(),
+                         'http://www.foobar.com/bar/foo')
+
         url_tool = self._makeOne()
         iURLiP = url_tool.isURLInPortal
         self.assertTrue(iURLiP('http://www.foobar.com/bar/foo/folder'))
@@ -101,11 +106,21 @@ def test_script_tag_url_not_in_portal(self):
         url_tool = self._makeOne()
         iURLiP = url_tool.isURLInPortal
         self.assertFalse(iURLiP('<script>alert("hi");</script>'))
+        self.assertFalse(iURLiP('<sCript>alert("hi");</script>'))
         self.assertFalse(
             iURLiP('%3Cscript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))
+        self.assertFalse(
+            iURLiP('%3CsCript%3Ealert(%22hi%22)%3B%3C%2Fscript%3E'))
 
     def test_inline_url_not_in_portal(self):
         url_tool = self._makeOne()
         iURLiP = url_tool.isURLInPortal
         self.assertFalse(iURLiP('javascript%3Aalert(3)'))
+        self.assertFalse(iURLiP('jaVascript%3Aalert(3)'))
         self.assertFalse(iURLiP('javascript:alert(3)'))
+        self.assertFalse(iURLiP('jaVascript:alert(3)'))
+
+    def test_double_back_slash(self):
+        url_tool = self._makeOne()
+        iURLiP = url_tool.isURLInPortal
+        self.assertFalse(iURLiP('\\\\www.example.com'))
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index c85ef52..511cd4a 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,7 +19,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Apply security hotfix 20160830 for ``@@plone-root-login``.  [maurits]
+
+- Apply security hotfix 20160830 for ``isURLInPortal``.  [maurits]
 
 
 4.3.11 (2016-08-15)


