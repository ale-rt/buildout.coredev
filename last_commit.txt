Repository: plone.app.content


Branch: refs/heads/master
Date: 2016-10-07T00:41:52-05:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/8eb204b0d87494144517c24d6d860d3fa93be6bf

Fix get_top_site_from_url, Issue #103.
Fix issue with ``get_top_site_from_url``, where in some circumstances a ValueError was thrown.
If that happens, just return ``getSite``.
You will only notice, if you have subsites, access them non-VirtualHost-rooted and an error is thrown.
Then folder contents won't be able to navigate up to the root Plone site.
Fixes #103.

Files changed:
M CHANGES.rst
M plone/app/content/browser/contents/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index d80e9bc..50db5a2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,11 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix issue with ``get_top_site_from_url``, where in some circumstances a ValueError was thrown.
+  If that happens, just return ``getSite``.
+  You will only notice, if you have subsites, access them non-VirtualHost-rooted and an error is thrown.
+  Then folder contents won't be able to navigate up to the root Plone site.
+  [thet]
 
 
 3.3.1 (2016-09-23)
diff --git a/plone/app/content/browser/contents/__init__.py b/plone/app/content/browser/contents/__init__.py
index e4ce584..4c6af3e 100644
--- a/plone/app/content/browser/contents/__init__.py
+++ b/plone/app/content/browser/contents/__init__.py
@@ -60,12 +60,17 @@ def get_top_site_from_url(context, request):
     url_path = urlparse(context.absolute_url()).path.split('/')
 
     site = getSite()
-    for idx in range(len(url_path)):
-        _path = '/'.join(url_path[:idx + 1]) or '/'
-        site_path = request.physicalPathFromURL(_path)
-        site = context.restrictedTraverse('/'.join(site_path) or '/')
-        if ISite.providedBy(site):
-            break
+    try:
+        for idx in range(len(url_path)):
+            _path = '/'.join(url_path[:idx + 1]) or '/'
+            site_path = request.physicalPathFromURL(_path)
+            site = context.restrictedTraverse('/'.join(site_path) or '/')
+            if ISite.providedBy(site):
+                break
+    except ValueError:
+        # Refs: https://github.com/plone/plone.app.content/issues/103
+        # On error, just return getSite.
+        return getSite()
     return site
 
 


Repository: plone.app.content


Branch: refs/heads/master
Date: 2016-10-07T02:54:11-05:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/ac1275fc588e756f44ec3c25e7ff079bcdfef667

Merge pull request #110 from plone/thet-fix103

Fix get_top_site_from_url, Issue #103.

Files changed:
M CHANGES.rst
M plone/app/content/browser/contents/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index d80e9bc..50db5a2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,11 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix issue with ``get_top_site_from_url``, where in some circumstances a ValueError was thrown.
+  If that happens, just return ``getSite``.
+  You will only notice, if you have subsites, access them non-VirtualHost-rooted and an error is thrown.
+  Then folder contents won't be able to navigate up to the root Plone site.
+  [thet]
 
 
 3.3.1 (2016-09-23)
diff --git a/plone/app/content/browser/contents/__init__.py b/plone/app/content/browser/contents/__init__.py
index e4ce584..4c6af3e 100644
--- a/plone/app/content/browser/contents/__init__.py
+++ b/plone/app/content/browser/contents/__init__.py
@@ -60,12 +60,17 @@ def get_top_site_from_url(context, request):
     url_path = urlparse(context.absolute_url()).path.split('/')
 
     site = getSite()
-    for idx in range(len(url_path)):
-        _path = '/'.join(url_path[:idx + 1]) or '/'
-        site_path = request.physicalPathFromURL(_path)
-        site = context.restrictedTraverse('/'.join(site_path) or '/')
-        if ISite.providedBy(site):
-            break
+    try:
+        for idx in range(len(url_path)):
+            _path = '/'.join(url_path[:idx + 1]) or '/'
+            site_path = request.physicalPathFromURL(_path)
+            site = context.restrictedTraverse('/'.join(site_path) or '/')
+            if ISite.providedBy(site):
+                break
+    except ValueError:
+        # Refs: https://github.com/plone/plone.app.content/issues/103
+        # On error, just return getSite.
+        return getSite()
     return site
 
 


