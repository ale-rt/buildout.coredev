Repository: plone.scale


Branch: refs/heads/1.4.x
Date: 2016-09-29T17:14:15+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.scale/commit/6822ba46c88d3d9dfdba39e63940cf2fa2f72b68

Catch KeyError when deleting non existing scale.

This can happen in corner cases.

Fixes https://github.com/plone/plone.scale/issues/15

Files changed:
M CHANGES.rst
M plone/scale/storage.py
M plone/scale/tests/test_storage.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a73a121..4443ece 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,6 +11,10 @@ New:
 
 Fixes:
 
+- Catch KeyError when deleting non existing scale.  This can happen in corner cases.
+  Fixes `issue 15 <https://github.com/plone/plone.scale/issues/15>`_.
+  [maurits]
+
 - Set ``zip_safe=False`` in ``setup.py``.  Otherwise you cannot run
   the tests of the released package because the test runner does not
   find any tests in the egg file.  Note that this is only a problem in
diff --git a/plone/scale/storage.py b/plone/scale/storage.py
index 2135f6f..1e50266 100644
--- a/plone/scale/storage.py
+++ b/plone/scale/storage.py
@@ -155,7 +155,7 @@ def scale(self, factory=None, **parameters):
         storage = self.storage
         info = self.get_info_by_hash(key)
         if info is not None and self._modified_since(info['modified']):
-            del storage[info['uid']]
+            del self[info['uid']]
             # invalidate when the image was updated
             info = None
         if info is None and factory:
@@ -180,11 +180,11 @@ def _cleanup(self):
             # remove info stored by tuple keys
             # before refactoring
             if isinstance(key, tuple):
-                del storage[key]
+                del self[key]
             # clear cache from scales older than one day
             elif (modified_time and
                     value['modified'] < modified_time - KEEP_SCALE_MILLIS):
-                del storage[key]
+                del self[key]
 
     def __getitem__(self, uid):
         return self.storage[uid]
@@ -193,7 +193,12 @@ def __setitem__(self, id, scale):
         raise RuntimeError('New scales have to be created via scale()')
 
     def __delitem__(self, uid):
-        del self.storage[uid]
+        try:
+            del self.storage[uid]
+        except KeyError:
+            # This should not happen, but it apparently can happen in corner
+            # cases.  See https://github.com/plone/plone.scale/issues/15
+            logger.warn('Could not delete key %s from storage.', uid)
 
     def __iter__(self):
         return iter(self.storage)
diff --git a/plone/scale/tests/test_storage.py b/plone/scale/tests/test_storage.py
index 1e05d7f..86dbbf6 100644
--- a/plone/scale/tests/test_storage.py
+++ b/plone/scale/tests/test_storage.py
@@ -94,7 +94,10 @@ def testPositiveHasKey(self):
 
     def testDeleteNonExistingItem(self):
         storage = self.storage
-        self.assertRaises(KeyError, delitem, storage, 'foo')
+        # This used to raise a KeyError, but sometimes the underlying storage
+        # can get inconsistent, so it is nicer to accept it.
+        # See https://github.com/plone/plone.scale/issues/15
+        delitem(storage, 'foo')
 
     def testDeleteRemovesItemAndIndex(self):
         storage = self.storage


Repository: plone.scale


Branch: refs/heads/1.4.x
Date: 2016-10-07T07:36:47+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.scale/commit/250beec33499c45de99b1fb98d627e35e6b53401

Merge pull request #17 from plone/catch-keyerror-on-broken-scalesdict-14

Catch KeyError when deleting non existing scale. [1.4]

Files changed:
M CHANGES.rst
M plone/scale/storage.py
M plone/scale/tests/test_storage.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a73a121..4443ece 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,6 +11,10 @@ New:
 
 Fixes:
 
+- Catch KeyError when deleting non existing scale.  This can happen in corner cases.
+  Fixes `issue 15 <https://github.com/plone/plone.scale/issues/15>`_.
+  [maurits]
+
 - Set ``zip_safe=False`` in ``setup.py``.  Otherwise you cannot run
   the tests of the released package because the test runner does not
   find any tests in the egg file.  Note that this is only a problem in
diff --git a/plone/scale/storage.py b/plone/scale/storage.py
index 2135f6f..1e50266 100644
--- a/plone/scale/storage.py
+++ b/plone/scale/storage.py
@@ -155,7 +155,7 @@ def scale(self, factory=None, **parameters):
         storage = self.storage
         info = self.get_info_by_hash(key)
         if info is not None and self._modified_since(info['modified']):
-            del storage[info['uid']]
+            del self[info['uid']]
             # invalidate when the image was updated
             info = None
         if info is None and factory:
@@ -180,11 +180,11 @@ def _cleanup(self):
             # remove info stored by tuple keys
             # before refactoring
             if isinstance(key, tuple):
-                del storage[key]
+                del self[key]
             # clear cache from scales older than one day
             elif (modified_time and
                     value['modified'] < modified_time - KEEP_SCALE_MILLIS):
-                del storage[key]
+                del self[key]
 
     def __getitem__(self, uid):
         return self.storage[uid]
@@ -193,7 +193,12 @@ def __setitem__(self, id, scale):
         raise RuntimeError('New scales have to be created via scale()')
 
     def __delitem__(self, uid):
-        del self.storage[uid]
+        try:
+            del self.storage[uid]
+        except KeyError:
+            # This should not happen, but it apparently can happen in corner
+            # cases.  See https://github.com/plone/plone.scale/issues/15
+            logger.warn('Could not delete key %s from storage.', uid)
 
     def __iter__(self):
         return iter(self.storage)
diff --git a/plone/scale/tests/test_storage.py b/plone/scale/tests/test_storage.py
index 1e05d7f..86dbbf6 100644
--- a/plone/scale/tests/test_storage.py
+++ b/plone/scale/tests/test_storage.py
@@ -94,7 +94,10 @@ def testPositiveHasKey(self):
 
     def testDeleteNonExistingItem(self):
         storage = self.storage
-        self.assertRaises(KeyError, delitem, storage, 'foo')
+        # This used to raise a KeyError, but sometimes the underlying storage
+        # can get inconsistent, so it is nicer to accept it.
+        # See https://github.com/plone/plone.scale/issues/15
+        delitem(storage, 'foo')
 
     def testDeleteRemovesItemAndIndex(self):
         storage = self.storage


