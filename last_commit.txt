Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2016-09-20T13:05:24+02:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.discussion/commit/26a21a12d5d497c24bf5be27d37450b1ebbdf1f1

Reindex comments when they are modified

Files changed:
M CHANGES.rst
M plone/app/discussion/browser/comment.py
M plone/app/discussion/subscribers.py
M plone/app/discussion/subscribers.zcml
M plone/app/discussion/tests/test_catalog.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 894e27f..983dc9f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Reindex comments when they are modified.
+  [gforcada]
 
 Bug fixes:
 
diff --git a/plone/app/discussion/browser/comment.py b/plone/app/discussion/browser/comment.py
index 9f22d93..6b9b5d3 100644
--- a/plone/app/discussion/browser/comment.py
+++ b/plone/app/discussion/browser/comment.py
@@ -12,6 +12,8 @@
 from z3c.form import button
 from zope.component import getMultiAdapter
 from zope.component import getUtility
+from zope.event import notify
+from zope.lifecycleevent import ObjectModifiedEvent
 
 
 class View(BrowserView):
@@ -91,6 +93,8 @@ def handleComment(self, action):
 
         # Update text
         self.context.text = data['text']
+        # Notify that the object has been modified
+        notify(ObjectModifiedEvent(self.context))
 
         # Redirect to comment
         IStatusMessage(self.request).add(_(u'comment_edit_notification',
diff --git a/plone/app/discussion/subscribers.py b/plone/app/discussion/subscribers.py
index 9663243..c3717e5 100644
--- a/plone/app/discussion/subscribers.py
+++ b/plone/app/discussion/subscribers.py
@@ -3,7 +3,7 @@
 
 
 def index_object(obj, event):
-    """Index the object when it is added to the conversation.
+    """Index the object when it is added/modified to the conversation.
     """
     catalog = getToolByName(obj, 'portal_catalog')
     return catalog.reindexObject(obj)
diff --git a/plone/app/discussion/subscribers.zcml b/plone/app/discussion/subscribers.zcml
index befc5f3..5bb3535 100644
--- a/plone/app/discussion/subscribers.zcml
+++ b/plone/app/discussion/subscribers.zcml
@@ -41,6 +41,12 @@
 
     <subscriber
         for="plone.app.discussion.interfaces.IComment
+             zope.lifecycleevent.interfaces.IObjectModifiedEvent"
+        handler=".subscribers.index_object"
+        />
+
+    <subscriber
+        for="plone.app.discussion.interfaces.IComment
              zope.lifecycleevent.interfaces.IObjectRemovedEvent"
         handler=".subscribers.unindex_object"
         />
diff --git a/plone/app/discussion/tests/test_catalog.py b/plone/app/discussion/tests/test_catalog.py
index 9cfcbfc..91b4c62 100644
--- a/plone/app/discussion/tests/test_catalog.py
+++ b/plone/app/discussion/tests/test_catalog.py
@@ -9,6 +9,8 @@
 from Products.CMFCore.utils import getToolByName
 from zope.annotation.interfaces import IAnnotations
 from zope.component import createObject
+from zope.event import notify
+from zope.lifecycleevent import ObjectModifiedEvent
 
 import transaction
 import unittest2 as unittest
@@ -329,6 +331,13 @@ def test_delete_comment(self):
         ))
         self.assertEqual(len(brains), 0)
 
+    def test_reindex_comment(self):
+        # Make sure a comment is reindexed on the catalog when is modified
+        self.comment.text = 'Another text'
+        notify(ObjectModifiedEvent(self.comment))
+        brains = self.catalog.searchResults(SearchableText='Another text')
+        self.assertEqual(len(brains), 1)
+
     def test_remove_comments_when_content_object_is_removed(self):
         """Make sure all comments are removed from the catalog, if the content
            object is removed.


Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2016-12-22T18:34:50+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.discussion/commit/17fd1b005debe976eea6a9f231f825584180c3f0

Merge pull request #109 from derFreitag/gforcada-patch-1

Reindex comments when they are modified

Files changed:
M CHANGES.rst
M plone/app/discussion/browser/comment.py
M plone/app/discussion/subscribers.py
M plone/app/discussion/subscribers.zcml
M plone/app/discussion/tests/test_catalog.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 32892c4..234d8d3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Reindex comments when they are modified.
+  [gforcada]
 
 Bug fixes:
 
diff --git a/plone/app/discussion/browser/comment.py b/plone/app/discussion/browser/comment.py
index 9f22d93..6b9b5d3 100644
--- a/plone/app/discussion/browser/comment.py
+++ b/plone/app/discussion/browser/comment.py
@@ -12,6 +12,8 @@
 from z3c.form import button
 from zope.component import getMultiAdapter
 from zope.component import getUtility
+from zope.event import notify
+from zope.lifecycleevent import ObjectModifiedEvent
 
 
 class View(BrowserView):
@@ -91,6 +93,8 @@ def handleComment(self, action):
 
         # Update text
         self.context.text = data['text']
+        # Notify that the object has been modified
+        notify(ObjectModifiedEvent(self.context))
 
         # Redirect to comment
         IStatusMessage(self.request).add(_(u'comment_edit_notification',
diff --git a/plone/app/discussion/subscribers.py b/plone/app/discussion/subscribers.py
index 9663243..c3717e5 100644
--- a/plone/app/discussion/subscribers.py
+++ b/plone/app/discussion/subscribers.py
@@ -3,7 +3,7 @@
 
 
 def index_object(obj, event):
-    """Index the object when it is added to the conversation.
+    """Index the object when it is added/modified to the conversation.
     """
     catalog = getToolByName(obj, 'portal_catalog')
     return catalog.reindexObject(obj)
diff --git a/plone/app/discussion/subscribers.zcml b/plone/app/discussion/subscribers.zcml
index befc5f3..5bb3535 100644
--- a/plone/app/discussion/subscribers.zcml
+++ b/plone/app/discussion/subscribers.zcml
@@ -41,6 +41,12 @@
 
     <subscriber
         for="plone.app.discussion.interfaces.IComment
+             zope.lifecycleevent.interfaces.IObjectModifiedEvent"
+        handler=".subscribers.index_object"
+        />
+
+    <subscriber
+        for="plone.app.discussion.interfaces.IComment
              zope.lifecycleevent.interfaces.IObjectRemovedEvent"
         handler=".subscribers.unindex_object"
         />
diff --git a/plone/app/discussion/tests/test_catalog.py b/plone/app/discussion/tests/test_catalog.py
index 9cfcbfc..91b4c62 100644
--- a/plone/app/discussion/tests/test_catalog.py
+++ b/plone/app/discussion/tests/test_catalog.py
@@ -9,6 +9,8 @@
 from Products.CMFCore.utils import getToolByName
 from zope.annotation.interfaces import IAnnotations
 from zope.component import createObject
+from zope.event import notify
+from zope.lifecycleevent import ObjectModifiedEvent
 
 import transaction
 import unittest2 as unittest
@@ -329,6 +331,13 @@ def test_delete_comment(self):
         ))
         self.assertEqual(len(brains), 0)
 
+    def test_reindex_comment(self):
+        # Make sure a comment is reindexed on the catalog when is modified
+        self.comment.text = 'Another text'
+        notify(ObjectModifiedEvent(self.comment))
+        brains = self.catalog.searchResults(SearchableText='Another text')
+        self.assertEqual(len(brains), 1)
+
     def test_remove_comments_when_content_object_is_removed(self):
         """Make sure all comments are removed from the catalog, if the content
            object is removed.


