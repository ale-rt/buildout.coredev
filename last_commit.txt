Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2016-10-27T16:56:27+02:00
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/1245242f2032d0af19c0580ac74f23c5c859f072

Move PasswordResetTool to CMFPlone

Files changed:
A plone/app/upgrade/v51/profiles/to_beta1/toolset.xml
M CHANGES.rst
M plone/app/upgrade/__init__.py
M plone/app/upgrade/atcontentypes_bbb.py
M plone/app/upgrade/bbb.py
M plone/app/upgrade/tests/test_utils.py
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index ff64b99..87669e2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -37,6 +37,9 @@ New features:
 - Update ``last_compilation`` to deliver new bundles.
   [thet]
 
+- Move PasswordResetTool to CMFPlone.
+  *Note: Pending password resets are deleted.*
+  [tomgross]
 
 Bug fixes:
 
diff --git a/plone/app/upgrade/__init__.py b/plone/app/upgrade/__init__.py
index 8ca157d..2ac8522 100644
--- a/plone/app/upgrade/__init__.py
+++ b/plone/app/upgrade/__init__.py
@@ -139,3 +139,9 @@ def getNonInstallableProducts(self):
     from Products.CMFPlacefulWorkflow import interfaces
     alias_module(
         'Products.CMFPlacefulWorkflow.interfaces.portal_placeful_workflow', interfaces)
+
+try:
+    from Products.PasswordResetTool import PasswordResetTool
+    PasswordResetTool  # pyflakes
+except ImportError:
+    sys.modules['Products.PasswordResetTool.PasswordResetTool'] = bbb
diff --git a/plone/app/upgrade/atcontentypes_bbb.py b/plone/app/upgrade/atcontentypes_bbb.py
index 62d00ff..42dea06 100644
--- a/plone/app/upgrade/atcontentypes_bbb.py
+++ b/plone/app/upgrade/atcontentypes_bbb.py
@@ -11,7 +11,7 @@ class FactoryTool(SimpleItem):
     '''
 
     def __nonzero__(self):
-        ''' Always evealuate to False
+        ''' Always evaluate to False
         '''
         return 0
 
diff --git a/plone/app/upgrade/bbb.py b/plone/app/upgrade/bbb.py
index 9866b48..9c7a28b 100644
--- a/plone/app/upgrade/bbb.py
+++ b/plone/app/upgrade/bbb.py
@@ -1,7 +1,6 @@
 from OFS.SimpleItem import SimpleItem
 from Products.CMFCore.utils import registerToolInterface
 from zope.interface import Interface
-from ZPublisher import BeforeTraverse
 
 
 CalendarTool = SimpleItem
@@ -10,6 +9,7 @@
 SyndicationTool = SimpleItem
 UndoTool = SimpleItem
 TinyMCE = SimpleItem
+PasswordResetTool = SimpleItem
 
 
 class ILanguageTool(Interface):
diff --git a/plone/app/upgrade/tests/test_utils.py b/plone/app/upgrade/tests/test_utils.py
index 3483181..55db344 100644
--- a/plone/app/upgrade/tests/test_utils.py
+++ b/plone/app/upgrade/tests/test_utils.py
@@ -22,9 +22,13 @@ def layers_in_selection(selection_name):
 
         # An initial cleanup should do nothing.
         utils.cleanUpSkinsTool(self.portal)
-        self.assertEqual(len(skins.keys()), len(existing))
+        difference = set(existing) ^ set(skins)
+        self.assertEqual(len(skins.keys()), len(existing),
+                         msg='Skink difference is: {}'.format(list(difference)))
+        difference = set(layers_in_selection(selection)) ^ set(existing_layers_in_selection)
         self.assertEqual(len(layers_in_selection(selection)),
-                         len(existing_layers_in_selection))
+                         len(existing_layers_in_selection),
+                         msg='Layer difference is: {}'.format(list(difference)))
 
         # A second cleanup should also do nothing.  We used to rename
         # plone_styles to classic_styles on the first run, which would get
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 4fdecdc..44cf382 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -65,3 +65,19 @@ def remove_jquery_cookie_from_stub_js_modules(context):
     if 'jquery.cookie' in value:
         value.remove('jquery.cookie')
         registry[reg_key] = value
+
+
+def move_pw_reset_tool(context):
+    """ Move PasswordResetTool from its own product to CMFPlone
+    """
+
+    pw_reset_tool = getToolByName(context, 'portal_password_reset')
+    old_days_timeout = pw_reset_tool._timedelta
+    old_user_check = pw_reset_tool._user_check
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    del portal['portal_password_reset']
+    loadMigrationProfile(context, 'profile-plone.app.upgrade.v51:to51beta1')
+    pw_reset_tool = getToolByName(context, 'portal_password_reset')
+    pw_reset_tool._timedelta = int(old_days_timeout / 24)
+    pw_reset_tool._user_check = bool(old_user_check)
+
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index ffbbb88..fdbc52a 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -75,4 +75,17 @@ was moved from the plone bundle to plone-logged-in in CMPlone 5.1a2.
 
     </gs:upgradeSteps>
 
+    <gs:upgradeSteps
+        source="5103"
+        destination="5104"
+        profile="Products.CMFPlone:plone">
+
+      <gs:upgradeStep
+           title="Run to51beta1 upgrade profile."
+           description="Move PasswordResetTool"
+           handler=".betas.move_pw_reset_tool"
+           />
+
+    </gs:upgradeSteps>
+
 </configure>
diff --git a/plone/app/upgrade/v51/profiles/to_beta1/toolset.xml b/plone/app/upgrade/v51/profiles/to_beta1/toolset.xml
new file mode 100644
index 0000000..7b9178e
--- /dev/null
+++ b/plone/app/upgrade/v51/profiles/to_beta1/toolset.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<tool-setup>
+ <required tool_id="portal_password_reset"
+           class="Products.CMFPlone.PasswordResetTool.PasswordResetTool"/>
+</tool-setup>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2016-10-27T16:56:58+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/303aa60ced73d2a6e9e1560660ea9f5f2963e26e

Merge pull request #92 from plone/tomgross-mergepwresettool

Upgrade step for move of PasswordResetTool

Files changed:
A plone/app/upgrade/v51/profiles/to_beta1/toolset.xml
M CHANGES.rst
M plone/app/upgrade/__init__.py
M plone/app/upgrade/atcontentypes_bbb.py
M plone/app/upgrade/bbb.py
M plone/app/upgrade/tests/test_utils.py
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index ff64b99..87669e2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -37,6 +37,9 @@ New features:
 - Update ``last_compilation`` to deliver new bundles.
   [thet]
 
+- Move PasswordResetTool to CMFPlone.
+  *Note: Pending password resets are deleted.*
+  [tomgross]
 
 Bug fixes:
 
diff --git a/plone/app/upgrade/__init__.py b/plone/app/upgrade/__init__.py
index 8ca157d..2ac8522 100644
--- a/plone/app/upgrade/__init__.py
+++ b/plone/app/upgrade/__init__.py
@@ -139,3 +139,9 @@ def getNonInstallableProducts(self):
     from Products.CMFPlacefulWorkflow import interfaces
     alias_module(
         'Products.CMFPlacefulWorkflow.interfaces.portal_placeful_workflow', interfaces)
+
+try:
+    from Products.PasswordResetTool import PasswordResetTool
+    PasswordResetTool  # pyflakes
+except ImportError:
+    sys.modules['Products.PasswordResetTool.PasswordResetTool'] = bbb
diff --git a/plone/app/upgrade/atcontentypes_bbb.py b/plone/app/upgrade/atcontentypes_bbb.py
index 62d00ff..42dea06 100644
--- a/plone/app/upgrade/atcontentypes_bbb.py
+++ b/plone/app/upgrade/atcontentypes_bbb.py
@@ -11,7 +11,7 @@ class FactoryTool(SimpleItem):
     '''
 
     def __nonzero__(self):
-        ''' Always evealuate to False
+        ''' Always evaluate to False
         '''
         return 0
 
diff --git a/plone/app/upgrade/bbb.py b/plone/app/upgrade/bbb.py
index 9866b48..9c7a28b 100644
--- a/plone/app/upgrade/bbb.py
+++ b/plone/app/upgrade/bbb.py
@@ -1,7 +1,6 @@
 from OFS.SimpleItem import SimpleItem
 from Products.CMFCore.utils import registerToolInterface
 from zope.interface import Interface
-from ZPublisher import BeforeTraverse
 
 
 CalendarTool = SimpleItem
@@ -10,6 +9,7 @@
 SyndicationTool = SimpleItem
 UndoTool = SimpleItem
 TinyMCE = SimpleItem
+PasswordResetTool = SimpleItem
 
 
 class ILanguageTool(Interface):
diff --git a/plone/app/upgrade/tests/test_utils.py b/plone/app/upgrade/tests/test_utils.py
index 3483181..55db344 100644
--- a/plone/app/upgrade/tests/test_utils.py
+++ b/plone/app/upgrade/tests/test_utils.py
@@ -22,9 +22,13 @@ def layers_in_selection(selection_name):
 
         # An initial cleanup should do nothing.
         utils.cleanUpSkinsTool(self.portal)
-        self.assertEqual(len(skins.keys()), len(existing))
+        difference = set(existing) ^ set(skins)
+        self.assertEqual(len(skins.keys()), len(existing),
+                         msg='Skink difference is: {}'.format(list(difference)))
+        difference = set(layers_in_selection(selection)) ^ set(existing_layers_in_selection)
         self.assertEqual(len(layers_in_selection(selection)),
-                         len(existing_layers_in_selection))
+                         len(existing_layers_in_selection),
+                         msg='Layer difference is: {}'.format(list(difference)))
 
         # A second cleanup should also do nothing.  We used to rename
         # plone_styles to classic_styles on the first run, which would get
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 4fdecdc..44cf382 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -65,3 +65,19 @@ def remove_jquery_cookie_from_stub_js_modules(context):
     if 'jquery.cookie' in value:
         value.remove('jquery.cookie')
         registry[reg_key] = value
+
+
+def move_pw_reset_tool(context):
+    """ Move PasswordResetTool from its own product to CMFPlone
+    """
+
+    pw_reset_tool = getToolByName(context, 'portal_password_reset')
+    old_days_timeout = pw_reset_tool._timedelta
+    old_user_check = pw_reset_tool._user_check
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    del portal['portal_password_reset']
+    loadMigrationProfile(context, 'profile-plone.app.upgrade.v51:to51beta1')
+    pw_reset_tool = getToolByName(context, 'portal_password_reset')
+    pw_reset_tool._timedelta = int(old_days_timeout / 24)
+    pw_reset_tool._user_check = bool(old_user_check)
+
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index ffbbb88..fdbc52a 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -75,4 +75,17 @@ was moved from the plone bundle to plone-logged-in in CMPlone 5.1a2.
 
     </gs:upgradeSteps>
 
+    <gs:upgradeSteps
+        source="5103"
+        destination="5104"
+        profile="Products.CMFPlone:plone">
+
+      <gs:upgradeStep
+           title="Run to51beta1 upgrade profile."
+           description="Move PasswordResetTool"
+           handler=".betas.move_pw_reset_tool"
+           />
+
+    </gs:upgradeSteps>
+
 </configure>
diff --git a/plone/app/upgrade/v51/profiles/to_beta1/toolset.xml b/plone/app/upgrade/v51/profiles/to_beta1/toolset.xml
new file mode 100644
index 0000000..7b9178e
--- /dev/null
+++ b/plone/app/upgrade/v51/profiles/to_beta1/toolset.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<tool-setup>
+ <required tool_id="portal_password_reset"
+           class="Products.CMFPlone.PasswordResetTool.PasswordResetTool"/>
+</tool-setup>


