Repository: plone.app.layout


Branch: refs/heads/2.5.x
Date: 2016-12-21T22:12:07Z
Author: Daniel Jowett (djowett) <daniel@jowettenterprises.com>
Commit: https://github.com/plone/plone.app.layout/commit/bedbfeb6788b4569b4706967c13f2dbc02ad6664

Rework sitemap.xml.gz to allow filtering of sitemap elements; and supply such a filter if LinguaPlone is installed.

The filter could (and probably should) be moved to LinguaPlone, but this is an improvement on previous code that assumed
LinguaPlone was the only multilingual addon for Plone

Files changed:
M CHANGES.rst
M plone/app/layout/sitemap/configure.zcml
M plone/app/layout/sitemap/sitemap.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0d788f5..665b699 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -50,6 +50,11 @@ Fixes:
 
 - Fixed html validation: element nav does not need a role attribute.
   [maurits]
+Fixes:
+
+- Rework sitemap.xml.gz to allow filtering of sitemap elements; and supply such
+  a filter if LinguaPlone is installed.
+  [djowett]
 
 - Fixed invalid html of social viewlet by moving the schema.org tags
   to the body in a new viewlet ``plone.abovecontenttitle.socialtags``
diff --git a/plone/app/layout/sitemap/configure.zcml b/plone/app/layout/sitemap/configure.zcml
index 992f5e8..1162b53 100644
--- a/plone/app/layout/sitemap/configure.zcml
+++ b/plone/app/layout/sitemap/configure.zcml
@@ -1,6 +1,7 @@
 <configure
     xmlns="http://namespaces.zope.org/zope"
-    xmlns:browser="http://namespaces.zope.org/browser">
+    xmlns:browser="http://namespaces.zope.org/browser"
+    xmlns:zcml="http://namespaces.zope.org/zcml">
 
   <browser:page
       name="sitemap.xml.gz"
@@ -9,4 +10,14 @@
       permission="zope2.Public"
      />
 
+  <configure zcml:condition="installed Products.LinguaPlone">
+      <browser:page
+          name="sitemap.xml.gz"
+          for="plone.app.layout.navigation.interfaces.INavigationRoot"
+          class=".sitemap.LinguaPloneSiteMapView"
+          permission="zope2.Public"
+          layer="Products.LinguaPlone.interfaces.ILinguaPloneProductLayer"
+         />
+  </configure>
+
 </configure>
diff --git a/plone/app/layout/sitemap/sitemap.py b/plone/app/layout/sitemap/sitemap.py
index 0349364..bc93d6d 100644
--- a/plone/app/layout/sitemap/sitemap.py
+++ b/plone/app/layout/sitemap/sitemap.py
@@ -56,7 +56,10 @@ def objects(self):
 
         query['is_default_page'] = True
         default_page_modified = OOBTree()
-        for item in catalog.searchResults(query, Language='all'):
+
+        keywords = self.extra_search_parameters()
+        
+        for item in catalog.searchResults(query, **keywords):
             key = item.getURL().rsplit('/', 1)[0]
             value = (item.modified.micros(), item.modified.ISO8601())
             default_page_modified[key] = value
@@ -80,7 +83,8 @@ def objects(self):
             }
 
         query['is_default_page'] = False
-        for item in catalog.searchResults(query, Language='all'):
+
+        for item in catalog.searchResults(query, **keywords):
             loc = item.getURL()
             date = item.modified
             # Comparison must be on GMT value
@@ -121,3 +125,22 @@ def __call__(self):
         self.request.response.setHeader('Content-Type',
                                         'application/octet-stream')
         return self.generate()
+        
+    def extra_search_parameters(self):
+        """Allows extra filtering of the sitemap 
+        for use (in particular) by LinguaPlone
+        
+        :returns: a dictionary of keyword parameters to pass into 
+        catalog.searchResults()
+        """
+        return {}
+
+
+class LinguaPloneSiteMapView(SiteMapView):
+    """Overrides SiteMapView with patch for LinguaPlone
+    """
+
+    def extra_search_parameters(self):
+        """Work around LinguaPlone's catalog patch."""
+        # see https://github.com/plone/Products.LinguaPlone/blob/master/Products/LinguaPlone/catalog.py
+        return {'Language':'all'}


Repository: plone.app.layout


Branch: refs/heads/2.5.x
Date: 2016-12-28T12:15:49+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/6b8e56b17b2fc2a3a1e8ec88503868eea16a778c

Merge pull request #108 from plone/2.5.x_fix_issue_91

Rework sitemap.xml.gz view to fix it for plone.app.multilingual [2.5.x]

Files changed:
M CHANGES.rst
M plone/app/layout/sitemap/configure.zcml
M plone/app/layout/sitemap/sitemap.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0d788f5..665b699 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -50,6 +50,11 @@ Fixes:
 
 - Fixed html validation: element nav does not need a role attribute.
   [maurits]
+Fixes:
+
+- Rework sitemap.xml.gz to allow filtering of sitemap elements; and supply such
+  a filter if LinguaPlone is installed.
+  [djowett]
 
 - Fixed invalid html of social viewlet by moving the schema.org tags
   to the body in a new viewlet ``plone.abovecontenttitle.socialtags``
diff --git a/plone/app/layout/sitemap/configure.zcml b/plone/app/layout/sitemap/configure.zcml
index 992f5e8..1162b53 100644
--- a/plone/app/layout/sitemap/configure.zcml
+++ b/plone/app/layout/sitemap/configure.zcml
@@ -1,6 +1,7 @@
 <configure
     xmlns="http://namespaces.zope.org/zope"
-    xmlns:browser="http://namespaces.zope.org/browser">
+    xmlns:browser="http://namespaces.zope.org/browser"
+    xmlns:zcml="http://namespaces.zope.org/zcml">
 
   <browser:page
       name="sitemap.xml.gz"
@@ -9,4 +10,14 @@
       permission="zope2.Public"
      />
 
+  <configure zcml:condition="installed Products.LinguaPlone">
+      <browser:page
+          name="sitemap.xml.gz"
+          for="plone.app.layout.navigation.interfaces.INavigationRoot"
+          class=".sitemap.LinguaPloneSiteMapView"
+          permission="zope2.Public"
+          layer="Products.LinguaPlone.interfaces.ILinguaPloneProductLayer"
+         />
+  </configure>
+
 </configure>
diff --git a/plone/app/layout/sitemap/sitemap.py b/plone/app/layout/sitemap/sitemap.py
index 0349364..bc93d6d 100644
--- a/plone/app/layout/sitemap/sitemap.py
+++ b/plone/app/layout/sitemap/sitemap.py
@@ -56,7 +56,10 @@ def objects(self):
 
         query['is_default_page'] = True
         default_page_modified = OOBTree()
-        for item in catalog.searchResults(query, Language='all'):
+
+        keywords = self.extra_search_parameters()
+        
+        for item in catalog.searchResults(query, **keywords):
             key = item.getURL().rsplit('/', 1)[0]
             value = (item.modified.micros(), item.modified.ISO8601())
             default_page_modified[key] = value
@@ -80,7 +83,8 @@ def objects(self):
             }
 
         query['is_default_page'] = False
-        for item in catalog.searchResults(query, Language='all'):
+
+        for item in catalog.searchResults(query, **keywords):
             loc = item.getURL()
             date = item.modified
             # Comparison must be on GMT value
@@ -121,3 +125,22 @@ def __call__(self):
         self.request.response.setHeader('Content-Type',
                                         'application/octet-stream')
         return self.generate()
+        
+    def extra_search_parameters(self):
+        """Allows extra filtering of the sitemap 
+        for use (in particular) by LinguaPlone
+        
+        :returns: a dictionary of keyword parameters to pass into 
+        catalog.searchResults()
+        """
+        return {}
+
+
+class LinguaPloneSiteMapView(SiteMapView):
+    """Overrides SiteMapView with patch for LinguaPlone
+    """
+
+    def extra_search_parameters(self):
+        """Work around LinguaPlone's catalog patch."""
+        # see https://github.com/plone/Products.LinguaPlone/blob/master/Products/LinguaPlone/catalog.py
+        return {'Language':'all'}


