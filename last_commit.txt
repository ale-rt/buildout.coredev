Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-12-13T15:29:47-05:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/1e9a768b1ef721b84239db5725e7f84cd0cfb6a3

disable CSRF protection when replacing keyring

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/alphas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 8c445806..b386dfea 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -17,6 +17,10 @@ Bug fixes:
 - Log progress and ignore bad catalog entries while updating catalog metadata.
   [davisagli]
 
+- Disable CSRF protection when replacing keyring.
+  This fixes running specific upgrade steps via the portal_setup UI.
+  [davisagli]
+
 
 2.0.10 (2017-12-13)
 -------------------
diff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py
index 8f594cba..87c9a20b 100644
--- a/plone/app/upgrade/v50/alphas.py
+++ b/plone/app/upgrade/v50/alphas.py
@@ -18,10 +18,13 @@
 from plone.keyring.interfaces import IKeyManager
 from plone.keyring.keymanager import KeyManager
 from plone.keyring.keyring import Keyring
+from plone.protect.interfaces import IDisableCSRFProtection
 from plone.registry.interfaces import IRegistry
 from zope.component import getSiteManager
 from zope.component import getUtility
 from zope.component.hooks import getSite
+from zope.globalrequest import getRequest
+from zope.interface import alsoProvides
 from zope.schema.interfaces import ConstraintNotSatisfied
 
 try:
@@ -206,6 +209,13 @@ def upgrade_keyring(context):
         obj = KeyManager()
         sm.registerUtility(aq_base(obj), IKeyManager, '')
 
+    # disable CSRF protection which will fail due to
+    # using different secrets than when the authenticator
+    # was generated
+    request = getRequest()
+    if request is not None:
+        alsoProvides(request, IDisableCSRFProtection)
+
 
 def to50alhpa3(context):
     """5.0alpha2 - > 5.0alpha3"""


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-12-13T15:30:33-05:00
Author: David Glick (davisagli) <david.glick@plone.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/9098cff6617968d99ce8b4ad6ebfaacca1638ea1

Merge pull request #147 from plone/davisagli-csrf

Disable CSRF protection when replacing keyring

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/alphas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 8c445806..b386dfea 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -17,6 +17,10 @@ Bug fixes:
 - Log progress and ignore bad catalog entries while updating catalog metadata.
   [davisagli]
 
+- Disable CSRF protection when replacing keyring.
+  This fixes running specific upgrade steps via the portal_setup UI.
+  [davisagli]
+
 
 2.0.10 (2017-12-13)
 -------------------
diff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py
index 8f594cba..87c9a20b 100644
--- a/plone/app/upgrade/v50/alphas.py
+++ b/plone/app/upgrade/v50/alphas.py
@@ -18,10 +18,13 @@
 from plone.keyring.interfaces import IKeyManager
 from plone.keyring.keymanager import KeyManager
 from plone.keyring.keyring import Keyring
+from plone.protect.interfaces import IDisableCSRFProtection
 from plone.registry.interfaces import IRegistry
 from zope.component import getSiteManager
 from zope.component import getUtility
 from zope.component.hooks import getSite
+from zope.globalrequest import getRequest
+from zope.interface import alsoProvides
 from zope.schema.interfaces import ConstraintNotSatisfied
 
 try:
@@ -206,6 +209,13 @@ def upgrade_keyring(context):
         obj = KeyManager()
         sm.registerUtility(aq_base(obj), IKeyManager, '')
 
+    # disable CSRF protection which will fail due to
+    # using different secrets than when the authenticator
+    # was generated
+    request = getRequest()
+    if request is not None:
+        alsoProvides(request, IDisableCSRFProtection)
+
 
 def to50alhpa3(context):
     """5.0alpha2 - > 5.0alpha3"""


