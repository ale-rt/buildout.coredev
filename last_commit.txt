Repository: diazo


Branch: refs/heads/master
Date: 2016-10-11T22:26:01+02:00
Author: Huub Bouma (huubbouma) <bouma@w20e.com>
Commit: https://github.com/plone/diazo/commit/2e2fcaabca2590bcb048d9a6965de2bd6e01ee64

only add absolute prefix for xlink:href attributes
if url doesn't start with a '#' (use anchor_safe_urljoin)

Files changed:
M CHANGES.rst
M lib/diazo/rules.py
M lib/diazo/tests/absolute-prefix/output.html
M lib/diazo/tests/absolute-prefix/theme.html

diff --git a/CHANGES.rst b/CHANGES.rst
index 941e9c3..89364d8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -12,6 +12,10 @@ New features:
 
 - *add item here*
 
+- only add absolute prefix for xlink:href attributes if url doesn't start
+  with a '#' (use anchor_safe_urljoin)
+  [huubbouma]
+
 Bug fixes:
 
 - *add item here*
diff --git a/lib/diazo/rules.py b/lib/diazo/rules.py
index 59e6473..53a1ea9 100644
--- a/lib/diazo/rules.py
+++ b/lib/diazo/rules.py
@@ -142,7 +142,7 @@ def apply_absolute_prefix(theme_doc, absolute_prefix):
         node.set('src', url)
     for xlink_attr in theme_doc.xpath('//@*[local-name()="xlink:href"]'):
         node = xlink_attr.getparent()
-        url = urljoin(absolute_prefix, node.get('xlink:href'))
+        url = anchor_safe_urljoin(absolute_prefix, node.get('xlink:href'))
         node.set('xlink:href', url)
     for node in theme_doc.xpath('//*[@srcset]'):
         srcset = node.get('srcset')
diff --git a/lib/diazo/tests/absolute-prefix/output.html b/lib/diazo/tests/absolute-prefix/output.html
index a2c2c78..58b07e7 100644
--- a/lib/diazo/tests/absolute-prefix/output.html
+++ b/lib/diazo/tests/absolute-prefix/output.html
@@ -39,9 +39,18 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="/abs/foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <svg>
+      <symbol id="symbol666">
+        <circle cx="20" cy="20" r="20" stroke-width="5" stroke="red" fill="red">
+        </circle>
+      </symbol>
+    </svg>
     <div xmlns:xlink="http://www.w3.org/1999/xlink">
       <svg><use xlink:href="/abs/img/foo.svg"></use></svg>
       <span xlink:href="/abs/foo.html"></span>
+      <svg>
+        <use xlink:href="#symbol666" x="0" y="0" width="100" height="50"></use>
+      </svg>
     </div>
   </body>
 </html>
diff --git a/lib/diazo/tests/absolute-prefix/theme.html b/lib/diazo/tests/absolute-prefix/theme.html
index 94cd30b..7a4763d 100644
--- a/lib/diazo/tests/absolute-prefix/theme.html
+++ b/lib/diazo/tests/absolute-prefix/theme.html
@@ -39,9 +39,18 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <svg>
+      <symbol id="symbol666">
+        <circle cx="20" cy="20" r="20" stroke-width="5" stroke="red" fill="red">
+        </circle>
+      </symbol>
+    </svg>
     <div xmlns:xlink="http://www.w3.org/1999/xlink">
       <svg><use xlink:href="img/foo.svg"></use></svg>
       <span xlink:href="foo.html"></span>
+      <svg>
+        <use xlink:href="#symbol666" x="0" y="0" width="100" height="50"></use>
+      </svg>
     </div>
   </body>
 </html>


Repository: diazo


Branch: refs/heads/master
Date: 2016-10-11T14:51:41-07:00
Author: Laurence Rowe (lrowe) <l@lrowe.co.uk>
Commit: https://github.com/plone/diazo/commit/5dbf906f2bc53d880bb7628fc3e3a991ae57705e

Merge pull request #63 from huubbouma/master

use anchor_safe_urljoin for xlink:href attributes

Files changed:
M CHANGES.rst
M lib/diazo/rules.py
M lib/diazo/tests/absolute-prefix/output.html
M lib/diazo/tests/absolute-prefix/theme.html

diff --git a/CHANGES.rst b/CHANGES.rst
index 941e9c3..89364d8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -12,6 +12,10 @@ New features:
 
 - *add item here*
 
+- only add absolute prefix for xlink:href attributes if url doesn't start
+  with a '#' (use anchor_safe_urljoin)
+  [huubbouma]
+
 Bug fixes:
 
 - *add item here*
diff --git a/lib/diazo/rules.py b/lib/diazo/rules.py
index 59e6473..53a1ea9 100644
--- a/lib/diazo/rules.py
+++ b/lib/diazo/rules.py
@@ -142,7 +142,7 @@ def apply_absolute_prefix(theme_doc, absolute_prefix):
         node.set('src', url)
     for xlink_attr in theme_doc.xpath('//@*[local-name()="xlink:href"]'):
         node = xlink_attr.getparent()
-        url = urljoin(absolute_prefix, node.get('xlink:href'))
+        url = anchor_safe_urljoin(absolute_prefix, node.get('xlink:href'))
         node.set('xlink:href', url)
     for node in theme_doc.xpath('//*[@srcset]'):
         srcset = node.get('srcset')
diff --git a/lib/diazo/tests/absolute-prefix/output.html b/lib/diazo/tests/absolute-prefix/output.html
index a2c2c78..58b07e7 100644
--- a/lib/diazo/tests/absolute-prefix/output.html
+++ b/lib/diazo/tests/absolute-prefix/output.html
@@ -39,9 +39,18 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="/abs/foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <svg>
+      <symbol id="symbol666">
+        <circle cx="20" cy="20" r="20" stroke-width="5" stroke="red" fill="red">
+        </circle>
+      </symbol>
+    </svg>
     <div xmlns:xlink="http://www.w3.org/1999/xlink">
       <svg><use xlink:href="/abs/img/foo.svg"></use></svg>
       <span xlink:href="/abs/foo.html"></span>
+      <svg>
+        <use xlink:href="#symbol666" x="0" y="0" width="100" height="50"></use>
+      </svg>
     </div>
   </body>
 </html>
diff --git a/lib/diazo/tests/absolute-prefix/theme.html b/lib/diazo/tests/absolute-prefix/theme.html
index 94cd30b..7a4763d 100644
--- a/lib/diazo/tests/absolute-prefix/theme.html
+++ b/lib/diazo/tests/absolute-prefix/theme.html
@@ -39,9 +39,18 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <svg>
+      <symbol id="symbol666">
+        <circle cx="20" cy="20" r="20" stroke-width="5" stroke="red" fill="red">
+        </circle>
+      </symbol>
+    </svg>
     <div xmlns:xlink="http://www.w3.org/1999/xlink">
       <svg><use xlink:href="img/foo.svg"></use></svg>
       <span xlink:href="foo.html"></span>
+      <svg>
+        <use xlink:href="#symbol666" x="0" y="0" width="100" height="50"></use>
+      </svg>
     </div>
   </body>
 </html>


