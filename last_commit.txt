Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-12-07T15:31:38+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/530572b5950edbddac638a2e8021b08a39fa2f45

Unregister p.a.c import_steps (Fix https://github.com/plone/Products.CMFPlone/issues/2238)

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 28637d76..3c47c194 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Unregister import_steps that were moved to post_handlers.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/2238
+  [pbauer]
 
 
 2.0.9 (2017-11-26)
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 7a8931b5..57eca92c 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -214,3 +214,18 @@ def remove_duplicate_iterate_settings(context):
     qi = get_installer(context)
     if qi.is_product_installed('plone.app.iterate'):
         registry.registerInterface(IIterateSettings)
+
+
+def cleanup_import_steps(context):
+    """Remove registration of old GS-import_steps since they were transformed
+    into post_handlers. Otherwise the registered methods would run for each
+    profile.
+    See https://github.com/plone/Products.CMFPlone/issues/2238
+    """
+    steps = [
+        'plone.app.contenttypes--plone-content',
+        'plone.app.contenttypes',
+    ]
+    for step in steps:
+        if step in context._import_registry.listSteps():
+            context._import_registry.unregisterStep(step)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 788bca81..63b45a84 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -189,9 +189,8 @@ Add image scaling options to image handling control panel.
         profile="Products.CMFPlone:plone">
 
         <gs:upgradeStep
-            title="Miscellaneous"
-            description=""
-            handler="..utils.null_upgrade_step"
+            title="Remove registration of p.a.c import_steps since they were transformed into post_handlers"
+            handler=".betas.cleanup_import_steps"
             />
     </gs:upgradeSteps>
 


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-12-09T00:40:52+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/6a3883674f899b7a96bc817307d064f213ee69a6

Merge pull request #144 from plone/unregister_import_steps

Unregister p.a.c import_steps

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 28637d76..3c47c194 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Unregister import_steps that were moved to post_handlers.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/2238
+  [pbauer]
 
 
 2.0.9 (2017-11-26)
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 7a8931b5..57eca92c 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -214,3 +214,18 @@ def remove_duplicate_iterate_settings(context):
     qi = get_installer(context)
     if qi.is_product_installed('plone.app.iterate'):
         registry.registerInterface(IIterateSettings)
+
+
+def cleanup_import_steps(context):
+    """Remove registration of old GS-import_steps since they were transformed
+    into post_handlers. Otherwise the registered methods would run for each
+    profile.
+    See https://github.com/plone/Products.CMFPlone/issues/2238
+    """
+    steps = [
+        'plone.app.contenttypes--plone-content',
+        'plone.app.contenttypes',
+    ]
+    for step in steps:
+        if step in context._import_registry.listSteps():
+            context._import_registry.unregisterStep(step)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 788bca81..63b45a84 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -189,9 +189,8 @@ Add image scaling options to image handling control panel.
         profile="Products.CMFPlone:plone">
 
         <gs:upgradeStep
-            title="Miscellaneous"
-            description=""
-            handler="..utils.null_upgrade_step"
+            title="Remove registration of p.a.c import_steps since they were transformed into post_handlers"
+            handler=".betas.cleanup_import_steps"
             />
     </gs:upgradeSteps>
 


