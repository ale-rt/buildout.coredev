Repository: Products.LinguaPlone


Branch: refs/heads/master
Date: 2016-11-10T19:31:25+01:00
Author: SyZn (SyZn) <zalan@gmx.net>
Commit: https://github.com/plone/Products.LinguaPlone/commit/0833fc9b269fcf421db5ac3ef0e2f3f1503a1734

Fixed CSRF protection bug

Files changed:
M CHANGES.rst
M Products/LinguaPlone/browser/setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ae5e577..2a62684 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed CSRF protection bug on @@language-setup-folders view.
+  [syzn]
 
 
 4.1.6 (2016-11-09)
diff --git a/Products/LinguaPlone/browser/setup.py b/Products/LinguaPlone/browser/setup.py
index d34e4f2..74da945 100644
--- a/Products/LinguaPlone/browser/setup.py
+++ b/Products/LinguaPlone/browser/setup.py
@@ -4,6 +4,13 @@
 from Products.CMFCore.utils import getToolByName
 from Products.Five import BrowserView
 
+CSRF_PROTECTION_ENABLED = False
+try:
+    from plone.protect.interfaces import IDisableCSRFProtection
+    CSRF_PROTECTION_ENABLED = True
+except ImportError:
+    pass
+
 
 class SetupView(BrowserView):
 
@@ -12,6 +19,8 @@ def __init__(self, context, request):
         self.previousDefaultPageId = None
 
     def __call__(self, forceOneLanguage=False):
+        if CSRF_PROTECTION_ENABLED:
+            alsoProvides(self.request, IDisableCSRFProtection)
         result = []
         self.folders = {}
         pl = getToolByName(self.context, "portal_languages")


