Repository: plone.testing


Branch: refs/heads/master
Date: 2015-12-10T22:35:50+01:00
Author: Johannes Raggam () <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.testing/commit/44fa415943f0f992673b2885ebe1608d1c2f75a0

Add support for Zope 4.

Files changed:
M CHANGES.rst
M src/plone/testing/z2.py

diff --git a/CHANGES.rst b/CHANGES.rst
index aa224df..a04ffcb 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,6 +11,8 @@ New:
 Fixes:
 
 - *add item here*
+- Add support for Zope 4.
+  [thet]
 
 
 4.0.15 (2015-08-14)
diff --git a/src/plone/testing/z2.py b/src/plone/testing/z2.py
index 04e00f8..879c81e 100644
--- a/src/plone/testing/z2.py
+++ b/src/plone/testing/z2.py
@@ -115,13 +115,17 @@ def uninstallProduct(app, productName, quiet=False):
                 if name in Application.misc_.__dict__:
                     del Application.misc_.__dict__[name]
 
-                if name in app['Control_Panel']['Products']:
-                    product = app['Control_Panel']['Products'][name]
+                try:
+                    if name in app['Control_Panel']['Products']:
+                        product = app['Control_Panel']['Products'][name]
 
-                    app._manage_remove_product_meta_type(product)
-                    app._manage_remove_product_permission(product)
+                        app._manage_remove_product_meta_type(product)
+                        app._manage_remove_product_permission(product)
 
-                    del app['Control_Panel']['Products'][name]
+                        del app['Control_Panel']['Products'][name]
+                except KeyError:
+                    # Zope 4
+                    pass
 
                 # TODO: Also remove permissions from get_folder_permissions?
                 # Difficult to know if this would stomp on any other permissions
@@ -134,13 +138,17 @@ def uninstallProduct(app, productName, quiet=False):
         module, init_func = _INSTALLED_PRODUCTS[productName]
         name = module.__name__
 
-        if name in app['Control_Panel']['Products']:
-            product = app['Control_Panel']['Products'][name]
+        try:
+            if name in app['Control_Panel']['Products']:
+                product = app['Control_Panel']['Products'][name]
 
-            app._manage_remove_product_meta_type(product)
-            app._manage_remove_product_permission(product)
+                app._manage_remove_product_meta_type(product)
+                app._manage_remove_product_permission(product)
 
-            del app['Control_Panel']['Products'][name]
+                del app['Control_Panel']['Products'][name]
+        except KeyError:
+            # Zope 4
+            pass
 
         if HAS_ZOPE213:
             packages = get_packages_to_initialize()
@@ -412,17 +420,21 @@ def null_initialize(app): pass
         OFS.Application.initialize = null_initialize
 
         # Avoid expensive help registration
-        def null_register_topic(self,id,topic): pass
-        self._App_ProductContext_ProductContext_registerHelpTopic = App.ProductContext.ProductContext.registerHelpTopic
-        App.ProductContext.ProductContext.registerHelpTopic = null_register_topic
-
-        def null_register_title(self,title): pass
-        self._App_ProductContext_ProductContext_registerHelpTitle = App.ProductContext.ProductContext.registerHelpTitle
-        App.ProductContext.ProductContext.registerHelpTitle = null_register_title
-
-        def null_register_help(self,directory='',clear=1,title_re=None): pass
-        self._App_ProductContext_ProductContext_registerHelp = App.ProductContext.ProductContext.registerHelp
-        App.ProductContext.ProductContext.registerHelp = null_register_help
+        try:
+            def null_register_topic(self,id,topic): pass
+            self._App_ProductContext_ProductContext_registerHelpTopic = App.ProductContext.ProductContext.registerHelpTopic
+            App.ProductContext.ProductContext.registerHelpTopic = null_register_topic
+
+            def null_register_title(self,title): pass
+            self._App_ProductContext_ProductContext_registerHelpTitle = App.ProductContext.ProductContext.registerHelpTitle
+            App.ProductContext.ProductContext.registerHelpTitle = null_register_title
+
+            def null_register_help(self,directory='',clear=1,title_re=None): pass
+            self._App_ProductContext_ProductContext_registerHelp = App.ProductContext.ProductContext.registerHelp
+            App.ProductContext.ProductContext.registerHelp = null_register_help
+        except AttributeError:
+            # Zope 4
+            pass
 
         # in Zope 2.13, prevent ZCML from loading during App startup
         if hasattr(Zope2.App.startup, 'load_zcml'):
@@ -443,14 +455,18 @@ def tearDownPatches(self):
         OFS.Application.initialize = self._OFS_Application_initialize
         del self._OFS_Application_initialize
 
-        App.ProductContext.ProductContext.registerHelpTopic = self._App_ProductContext_ProductContext_registerHelpTopic
-        del self._App_ProductContext_ProductContext_registerHelpTopic
+        try:
+            App.ProductContext.ProductContext.registerHelpTopic = self._App_ProductContext_ProductContext_registerHelpTopic
+            del self._App_ProductContext_ProductContext_registerHelpTopic
 
-        App.ProductContext.ProductContext.registerHelpTitle = self._App_ProductContext_ProductContext_registerHelpTitle
-        del self._App_ProductContext_ProductContext_registerHelpTitle
+            App.ProductContext.ProductContext.registerHelpTitle = self._App_ProductContext_ProductContext_registerHelpTitle
+            del self._App_ProductContext_ProductContext_registerHelpTitle
 
-        App.ProductContext.ProductContext.registerHelp = self._App_ProductContext_ProductContext_registerHelp
-        del self._App_ProductContext_ProductContext_registerHelp
+            App.ProductContext.ProductContext.registerHelp = self._App_ProductContext_ProductContext_registerHelp
+            del self._App_ProductContext_ProductContext_registerHelp
+        except AttributeError:
+            # Zope 4
+            pass
 
     def setUpThreads(self):
         """Set the thread count for ZServer. This defaults to 1.


Repository: plone.testing


Branch: refs/heads/master
Date: 2015-12-10T22:35:50+01:00
Author: Johannes Raggam () <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.testing/commit/b302bb5c3bb8662275d8f2b92cd83236b96903fa

use better pattern for catching errors. only the part, which throws the error should be try'd. tnx @davisagli

Files changed:
M src/plone/testing/z2.py

diff --git a/src/plone/testing/z2.py b/src/plone/testing/z2.py
index 879c81e..316f236 100644
--- a/src/plone/testing/z2.py
+++ b/src/plone/testing/z2.py
@@ -116,16 +116,18 @@ def uninstallProduct(app, productName, quiet=False):
                     del Application.misc_.__dict__[name]
 
                 try:
-                    if name in app['Control_Panel']['Products']:
-                        product = app['Control_Panel']['Products'][name]
+                    cp = app['Control_Panel']['Products']
+                except KeyError:
+                    # Zope 4
+                    pass
+                else:
+                    if name in cp:
+                        product = cp[name]
 
                         app._manage_remove_product_meta_type(product)
                         app._manage_remove_product_permission(product)
 
-                        del app['Control_Panel']['Products'][name]
-                except KeyError:
-                    # Zope 4
-                    pass
+                        del cp[name]
 
                 # TODO: Also remove permissions from get_folder_permissions?
                 # Difficult to know if this would stomp on any other permissions
@@ -139,16 +141,18 @@ def uninstallProduct(app, productName, quiet=False):
         name = module.__name__
 
         try:
-            if name in app['Control_Panel']['Products']:
-                product = app['Control_Panel']['Products'][name]
+            cp = app['Control_Panel']['Products']
+        except KeyError:
+            # Zope 4
+            pass
+        else:
+            if name in cp:
+                product = cp[name]
 
                 app._manage_remove_product_meta_type(product)
                 app._manage_remove_product_permission(product)
 
-                del app['Control_Panel']['Products'][name]
-        except KeyError:
-            # Zope 4
-            pass
+                del cp[name]
 
         if HAS_ZOPE213:
             packages = get_packages_to_initialize()
@@ -421,20 +425,21 @@ def null_initialize(app): pass
 
         # Avoid expensive help registration
         try:
-            def null_register_topic(self,id,topic): pass
             self._App_ProductContext_ProductContext_registerHelpTopic = App.ProductContext.ProductContext.registerHelpTopic
+        except AttributeError:
+            # Zope 4
+            pass
+        else:
+            def null_register_topic(self,id,topic): pass
             App.ProductContext.ProductContext.registerHelpTopic = null_register_topic
 
-            def null_register_title(self,title): pass
             self._App_ProductContext_ProductContext_registerHelpTitle = App.ProductContext.ProductContext.registerHelpTitle
+            def null_register_title(self,title): pass
             App.ProductContext.ProductContext.registerHelpTitle = null_register_title
 
-            def null_register_help(self,directory='',clear=1,title_re=None): pass
             self._App_ProductContext_ProductContext_registerHelp = App.ProductContext.ProductContext.registerHelp
+            def null_register_help(self,directory='',clear=1,title_re=None): pass
             App.ProductContext.ProductContext.registerHelp = null_register_help
-        except AttributeError:
-            # Zope 4
-            pass
 
         # in Zope 2.13, prevent ZCML from loading during App startup
         if hasattr(Zope2.App.startup, 'load_zcml'):
@@ -457,6 +462,10 @@ def tearDownPatches(self):
 
         try:
             App.ProductContext.ProductContext.registerHelpTopic = self._App_ProductContext_ProductContext_registerHelpTopic
+        except AttributeError:
+            # Zope 4
+            pass
+        else:
             del self._App_ProductContext_ProductContext_registerHelpTopic
 
             App.ProductContext.ProductContext.registerHelpTitle = self._App_ProductContext_ProductContext_registerHelpTitle
@@ -464,9 +473,6 @@ def tearDownPatches(self):
 
             App.ProductContext.ProductContext.registerHelp = self._App_ProductContext_ProductContext_registerHelp
             del self._App_ProductContext_ProductContext_registerHelp
-        except AttributeError:
-            # Zope 4
-            pass
 
     def setUpThreads(self):
         """Set the thread count for ZServer. This defaults to 1.


Repository: plone.testing


Branch: refs/heads/master
Date: 2015-12-10T22:35:50+01:00
Author: Johannes Raggam () <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.testing/commit/ca49cfd16fa914d71bd9ab2ca4610e87a4774523

depend on zope.testrunner, which was moved out from zope.testing.testrunner

Files changed:
M CHANGES.rst
M setup.py
M src/plone/testing/publisher.txt
M src/plone/testing/security.txt
M src/plone/testing/z2.txt
M src/plone/testing/zca.txt
M src/plone/testing/zodb.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index a04ffcb..3f6690b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,6 +11,10 @@ New:
 Fixes:
 
 - *add item here*
+- Depend on zope.testrunner, which was moved out from
+  zope.testing.testrunner.
+  [thet]
+
 - Add support for Zope 4.
   [thet]
 
diff --git a/setup.py b/setup.py
index c7e7518..7d39119 100644
--- a/setup.py
+++ b/setup.py
@@ -20,6 +20,7 @@
                  'zope.event',
                  'zope.configuration',
                  'zope.testbrowser',
+                 'zope.testrunner',
                  'zope.app.publisher',  # XXX: Can probably go away in Zope 2.13
                  'ZODB3',
                  'Zope2',
diff --git a/src/plone/testing/publisher.txt b/src/plone/testing/publisher.txt
index b198967..5f35948 100644
--- a/src/plone/testing/publisher.txt
+++ b/src/plone/testing/publisher.txt
@@ -7,7 +7,7 @@ The Zope Publisher layers are found in the module ``plone.testing.publisher``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 ZCML directives
 ~~~~~~~~~~~~~~~
diff --git a/src/plone/testing/security.txt b/src/plone/testing/security.txt
index 92b0f52..2cd34ca 100644
--- a/src/plone/testing/security.txt
+++ b/src/plone/testing/security.txt
@@ -7,7 +7,7 @@ The Zope Security layers are found in the module ``plone.testing.security``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Layers
 ~~~~~~
diff --git a/src/plone/testing/z2.txt b/src/plone/testing/z2.txt
index d5f0172..9b2f471 100644
--- a/src/plone/testing/z2.txt
+++ b/src/plone/testing/z2.txt
@@ -7,7 +7,7 @@ The Zope 2 layers are found in the module ``plone.testing.z2``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Startup
 ~~~~~~~
diff --git a/src/plone/testing/zca.txt b/src/plone/testing/zca.txt
index 6e14a55..134fc10 100644
--- a/src/plone/testing/zca.txt
+++ b/src/plone/testing/zca.txt
@@ -7,7 +7,7 @@ The ZCA layers are found in the module ``plone.testing.zca``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Unit testing
 ~~~~~~~~~~~~
diff --git a/src/plone/testing/zodb.txt b/src/plone/testing/zodb.txt
index 5986fdb..79ff465 100644
--- a/src/plone/testing/zodb.txt
+++ b/src/plone/testing/zodb.txt
@@ -7,7 +7,7 @@ The ZODB layers are found in the module ``plone.testing.zodb``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Empty ZODB layer
 ~~~~~~~~~~~~~~~~


Repository: plone.testing


Branch: refs/heads/master
Date: 2015-12-10T22:35:50+01:00
Author: Johannes Raggam () <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.testing/commit/592c087fe324c018fbe50e4e4a73a485f06310cc

raise version

Files changed:
M CHANGES.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3f6690b..9ad20c9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,8 +1,8 @@
 Changelog
 =========
 
-4.0.16 (unreleased)
--------------------
+4.1.0 (unreleased)
+------------------
 
 New:
 
diff --git a/setup.py b/setup.py
index 7d39119..6fb36ff 100644
--- a/setup.py
+++ b/setup.py
@@ -3,7 +3,7 @@
 import sys
 from setuptools import setup, find_packages
 
-version = '4.0.16.dev0'
+version = '4.1.0.dev0'
 
 install_requires = ['setuptools',
                     'zope.testing',


Repository: plone.testing


Branch: refs/heads/master
Date: 2015-12-11T01:31:00+01:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.testing/commit/d468f13db38f466185d9fca71601133836ef9edd

Merge pull request #16 from plone/thet-zope4fixes

Zope 4 fixes

Files changed:
M CHANGES.rst
M setup.py
M src/plone/testing/publisher.txt
M src/plone/testing/security.txt
M src/plone/testing/z2.py
M src/plone/testing/z2.txt
M src/plone/testing/zca.txt
M src/plone/testing/zodb.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index aa224df..9ad20c9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,8 +1,8 @@
 Changelog
 =========
 
-4.0.16 (unreleased)
--------------------
+4.1.0 (unreleased)
+------------------
 
 New:
 
@@ -11,6 +11,12 @@ New:
 Fixes:
 
 - *add item here*
+- Depend on zope.testrunner, which was moved out from
+  zope.testing.testrunner.
+  [thet]
+
+- Add support for Zope 4.
+  [thet]
 
 
 4.0.15 (2015-08-14)
diff --git a/setup.py b/setup.py
index c7e7518..6fb36ff 100644
--- a/setup.py
+++ b/setup.py
@@ -3,7 +3,7 @@
 import sys
 from setuptools import setup, find_packages
 
-version = '4.0.16.dev0'
+version = '4.1.0.dev0'
 
 install_requires = ['setuptools',
                     'zope.testing',
@@ -20,6 +20,7 @@
                  'zope.event',
                  'zope.configuration',
                  'zope.testbrowser',
+                 'zope.testrunner',
                  'zope.app.publisher',  # XXX: Can probably go away in Zope 2.13
                  'ZODB3',
                  'Zope2',
diff --git a/src/plone/testing/publisher.txt b/src/plone/testing/publisher.txt
index b198967..5f35948 100644
--- a/src/plone/testing/publisher.txt
+++ b/src/plone/testing/publisher.txt
@@ -7,7 +7,7 @@ The Zope Publisher layers are found in the module ``plone.testing.publisher``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 ZCML directives
 ~~~~~~~~~~~~~~~
diff --git a/src/plone/testing/security.txt b/src/plone/testing/security.txt
index 92b0f52..2cd34ca 100644
--- a/src/plone/testing/security.txt
+++ b/src/plone/testing/security.txt
@@ -7,7 +7,7 @@ The Zope Security layers are found in the module ``plone.testing.security``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Layers
 ~~~~~~
diff --git a/src/plone/testing/z2.py b/src/plone/testing/z2.py
index 04e00f8..316f236 100644
--- a/src/plone/testing/z2.py
+++ b/src/plone/testing/z2.py
@@ -115,13 +115,19 @@ def uninstallProduct(app, productName, quiet=False):
                 if name in Application.misc_.__dict__:
                     del Application.misc_.__dict__[name]
 
-                if name in app['Control_Panel']['Products']:
-                    product = app['Control_Panel']['Products'][name]
+                try:
+                    cp = app['Control_Panel']['Products']
+                except KeyError:
+                    # Zope 4
+                    pass
+                else:
+                    if name in cp:
+                        product = cp[name]
 
-                    app._manage_remove_product_meta_type(product)
-                    app._manage_remove_product_permission(product)
+                        app._manage_remove_product_meta_type(product)
+                        app._manage_remove_product_permission(product)
 
-                    del app['Control_Panel']['Products'][name]
+                        del cp[name]
 
                 # TODO: Also remove permissions from get_folder_permissions?
                 # Difficult to know if this would stomp on any other permissions
@@ -134,13 +140,19 @@ def uninstallProduct(app, productName, quiet=False):
         module, init_func = _INSTALLED_PRODUCTS[productName]
         name = module.__name__
 
-        if name in app['Control_Panel']['Products']:
-            product = app['Control_Panel']['Products'][name]
+        try:
+            cp = app['Control_Panel']['Products']
+        except KeyError:
+            # Zope 4
+            pass
+        else:
+            if name in cp:
+                product = cp[name]
 
-            app._manage_remove_product_meta_type(product)
-            app._manage_remove_product_permission(product)
+                app._manage_remove_product_meta_type(product)
+                app._manage_remove_product_permission(product)
 
-            del app['Control_Panel']['Products'][name]
+                del cp[name]
 
         if HAS_ZOPE213:
             packages = get_packages_to_initialize()
@@ -412,17 +424,22 @@ def null_initialize(app): pass
         OFS.Application.initialize = null_initialize
 
         # Avoid expensive help registration
-        def null_register_topic(self,id,topic): pass
-        self._App_ProductContext_ProductContext_registerHelpTopic = App.ProductContext.ProductContext.registerHelpTopic
-        App.ProductContext.ProductContext.registerHelpTopic = null_register_topic
+        try:
+            self._App_ProductContext_ProductContext_registerHelpTopic = App.ProductContext.ProductContext.registerHelpTopic
+        except AttributeError:
+            # Zope 4
+            pass
+        else:
+            def null_register_topic(self,id,topic): pass
+            App.ProductContext.ProductContext.registerHelpTopic = null_register_topic
 
-        def null_register_title(self,title): pass
-        self._App_ProductContext_ProductContext_registerHelpTitle = App.ProductContext.ProductContext.registerHelpTitle
-        App.ProductContext.ProductContext.registerHelpTitle = null_register_title
+            self._App_ProductContext_ProductContext_registerHelpTitle = App.ProductContext.ProductContext.registerHelpTitle
+            def null_register_title(self,title): pass
+            App.ProductContext.ProductContext.registerHelpTitle = null_register_title
 
-        def null_register_help(self,directory='',clear=1,title_re=None): pass
-        self._App_ProductContext_ProductContext_registerHelp = App.ProductContext.ProductContext.registerHelp
-        App.ProductContext.ProductContext.registerHelp = null_register_help
+            self._App_ProductContext_ProductContext_registerHelp = App.ProductContext.ProductContext.registerHelp
+            def null_register_help(self,directory='',clear=1,title_re=None): pass
+            App.ProductContext.ProductContext.registerHelp = null_register_help
 
         # in Zope 2.13, prevent ZCML from loading during App startup
         if hasattr(Zope2.App.startup, 'load_zcml'):
@@ -443,14 +460,19 @@ def tearDownPatches(self):
         OFS.Application.initialize = self._OFS_Application_initialize
         del self._OFS_Application_initialize
 
-        App.ProductContext.ProductContext.registerHelpTopic = self._App_ProductContext_ProductContext_registerHelpTopic
-        del self._App_ProductContext_ProductContext_registerHelpTopic
+        try:
+            App.ProductContext.ProductContext.registerHelpTopic = self._App_ProductContext_ProductContext_registerHelpTopic
+        except AttributeError:
+            # Zope 4
+            pass
+        else:
+            del self._App_ProductContext_ProductContext_registerHelpTopic
 
-        App.ProductContext.ProductContext.registerHelpTitle = self._App_ProductContext_ProductContext_registerHelpTitle
-        del self._App_ProductContext_ProductContext_registerHelpTitle
+            App.ProductContext.ProductContext.registerHelpTitle = self._App_ProductContext_ProductContext_registerHelpTitle
+            del self._App_ProductContext_ProductContext_registerHelpTitle
 
-        App.ProductContext.ProductContext.registerHelp = self._App_ProductContext_ProductContext_registerHelp
-        del self._App_ProductContext_ProductContext_registerHelp
+            App.ProductContext.ProductContext.registerHelp = self._App_ProductContext_ProductContext_registerHelp
+            del self._App_ProductContext_ProductContext_registerHelp
 
     def setUpThreads(self):
         """Set the thread count for ZServer. This defaults to 1.
diff --git a/src/plone/testing/z2.txt b/src/plone/testing/z2.txt
index d5f0172..9b2f471 100644
--- a/src/plone/testing/z2.txt
+++ b/src/plone/testing/z2.txt
@@ -7,7 +7,7 @@ The Zope 2 layers are found in the module ``plone.testing.z2``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Startup
 ~~~~~~~
diff --git a/src/plone/testing/zca.txt b/src/plone/testing/zca.txt
index 6e14a55..134fc10 100644
--- a/src/plone/testing/zca.txt
+++ b/src/plone/testing/zca.txt
@@ -7,7 +7,7 @@ The ZCA layers are found in the module ``plone.testing.zca``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Unit testing
 ~~~~~~~~~~~~
diff --git a/src/plone/testing/zodb.txt b/src/plone/testing/zodb.txt
index 5986fdb..79ff465 100644
--- a/src/plone/testing/zodb.txt
+++ b/src/plone/testing/zodb.txt
@@ -7,7 +7,7 @@ The ZODB layers are found in the module ``plone.testing.zodb``:
 
 For testing, we need a testrunner
 
-    >>> from zope.testing.testrunner import runner
+    >>> from zope.testrunner import runner
 
 Empty ZODB layer
 ~~~~~~~~~~~~~~~~


