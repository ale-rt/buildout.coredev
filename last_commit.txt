Repository: Products.Archetypes


Branch: refs/heads/1.9.x
Date: 2017-05-23T16:12:02+02:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/Products.Archetypes/commit/86e301fe93b1b799dd7bdda26ccb734cee91da69

fix issue when vocabulary key is utf8 encoded string

Files changed:
M Products/Archetypes/BaseObject.py
M Products/Archetypes/tests/test_baseobject.py

diff --git a/Products/Archetypes/BaseObject.py b/Products/Archetypes/BaseObject.py
index a6317bda..6e69ec7d 100644
--- a/Products/Archetypes/BaseObject.py
+++ b/Products/Archetypes/BaseObject.py
@@ -524,6 +524,10 @@ def SearchableText(self):
                 if isinstance(datum, (list, tuple)):
                     # Unmangle vocabulary: we index key AND value
                     vocab_values = map(lambda value, vocab=vocab: vocab.getValue(value, ''), datum)
+                    vocab_values = [
+                        v.encode('utf-8') if isinstance(v, unicode) else v
+                        for v in vocab_values
+                    ]
                     datum = list(datum)
                     datum.extend(vocab_values)
                     datum = ' '.join(datum)
diff --git a/Products/Archetypes/tests/test_baseobject.py b/Products/Archetypes/tests/test_baseobject.py
index 682fcc9b..91425776 100644
--- a/Products/Archetypes/tests/test_baseobject.py
+++ b/Products/Archetypes/tests/test_baseobject.py
@@ -43,6 +43,7 @@ def overrideDiscussionFor(self, content, allowDiscussion):
     (
     ('1', _(u'Option 1 : printemps')),
     ('2', unicode('Option 2 : \xc3\xa9t\xc3\xa9', 'utf-8')),  # e-acute t e-acute
+    ('\xc3\xa9t\xc3\xa9', unicode('Option 2 : \xc3\xa9t\xc3\xa9', 'utf-8')),  # e-acute t e-acute
     ('3', u'Option 3 : automne'),
     ('4', _(u'option3', default=u'Option 3 : hiver')),
     ))
@@ -56,6 +57,15 @@ def overrideDiscussionFor(self, content, allowDiscussion):
             i18n_domain='plone',
             ),
         ),
+    atapi.LinesField(
+        'MULTIVALUED',
+        multiValued=1,
+        searchable=1,
+        vocabulary=MULTIPLEFIELD_LIST,
+        widget=atapi.MultiSelectionWidget(
+            i18n_domain='plone',
+            ),
+        ),
     atapi.TextField(
         'TEXTFIELD',
         primary=True,
@@ -63,6 +73,8 @@ def overrideDiscussionFor(self, content, allowDiscussion):
 ))
 
 
+
+
 class Dummy(atapi.BaseContent):
 
     portal_discussion = DummyDiscussionTool()
@@ -85,7 +97,7 @@ def test_searchableText(self):
         dummy = self._dummy
 
         # Set a multiple field
-        dummy.setMULTIPLEFIELD(['1', '2'])
+        dummy.setMULTIPLEFIELD(['1', '2', '\xc3\xa9t\xc3\xa9'])
         searchable = dummy.SearchableText()
 
         self.assertTrue(isinstance(searchable, basestring))
@@ -93,7 +105,7 @@ def test_searchableText(self):
         # cases, which during test runs would mean they would get
         # formatted as '[[plone][some value]]' instead of 'some value'.
         self.assertEquals(searchable,
-            '1 2 Option 1 : printemps Option 2 : \xc3\xa9t\xc3\xa9')
+            '1 2 \xc3\xa9t\xc3\xa9 Option 1 : printemps Option 2 : \xc3\xa9t\xc3\xa9 Option 2 : \xc3\xa9t\xc3\xa9')
 
         dummy.setMULTIPLEFIELD(['3', '4'])
         searchable = dummy.SearchableText()


Repository: Products.Archetypes


Branch: refs/heads/1.9.x
Date: 2017-05-23T16:15:23+02:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/Products.Archetypes/commit/e385f30aa8b7a14099e75bfbbb15088692f004e3

update changelog

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 663aff07..7cd7b17c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix bug in BaseObject SearchableText when vocabulary key is uft8 encoded string
 
 
 1.9.15 (2017-05-09)


Repository: Products.Archetypes


Branch: refs/heads/1.9.x
Date: 2017-05-23T16:38:06+02:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/Products.Archetypes/commit/ff93faa98901f7191aaff6b6646267e9dbdc76e1

Merge pull request #86 from plone/fix-utf8-in-vocabulary-key

fix issue when vocabulary key is utf8 encoded string

Files changed:
M CHANGES.rst
M Products/Archetypes/BaseObject.py
M Products/Archetypes/tests/test_baseobject.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 663aff07..7cd7b17c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix bug in BaseObject SearchableText when vocabulary key is uft8 encoded string
 
 
 1.9.15 (2017-05-09)
diff --git a/Products/Archetypes/BaseObject.py b/Products/Archetypes/BaseObject.py
index a6317bda..6e69ec7d 100644
--- a/Products/Archetypes/BaseObject.py
+++ b/Products/Archetypes/BaseObject.py
@@ -524,6 +524,10 @@ def SearchableText(self):
                 if isinstance(datum, (list, tuple)):
                     # Unmangle vocabulary: we index key AND value
                     vocab_values = map(lambda value, vocab=vocab: vocab.getValue(value, ''), datum)
+                    vocab_values = [
+                        v.encode('utf-8') if isinstance(v, unicode) else v
+                        for v in vocab_values
+                    ]
                     datum = list(datum)
                     datum.extend(vocab_values)
                     datum = ' '.join(datum)
diff --git a/Products/Archetypes/tests/test_baseobject.py b/Products/Archetypes/tests/test_baseobject.py
index 682fcc9b..91425776 100644
--- a/Products/Archetypes/tests/test_baseobject.py
+++ b/Products/Archetypes/tests/test_baseobject.py
@@ -43,6 +43,7 @@ def overrideDiscussionFor(self, content, allowDiscussion):
     (
     ('1', _(u'Option 1 : printemps')),
     ('2', unicode('Option 2 : \xc3\xa9t\xc3\xa9', 'utf-8')),  # e-acute t e-acute
+    ('\xc3\xa9t\xc3\xa9', unicode('Option 2 : \xc3\xa9t\xc3\xa9', 'utf-8')),  # e-acute t e-acute
     ('3', u'Option 3 : automne'),
     ('4', _(u'option3', default=u'Option 3 : hiver')),
     ))
@@ -56,6 +57,15 @@ def overrideDiscussionFor(self, content, allowDiscussion):
             i18n_domain='plone',
             ),
         ),
+    atapi.LinesField(
+        'MULTIVALUED',
+        multiValued=1,
+        searchable=1,
+        vocabulary=MULTIPLEFIELD_LIST,
+        widget=atapi.MultiSelectionWidget(
+            i18n_domain='plone',
+            ),
+        ),
     atapi.TextField(
         'TEXTFIELD',
         primary=True,
@@ -63,6 +73,8 @@ def overrideDiscussionFor(self, content, allowDiscussion):
 ))
 
 
+
+
 class Dummy(atapi.BaseContent):
 
     portal_discussion = DummyDiscussionTool()
@@ -85,7 +97,7 @@ def test_searchableText(self):
         dummy = self._dummy
 
         # Set a multiple field
-        dummy.setMULTIPLEFIELD(['1', '2'])
+        dummy.setMULTIPLEFIELD(['1', '2', '\xc3\xa9t\xc3\xa9'])
         searchable = dummy.SearchableText()
 
         self.assertTrue(isinstance(searchable, basestring))
@@ -93,7 +105,7 @@ def test_searchableText(self):
         # cases, which during test runs would mean they would get
         # formatted as '[[plone][some value]]' instead of 'some value'.
         self.assertEquals(searchable,
-            '1 2 Option 1 : printemps Option 2 : \xc3\xa9t\xc3\xa9')
+            '1 2 \xc3\xa9t\xc3\xa9 Option 1 : printemps Option 2 : \xc3\xa9t\xc3\xa9 Option 2 : \xc3\xa9t\xc3\xa9')
 
         dummy.setMULTIPLEFIELD(['3', '4'])
         searchable = dummy.SearchableText()


