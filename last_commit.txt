Repository: plone.protect


Branch: refs/heads/master
Date: 2016-11-25T07:15:00+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.protect/commit/36f2a7380beace2c377062531d63062ba48ed4f0

fixes #57 Html must contain body, otherwise plone.protect breaks

Files changed:
M CHANGES.rst
M plone/protect/auto.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 254daed..dd39d8a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -16,6 +16,9 @@ Bug fixes:
 
 - Code Style: utf8-headers, import sorting, new style namespace declaration, autopep8
   [jensens]
+- Fix #57: Html must contain "body", otherwise plone.protect breaks.
+  [jensens]
+
 
 3.0.22 (2016-11-17)
 -------------------
diff --git a/plone/protect/auto.py b/plone/protect/auto.py
index 3e7cbdf..445aaaf 100644
--- a/plone/protect/auto.py
+++ b/plone/protect/auto.py
@@ -357,15 +357,17 @@ def transform(self, result, encoding):
         if self.site is not None and not root.cssselect('#protect-script'):
             # Alternative: add this in the resource registry.
             site_url = self.site.absolute_url()
-            body = root.cssselect('body')[0]
-            protect_script = etree.Element("script")
-            protect_script.attrib.update({
-                'type': "application/javascript",
-                'src': "%s/++resource++protect.js" % site_url,
-                'data-site-url': site_url,
-                'data-token': token,
-                'id': 'protect-script'
-            })
-            body.append(protect_script)
+            elements = root.cssselect('body')
+            if len(elements):
+                body = elements[0]
+                protect_script = etree.Element("script")
+                protect_script.attrib.update({
+                    'type': "application/javascript",
+                    'src': "%s/++resource++protect.js" % site_url,
+                    'data-site-url': site_url,
+                    'data-token': token,
+                    'id': 'protect-script'
+                })
+                body.append(protect_script)
 
         return result


Repository: plone.protect


Branch: refs/heads/master
Date: 2016-11-25T17:36:27+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.protect/commit/9ef98811ecfdf23e7f3a76af7b1ab8f4451ad083

Merge pull request #59 from plone/jensens-fix-57

Fix #57: Html must contain "body", otherwise plone.protect breaks.

Files changed:
M CHANGES.rst
M plone/protect/auto.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 254daed..dd39d8a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -16,6 +16,9 @@ Bug fixes:
 
 - Code Style: utf8-headers, import sorting, new style namespace declaration, autopep8
   [jensens]
+- Fix #57: Html must contain "body", otherwise plone.protect breaks.
+  [jensens]
+
 
 3.0.22 (2016-11-17)
 -------------------
diff --git a/plone/protect/auto.py b/plone/protect/auto.py
index 3e7cbdf..445aaaf 100644
--- a/plone/protect/auto.py
+++ b/plone/protect/auto.py
@@ -357,15 +357,17 @@ def transform(self, result, encoding):
         if self.site is not None and not root.cssselect('#protect-script'):
             # Alternative: add this in the resource registry.
             site_url = self.site.absolute_url()
-            body = root.cssselect('body')[0]
-            protect_script = etree.Element("script")
-            protect_script.attrib.update({
-                'type': "application/javascript",
-                'src': "%s/++resource++protect.js" % site_url,
-                'data-site-url': site_url,
-                'data-token': token,
-                'id': 'protect-script'
-            })
-            body.append(protect_script)
+            elements = root.cssselect('body')
+            if len(elements):
+                body = elements[0]
+                protect_script = etree.Element("script")
+                protect_script.attrib.update({
+                    'type': "application/javascript",
+                    'src': "%s/++resource++protect.js" % site_url,
+                    'data-site-url': site_url,
+                    'data-token': token,
+                    'id': 'protect-script'
+                })
+                body.append(protect_script)
 
         return result


