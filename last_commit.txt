Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2017-03-29T13:02:51+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/e7266e8aa263c48d39b01e0a7c9bf4d419376bb4

Fixed inline validation for Archetypes content.

Every field was shown as having an error, without showing an error message.
Fixes https://github.com/plone/Products.CMFPlone/issues/1982

The wrong behavior was a side effect of the base tag changes in Plone 4.3.12.

Files changed:
M Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js b/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
index 029aa34..9e83806 100644
--- a/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
+++ b/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
@@ -29,6 +29,8 @@ jQuery(function ($) {
             $field = $input.closest('.field'),
             uid = $field.attr('data-uid'),
             fname = $field.attr('data-fieldname'),
+            url = '',
+            index = -1,
             value = $input.val();
 
         // value is null for empty multiSelection select, turn it into a [] instead
@@ -42,7 +44,14 @@ jQuery(function ($) {
         params = $.param({uid: uid, fname: fname, value: value}, traditional = true);
 
         if ($field && uid && fname) {
-            $.post($('base').attr('href') + '/at_validate_field', params, function (data) {
+            url = $('base').attr('href');
+            index = url.lastIndexOf('/');
+            if (index > -1 && url.lastIndexOf('edit') > index) {
+                // The url is for an edit page, so we strip the last part,
+                // otherwise we wrongly get context-url/edit/at_validate_field.
+                url = url.slice(0, index);
+            }
+            $.post(url + '/at_validate_field', params, function (data) {
                 render_error($field, data.errmsg);
             });
         }
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 0af2333..145a90e 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,7 +19,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed inline validation for Archetypes content.
+  Every field was shown as having an error, without showing an error message.
+  Fixes `issue 1982 <https://github.com/plone/Products.CMFPlone/issues/1982>`_.
+  [maurits]
 
 
 4.3.13 (2017-03-27)


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2017-03-29T14:25:41+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/8e10581c9e960fffd451f34de34f2c01c82e911c

Inline validation for AT: use url of form action as basis.

The base attribute gives 'context-url/' for a folder, and 'context-url/edit' for a page.
location.href gives 'context-url/edit' for both, but it may be 'edit?foo=bar'.
So the form action seems best.
That is also what the other inline validations in this file use (for formlib and z3c.form).
Issue https://github.com/plone/Products.CMFPlone/issues/1982

Files changed:
M Products/CMFPlone/skins/plone_ecmascript/inline_validation.js

diff --git a/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js b/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
index 9e83806..48f47c3 100644
--- a/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
+++ b/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
@@ -29,6 +29,7 @@ jQuery(function ($) {
             $field = $input.closest('.field'),
             uid = $field.attr('data-uid'),
             fname = $field.attr('data-fieldname'),
+            $form = $field.closest('form'),
             url = '',
             index = -1,
             value = $input.val();
@@ -44,14 +45,21 @@ jQuery(function ($) {
         params = $.param({uid: uid, fname: fname, value: value}, traditional = true);
 
         if ($field && uid && fname) {
-            url = $('base').attr('href');
+            url = $form.attr('action');
             index = url.lastIndexOf('/');
             if (index > -1 && url.lastIndexOf('edit') > index) {
                 // The url is for an edit page, so we strip the last part,
                 // otherwise we wrongly get context-url/edit/at_validate_field.
+                // 'edit' can be 'atct_edit' too.
                 url = url.slice(0, index);
             }
             $.post(url + '/at_validate_field', params, function (data) {
+                if (data.errmsg === undefined) {
+                  // If we ask at the wrong url, like edit/at_validate_field,
+                  // we get the html of the edit page back.
+                  // It is best not to do anything then.
+                  return;
+                };
                 render_error($field, data.errmsg);
             });
         }


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2017-03-29T15:10:50+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/625429f051b4b585cb0c2e8c97685060894e2e94

Merge pull request #1984 from plone/inline-validation-issue-1982-43x

Fixed inline validation for Archetypes content. [4.3]

Files changed:
M Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js b/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
index 029aa34..48f47c3 100644
--- a/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
+++ b/Products/CMFPlone/skins/plone_ecmascript/inline_validation.js
@@ -29,6 +29,9 @@ jQuery(function ($) {
             $field = $input.closest('.field'),
             uid = $field.attr('data-uid'),
             fname = $field.attr('data-fieldname'),
+            $form = $field.closest('form'),
+            url = '',
+            index = -1,
             value = $input.val();
 
         // value is null for empty multiSelection select, turn it into a [] instead
@@ -42,7 +45,21 @@ jQuery(function ($) {
         params = $.param({uid: uid, fname: fname, value: value}, traditional = true);
 
         if ($field && uid && fname) {
-            $.post($('base').attr('href') + '/at_validate_field', params, function (data) {
+            url = $form.attr('action');
+            index = url.lastIndexOf('/');
+            if (index > -1 && url.lastIndexOf('edit') > index) {
+                // The url is for an edit page, so we strip the last part,
+                // otherwise we wrongly get context-url/edit/at_validate_field.
+                // 'edit' can be 'atct_edit' too.
+                url = url.slice(0, index);
+            }
+            $.post(url + '/at_validate_field', params, function (data) {
+                if (data.errmsg === undefined) {
+                  // If we ask at the wrong url, like edit/at_validate_field,
+                  // we get the html of the edit page back.
+                  // It is best not to do anything then.
+                  return;
+                };
                 render_error($field, data.errmsg);
             });
         }
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 0af2333..145a90e 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,7 +19,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed inline validation for Archetypes content.
+  Every field was shown as having an error, without showing an error message.
+  Fixes `issue 1982 <https://github.com/plone/Products.CMFPlone/issues/1982>`_.
+  [maurits]
 
 
 4.3.13 (2017-03-27)


