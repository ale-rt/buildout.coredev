Repository: plone.dexterity


Branch: refs/heads/2.2.x
Date: 2016-09-01T09:18:17+02:00
Author: Jonas Baumann (jone) <jone@jone.ch>
Commit: https://github.com/plone/plone.dexterity/commit/d385d80ac11c4a172e160089c3153651a80340aa

Set copy flags when copying container.

When copying a DX container which has AT children, the UID of the AT
children was not updated.
The reason for the error is that the DX container copy did not have the
_v_is_cp flag while the AT children were processed and thus the flag was
not properly delegated.

By copying the _v_is_cp and _v_cp_refs flags to the copy we have the
same behavior as it used to be with AT, which does fix the error.

Files changed:
M CHANGES.rst
M plone/dexterity/content.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 4d61c82..97e35f5 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix error when copying DX containers with AT children which caused the
+  children to not have the UID updated properly.  [jone]
 
 
 2.2.7 (2016-05-05)
diff --git a/plone/dexterity/content.py b/plone/dexterity/content.py
index 167a3ed..1222064 100644
--- a/plone/dexterity/content.py
+++ b/plone/dexterity/content.py
@@ -221,6 +221,22 @@ def _verifyObjectPaste(self, obj, validate_src=True):
                         'You can not add the copied content here.'
                     )
 
+    def _getCopy(self, container):
+        # Copy the _v_is_cp and _v_cp_refs flags from the original
+        # object (self) to the new copy.
+        # This has impact on how children will be handled.
+        # When the flags are missing, an Archetypes child object will not have
+        # the UID updated in some situations.
+        # Copied from Products.Archetypes.Referenceable.Referenceable._getCopy
+        is_cp_flag = getattr(self, '_v_is_cp', None)
+        cp_refs_flag = getattr(self, '_v_cp_refs', None)
+        ob = super(PasteBehaviourMixin, self)._getCopy(container)
+        if is_cp_flag:
+            setattr(ob, '_v_is_cp', is_cp_flag)
+        if cp_refs_flag:
+            setattr(ob, '_v_cp_refs', cp_refs_flag)
+        return ob
+
 
 @implementer(
     IDexterityContent,


Repository: plone.dexterity


Branch: refs/heads/2.2.x
Date: 2016-09-12T17:37:31+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.dexterity/commit/f09a5977990240874c29720db66204f37da96b85

Merge pull request #60 from plone/jone-set-copy-flags

Set copy flags when copying container.

Files changed:
M CHANGES.rst
M plone/dexterity/content.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 4d61c82..97e35f5 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix error when copying DX containers with AT children which caused the
+  children to not have the UID updated properly.  [jone]
 
 
 2.2.7 (2016-05-05)
diff --git a/plone/dexterity/content.py b/plone/dexterity/content.py
index 167a3ed..1222064 100644
--- a/plone/dexterity/content.py
+++ b/plone/dexterity/content.py
@@ -221,6 +221,22 @@ def _verifyObjectPaste(self, obj, validate_src=True):
                         'You can not add the copied content here.'
                     )
 
+    def _getCopy(self, container):
+        # Copy the _v_is_cp and _v_cp_refs flags from the original
+        # object (self) to the new copy.
+        # This has impact on how children will be handled.
+        # When the flags are missing, an Archetypes child object will not have
+        # the UID updated in some situations.
+        # Copied from Products.Archetypes.Referenceable.Referenceable._getCopy
+        is_cp_flag = getattr(self, '_v_is_cp', None)
+        cp_refs_flag = getattr(self, '_v_cp_refs', None)
+        ob = super(PasteBehaviourMixin, self)._getCopy(container)
+        if is_cp_flag:
+            setattr(ob, '_v_is_cp', is_cp_flag)
+        if cp_refs_flag:
+            setattr(ob, '_v_cp_refs', cp_refs_flag)
+        return ob
+
 
 @implementer(
     IDexterityContent,


