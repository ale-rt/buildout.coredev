Repository: plone.api


Branch: refs/heads/master
Date: 2017-01-31T12:22:26+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.api/commit/cd249e66be2cd7b770514287729fc3e2457cee5c

Fix imports from Globals that was removed in Zope4

Files changed:
M docs/CHANGES.rst
M src/plone/api/env.py
M src/plone/api/portal.py
M src/plone/api/tests/test_env.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index c12bad2..be0fbad 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -17,6 +17,9 @@ Bug fixes:
 - Support user.get_roles for anonymous users. Refs #339
   [jaroel]
 
+- Fix imports from Globals that was removed in Zope4
+  [pbauer]
+
 
 1.5.1 (2016-12-06)
 ------------------
diff --git a/src/plone/api/env.py b/src/plone/api/env.py
index 0417472..96545e2 100644
--- a/src/plone/api/env.py
+++ b/src/plone/api/env.py
@@ -2,6 +2,7 @@
 from AccessControl.SecurityManagement import getSecurityManager
 from AccessControl.SecurityManagement import newSecurityManager
 from AccessControl.SecurityManagement import setSecurityManager
+from App.config import getConfiguration
 from contextlib import contextmanager
 from pkg_resources import get_distribution
 from plone.api import portal
@@ -12,7 +13,6 @@
 from plone.api.validation import required_parameters
 from zope.globalrequest import getRequest
 
-import Globals
 import traceback
 
 
@@ -181,7 +181,7 @@ def debug_mode():
 
     :Example: :ref:`env_debug_mode_example`
     """
-    return Globals.DevelopmentMode
+    return getConfiguration().debug_mode
 
 
 def test_mode():
diff --git a/src/plone/api/portal.py b/src/plone/api/portal.py
index 5a4981d..659850a 100644
--- a/src/plone/api/portal.py
+++ b/src/plone/api/portal.py
@@ -52,7 +52,11 @@
 ):
     PRINTINGMAILHOST_ENABLED = True
 else:
-    PRINTINGMAILHOST_ENABLED = False
+    # PrintingMailHost only patches in debug mode.
+    # plone.api.env.debug_mode cannot be used here, because .env imports this
+    # file
+    from App.config import getConfiguration
+    PRINTINGMAILHOST_ENABLED = getConfiguration().debug_mode
 
 MISSING = object()
 
diff --git a/src/plone/api/tests/test_env.py b/src/plone/api/tests/test_env.py
index e9ec1b7..8a8fc8e 100644
--- a/src/plone/api/tests/test_env.py
+++ b/src/plone/api/tests/test_env.py
@@ -389,12 +389,13 @@ def test_argument_requirement(self):
             api.env.adopt_roles()
 
     def test_debug_mode(self):
-        """Tests that returned value is the same as Globals.DevelopmentMode."""
+        """Tests that the retured value is the same as
+        getConfiguration.debug_mode."""
         from plone.api.env import debug_mode
-        import Globals
-        Globals.DevelopmentMode = True
+        from App.config import getConfiguration
+        getConfiguration().debug_mode = True
         self.assertEqual(debug_mode(), True)
-        Globals.DevelopmentMode = False
+        getConfiguration().debug_mode = False
         self.assertEqual(debug_mode(), False)
 
     def test_test_mode(self):


Repository: plone.api


Branch: refs/heads/master
Date: 2017-01-31T13:06:07+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.api/commit/16f30c48b56fc9ad850c1baff0a835c130197c74

fix deprecated import

Files changed:
M src/plone/api/tests/test_env.py

diff --git a/src/plone/api/tests/test_env.py b/src/plone/api/tests/test_env.py
index 8a8fc8e..7f97a29 100644
--- a/src/plone/api/tests/test_env.py
+++ b/src/plone/api/tests/test_env.py
@@ -8,7 +8,6 @@
 from plone.app.testing import TEST_USER_ID
 
 import AccessControl
-import Globals
 import unittest
 
 
@@ -51,7 +50,7 @@ def private_method(self):
         pass
 
 
-Globals.InitializeClass(HasProtectedMethods)
+AccessControl.class_init.InitializeClass(HasProtectedMethods)
 
 
 class TestPloneApiEnv(unittest.TestCase):


Repository: plone.api


Branch: refs/heads/master
Date: 2017-01-31T14:10:15+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.api/commit/78914c94742ff8fafe7f040e8e4b905a270fa9d9

Merge pull request #323 from plone/plonezope4

Fix imports from Globals that was removed in Zope4

Files changed:
M docs/CHANGES.rst
M src/plone/api/env.py
M src/plone/api/portal.py
M src/plone/api/tests/test_env.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index c12bad2..be0fbad 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -17,6 +17,9 @@ Bug fixes:
 - Support user.get_roles for anonymous users. Refs #339
   [jaroel]
 
+- Fix imports from Globals that was removed in Zope4
+  [pbauer]
+
 
 1.5.1 (2016-12-06)
 ------------------
diff --git a/src/plone/api/env.py b/src/plone/api/env.py
index 0417472..96545e2 100644
--- a/src/plone/api/env.py
+++ b/src/plone/api/env.py
@@ -2,6 +2,7 @@
 from AccessControl.SecurityManagement import getSecurityManager
 from AccessControl.SecurityManagement import newSecurityManager
 from AccessControl.SecurityManagement import setSecurityManager
+from App.config import getConfiguration
 from contextlib import contextmanager
 from pkg_resources import get_distribution
 from plone.api import portal
@@ -12,7 +13,6 @@
 from plone.api.validation import required_parameters
 from zope.globalrequest import getRequest
 
-import Globals
 import traceback
 
 
@@ -181,7 +181,7 @@ def debug_mode():
 
     :Example: :ref:`env_debug_mode_example`
     """
-    return Globals.DevelopmentMode
+    return getConfiguration().debug_mode
 
 
 def test_mode():
diff --git a/src/plone/api/portal.py b/src/plone/api/portal.py
index 5a4981d..659850a 100644
--- a/src/plone/api/portal.py
+++ b/src/plone/api/portal.py
@@ -52,7 +52,11 @@
 ):
     PRINTINGMAILHOST_ENABLED = True
 else:
-    PRINTINGMAILHOST_ENABLED = False
+    # PrintingMailHost only patches in debug mode.
+    # plone.api.env.debug_mode cannot be used here, because .env imports this
+    # file
+    from App.config import getConfiguration
+    PRINTINGMAILHOST_ENABLED = getConfiguration().debug_mode
 
 MISSING = object()
 
diff --git a/src/plone/api/tests/test_env.py b/src/plone/api/tests/test_env.py
index e9ec1b7..7f97a29 100644
--- a/src/plone/api/tests/test_env.py
+++ b/src/plone/api/tests/test_env.py
@@ -8,7 +8,6 @@
 from plone.app.testing import TEST_USER_ID
 
 import AccessControl
-import Globals
 import unittest
 
 
@@ -51,7 +50,7 @@ def private_method(self):
         pass
 
 
-Globals.InitializeClass(HasProtectedMethods)
+AccessControl.class_init.InitializeClass(HasProtectedMethods)
 
 
 class TestPloneApiEnv(unittest.TestCase):
@@ -389,12 +388,13 @@ def test_argument_requirement(self):
             api.env.adopt_roles()
 
     def test_debug_mode(self):
-        """Tests that returned value is the same as Globals.DevelopmentMode."""
+        """Tests that the retured value is the same as
+        getConfiguration.debug_mode."""
         from plone.api.env import debug_mode
-        import Globals
-        Globals.DevelopmentMode = True
+        from App.config import getConfiguration
+        getConfiguration().debug_mode = True
         self.assertEqual(debug_mode(), True)
-        Globals.DevelopmentMode = False
+        getConfiguration().debug_mode = False
         self.assertEqual(debug_mode(), False)
 
     def test_test_mode(self):


