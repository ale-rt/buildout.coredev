Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2016-02-07T00:10:57+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/2e368576d5a2727a68739b363bee25f5c0b80812

Use unsetLastVersionForProfile from Products.GenericSetup 1.8.1.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v43/final.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c774eca..eef4faa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ New:
 
 Fixes:
 
+- Use `unsetLastVersionForProfile` from GenericSetup 1.8.1 and
+  higher.  [maurits]
+
 - Fix ``cleanUpProductRegistry`` to not break when ``Control_Panel`` cannot be found.
   Fixes test failures with Zope 4.
   [thet]
diff --git a/plone/app/upgrade/v43/final.py b/plone/app/upgrade/v43/final.py
index 2c199c9..ff4d6c4 100644
--- a/plone/app/upgrade/v43/final.py
+++ b/plone/app/upgrade/v43/final.py
@@ -4,7 +4,8 @@
 from zope.component import getAllUtilitiesRegisteredFor
 from zope.component import queryUtility
 from plone.contentrules.engine.interfaces import IRuleStorage
-from plone.contentrules.engine.assignments import check_rules_with_dotted_name_moved
+from plone.contentrules.engine.assignments import \
+    check_rules_with_dotted_name_moved
 
 from plone.app.upgrade.utils import loadMigrationProfile
 from plone.app.upgrade.utils import unregisterSteps
@@ -61,24 +62,12 @@ def unmarkUnavailableProfiles(context):
     """
     setup = context
     available = [profile['id'] for profile in setup.listProfileInfo()]
-    # XXX We want to use unsetLastVersionForProfile,
-    # but that requires a merge and release of this
-    # GenericSetup pull request:
-    # https://github.com/zopefoundation/Products.GenericSetup/pull/18
-    # portal_setup.unsetLastVersionForProfile(profile_id)
-    # Instead we must copy and set the
-    # (non-persistent) profile upgrade versions.
-    prof_versions = setup._profile_upgrade_versions.copy()
-    to_remove = [profile_id for profile_id in prof_versions
-                 if profile_id not in available]
-    if not to_remove:
-        return
-    for profile_id in to_remove:
+    for profile_id in setup._profile_upgrade_versions.copy():
+        if profile_id in available:
+            continue
         logger.info('Setting installed version of profile %s as unknown.',
                     profile_id)
-        del prof_versions[profile_id]
-    # save the new dictionary
-    setup._profile_upgrade_versions = prof_versions
+        setup.unsetLastVersionForProfile(profile_id)
 
 
 def markProductsInstalledForUninstallableProfiles(context):
@@ -243,18 +232,7 @@ def cleanupUninstalledProducts(context):
             continue
         # Mark profile as uninstalled/unknown.
         profile_id = profile['id']
-        # XXX We want to use unsetLastVersionForProfile,
-        # but that requires a merge and release of this
-        # GenericSetup pull request:
-        # https://github.com/zopefoundation/Products.GenericSetup/pull/18
-        # portal_setup.unsetLastVersionForProfile(profile_id)
-        # Instead we must copy and set the
-        # (non-persistent) profile upgrade versions.
-        prof_versions = setup._profile_upgrade_versions.copy()
-        if profile_id not in prof_versions:
-            continue
-        del prof_versions[profile_id]
-        setup._profile_upgrade_versions = prof_versions
+        setup.unsetLastVersionForProfile(profile_id)
 
 
 def removeFakeKupu(context):
diff --git a/setup.py b/setup.py
index 3366cf1..d6bf463 100644
--- a/setup.py
+++ b/setup.py
@@ -64,7 +64,7 @@
         'Products.CMFQuickInstallerTool',
         'Products.CMFUid',
         'Products.DCWorkflow',
-        'Products.GenericSetup',
+        'Products.GenericSetup>=1.8.1',
         'Products.MimetypesRegistry',
         # 'Products.PloneLanguageTool',
         'Products.PlonePAS',


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2016-02-07T00:12:22+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/36567888628353b9326d7de486b30a35605166d5

Merge pull request #63 from plone/use-gs-181

Use unsetLastVersionForProfile from Products.GenericSetup 1.8.1.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v43/final.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c774eca..eef4faa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ New:
 
 Fixes:
 
+- Use `unsetLastVersionForProfile` from GenericSetup 1.8.1 and
+  higher.  [maurits]
+
 - Fix ``cleanUpProductRegistry`` to not break when ``Control_Panel`` cannot be found.
   Fixes test failures with Zope 4.
   [thet]
diff --git a/plone/app/upgrade/v43/final.py b/plone/app/upgrade/v43/final.py
index 2c199c9..ff4d6c4 100644
--- a/plone/app/upgrade/v43/final.py
+++ b/plone/app/upgrade/v43/final.py
@@ -4,7 +4,8 @@
 from zope.component import getAllUtilitiesRegisteredFor
 from zope.component import queryUtility
 from plone.contentrules.engine.interfaces import IRuleStorage
-from plone.contentrules.engine.assignments import check_rules_with_dotted_name_moved
+from plone.contentrules.engine.assignments import \
+    check_rules_with_dotted_name_moved
 
 from plone.app.upgrade.utils import loadMigrationProfile
 from plone.app.upgrade.utils import unregisterSteps
@@ -61,24 +62,12 @@ def unmarkUnavailableProfiles(context):
     """
     setup = context
     available = [profile['id'] for profile in setup.listProfileInfo()]
-    # XXX We want to use unsetLastVersionForProfile,
-    # but that requires a merge and release of this
-    # GenericSetup pull request:
-    # https://github.com/zopefoundation/Products.GenericSetup/pull/18
-    # portal_setup.unsetLastVersionForProfile(profile_id)
-    # Instead we must copy and set the
-    # (non-persistent) profile upgrade versions.
-    prof_versions = setup._profile_upgrade_versions.copy()
-    to_remove = [profile_id for profile_id in prof_versions
-                 if profile_id not in available]
-    if not to_remove:
-        return
-    for profile_id in to_remove:
+    for profile_id in setup._profile_upgrade_versions.copy():
+        if profile_id in available:
+            continue
         logger.info('Setting installed version of profile %s as unknown.',
                     profile_id)
-        del prof_versions[profile_id]
-    # save the new dictionary
-    setup._profile_upgrade_versions = prof_versions
+        setup.unsetLastVersionForProfile(profile_id)
 
 
 def markProductsInstalledForUninstallableProfiles(context):
@@ -243,18 +232,7 @@ def cleanupUninstalledProducts(context):
             continue
         # Mark profile as uninstalled/unknown.
         profile_id = profile['id']
-        # XXX We want to use unsetLastVersionForProfile,
-        # but that requires a merge and release of this
-        # GenericSetup pull request:
-        # https://github.com/zopefoundation/Products.GenericSetup/pull/18
-        # portal_setup.unsetLastVersionForProfile(profile_id)
-        # Instead we must copy and set the
-        # (non-persistent) profile upgrade versions.
-        prof_versions = setup._profile_upgrade_versions.copy()
-        if profile_id not in prof_versions:
-            continue
-        del prof_versions[profile_id]
-        setup._profile_upgrade_versions = prof_versions
+        setup.unsetLastVersionForProfile(profile_id)
 
 
 def removeFakeKupu(context):
diff --git a/setup.py b/setup.py
index 3366cf1..d6bf463 100644
--- a/setup.py
+++ b/setup.py
@@ -64,7 +64,7 @@
         'Products.CMFQuickInstallerTool',
         'Products.CMFUid',
         'Products.DCWorkflow',
-        'Products.GenericSetup',
+        'Products.GenericSetup>=1.8.1',
         'Products.MimetypesRegistry',
         # 'Products.PloneLanguageTool',
         'Products.PlonePAS',


