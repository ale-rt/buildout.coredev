Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2016-11-18T22:41:43-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/Products.CMFEditions/commit/c8b7ccafcd067ef1e6c11458859a42786a78cc1c

avoid an error with BTrees 4.x

Files changed:
M CHANGES.rst
M Products/CMFEditions/ZVCStorageTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a284740..4b4fee8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,11 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- In ShadowStorage's `isRegistered` method, avoid checking
+  for a history_id of None in the storage's BTree.
+  This fixes compatibility with BTrees 4.x,
+  which disallows comparing keys to None.
+  [davisagli]
 
 
 2.2.22 (2016-11-17)
diff --git a/Products/CMFEditions/ZVCStorageTool.py b/Products/CMFEditions/ZVCStorageTool.py
index 42a66ff..d5ff820 100644
--- a/Products/CMFEditions/ZVCStorageTool.py
+++ b/Products/CMFEditions/ZVCStorageTool.py
@@ -755,14 +755,16 @@ class ShadowStorage(Persistent):
     Only cares about containerish operations.
     """
     def __init__(self):
-        # Using a OOBtree to allow history ids of any type. The type
-        # of the history ids higly depends on the unique id tool which
-        # we isn't under our control.
+        # Using an OOBtree to allow history ids of any type. The type
+        # of the history ids highly depends on the unique id tool which
+        # isn't under our control.
         self._storage = OOBTree()
 
     def isRegistered(self, history_id):
         """Returns True if a History With the Given History id Exists
         """
+        if history_id is None:
+            return False
         return history_id in self._storage
 
     def getHistory(self, history_id, autoAdd=False):


Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2016-11-18T23:04:11-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/Products.CMFEditions/commit/90fd6db67102951521048caf21dd5c0544e6b514

also avoid None comparison in getHistory

Files changed:
M CHANGES.rst
M Products/CMFEditions/ZVCStorageTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 4b4fee8..90d7ad6 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,8 +14,8 @@ New features:
 
 Bug fixes:
 
-- In ShadowStorage's `isRegistered` method, avoid checking
-  for a history_id of None in the storage's BTree.
+- In ShadowStorage's `isRegistered` and `getHistory` methods,
+  avoid checking for a history_id of None in the storage's BTree.
   This fixes compatibility with BTrees 4.x,
   which disallows comparing keys to None.
   [davisagli]
diff --git a/Products/CMFEditions/ZVCStorageTool.py b/Products/CMFEditions/ZVCStorageTool.py
index d5ff820..f843866 100644
--- a/Products/CMFEditions/ZVCStorageTool.py
+++ b/Products/CMFEditions/ZVCStorageTool.py
@@ -773,6 +773,8 @@ def getHistory(self, history_id, autoAdd=False):
         Returns None if ``autoAdd`` is False and the history
         does not exist. Else prepares and returns an empty history.
         """
+        if history_id is None:
+            return None
         # Create a new history if there isn't one yet
         if autoAdd and not self.isRegistered(history_id):
             self._storage[history_id] = ShadowHistory()


Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2016-11-21T18:29:28+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFEditions/commit/e7b0e280cef8bfdd06bff2ba4c6629267525e42c

Merge pull request #43 from plone/davisagli-fix-zodb4

avoid an error with BTrees 4.x

Files changed:
M CHANGES.rst
M Products/CMFEditions/ZVCStorageTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a284740..90d7ad6 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,11 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- In ShadowStorage's `isRegistered` and `getHistory` methods,
+  avoid checking for a history_id of None in the storage's BTree.
+  This fixes compatibility with BTrees 4.x,
+  which disallows comparing keys to None.
+  [davisagli]
 
 
 2.2.22 (2016-11-17)
diff --git a/Products/CMFEditions/ZVCStorageTool.py b/Products/CMFEditions/ZVCStorageTool.py
index 42a66ff..f843866 100644
--- a/Products/CMFEditions/ZVCStorageTool.py
+++ b/Products/CMFEditions/ZVCStorageTool.py
@@ -755,14 +755,16 @@ class ShadowStorage(Persistent):
     Only cares about containerish operations.
     """
     def __init__(self):
-        # Using a OOBtree to allow history ids of any type. The type
-        # of the history ids higly depends on the unique id tool which
-        # we isn't under our control.
+        # Using an OOBtree to allow history ids of any type. The type
+        # of the history ids highly depends on the unique id tool which
+        # isn't under our control.
         self._storage = OOBTree()
 
     def isRegistered(self, history_id):
         """Returns True if a History With the Given History id Exists
         """
+        if history_id is None:
+            return False
         return history_id in self._storage
 
     def getHistory(self, history_id, autoAdd=False):
@@ -771,6 +773,8 @@ def getHistory(self, history_id, autoAdd=False):
         Returns None if ``autoAdd`` is False and the history
         does not exist. Else prepares and returns an empty history.
         """
+        if history_id is None:
+            return None
         # Create a new history if there isn't one yet
         if autoAdd and not self.isRegistered(history_id):
             self._storage[history_id] = ShadowHistory()


