Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2016-05-23T08:43:43+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/dae0367244c4081a827a9485c5b983f3baa27c80

Removed dexterity-types from portal_actions.

This is set correctly in controlpanel.xml.

Added upgrade step to remove this action.  We also remove the sub and
main action categories it is in, if they are empty.

Issue https://github.com/plone/plone.app.dexterity/issues/218

Files changed:
A plone/app/dexterity/upgrades/to2005.py
M CHANGES.rst
M plone/app/dexterity/profiles/default/metadata.xml
M plone/app/dexterity/upgrades/configure.zcml
D plone/app/dexterity/profiles/default/actions.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index 5464176..1dd721f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Removed ``dexterity-types`` from portal_actions.  This is set
+  correctly in ``controlpanel.xml``.
+  Issue https://github.com/plone/plone.app.dexterity/issues/218
+  [maurits]
 
 
 2.3.0 (2016-05-21)
diff --git a/plone/app/dexterity/profiles/default/actions.xml b/plone/app/dexterity/profiles/default/actions.xml
deleted file mode 100644
index 2561585..0000000
--- a/plone/app/dexterity/profiles/default/actions.xml
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_actions" meta_type="Plone Actions Tool" xmlns:i18n="http://xml.zope.org/namespaces/i18n">
-  <object name="controlpanel" meta_type="CMF Action Category">
-    <object name="controlpanel_addons" meta_type="CMF Action Category">
-      <object name="dexterity-types" meta_type="CMF Action" i18n:domain="plone">
-        <property name="title" i18n:translate="">Dexterity Content Types</property>
-        <property name="description" i18n:translate=""></property>
-        <property name="url_expr">string:${portal_url}/@@dexterity-types</property>
-        <property name="icon_expr"></property>
-        <property name="available_expr"></property>
-        <property name="permissions">
-          <element value="Manage portal" />
-        </property>
-        <property name="visible">True</property>
-      </object>
-    </object>
-  </object>
-</object>
diff --git a/plone/app/dexterity/profiles/default/metadata.xml b/plone/app/dexterity/profiles/default/metadata.xml
index b75a5da..a505a77 100644
--- a/plone/app/dexterity/profiles/default/metadata.xml
+++ b/plone/app/dexterity/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>2004</version>
+  <version>2005</version>
   <dependencies>
     <dependency>profile-plone.app.z3cform:default</dependency>
   </dependencies>
diff --git a/plone/app/dexterity/upgrades/configure.zcml b/plone/app/dexterity/upgrades/configure.zcml
index cb80d4b..88a069d 100644
--- a/plone/app/dexterity/upgrades/configure.zcml
+++ b/plone/app/dexterity/upgrades/configure.zcml
@@ -60,4 +60,12 @@
       handler=".to2004.remove_cr_and_lf_description"
       />
 
+  <genericsetup:upgradeStep
+      source="2004"
+      destination="2005"
+      title="Remove dexterity-types from portal_actions"
+      profile="plone.app.dexterity:default"
+      handler=".to2005.cleanup_portal_actions"
+      />
+
 </configure>
diff --git a/plone/app/dexterity/upgrades/to2005.py b/plone/app/dexterity/upgrades/to2005.py
new file mode 100644
index 0000000..6a9e8a7
--- /dev/null
+++ b/plone/app/dexterity/upgrades/to2005.py
@@ -0,0 +1,42 @@
+# -*- coding: utf-8 -*-
+from Products.CMFCore.utils import getToolByName
+
+import logging
+
+
+logger = logging.getLogger('plone.app.dexterity')
+
+
+def cleanup_portal_actions(context):
+    # Our actions.xml registers dexterity-types as controlpanel item.  But this
+    # is what controlpanel.xml is for.  So remove it.
+    # https://github.com/plone/plone.app.dexterity/issues/218
+    actions_tool = getToolByName(context, 'portal_actions')
+    main_category = 'controlpanel'
+    sub_category = 'controlpanel_addons'
+    action_name = 'dexterity-types'
+
+    # Lookup for action in category.
+    main = getattr(actions_tool, main_category, None)
+    if main is None:
+        logger.info('%s category was already removed.', main_category)
+        return
+    sub = getattr(main, sub_category, None)
+    if sub is None:
+        logger.info('%s category was already removed.', sub_category)
+        return
+    if action_name not in sub.objectIds():
+        logger.info('%s action was already removed.', action_name)
+        return
+    sub._delObject(action_name)
+    logger.info('Removed %s from portal_actions.', action_name)
+
+    # Cleanup empty categories.
+    if len(sub.objectIds()) > 0:
+        return
+    main._delObject(sub_category)
+    logger.info('Removed empty %s action sub category.', sub_category)
+    if len(main.objectIds()) > 0:
+        return
+    actions_tool._delObject(main_category)
+    logger.info('Removed empty %s action main category.', main_category)


Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2016-05-23T10:04:44+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.dexterity/commit/06468d7740033fee1e3c66e88a5fb519de6a2827

Merge pull request #219 from plone/remove-actions-xml

Removed dexterity-types from portal_actions.

Files changed:
A plone/app/dexterity/upgrades/to2005.py
M CHANGES.rst
M plone/app/dexterity/profiles/default/metadata.xml
M plone/app/dexterity/upgrades/configure.zcml
D plone/app/dexterity/profiles/default/actions.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index 5464176..1dd721f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Removed ``dexterity-types`` from portal_actions.  This is set
+  correctly in ``controlpanel.xml``.
+  Issue https://github.com/plone/plone.app.dexterity/issues/218
+  [maurits]
 
 
 2.3.0 (2016-05-21)
diff --git a/plone/app/dexterity/profiles/default/actions.xml b/plone/app/dexterity/profiles/default/actions.xml
deleted file mode 100644
index 2561585..0000000
--- a/plone/app/dexterity/profiles/default/actions.xml
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_actions" meta_type="Plone Actions Tool" xmlns:i18n="http://xml.zope.org/namespaces/i18n">
-  <object name="controlpanel" meta_type="CMF Action Category">
-    <object name="controlpanel_addons" meta_type="CMF Action Category">
-      <object name="dexterity-types" meta_type="CMF Action" i18n:domain="plone">
-        <property name="title" i18n:translate="">Dexterity Content Types</property>
-        <property name="description" i18n:translate=""></property>
-        <property name="url_expr">string:${portal_url}/@@dexterity-types</property>
-        <property name="icon_expr"></property>
-        <property name="available_expr"></property>
-        <property name="permissions">
-          <element value="Manage portal" />
-        </property>
-        <property name="visible">True</property>
-      </object>
-    </object>
-  </object>
-</object>
diff --git a/plone/app/dexterity/profiles/default/metadata.xml b/plone/app/dexterity/profiles/default/metadata.xml
index b75a5da..a505a77 100644
--- a/plone/app/dexterity/profiles/default/metadata.xml
+++ b/plone/app/dexterity/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>2004</version>
+  <version>2005</version>
   <dependencies>
     <dependency>profile-plone.app.z3cform:default</dependency>
   </dependencies>
diff --git a/plone/app/dexterity/upgrades/configure.zcml b/plone/app/dexterity/upgrades/configure.zcml
index cb80d4b..88a069d 100644
--- a/plone/app/dexterity/upgrades/configure.zcml
+++ b/plone/app/dexterity/upgrades/configure.zcml
@@ -60,4 +60,12 @@
       handler=".to2004.remove_cr_and_lf_description"
       />
 
+  <genericsetup:upgradeStep
+      source="2004"
+      destination="2005"
+      title="Remove dexterity-types from portal_actions"
+      profile="plone.app.dexterity:default"
+      handler=".to2005.cleanup_portal_actions"
+      />
+
 </configure>
diff --git a/plone/app/dexterity/upgrades/to2005.py b/plone/app/dexterity/upgrades/to2005.py
new file mode 100644
index 0000000..6a9e8a7
--- /dev/null
+++ b/plone/app/dexterity/upgrades/to2005.py
@@ -0,0 +1,42 @@
+# -*- coding: utf-8 -*-
+from Products.CMFCore.utils import getToolByName
+
+import logging
+
+
+logger = logging.getLogger('plone.app.dexterity')
+
+
+def cleanup_portal_actions(context):
+    # Our actions.xml registers dexterity-types as controlpanel item.  But this
+    # is what controlpanel.xml is for.  So remove it.
+    # https://github.com/plone/plone.app.dexterity/issues/218
+    actions_tool = getToolByName(context, 'portal_actions')
+    main_category = 'controlpanel'
+    sub_category = 'controlpanel_addons'
+    action_name = 'dexterity-types'
+
+    # Lookup for action in category.
+    main = getattr(actions_tool, main_category, None)
+    if main is None:
+        logger.info('%s category was already removed.', main_category)
+        return
+    sub = getattr(main, sub_category, None)
+    if sub is None:
+        logger.info('%s category was already removed.', sub_category)
+        return
+    if action_name not in sub.objectIds():
+        logger.info('%s action was already removed.', action_name)
+        return
+    sub._delObject(action_name)
+    logger.info('Removed %s from portal_actions.', action_name)
+
+    # Cleanup empty categories.
+    if len(sub.objectIds()) > 0:
+        return
+    main._delObject(sub_category)
+    logger.info('Removed empty %s action sub category.', sub_category)
+    if len(main.objectIds()) > 0:
+        return
+    actions_tool._delObject(main_category)
+    logger.info('Removed empty %s action main category.', main_category)


