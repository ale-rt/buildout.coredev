Repository: plone.outputfilters


Branch: refs/heads/master
Date: 2016-07-30T21:31:51+02:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.outputfilters/commit/bdba311828cb43e2b23e7b4eba0996ceb99df65c

Handle unicode errors in img attributes (#19)

* Handle unicode errors in img attributes

* use unidecode if unicode decode issues

* unidecode is a dependency now

Files changed:
M CHANGES.rst
M plone/outputfilters/filters/resolveuid_and_caption.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1fe6734..ceccceb 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Handle unicode errors in img attributes
+  [vangheem]
 
 
 2.1.5 (2016-06-07)
diff --git a/plone/outputfilters/filters/resolveuid_and_caption.py b/plone/outputfilters/filters/resolveuid_and_caption.py
index dd764af..ff5bed7 100644
--- a/plone/outputfilters/filters/resolveuid_and_caption.py
+++ b/plone/outputfilters/filters/resolveuid_and_caption.py
@@ -1,3 +1,4 @@
+from unidecode import unidecode
 from ZODB.POSException import ConflictError
 from Acquisition import aq_base, aq_acquire, aq_parent
 from zExceptions import NotFound
@@ -245,10 +246,10 @@ def traverse_path(base, path):
                     if hasattr(aq_base(parent), 'tag'):
                         fullimage = parent
                         break
-        
+
         if image is None:
             return None, None, src, description
-        
+
         try:
             url = image.absolute_url()
         except AttributeError:
@@ -358,16 +359,20 @@ def unknown_starttag(self, tag, attrs):
                 if fullimage is not None:
                     # Check to see if the alt / title tags need setting
                     title = aq_acquire(fullimage, 'Title')()
-                    if 'alt' not in attributes:
+                    if not attributes.get('alt'):
                         attributes['alt'] = description or title
                     if 'title' not in attributes:
                         attributes['title'] = title
                     attrs = attributes.iteritems()
 
         # Add the tag to the result
-        strattrs = "".join([' %s="%s"'
-                               % (key, escape(value, quote=True))
-                                    for key, value in attrs])
+        strattrs = ""
+        for key, value in attrs:
+            try:
+                strattrs += ' %s="%s"' % (key, escape(value, quote=True))
+            except UnicodeDecodeError:
+                strattrs += ' %s="%s"' % (unidecode(key), escape(unidecode(value), quote=True))
+
         if tag in self.singleton_tags:
             self.append_data("<%s%s />" % (tag, strattrs))
         else:
diff --git a/setup.py b/setup.py
index e237aa2..91482c9 100644
--- a/setup.py
+++ b/setup.py
@@ -35,6 +35,7 @@
           'Products.GenericSetup',
           'Products.MimetypesRegistry',
           'Products.PortalTransforms',
+          'unidecode'
       ],
       extras_require={
           'test': [


