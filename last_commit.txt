Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-11-02T12:38:16+01:00
Author: Luca Fabbri (keul) <luca@keul.it>
Commit: https://github.com/plone/Products.TinyMCE/commit/1e1068a06571db8b0806510f0ee7d0b1ed488945

Prevent broken breadcrumbs when parent is private

This close #150

Files changed:
M Products/TinyMCE/adapters/JSONFolderListing.py
M Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js

diff --git a/Products/TinyMCE/adapters/JSONFolderListing.py b/Products/TinyMCE/adapters/JSONFolderListing.py
index a6f54e7..8db9699 100644
--- a/Products/TinyMCE/adapters/JSONFolderListing.py
+++ b/Products/TinyMCE/adapters/JSONFolderListing.py
@@ -4,6 +4,7 @@
 except ImportError:
     import json
 
+from zope.security import checkPermission
 from zope.interface import implements
 from zope.component import getUtility
 from zope.i18n import translate
@@ -11,9 +12,11 @@
 from plone.i18n.normalizer.interfaces import IIDNormalizer
 from plone.app.layout.navigation.root import getNavigationRootObject
 from plone.app.layout.navigation.interfaces import INavigationRoot
+from AccessControl import getSecurityManager
 from Products.CMFCore.interfaces._content import IFolderish
 from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot
 from Products.CMFCore.utils import getToolByName
+from Products.CMFCore import permissions
 from Acquisition import aq_inner
 from Acquisition import aq_parent
 
@@ -39,10 +42,11 @@ def getBreadcrumbs(self, path=None):
         portal_state = self.context.restrictedTraverse('@@plone_portal_state')
         root = getNavigationRootObject(self.context, portal_state.portal())
         root_url = root.absolute_url()
+        sm = getSecurityManager()
 
         if path is not None:
             path = path.replace(root_url, '', 1).strip('/')
-            root = aq_inner(root.restrictedTraverse(path))
+            root = aq_inner(root.unrestrictedTraverse(path))
 
         relative = aq_inner(self.context).getPhysicalPath()[len(root.getPhysicalPath()):]
         if path is None:
@@ -59,15 +63,21 @@ def getBreadcrumbs(self, path=None):
 
         for i in range(len(relative)):
             now = relative[:i + 1]
-            obj = aq_inner(root.restrictedTraverse(now))
+            obj = aq_inner(root.unrestrictedTraverse(now))
 
             if IFolderish.providedBy(obj):
                 if not now[-1] == 'talkback':
-                    result.append({
-                        'title': obj.title_or_id(),
-                        'url': root_url + '/' + '/'.join(now),
-                        'icon': '<img src="%s" width="16" height="16" />' % self.folder_icon,
-                    })
+                    if not sm.checkPermission(permissions.View, obj):
+                        result.append({
+                            'title': '...',
+                            'unaccessible': True
+                        })
+                    else:
+                        result.append({
+                            'title': obj.title_or_id(),
+                            'url': root_url + '/' + '/'.join(now),
+                            'icon': '<img src="%s" width="16" height="16" />' % self.folder_icon,
+                        })
         return result
 
     def getListing(self, filter_portal_types, rooted, document_base_url, upload_type=None, image_types=None):
diff --git a/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js b/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js
index 8147a55..13f3403 100644
--- a/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js
+++ b/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js
@@ -687,9 +687,9 @@ BrowserDialog.prototype.checkSearch = function (e) {
     }
 
     // Activate search when we have enough input and either livesearch is
-    // enabled or the user explicitly pressed Enter (which === 13), or the user 
-    // clicks (which === 1) on the search icon 
-    if (len >= 3 && (this.tinyMCEPopup.editor.settings.livesearch === true 
+    // enabled or the user explicitly pressed Enter (which === 13), or the user
+    // clicks (which === 1) on the search icon
+    if (len >= 3 && (this.tinyMCEPopup.editor.settings.livesearch === true
                     || e.which === 13 || e.which === 1)) {
         this.is_search_activated = true;
         this.getFolderListing(this.tinyMCEPopup.editor.settings.navigation_root_url, this.method_search);
@@ -988,7 +988,11 @@ BrowserDialog.prototype.getFolderListing = function (context_url, method) {
                 if (i === len - 1) {
                     html.push('<span>' + item.title + '</span>');
                 } else {
-                    html.push('<a href="' + item.url + '">' + item.title + '</a>');
+                    if (item.unaccessible) {
+                      html.push('<em>' + item.title + '</em>');
+                    } else {
+                      html.push('<a href="' + item.url + '">' + item.title + '</a>');
+                    }
                 }
             });
             jq('#internalpath', document).html(html.join(''));


Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-11-02T12:46:24+01:00
Author: Luca Fabbri (keul) <luca@keul.it>
Commit: https://github.com/plone/Products.TinyMCE/commit/7eb0615b2d033a95d43fdf47c3ae312ed2b2bd6f

Fix to current folder shortcut

Preventing current folder shortcut to link to a temporary object; fallback to the container

Files changed:
M Products/TinyMCE/shortcut.py

diff --git a/Products/TinyMCE/shortcut.py b/Products/TinyMCE/shortcut.py
index e53cfe2..94fb312 100644
--- a/Products/TinyMCE/shortcut.py
+++ b/Products/TinyMCE/shortcut.py
@@ -1,6 +1,8 @@
 """Shortcuts implementation for Plone"""
 
+from Acquisition import aq_parent, aq_inner
 from Products.TinyMCE.interfaces.utility import _
+from Products.CMFCore.utils import getToolByName
 from zope.i18n import translate
 
 
@@ -9,10 +11,16 @@ class CurrentFolderShortcut(object):
     title = _(u'Current Folder')
 
     def render(self, context):
+        portal_factory = getToolByName(context, 'portal_factory')
+        if portal_factory.isTemporary(context):
+            # Fix current folder URL on creation
+            url = aq_parent(aq_parent(aq_parent(aq_inner(context)))).absolute_url()
+        else:
+            url = context.absolute_url()
         return ["""
         <img src="img/folder_current.png" />
         <a id="currentfolder" href="%s">%s</a>
-        """ % (context.absolute_url(), translate(self.title, context=context.REQUEST))]
+        """ % (url, translate(self.title, context=context.REQUEST))]
 
 
 class HomeShortcut(object):


Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-11-02T12:54:55+01:00
Author: Luca Fabbri (keul) <luca@keul.it>
Commit: https://github.com/plone/Products.TinyMCE/commit/f12f1753f315a0e5fe30d58279f6085b2730b5cf

Updated history

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index a50f26d..60fafb1 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,8 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
-
+- Breadcrumbs on browser plugin will not longer be emtpy when one of the parents
+  is not accessible. See `#150`_.
+  [keul]
 
 1.3.23 (2016-08-11)
 -------------------
@@ -1828,3 +1829,4 @@ __ https://dev.plone.org/ticket/13566
   [turgmr2]
 
 .. _`#99`: https://github.com/collective/sc.social.like/pull/99
+.. _`#150`: https://github.com/plone/Products.TinyMCE/issues/150


Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-11-03T08:48:09+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.TinyMCE/commit/2e70b7517dc6db507dbb6329f7e726a2abe25215

Merge pull request #151 from plone/fix-150

Preventing broken breadcrumbs on unaccessible parents

Files changed:
M CHANGES.rst
M Products/TinyMCE/adapters/JSONFolderListing.py
M Products/TinyMCE/shortcut.py
M Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js

diff --git a/CHANGES.rst b/CHANGES.rst
index a50f26d..60fafb1 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,8 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
-
+- Breadcrumbs on browser plugin will not longer be emtpy when one of the parents
+  is not accessible. See `#150`_.
+  [keul]
 
 1.3.23 (2016-08-11)
 -------------------
@@ -1828,3 +1829,4 @@ __ https://dev.plone.org/ticket/13566
   [turgmr2]
 
 .. _`#99`: https://github.com/collective/sc.social.like/pull/99
+.. _`#150`: https://github.com/plone/Products.TinyMCE/issues/150
diff --git a/Products/TinyMCE/adapters/JSONFolderListing.py b/Products/TinyMCE/adapters/JSONFolderListing.py
index a6f54e7..8db9699 100644
--- a/Products/TinyMCE/adapters/JSONFolderListing.py
+++ b/Products/TinyMCE/adapters/JSONFolderListing.py
@@ -4,6 +4,7 @@
 except ImportError:
     import json
 
+from zope.security import checkPermission
 from zope.interface import implements
 from zope.component import getUtility
 from zope.i18n import translate
@@ -11,9 +12,11 @@
 from plone.i18n.normalizer.interfaces import IIDNormalizer
 from plone.app.layout.navigation.root import getNavigationRootObject
 from plone.app.layout.navigation.interfaces import INavigationRoot
+from AccessControl import getSecurityManager
 from Products.CMFCore.interfaces._content import IFolderish
 from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot
 from Products.CMFCore.utils import getToolByName
+from Products.CMFCore import permissions
 from Acquisition import aq_inner
 from Acquisition import aq_parent
 
@@ -39,10 +42,11 @@ def getBreadcrumbs(self, path=None):
         portal_state = self.context.restrictedTraverse('@@plone_portal_state')
         root = getNavigationRootObject(self.context, portal_state.portal())
         root_url = root.absolute_url()
+        sm = getSecurityManager()
 
         if path is not None:
             path = path.replace(root_url, '', 1).strip('/')
-            root = aq_inner(root.restrictedTraverse(path))
+            root = aq_inner(root.unrestrictedTraverse(path))
 
         relative = aq_inner(self.context).getPhysicalPath()[len(root.getPhysicalPath()):]
         if path is None:
@@ -59,15 +63,21 @@ def getBreadcrumbs(self, path=None):
 
         for i in range(len(relative)):
             now = relative[:i + 1]
-            obj = aq_inner(root.restrictedTraverse(now))
+            obj = aq_inner(root.unrestrictedTraverse(now))
 
             if IFolderish.providedBy(obj):
                 if not now[-1] == 'talkback':
-                    result.append({
-                        'title': obj.title_or_id(),
-                        'url': root_url + '/' + '/'.join(now),
-                        'icon': '<img src="%s" width="16" height="16" />' % self.folder_icon,
-                    })
+                    if not sm.checkPermission(permissions.View, obj):
+                        result.append({
+                            'title': '...',
+                            'unaccessible': True
+                        })
+                    else:
+                        result.append({
+                            'title': obj.title_or_id(),
+                            'url': root_url + '/' + '/'.join(now),
+                            'icon': '<img src="%s" width="16" height="16" />' % self.folder_icon,
+                        })
         return result
 
     def getListing(self, filter_portal_types, rooted, document_base_url, upload_type=None, image_types=None):
diff --git a/Products/TinyMCE/shortcut.py b/Products/TinyMCE/shortcut.py
index e53cfe2..94fb312 100644
--- a/Products/TinyMCE/shortcut.py
+++ b/Products/TinyMCE/shortcut.py
@@ -1,6 +1,8 @@
 """Shortcuts implementation for Plone"""
 
+from Acquisition import aq_parent, aq_inner
 from Products.TinyMCE.interfaces.utility import _
+from Products.CMFCore.utils import getToolByName
 from zope.i18n import translate
 
 
@@ -9,10 +11,16 @@ class CurrentFolderShortcut(object):
     title = _(u'Current Folder')
 
     def render(self, context):
+        portal_factory = getToolByName(context, 'portal_factory')
+        if portal_factory.isTemporary(context):
+            # Fix current folder URL on creation
+            url = aq_parent(aq_parent(aq_parent(aq_inner(context)))).absolute_url()
+        else:
+            url = context.absolute_url()
         return ["""
         <img src="img/folder_current.png" />
         <a id="currentfolder" href="%s">%s</a>
-        """ % (context.absolute_url(), translate(self.title, context=context.REQUEST))]
+        """ % (url, translate(self.title, context=context.REQUEST))]
 
 
 class HomeShortcut(object):
diff --git a/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js b/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js
index 8147a55..13f3403 100644
--- a/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js
+++ b/Products/TinyMCE/skins/tinymce/plugins/plonebrowser/js/plonebrowser.js
@@ -687,9 +687,9 @@ BrowserDialog.prototype.checkSearch = function (e) {
     }
 
     // Activate search when we have enough input and either livesearch is
-    // enabled or the user explicitly pressed Enter (which === 13), or the user 
-    // clicks (which === 1) on the search icon 
-    if (len >= 3 && (this.tinyMCEPopup.editor.settings.livesearch === true 
+    // enabled or the user explicitly pressed Enter (which === 13), or the user
+    // clicks (which === 1) on the search icon
+    if (len >= 3 && (this.tinyMCEPopup.editor.settings.livesearch === true
                     || e.which === 13 || e.which === 1)) {
         this.is_search_activated = true;
         this.getFolderListing(this.tinyMCEPopup.editor.settings.navigation_root_url, this.method_search);
@@ -988,7 +988,11 @@ BrowserDialog.prototype.getFolderListing = function (context_url, method) {
                 if (i === len - 1) {
                     html.push('<span>' + item.title + '</span>');
                 } else {
-                    html.push('<a href="' + item.url + '">' + item.title + '</a>');
+                    if (item.unaccessible) {
+                      html.push('<em>' + item.title + '</em>');
+                    } else {
+                      html.push('<a href="' + item.url + '">' + item.title + '</a>');
+                    }
                 }
             });
             jq('#internalpath', document).html(html.join(''));


