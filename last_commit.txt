Repository: plone.app.content


Branch: refs/heads/2.1.x
Date: 2016-09-19T11:26:14+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.content/commit/8abb1383fddacb2a051c6fe8b698939969d80c17

Apply security hotfix 20160830 for folder factories redirection.

Files changed:
A plone/app/content/tests/test_folder.py
M CHANGES.txt
M plone/app/content/browser/folderfactories.py

diff --git a/CHANGES.txt b/CHANGES.txt
index 5133bf4..16e9235 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,7 +4,9 @@ Changelog
 2.1.6 (unreleased)
 ------------------
 
-- Nothing changed yet.
+Bug fixes:
+
+- Apply security hotfix 20160830 for folder factories redirection.  [maurits]
 
 
 2.1.5 (2014-09-07)
diff --git a/plone/app/content/browser/folderfactories.py b/plone/app/content/browser/folderfactories.py
index efd2ccb..148a81a 100644
--- a/plone/app/content/browser/folderfactories.py
+++ b/plone/app/content/browser/folderfactories.py
@@ -26,7 +26,10 @@ class FolderFactoriesView(BrowserView):
 
     def __call__(self):
         if 'form.button.Add' in self.request.form:
+            urltool = getToolByName(self.context, 'portal_url')
             url = self.request.form.get('url')
+            if not urltool.isURLInPortal(url):
+                url = self.context.absolute_url()
             self.request.response.redirect(url)
             return ''
         else:
diff --git a/plone/app/content/tests/test_folder.py b/plone/app/content/tests/test_folder.py
new file mode 100644
index 0000000..2090de5
--- /dev/null
+++ b/plone/app/content/tests/test_folder.py
@@ -0,0 +1,42 @@
+# -*- coding: utf-8 -*-
+from plone.app.content.testing import PLONE_APP_CONTENT_FUNCTIONAL_TESTING
+from plone.app.testing import login
+from plone.app.testing import setRoles
+from plone.app.testing import TEST_USER_ID
+from plone.app.testing import TEST_USER_NAME
+
+import unittest
+
+
+class FolderFactoriesTest(unittest.TestCase):
+    layer = PLONE_APP_CONTENT_FUNCTIONAL_TESTING
+
+    def setUp(self):
+        self.portal = self.layer['portal']
+        self.request = self.layer['request']
+        login(self.portal, TEST_USER_NAME)
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+
+    def test_folder_factories_regression(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': self.portal.absolute_url()
+        })
+        view()
+        self.assertEqual(self.request.response.headers.get('location'),
+                         self.portal.absolute_url())
+
+    def test_folder_factories(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': 'http://www.foobar.com'
+        })
+        view()
+        self.assertNotEqual(self.request.response.headers.get('location'),
+                            'http://www.foobar.com')


Repository: plone.app.content


Branch: refs/heads/2.1.x
Date: 2016-09-19T12:42:34+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.content/commit/077f019558048edeaf6ac71d5b2f646d4ff1fdbf

Merge pull request #109 from plone/apply-hotfix-20160830-21

Apply security hotfix 20160830 for folder factories redirection. [2.1]

Files changed:
A plone/app/content/tests/test_folder.py
M CHANGES.txt
M plone/app/content/browser/folderfactories.py

diff --git a/CHANGES.txt b/CHANGES.txt
index 5133bf4..16e9235 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,7 +4,9 @@ Changelog
 2.1.6 (unreleased)
 ------------------
 
-- Nothing changed yet.
+Bug fixes:
+
+- Apply security hotfix 20160830 for folder factories redirection.  [maurits]
 
 
 2.1.5 (2014-09-07)
diff --git a/plone/app/content/browser/folderfactories.py b/plone/app/content/browser/folderfactories.py
index efd2ccb..148a81a 100644
--- a/plone/app/content/browser/folderfactories.py
+++ b/plone/app/content/browser/folderfactories.py
@@ -26,7 +26,10 @@ class FolderFactoriesView(BrowserView):
 
     def __call__(self):
         if 'form.button.Add' in self.request.form:
+            urltool = getToolByName(self.context, 'portal_url')
             url = self.request.form.get('url')
+            if not urltool.isURLInPortal(url):
+                url = self.context.absolute_url()
             self.request.response.redirect(url)
             return ''
         else:
diff --git a/plone/app/content/tests/test_folder.py b/plone/app/content/tests/test_folder.py
new file mode 100644
index 0000000..2090de5
--- /dev/null
+++ b/plone/app/content/tests/test_folder.py
@@ -0,0 +1,42 @@
+# -*- coding: utf-8 -*-
+from plone.app.content.testing import PLONE_APP_CONTENT_FUNCTIONAL_TESTING
+from plone.app.testing import login
+from plone.app.testing import setRoles
+from plone.app.testing import TEST_USER_ID
+from plone.app.testing import TEST_USER_NAME
+
+import unittest
+
+
+class FolderFactoriesTest(unittest.TestCase):
+    layer = PLONE_APP_CONTENT_FUNCTIONAL_TESTING
+
+    def setUp(self):
+        self.portal = self.layer['portal']
+        self.request = self.layer['request']
+        login(self.portal, TEST_USER_NAME)
+        setRoles(self.portal, TEST_USER_ID, ['Manager'])
+
+    def test_folder_factories_regression(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': self.portal.absolute_url()
+        })
+        view()
+        self.assertEqual(self.request.response.headers.get('location'),
+                         self.portal.absolute_url())
+
+    def test_folder_factories(self):
+        from plone.app.content.browser.folderfactories import (
+            FolderFactoriesView as FFV)
+        view = FFV(self.portal, self.request)
+        self.request.form.update({
+            'form.button.Add': 'yes',
+            'url': 'http://www.foobar.com'
+        })
+        view()
+        self.assertNotEqual(self.request.response.headers.get('location'),
+                            'http://www.foobar.com')


