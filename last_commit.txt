Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2016-08-31T18:42:52+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/26eda61e68d0247c17ba12e8730307d16a614755

Fixed tests in combination with CMFFormController that includes hotfix.

This is from PloneHotfix20160830.

Test in combination with https://github.com/plone/Products.CMFFormController/pull/9

Files changed:
M Products/CMFPlone/tests/testSSOLogin.py
M Products/CMFPlone/tests/testSecurity.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/tests/testSSOLogin.py b/Products/CMFPlone/tests/testSSOLogin.py
index 222182f..ed961d1 100644
--- a/Products/CMFPlone/tests/testSSOLogin.py
+++ b/Products/CMFPlone/tests/testSSOLogin.py
@@ -30,6 +30,15 @@ def afterSetUp(self):
                 self.another_portal.absolute_url(),
                 ]
             )
+        # The normal portal needs to allow logins from the login portal,
+        # otherwise the redirect_to action on login or logout will refuse to
+        # redirect externally.  This may need to be done on another_portal too,
+        # but for the current tests this is not needed.
+        self.portal.portal_properties.site_properties._updateProperty(
+            'allow_external_login_sites', [
+                self.login_portal.absolute_url(),
+                ]
+            )
 
         # Configure our sites to use the login portal for logins and logouts
         login_portal_url = self.login_portal.absolute_url()
diff --git a/Products/CMFPlone/tests/testSecurity.py b/Products/CMFPlone/tests/testSecurity.py
index aedfb0c..51f4d62 100644
--- a/Products/CMFPlone/tests/testSecurity.py
+++ b/Products/CMFPlone/tests/testSecurity.py
@@ -195,8 +195,17 @@ def test_atat_does_not_return_anything(self):
     def test_go_back(self):
         res = self.publish('/plone/front-page/go_back?last_referer=http://${request}',
             basic=ptc.portal_owner + ':' + ptc.default_password)
+        # This used to show the request as location, so something like:
+        # http://<h3>form</h3><table>... and then all kinds of data from the
+        # request.  This was fixed in PloneHotfix20121106.  For this request
+        # you then got redirected to url http://${request} which your browser
+        # obviously does not know how to handle.
+        #
+        # In PloneHotfix20160830 this fix was kept, but additionally Plone
+        # refuses to redirect to external sites by default.
         self.assertEqual(302, res.status)
-        self.assertEqual('http://${request}', res.headers['location'][:17])
+        self.assertEqual(res.headers['location'],
+                         self.portal.absolute_url() + '/front-page')
 
     def test_getFolderContents(self):
         res = self.publish('/plone/getFolderContents')
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 511cd4a..751c267 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,6 +19,8 @@ New features:
 
 Bug fixes:
 
+- Fixed tests in combination with newer CMFFormController which has the hotfix.  [maurits]
+
 - Apply security hotfix 20160830 for ``@@plone-root-login``.  [maurits]
 
 - Apply security hotfix 20160830 for ``isURLInPortal``.  [maurits]


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2016-08-31T22:32:11+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/5f0d09141a093e4d4b7efc4e76e671e29c36c2c6

Merge pull request #1740 from plone/fix-combination-with-cmfformcontroller-hotfix-43

Fixed tests in combination with CMFFormController that includes hotfix.

Files changed:
M Products/CMFPlone/tests/testSSOLogin.py
M Products/CMFPlone/tests/testSecurity.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/tests/testSSOLogin.py b/Products/CMFPlone/tests/testSSOLogin.py
index 222182f..ed961d1 100644
--- a/Products/CMFPlone/tests/testSSOLogin.py
+++ b/Products/CMFPlone/tests/testSSOLogin.py
@@ -30,6 +30,15 @@ def afterSetUp(self):
                 self.another_portal.absolute_url(),
                 ]
             )
+        # The normal portal needs to allow logins from the login portal,
+        # otherwise the redirect_to action on login or logout will refuse to
+        # redirect externally.  This may need to be done on another_portal too,
+        # but for the current tests this is not needed.
+        self.portal.portal_properties.site_properties._updateProperty(
+            'allow_external_login_sites', [
+                self.login_portal.absolute_url(),
+                ]
+            )
 
         # Configure our sites to use the login portal for logins and logouts
         login_portal_url = self.login_portal.absolute_url()
diff --git a/Products/CMFPlone/tests/testSecurity.py b/Products/CMFPlone/tests/testSecurity.py
index aedfb0c..51f4d62 100644
--- a/Products/CMFPlone/tests/testSecurity.py
+++ b/Products/CMFPlone/tests/testSecurity.py
@@ -195,8 +195,17 @@ def test_atat_does_not_return_anything(self):
     def test_go_back(self):
         res = self.publish('/plone/front-page/go_back?last_referer=http://${request}',
             basic=ptc.portal_owner + ':' + ptc.default_password)
+        # This used to show the request as location, so something like:
+        # http://<h3>form</h3><table>... and then all kinds of data from the
+        # request.  This was fixed in PloneHotfix20121106.  For this request
+        # you then got redirected to url http://${request} which your browser
+        # obviously does not know how to handle.
+        #
+        # In PloneHotfix20160830 this fix was kept, but additionally Plone
+        # refuses to redirect to external sites by default.
         self.assertEqual(302, res.status)
-        self.assertEqual('http://${request}', res.headers['location'][:17])
+        self.assertEqual(res.headers['location'],
+                         self.portal.absolute_url() + '/front-page')
 
     def test_getFolderContents(self):
         res = self.publish('/plone/getFolderContents')
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 511cd4a..751c267 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,6 +19,8 @@ New features:
 
 Bug fixes:
 
+- Fixed tests in combination with newer CMFFormController which has the hotfix.  [maurits]
+
 - Apply security hotfix 20160830 for ``@@plone-root-login``.  [maurits]
 
 - Apply security hotfix 20160830 for ``isURLInPortal``.  [maurits]


