Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2016-07-19T19:24:14+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/264dbb8d72adfa2971a403e83c3511a70f66db0b

remove dup path injection code in collections results method

Files changed:
M CHANGES.rst
M plone/app/contenttypes/behaviors/collection.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 826bb31..e7acf1a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,12 @@ New features:
 
 Bug fixes:
 
+- Remove ``path`` index injection in "plone.collection" behaviors ``results`` method.
+  It is a duplicate.
+  Exactly the same is done already in the ``plone.app.querybuilder.querybuilder._makequery``,
+  which is called by above ``results`` method.
+  [jensens]
+
 - Select all migratable types in migration-form by default. Fixes #193.
   [pbauer]
 
diff --git a/plone/app/contenttypes/behaviors/collection.py b/plone/app/contenttypes/behaviors/collection.py
index d63b39d..cce4e9d 100644
--- a/plone/app/contenttypes/behaviors/collection.py
+++ b/plone/app/contenttypes/behaviors/collection.py
@@ -115,35 +115,8 @@ def results(self, batch=True, b_start=0, b_size=None,
             sort_on = self.sort_on
         if not limit:
             limit = self.limit
-
-        query = self.query
-
-        # Handle INavigationRoot awareness as follows:
-        # - If query is None or empty then do nothing.
-        # - If query already contains a criteria for the index "path", then do
-        #   nothing, since plone.app.querybuilder takes care of this
-        #   already. (See the code of _path and _relativePath inside
-        #   p.a.querystring.queryparser to understand).
-        # - If query does not contain any criteria using the index "path", then
-        #   add a criteria to match everything under the path "/" (which will
-        #   be converted to the actual navigation root path by
-        #   p.a.querystring).
-        if query:
-            has_path_criteria = any(
-                (criteria['i'] == 'path')
-                for criteria in query
-            )
-            if not has_path_criteria:
-                # Make a copy of the query to avoid modifying it
-                query = list(self.query)
-                query.append({
-                    'i': 'path',
-                    'o': 'plone.app.querystring.operation.string.path',
-                    'v': '/',
-                })
-
         return querybuilder(
-            query=query, batch=batch, b_start=b_start, b_size=b_size,
+            query=self.query, batch=batch, b_start=b_start, b_size=b_size,
             sort_on=sort_on, sort_order=sort_order,
             limit=limit, brains=brains, custom_query=custom_query
         )


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2016-07-20T13:27:00+02:00
Author: agitator (agitator) <hpeter@agitator.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/c0769094d88e4f9c543f63aef627864d0fbcff3b

Merge pull request #360 from plone/remove-superfluous-path-injection

remove dup path injection code in collections results method

Files changed:
M CHANGES.rst
M plone/app/contenttypes/behaviors/collection.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 826bb31..e7acf1a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,12 @@ New features:
 
 Bug fixes:
 
+- Remove ``path`` index injection in "plone.collection" behaviors ``results`` method.
+  It is a duplicate.
+  Exactly the same is done already in the ``plone.app.querybuilder.querybuilder._makequery``,
+  which is called by above ``results`` method.
+  [jensens]
+
 - Select all migratable types in migration-form by default. Fixes #193.
   [pbauer]
 
diff --git a/plone/app/contenttypes/behaviors/collection.py b/plone/app/contenttypes/behaviors/collection.py
index d63b39d..cce4e9d 100644
--- a/plone/app/contenttypes/behaviors/collection.py
+++ b/plone/app/contenttypes/behaviors/collection.py
@@ -115,35 +115,8 @@ def results(self, batch=True, b_start=0, b_size=None,
             sort_on = self.sort_on
         if not limit:
             limit = self.limit
-
-        query = self.query
-
-        # Handle INavigationRoot awareness as follows:
-        # - If query is None or empty then do nothing.
-        # - If query already contains a criteria for the index "path", then do
-        #   nothing, since plone.app.querybuilder takes care of this
-        #   already. (See the code of _path and _relativePath inside
-        #   p.a.querystring.queryparser to understand).
-        # - If query does not contain any criteria using the index "path", then
-        #   add a criteria to match everything under the path "/" (which will
-        #   be converted to the actual navigation root path by
-        #   p.a.querystring).
-        if query:
-            has_path_criteria = any(
-                (criteria['i'] == 'path')
-                for criteria in query
-            )
-            if not has_path_criteria:
-                # Make a copy of the query to avoid modifying it
-                query = list(self.query)
-                query.append({
-                    'i': 'path',
-                    'o': 'plone.app.querystring.operation.string.path',
-                    'v': '/',
-                })
-
         return querybuilder(
-            query=query, batch=batch, b_start=b_start, b_size=b_size,
+            query=self.query, batch=batch, b_start=b_start, b_size=b_size,
             sort_on=sort_on, sort_order=sort_order,
             limit=limit, brains=brains, custom_query=custom_query
         )


