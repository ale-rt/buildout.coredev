Repository: plone.formwidget.querystring


Branch: refs/heads/master
Date: 2017-08-09T16:25:47+02:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/plone.formwidget.querystring/commit/955c4cad57b50679eadbe027ec2133d4c9667189

fix calculation of the baseUrl in queryresults

Files changed:
M CHANGES.rst
M plone/formwidget/querystring/querywidget.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 7cdc3ce..db7a6c9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,8 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
-
+- Recent Plone 4.3 versions have a change in the base href calculation. Fix
+  calculation of the baseUrl in updating the queryresults in the widgets if
+  /edit is part of the base href.
+  [fredvd, maurits]
 
 1.1.9 (2017-05-06)
 ------------------
diff --git a/plone/formwidget/querystring/querywidget.js b/plone/formwidget/querystring/querywidget.js
index 9656807..b2e50e6 100644
--- a/plone/formwidget/querystring/querywidget.js
+++ b/plone/formwidget/querystring/querywidget.js
@@ -201,13 +201,20 @@
 
     $.querywidget.updateSearch = function () {
         var context_url = (function() {
-            var baseUrl, pieces;
+            var baseUrl, pieces, index;
             baseUrl = $('base').attr('href');
             if (!baseUrl) {
                 pieces = window.location.href.split('/');
                 pieces.pop();
                 baseUrl = pieces.join('/');
             }
+            index = baseUrl.lastIndexOf('/');
+            if (index > -1 && baseUrl.lastIndexOf('edit') > index) {
+                // The url is for an edit page, so we strip the last part,
+                // otherwise we wrongly get /edit/@@querybuilder_html_results
+                // 'edit' can be 'atct_edit' too.
+                baseUrl = baseUrl.slice(0, index);
+            }
             return baseUrl;
         })();
         var query = context_url + "/@@querybuilder_html_results?";


Repository: plone.formwidget.querystring


Branch: refs/heads/master
Date: 2017-08-09T17:09:53+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.formwidget.querystring/commit/f2eaf13cb98a6d43cff1e682a9a835e4b4e64f3c

Merge pull request #18 from plone/fix_base_href

fix calculation of the baseUrl in queryresults

Files changed:
M CHANGES.rst
M plone/formwidget/querystring/querywidget.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 7cdc3ce..db7a6c9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,8 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
-
+- Recent Plone 4.3 versions have a change in the base href calculation. Fix
+  calculation of the baseUrl in updating the queryresults in the widgets if
+  /edit is part of the base href.
+  [fredvd, maurits]
 
 1.1.9 (2017-05-06)
 ------------------
diff --git a/plone/formwidget/querystring/querywidget.js b/plone/formwidget/querystring/querywidget.js
index 9656807..b2e50e6 100644
--- a/plone/formwidget/querystring/querywidget.js
+++ b/plone/formwidget/querystring/querywidget.js
@@ -201,13 +201,20 @@
 
     $.querywidget.updateSearch = function () {
         var context_url = (function() {
-            var baseUrl, pieces;
+            var baseUrl, pieces, index;
             baseUrl = $('base').attr('href');
             if (!baseUrl) {
                 pieces = window.location.href.split('/');
                 pieces.pop();
                 baseUrl = pieces.join('/');
             }
+            index = baseUrl.lastIndexOf('/');
+            if (index > -1 && baseUrl.lastIndexOf('edit') > index) {
+                // The url is for an edit page, so we strip the last part,
+                // otherwise we wrongly get /edit/@@querybuilder_html_results
+                // 'edit' can be 'atct_edit' too.
+                baseUrl = baseUrl.slice(0, index);
+            }
             return baseUrl;
         })();
         var query = context_url + "/@@querybuilder_html_results?";


