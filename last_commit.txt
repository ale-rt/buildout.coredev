Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-07-08T00:56:48+03:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/60d6c49ac1d7a4dae12f6b8f5eda7c594fc1060a

finish upgrade step for safe_html setting to registry

Files changed:
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/tests.py

diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 90e9453..59a516a 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -3,6 +3,7 @@
 from plone.app.upgrade.utils import loadMigrationProfile
 from plone.registry.interfaces import IRegistry
 from Products.CMFCore.utils import getToolByName
+from Products.CMFPlone.interfaces import IFilterSchema
 from Products.CMFPlone.interfaces import ISearchSchema
 from zope.component import getUtility
 import logging
@@ -178,3 +179,22 @@ def reindex_mime_type(context):
         catalog.data[brain.getRID()] = tuple(record)
         cnt += 1
     logger.info('Reindexed `mime_type` for %s items' % str(cnt))
+
+
+def move_safe_html_settings_to_registry(context):
+    """ Move safe_html settings from portal_transforms to Plone registry.
+    """
+    registry = getUtility(IRegistry)
+    settings = registry.forInterface(
+        IFilterSchema, prefix="plone")
+    pt = getToolByName(context, 'portal_transforms')
+    disable_filtering = pt.safe_html._config.get('disable_transform')
+    raw_valid_tags = pt.safe_html._config.get('valid_tags') or {}
+    raw_nasty_tags = pt.safe_html._config.get('nasty_tags') or {}
+    valid_tags = [
+        tag.decode() for tag, enabled in raw_valid_tags.items() if enabled]
+    nasty_tags = [
+        tag.decode() for tag, enabled in raw_nasty_tags.items() if enabled]
+    settings.disable_filtering = disable_filtering
+    settings.valid_tags = sorted(valid_tags)
+    settings.nasty_tags = sorted(nasty_tags)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index 24dad71..1dd9db1 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -167,10 +167,10 @@ Add image scaling options to image handling control panel.
             import_profile="plone.app.upgrade.v51:to51beta5"
             />
 
-        <!--<gs:upgradeStep
+        <gs:upgradeStep
             title="Move safe_html settings from portal_transforms to Plone registry"
             handler=".betas.move_safe_html_settings_to_registry"
-            />-->
+            />
 
     </gs:upgradeSteps>
 </configure>
diff --git a/plone/app/upgrade/v51/tests.py b/plone/app/upgrade/v51/tests.py
index 9f66344..0fad483 100644
--- a/plone/app/upgrade/v51/tests.py
+++ b/plone/app/upgrade/v51/tests.py
@@ -1,6 +1,9 @@
 # -*- coding: utf-8 -*-
 from plone.app.testing import PLONE_INTEGRATION_TESTING
+from plone.app.upgrade.v50.testing import REAL_UPGRADE_FUNCTIONAL
 from zope.component import getUtility
+from plone.registry.interfaces import IRegistry
+from Products.CMFPlone.interfaces import IFilterSchema
 
 import unittest
 
@@ -42,6 +45,24 @@ def test_migrate_less_variable_typo(self):
         )
 
 
+class UpgradePortalTransforms51beta4to51beta5Test(unittest.TestCase):
+    layer = PLONE_INTEGRATION_TESTING
+
+    def setUp(self):
+        self.portal = self.layer['portal']
+        self.request = self.layer['request']
+        self.pt = self.portal.portal_transforms
+        registry = getUtility(IRegistry)
+        self.settings = registry.forInterface(
+            IFilterSchema, prefix="plone")
+
+    def test_migrate_safe_html_settings(self):
+        from plone.app.upgrade.v51.betas import \
+            move_safe_html_settings_to_registry
+
+        move_safe_html_settings_to_registry(self.portal)
+
+
 def test_suite():
     # Skip these tests on Plone 4
     if not PLONE_5:
@@ -51,4 +72,7 @@ def test_suite():
     suite.addTest(
         unittest.makeSuite(UpgradeRegistry503to51alpha1Test)
     )
+    suite.addTest(
+        unittest.makeSuite(UpgradePortalTransforms51beta4to51beta5Test)
+    )
     return suite


