Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-07-12T12:45:11+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.TinyMCE/commit/852a28ea06b23f94d68990ebac0612654ba41a9a

Added tablerowstyles setting in control panel.

These styles are available when you are setting the table row
properties.  Until now, all styles were shown here, most of which are
not useful for table rows, and they were shown in an ugly and wrong
way.

Note that this went wrong probably since Products.TinyMCE 1.3.
In row.js this does:

    addClassesToList('class', 'table_row_styles');

But `table_row_styles` was not available in the json configuration,
so addClassesToList fell back to the `advanced_styles`,
which resulted in a dictionary being shown as option.

Files changed:
M CHANGES.rst
M Products/TinyMCE/exportimport.py
M Products/TinyMCE/interfaces/utility.py
M Products/TinyMCE/profiles.zcml
M Products/TinyMCE/profiles/default/metadata.xml
M Products/TinyMCE/profiles/default/tinymce.xml
M Products/TinyMCE/upgrades.py
M Products/TinyMCE/utility.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9f6c56f..12d1f8c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,7 +11,10 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Added ``tablerowstyles`` setting in control panel.  These styles are
+  available when you are setting the table row properties.  Until now,
+  all styles were shown here, most of which are not useful for table
+  rows, and they were shown in an ugly and wrong way.  [maurits]
 
 Bug fixes:
 
diff --git a/Products/TinyMCE/exportimport.py b/Products/TinyMCE/exportimport.py
index e91338a..e5c74b2 100644
--- a/Products/TinyMCE/exportimport.py
+++ b/Products/TinyMCE/exportimport.py
@@ -38,6 +38,11 @@ class TinyMCESettingsXMLAdapter(XMLAdapterBase):
                 u'Invisible grid|invisible\n'
                 u'Fancy listing|listing\n'
             },
+            'tablerowstyles': {
+                'type': 'List', 'default':
+                u'Even|even\n'
+                u'Odd|odd\n'
+            },
         },
         'toolbar': {
             'toolbar_width': {'type': 'Text', 'default': u'440'},
diff --git a/Products/TinyMCE/interfaces/utility.py b/Products/TinyMCE/interfaces/utility.py
index 8012332..4d527c7 100644
--- a/Products/TinyMCE/interfaces/utility.py
+++ b/Products/TinyMCE/interfaces/utility.py
@@ -92,6 +92,11 @@ class ITinyMCELayout(Interface):
         description=_(u"Enter a list of styles to appear in the table style pulldown. Format is title|class, one per line."),
         required=False)
 
+    tablerowstyles = schema.Text(
+        title=_(u"Table row styles"),
+        description=_(u"Enter a list of styles to appear in the table row style pulldown. Format is title|class, one per line."),
+        required=False)
+
 
 class ITinyMCEToolbar(Interface):
     """This interface defines the toolbar properties."""
diff --git a/Products/TinyMCE/profiles.zcml b/Products/TinyMCE/profiles.zcml
index 35ef096..f7b0521 100644
--- a/Products/TinyMCE/profiles.zcml
+++ b/Products/TinyMCE/profiles.zcml
@@ -109,6 +109,15 @@
         handler=".upgrades.upgrade_to_profile_8"
         />
 
+   <genericsetup:upgradeStep
+        title="Upgrade TinyMCE 1.3.22 to 1.3.23"
+        description="Add default tablerowstyles"
+        source="8"
+        destination="9"
+        profile="Products.TinyMCE:TinyMCE"
+        handler=".upgrades.upgrade_to_profile_9"
+        />
+
     <genericsetup:upgradeStep
         title="Install plone.outputfilters"
         description="This replaces the old TinyMCE-specific resolveuid and captioning transform."
diff --git a/Products/TinyMCE/profiles/default/metadata.xml b/Products/TinyMCE/profiles/default/metadata.xml
index 2960b02..910663b 100644
--- a/Products/TinyMCE/profiles/default/metadata.xml
+++ b/Products/TinyMCE/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>8</version>
+  <version>9</version>
   <dependencies>
     <dependency>profile-plone.outputfilters:default</dependency>
     <dependency>profile-plone.app.imaging:default</dependency>
diff --git a/Products/TinyMCE/profiles/default/tinymce.xml b/Products/TinyMCE/profiles/default/tinymce.xml
index 9a10440..35561b3 100644
--- a/Products/TinyMCE/profiles/default/tinymce.xml
+++ b/Products/TinyMCE/profiles/default/tinymce.xml
@@ -66,6 +66,10 @@
    <element value="Invisible grid|invisible"/>
    <element value="Fancy listing|listing"/>
   </tablestyles>
+  <tablerowstyles>
+   <element value="Even|even"/>
+   <element value="Odd|odd"/>
+  </tablerowstyles>
   <resizing value="True"/>
  </layout>
  <toolbar>
diff --git a/Products/TinyMCE/upgrades.py b/Products/TinyMCE/upgrades.py
index 4095e47..f740dc0 100644
--- a/Products/TinyMCE/upgrades.py
+++ b/Products/TinyMCE/upgrades.py
@@ -103,3 +103,13 @@ def upgrade_to_profile_8(context):
     tdata.append('vertical-align')
     transform._p_changed = True
     transform.reload()
+
+
+def upgrade_to_profile_9(context):
+    tinymce = getToolByName(context, 'portal_tinymce')
+    if tinymce.tablerowstyles:
+        return
+    tinymce.tablerowstyles = (
+        u'Even|even\n'
+        u'Odd|odd\n'
+    )
diff --git a/Products/TinyMCE/utility.py b/Products/TinyMCE/utility.py
index 4586ffa..0030498 100644
--- a/Products/TinyMCE/utility.py
+++ b/Products/TinyMCE/utility.py
@@ -94,6 +94,7 @@ class TinyMCE(SimpleItem):
     styles = FieldProperty(ITinyMCELayout['styles'])
     formats = FieldProperty(ITinyMCELayout['formats'])
     tablestyles = FieldProperty(ITinyMCELayout['tablestyles'])
+    tablerowstyles = FieldProperty(ITinyMCELayout['tablerowstyles'])
 
     toolbar_width = FieldProperty(ITinyMCEToolbar['toolbar_width'])
 
@@ -760,6 +761,7 @@ def getConfiguration(self, context=None, field=None, request=None):
         # Add styles to results
         results['styles'] = []
         table_styles = []
+        table_row_styles = []
         if not redefine_parastyles:
             if isinstance(self.tablestyles, StringTypes):
                 for tablestyle in self.tablestyles.split('\n'):
@@ -777,6 +779,22 @@ def getConfiguration(self, context=None, field=None, request=None):
                         tablestyletitle = translate(_(tablestylefields[0]), context=request)
                     results['styles'].append(tablestyletitle + '|table|' + tablestyleid)
                     table_styles.append(tablestyletitle + '=' + tablestyleid)
+            if isinstance(self.tablerowstyles, StringTypes):
+                for tablerowstyle in self.tablerowstyles.split('\n'):
+                    if not tablerowstyle:
+                        # empty line
+                        continue
+                    tablerowstylefields = tablerowstyle.split('|')
+                    tablerowstyletitle = tablerowstylefields[0]
+                    tablerowstyleid = tablerowstylefields[1]
+                    if tablerowstyleid == 'plain':
+                        # Do not duplicate the default style hardcoded in the
+                        # table.htm.pt
+                        continue
+                    if request is not None:
+                        tablerowstyletitle = translate(_(tablerowstylefields[0]), context=request)
+                    results['styles'].append(tablerowstyletitle + '|tr|' + tablerowstyleid)
+                    table_row_styles.append(tablerowstyletitle + '=' + tablerowstyleid)
             if isinstance(self.styles, StringTypes):
                 styles = []
                 for style in self.styles.split('\n'):
@@ -791,6 +809,7 @@ def getConfiguration(self, context=None, field=None, request=None):
                     styles.append(merge)
                 results['styles'].extend(styles)
         results['table_styles'] = ';'.join(table_styles)  # tinymce config
+        results['table_row_styles'] = ';'.join(table_row_styles)
 
         if parastyles is not None:
             results['styles'].extend(parastyles)


Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-07-22T19:51:00+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.TinyMCE/commit/965118d7302bb7cbe64412fb3b3080ef4ecfd4e9

Merge pull request #146 from plone/table-row-styles

Added tablerowstyles setting in control panel.

Files changed:
M CHANGES.rst
M Products/TinyMCE/exportimport.py
M Products/TinyMCE/interfaces/utility.py
M Products/TinyMCE/profiles.zcml
M Products/TinyMCE/profiles/default/metadata.xml
M Products/TinyMCE/profiles/default/tinymce.xml
M Products/TinyMCE/upgrades.py
M Products/TinyMCE/utility.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9f6c56f..12d1f8c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,7 +11,10 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Added ``tablerowstyles`` setting in control panel.  These styles are
+  available when you are setting the table row properties.  Until now,
+  all styles were shown here, most of which are not useful for table
+  rows, and they were shown in an ugly and wrong way.  [maurits]
 
 Bug fixes:
 
diff --git a/Products/TinyMCE/exportimport.py b/Products/TinyMCE/exportimport.py
index e91338a..e5c74b2 100644
--- a/Products/TinyMCE/exportimport.py
+++ b/Products/TinyMCE/exportimport.py
@@ -38,6 +38,11 @@ class TinyMCESettingsXMLAdapter(XMLAdapterBase):
                 u'Invisible grid|invisible\n'
                 u'Fancy listing|listing\n'
             },
+            'tablerowstyles': {
+                'type': 'List', 'default':
+                u'Even|even\n'
+                u'Odd|odd\n'
+            },
         },
         'toolbar': {
             'toolbar_width': {'type': 'Text', 'default': u'440'},
diff --git a/Products/TinyMCE/interfaces/utility.py b/Products/TinyMCE/interfaces/utility.py
index 8012332..4d527c7 100644
--- a/Products/TinyMCE/interfaces/utility.py
+++ b/Products/TinyMCE/interfaces/utility.py
@@ -92,6 +92,11 @@ class ITinyMCELayout(Interface):
         description=_(u"Enter a list of styles to appear in the table style pulldown. Format is title|class, one per line."),
         required=False)
 
+    tablerowstyles = schema.Text(
+        title=_(u"Table row styles"),
+        description=_(u"Enter a list of styles to appear in the table row style pulldown. Format is title|class, one per line."),
+        required=False)
+
 
 class ITinyMCEToolbar(Interface):
     """This interface defines the toolbar properties."""
diff --git a/Products/TinyMCE/profiles.zcml b/Products/TinyMCE/profiles.zcml
index 35ef096..f7b0521 100644
--- a/Products/TinyMCE/profiles.zcml
+++ b/Products/TinyMCE/profiles.zcml
@@ -109,6 +109,15 @@
         handler=".upgrades.upgrade_to_profile_8"
         />
 
+   <genericsetup:upgradeStep
+        title="Upgrade TinyMCE 1.3.22 to 1.3.23"
+        description="Add default tablerowstyles"
+        source="8"
+        destination="9"
+        profile="Products.TinyMCE:TinyMCE"
+        handler=".upgrades.upgrade_to_profile_9"
+        />
+
     <genericsetup:upgradeStep
         title="Install plone.outputfilters"
         description="This replaces the old TinyMCE-specific resolveuid and captioning transform."
diff --git a/Products/TinyMCE/profiles/default/metadata.xml b/Products/TinyMCE/profiles/default/metadata.xml
index 2960b02..910663b 100644
--- a/Products/TinyMCE/profiles/default/metadata.xml
+++ b/Products/TinyMCE/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>8</version>
+  <version>9</version>
   <dependencies>
     <dependency>profile-plone.outputfilters:default</dependency>
     <dependency>profile-plone.app.imaging:default</dependency>
diff --git a/Products/TinyMCE/profiles/default/tinymce.xml b/Products/TinyMCE/profiles/default/tinymce.xml
index 9a10440..35561b3 100644
--- a/Products/TinyMCE/profiles/default/tinymce.xml
+++ b/Products/TinyMCE/profiles/default/tinymce.xml
@@ -66,6 +66,10 @@
    <element value="Invisible grid|invisible"/>
    <element value="Fancy listing|listing"/>
   </tablestyles>
+  <tablerowstyles>
+   <element value="Even|even"/>
+   <element value="Odd|odd"/>
+  </tablerowstyles>
   <resizing value="True"/>
  </layout>
  <toolbar>
diff --git a/Products/TinyMCE/upgrades.py b/Products/TinyMCE/upgrades.py
index 4095e47..f740dc0 100644
--- a/Products/TinyMCE/upgrades.py
+++ b/Products/TinyMCE/upgrades.py
@@ -103,3 +103,13 @@ def upgrade_to_profile_8(context):
     tdata.append('vertical-align')
     transform._p_changed = True
     transform.reload()
+
+
+def upgrade_to_profile_9(context):
+    tinymce = getToolByName(context, 'portal_tinymce')
+    if tinymce.tablerowstyles:
+        return
+    tinymce.tablerowstyles = (
+        u'Even|even\n'
+        u'Odd|odd\n'
+    )
diff --git a/Products/TinyMCE/utility.py b/Products/TinyMCE/utility.py
index 4586ffa..0030498 100644
--- a/Products/TinyMCE/utility.py
+++ b/Products/TinyMCE/utility.py
@@ -94,6 +94,7 @@ class TinyMCE(SimpleItem):
     styles = FieldProperty(ITinyMCELayout['styles'])
     formats = FieldProperty(ITinyMCELayout['formats'])
     tablestyles = FieldProperty(ITinyMCELayout['tablestyles'])
+    tablerowstyles = FieldProperty(ITinyMCELayout['tablerowstyles'])
 
     toolbar_width = FieldProperty(ITinyMCEToolbar['toolbar_width'])
 
@@ -760,6 +761,7 @@ def getConfiguration(self, context=None, field=None, request=None):
         # Add styles to results
         results['styles'] = []
         table_styles = []
+        table_row_styles = []
         if not redefine_parastyles:
             if isinstance(self.tablestyles, StringTypes):
                 for tablestyle in self.tablestyles.split('\n'):
@@ -777,6 +779,22 @@ def getConfiguration(self, context=None, field=None, request=None):
                         tablestyletitle = translate(_(tablestylefields[0]), context=request)
                     results['styles'].append(tablestyletitle + '|table|' + tablestyleid)
                     table_styles.append(tablestyletitle + '=' + tablestyleid)
+            if isinstance(self.tablerowstyles, StringTypes):
+                for tablerowstyle in self.tablerowstyles.split('\n'):
+                    if not tablerowstyle:
+                        # empty line
+                        continue
+                    tablerowstylefields = tablerowstyle.split('|')
+                    tablerowstyletitle = tablerowstylefields[0]
+                    tablerowstyleid = tablerowstylefields[1]
+                    if tablerowstyleid == 'plain':
+                        # Do not duplicate the default style hardcoded in the
+                        # table.htm.pt
+                        continue
+                    if request is not None:
+                        tablerowstyletitle = translate(_(tablerowstylefields[0]), context=request)
+                    results['styles'].append(tablerowstyletitle + '|tr|' + tablerowstyleid)
+                    table_row_styles.append(tablerowstyletitle + '=' + tablerowstyleid)
             if isinstance(self.styles, StringTypes):
                 styles = []
                 for style in self.styles.split('\n'):
@@ -791,6 +809,7 @@ def getConfiguration(self, context=None, field=None, request=None):
                     styles.append(merge)
                 results['styles'].extend(styles)
         results['table_styles'] = ';'.join(table_styles)  # tinymce config
+        results['table_row_styles'] = ';'.join(table_row_styles)
 
         if parastyles is not None:
             results['styles'].extend(parastyles)


