Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2017-05-24T14:02:55-03:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/e851fef3c0833fe033764a354aaea71e1a324b2e

Review context url for @@render-portlet and @@updateSharingInfo ajax calls

Files changed:
M Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js b/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
index 1b4479daa..305e9f715 100644
--- a/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
+++ b/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
@@ -1,5 +1,18 @@
 (function($){
 
+function createURL(view){
+    // using this method we keep the get parameters used with plone protect
+    // https://gist.github.com/jlong/2428561
+    if (typeof view === 'undefined') {
+        view = '';
+    }
+    var parser = document.createElement('a');
+    parser.href = location.href;
+    parser.pathname = parser.pathname.replace(/\/@@.*/, '');
+    parser.pathname += view;
+    return parser.href;
+}
+
 function refreshPortlet(hash, _options){
     var options = {
         data: {},
@@ -9,7 +22,7 @@ function refreshPortlet(hash, _options){
     $.extend(options, _options);
     options.data.portlethash = hash;
     ajaxOptions = options.ajaxOptions;
-    ajaxOptions.url = $('base').attr('href') + '/@@render-portlet';
+    ajaxOptions.url = createURL('/@@render-portlet');
     ajaxOptions.success = function(data){
         var container = $('[data-portlethash="' + hash + '"]');
         var portlet = $(data);
@@ -103,7 +116,7 @@ $(document).ready(function(){
 
     $('#content-core').delegate('#sharing-search-button', 'click', function(){
         $.ajax({
-            url: $('base').attr('href') + '/@@updateSharingInfo',
+            url: createURL('/@@updateSharingInfo'),
             data: {
                 search_term: $('#sharing-user-group-search').val(),
                 'form.button.Search': 'Search'
@@ -122,7 +135,7 @@ $(document).ready(function(){
         var data = form.serializeArray();
         data.push({name: 'form.button.Save', value: 'Save'});
         $.ajax({
-            url: $('base').attr('href') + '/@@updateSharingInfo',
+            url: createURL('/@@updateSharingInfo'),
             data: data,
             type: 'POST',
             dataType: 'json',
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index e8bd70411..b88ca57c0 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,7 +19,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Review context url for @@render-portlet and @@updateSharingInfo ajax calls.
+  Fixes `issue 2053 <https://github.com/plone/Products.CMFPlone/issues/2053>`_.
+  [rodfersou]
 
 
 4.3.14 (2017-04-03)


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2017-06-04T20:39:34+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/230c036adf522fb80cb87960c777daff4ff686ae

Merge pull request #2058 from plone/issue_2053

Review context url for @@render-portlet and @@updateSharingInfo ajax calls

Files changed:
M Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js b/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
index 1b4479daa..305e9f715 100644
--- a/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
+++ b/Products/CMFPlone/skins/plone_ecmascript/kss-bbb.js
@@ -1,5 +1,18 @@
 (function($){
 
+function createURL(view){
+    // using this method we keep the get parameters used with plone protect
+    // https://gist.github.com/jlong/2428561
+    if (typeof view === 'undefined') {
+        view = '';
+    }
+    var parser = document.createElement('a');
+    parser.href = location.href;
+    parser.pathname = parser.pathname.replace(/\/@@.*/, '');
+    parser.pathname += view;
+    return parser.href;
+}
+
 function refreshPortlet(hash, _options){
     var options = {
         data: {},
@@ -9,7 +22,7 @@ function refreshPortlet(hash, _options){
     $.extend(options, _options);
     options.data.portlethash = hash;
     ajaxOptions = options.ajaxOptions;
-    ajaxOptions.url = $('base').attr('href') + '/@@render-portlet';
+    ajaxOptions.url = createURL('/@@render-portlet');
     ajaxOptions.success = function(data){
         var container = $('[data-portlethash="' + hash + '"]');
         var portlet = $(data);
@@ -103,7 +116,7 @@ $(document).ready(function(){
 
     $('#content-core').delegate('#sharing-search-button', 'click', function(){
         $.ajax({
-            url: $('base').attr('href') + '/@@updateSharingInfo',
+            url: createURL('/@@updateSharingInfo'),
             data: {
                 search_term: $('#sharing-user-group-search').val(),
                 'form.button.Search': 'Search'
@@ -122,7 +135,7 @@ $(document).ready(function(){
         var data = form.serializeArray();
         data.push({name: 'form.button.Save', value: 'Save'});
         $.ajax({
-            url: $('base').attr('href') + '/@@updateSharingInfo',
+            url: createURL('/@@updateSharingInfo'),
             data: data,
             type: 'POST',
             dataType: 'json',
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index e8bd70411..b88ca57c0 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -19,7 +19,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Review context url for @@render-portlet and @@updateSharingInfo ajax calls.
+  Fixes `issue 2053 <https://github.com/plone/Products.CMFPlone/issues/2053>`_.
+  [rodfersou]
 
 
 4.3.14 (2017-04-03)


