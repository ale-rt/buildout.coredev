Repository: plone.app.imaging


Branch: refs/heads/1.0.x
Date: 2015-12-13T23:44:12+01:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.imaging/commit/8a5719f6c023a57dc79190b89cc882cafa265dac

Disable csrf protection when scale is generated and traversed to

Files changed:
M docs/HISTORY.txt
M setup.py
M src/plone/app/imaging/traverse.py

diff --git a/docs/HISTORY.txt b/docs/HISTORY.txt
index 68079a6..8c55bf7 100644
--- a/docs/HISTORY.txt
+++ b/docs/HISTORY.txt
@@ -10,7 +10,8 @@ New:
 
 Fixes:
 
-- *add item here*
+- Disable csrf protection when scale is generated and traversed to.
+  [vangheem]
 
 
 1.0.12 (2015-11-26)
diff --git a/setup.py b/setup.py
index c4a1176..533bc47 100644
--- a/setup.py
+++ b/setup.py
@@ -35,6 +35,7 @@
         'setuptools',
         'plone.scale [storage]',
         'z3c.caching',
+        'five.globalrequest'
       ],
       extras_require = {'test':
           ['collective.testcaselayer',
diff --git a/src/plone/app/imaging/traverse.py b/src/plone/app/imaging/traverse.py
index 4cfe2c8..e967754 100644
--- a/src/plone/app/imaging/traverse.py
+++ b/src/plone/app/imaging/traverse.py
@@ -9,6 +9,9 @@
 from plone.app.imaging.interfaces import IBaseObject
 from plone.app.imaging.interfaces import IImageScaleHandler
 from plone.app.imaging.scale import ImageScale
+from plone.protect.interfaces import IDisableCSRFProtection
+from zope.interface import alsoProvides
+from zope.globalrequest import getRequest
 
 
 class ImageTraverser(DefaultPublishTraverse):
@@ -60,6 +63,10 @@ def getScale(self, instance, scale):
     def createScale(self, instance, scale, width, height, data=None):
         """ create & return a scaled version of the image as retrieved
             from the field or optionally given data """
+        # disable CRSF on scale generation
+        req = getRequest()
+        if req:
+            alsoProvides(req, IDisableCSRFProtection)
         field = self.context
         if HAS_PIL and width and height:
             if data is None:


Repository: plone.app.imaging


Branch: refs/heads/1.0.x
Date: 2016-02-23T13:35:07-05:00
Author: Eric Steele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.imaging/commit/132c731530c8ee9aba8c1f43c8a3f8d4bbed0c28

Merge pull request #24 from plone/write-on-read

Disable csrf protection when scale is generated and traversed to

Files changed:
M docs/HISTORY.txt
M setup.py
M src/plone/app/imaging/traverse.py

diff --git a/docs/HISTORY.txt b/docs/HISTORY.txt
index 68079a6..8c55bf7 100644
--- a/docs/HISTORY.txt
+++ b/docs/HISTORY.txt
@@ -10,7 +10,8 @@ New:
 
 Fixes:
 
-- *add item here*
+- Disable csrf protection when scale is generated and traversed to.
+  [vangheem]
 
 
 1.0.12 (2015-11-26)
diff --git a/setup.py b/setup.py
index c4a1176..533bc47 100644
--- a/setup.py
+++ b/setup.py
@@ -35,6 +35,7 @@
         'setuptools',
         'plone.scale [storage]',
         'z3c.caching',
+        'five.globalrequest'
       ],
       extras_require = {'test':
           ['collective.testcaselayer',
diff --git a/src/plone/app/imaging/traverse.py b/src/plone/app/imaging/traverse.py
index 4cfe2c8..e967754 100644
--- a/src/plone/app/imaging/traverse.py
+++ b/src/plone/app/imaging/traverse.py
@@ -9,6 +9,9 @@
 from plone.app.imaging.interfaces import IBaseObject
 from plone.app.imaging.interfaces import IImageScaleHandler
 from plone.app.imaging.scale import ImageScale
+from plone.protect.interfaces import IDisableCSRFProtection
+from zope.interface import alsoProvides
+from zope.globalrequest import getRequest
 
 
 class ImageTraverser(DefaultPublishTraverse):
@@ -60,6 +63,10 @@ def getScale(self, instance, scale):
     def createScale(self, instance, scale, width, height, data=None):
         """ create & return a scaled version of the image as retrieved
             from the field or optionally given data """
+        # disable CRSF on scale generation
+        req = getRequest()
+        if req:
+            alsoProvides(req, IDisableCSRFProtection)
         field = self.context
         if HAS_PIL and width and height:
             if data is None:


