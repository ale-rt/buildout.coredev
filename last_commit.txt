Repository: diazo


Branch: refs/heads/master
Date: 2016-06-06T14:24:35+02:00
Author: Kristin Kuche (krissik) <kuche@hrz.uni-marburg.de>
Commit: https://github.com/plone/diazo/commit/11ce1abef7879f28d6594f73deae2e9ecabd7bbc

Add absolute url prefix to xlink:href attributes

Files changed:
M CHANGES.rst
M lib/diazo/rules.py
M lib/diazo/tests/absolute-prefix/output.html
M lib/diazo/tests/absolute-prefix/theme.html

diff --git a/CHANGES.rst b/CHANGES.rst
index 7ec41be..adf576e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -7,6 +7,8 @@ Changelog
 New:
 
 - *add item here*
+- Add absolute url prefix to xlink:href attributes
+  [krissik]
 
 Fixes:
 
diff --git a/lib/diazo/rules.py b/lib/diazo/rules.py
index c6a70dc..59e6473 100644
--- a/lib/diazo/rules.py
+++ b/lib/diazo/rules.py
@@ -140,6 +140,10 @@ def apply_absolute_prefix(theme_doc, absolute_prefix):
     for node in theme_doc.xpath('//*[@src]'):
         url = urljoin(absolute_prefix, node.get('src'))
         node.set('src', url)
+    for xlink_attr in theme_doc.xpath('//@*[local-name()="xlink:href"]'):
+        node = xlink_attr.getparent()
+        url = urljoin(absolute_prefix, node.get('xlink:href'))
+        node.set('xlink:href', url)
     for node in theme_doc.xpath('//*[@srcset]'):
         srcset = node.get('srcset')
         srcset = SRCSET.sub(
diff --git a/lib/diazo/tests/absolute-prefix/output.html b/lib/diazo/tests/absolute-prefix/output.html
index 7b77fe3..a2c2c78 100644
--- a/lib/diazo/tests/absolute-prefix/output.html
+++ b/lib/diazo/tests/absolute-prefix/output.html
@@ -39,5 +39,9 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="/abs/foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <div xmlns:xlink="http://www.w3.org/1999/xlink">
+      <svg><use xlink:href="/abs/img/foo.svg"></use></svg>
+      <span xlink:href="/abs/foo.html"></span>
+    </div>
   </body>
 </html>
diff --git a/lib/diazo/tests/absolute-prefix/theme.html b/lib/diazo/tests/absolute-prefix/theme.html
index a348111..94cd30b 100644
--- a/lib/diazo/tests/absolute-prefix/theme.html
+++ b/lib/diazo/tests/absolute-prefix/theme.html
@@ -39,5 +39,9 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <div xmlns:xlink="http://www.w3.org/1999/xlink">
+      <svg><use xlink:href="img/foo.svg"></use></svg>
+      <span xlink:href="foo.html"></span>
+    </div>
   </body>
 </html>


Repository: diazo


Branch: refs/heads/master
Date: 2016-06-06T14:45:49+02:00
Author: Kristin Kuche (krissik) <kuche@hrz.uni-marburg.de>
Commit: https://github.com/plone/diazo/commit/3d99953f296c43d58a658b82358c562049a176a9

Pin repoze.xmliter to 0.6

Files changed:
M versions.cfg

diff --git a/versions.cfg b/versions.cfg
index 4b66da6..a709949 100644
--- a/versions.cfg
+++ b/versions.cfg
@@ -5,5 +5,5 @@ versions = versions
 WebOb = 1.4
 cssselect = 0.9.1
 lxml = 3.3.5
-repoze.xmliter = 0.5
+repoze.xmliter = 0.6
 FormEncode = 1.3.0a1


Repository: diazo


Branch: refs/heads/master
Date: 2016-06-07T09:08:25+02:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/diazo/commit/a354f53f3fe2c414fefe5642b4997cabe052c6b1

Merge pull request #58 from hrz-unimr/master

Add absolute url prefix to xlink:href attributes

Files changed:
M CHANGES.rst
M lib/diazo/rules.py
M lib/diazo/tests/absolute-prefix/output.html
M lib/diazo/tests/absolute-prefix/theme.html
M versions.cfg

diff --git a/CHANGES.rst b/CHANGES.rst
index 7ec41be..adf576e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -7,6 +7,8 @@ Changelog
 New:
 
 - *add item here*
+- Add absolute url prefix to xlink:href attributes
+  [krissik]
 
 Fixes:
 
diff --git a/lib/diazo/rules.py b/lib/diazo/rules.py
index c6a70dc..59e6473 100644
--- a/lib/diazo/rules.py
+++ b/lib/diazo/rules.py
@@ -140,6 +140,10 @@ def apply_absolute_prefix(theme_doc, absolute_prefix):
     for node in theme_doc.xpath('//*[@src]'):
         url = urljoin(absolute_prefix, node.get('src'))
         node.set('src', url)
+    for xlink_attr in theme_doc.xpath('//@*[local-name()="xlink:href"]'):
+        node = xlink_attr.getparent()
+        url = urljoin(absolute_prefix, node.get('xlink:href'))
+        node.set('xlink:href', url)
     for node in theme_doc.xpath('//*[@srcset]'):
         srcset = node.get('srcset')
         srcset = SRCSET.sub(
diff --git a/lib/diazo/tests/absolute-prefix/output.html b/lib/diazo/tests/absolute-prefix/output.html
index 7b77fe3..a2c2c78 100644
--- a/lib/diazo/tests/absolute-prefix/output.html
+++ b/lib/diazo/tests/absolute-prefix/output.html
@@ -39,5 +39,9 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="/abs/foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <div xmlns:xlink="http://www.w3.org/1999/xlink">
+      <svg><use xlink:href="/abs/img/foo.svg"></use></svg>
+      <span xlink:href="/abs/foo.html"></span>
+    </div>
   </body>
 </html>
diff --git a/lib/diazo/tests/absolute-prefix/theme.html b/lib/diazo/tests/absolute-prefix/theme.html
index a348111..94cd30b 100644
--- a/lib/diazo/tests/absolute-prefix/theme.html
+++ b/lib/diazo/tests/absolute-prefix/theme.html
@@ -39,5 +39,9 @@
     <input type="submit" src="http://site.com/foo.jpg" />
     <a href="foo.html">Link</a>
     <a href="#foo">Anchor</a>
+    <div xmlns:xlink="http://www.w3.org/1999/xlink">
+      <svg><use xlink:href="img/foo.svg"></use></svg>
+      <span xlink:href="foo.html"></span>
+    </div>
   </body>
 </html>
diff --git a/versions.cfg b/versions.cfg
index 4b66da6..a709949 100644
--- a/versions.cfg
+++ b/versions.cfg
@@ -5,5 +5,5 @@ versions = versions
 WebOb = 1.4
 cssselect = 0.9.1
 lxml = 3.3.5
-repoze.xmliter = 0.5
+repoze.xmliter = 0.6
 FormEncode = 1.3.0a1


