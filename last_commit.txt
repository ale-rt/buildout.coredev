Repository: plone.app.registry


Branch: refs/heads/master
Date: 2018-01-08T14:28:55+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.registry/commit/672671259a8920d79a345548deb79be0b95fedd8

minor refactoring: DRY

Files changed:
M CHANGES.rst
M plone/app/registry/exportimport/handler.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 160b930..69c8f1b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Minor refactoring of registry import (DRY).
+  [jensens]
 
 
 1.6.1 (2017-06-04)
diff --git a/plone/app/registry/exportimport/handler.py b/plone/app/registry/exportimport/handler.py
index a1c8b3c..ff836d5 100644
--- a/plone/app/registry/exportimport/handler.py
+++ b/plone/app/registry/exportimport/handler.py
@@ -43,7 +43,6 @@ def evaluateCondition(expression):
     return handler.evaluateCondition(expression)
 
 
-
 def shouldPurgeList(value_node, key):
     for child in value_node:
         attrib = child.attrib
@@ -64,17 +63,16 @@ def importRegistry(context):
         logger.info("Cannot find registry")
         return
 
-    body = context.readDataFile('registry.xml')
-    if body is not None:
-        importer = RegistryImporter(registry, context)
-        importer.importDocument(body)
-
+    filepaths = ['registry.xml']
     if context.isDirectory('registry'):
         for filename in context.listDirectory('registry'):
-            body = context.readDataFile('registry/' + filename)
-            if body is not None:
-                importer = RegistryImporter(registry, context)
-                importer.importDocument(body)
+            filepaths.append('registry/' + filename)
+
+    importer = RegistryImporter(registry, context)
+    for filepath in filepaths:
+        body = context.readDataFile(filepath)
+        if body is not None:
+            importer.importDocument(body)
 
 
 def exportRegistry(context):


Repository: plone.app.registry


Branch: refs/heads/master
Date: 2018-01-08T14:30:47+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.registry/commit/2e51358f84cd52b14b459e935b4a86ddbaea0c32

traceback info for imported filename

Files changed:
M CHANGES.rst
M plone/app/registry/exportimport/handler.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 69c8f1b..d67644d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Added traceback info of filename to importer in order to ease debugging.
+  [jensens]
 
 Bug fixes:
 
diff --git a/plone/app/registry/exportimport/handler.py b/plone/app/registry/exportimport/handler.py
index ff836d5..00429f3 100644
--- a/plone/app/registry/exportimport/handler.py
+++ b/plone/app/registry/exportimport/handler.py
@@ -70,6 +70,7 @@ def importRegistry(context):
 
     importer = RegistryImporter(registry, context)
     for filepath in filepaths:
+        __traceback_info__ = filepath
         body = context.readDataFile(filepath)
         if body is not None:
             importer.importDocument(body)


Repository: plone.app.registry


Branch: refs/heads/master
Date: 2018-01-08T15:45:51+01:00
Author: agitator (agitator) <agitator@users.noreply.github.com>
Commit: https://github.com/plone/plone.app.registry/commit/d66615e0d05f4f9ebcf420e10912db061b14632f

Merge pull request #28 from plone/jensens-better-debugging-import-filename

traceback info for registry import filename

Files changed:
M CHANGES.rst
M plone/app/registry/exportimport/handler.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 160b930..d67644d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,11 +10,13 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Added traceback info of filename to importer in order to ease debugging.
+  [jensens]
 
 Bug fixes:
 
-- *add item here*
+- Minor refactoring of registry import (DRY).
+  [jensens]
 
 
 1.6.1 (2017-06-04)
diff --git a/plone/app/registry/exportimport/handler.py b/plone/app/registry/exportimport/handler.py
index a1c8b3c..00429f3 100644
--- a/plone/app/registry/exportimport/handler.py
+++ b/plone/app/registry/exportimport/handler.py
@@ -43,7 +43,6 @@ def evaluateCondition(expression):
     return handler.evaluateCondition(expression)
 
 
-
 def shouldPurgeList(value_node, key):
     for child in value_node:
         attrib = child.attrib
@@ -64,17 +63,17 @@ def importRegistry(context):
         logger.info("Cannot find registry")
         return
 
-    body = context.readDataFile('registry.xml')
-    if body is not None:
-        importer = RegistryImporter(registry, context)
-        importer.importDocument(body)
-
+    filepaths = ['registry.xml']
     if context.isDirectory('registry'):
         for filename in context.listDirectory('registry'):
-            body = context.readDataFile('registry/' + filename)
-            if body is not None:
-                importer = RegistryImporter(registry, context)
-                importer.importDocument(body)
+            filepaths.append('registry/' + filename)
+
+    importer = RegistryImporter(registry, context)
+    for filepath in filepaths:
+        __traceback_info__ = filepath
+        body = context.readDataFile(filepath)
+        if body is not None:
+            importer.importDocument(body)
 
 
 def exportRegistry(context):


