Repository: Products.ResourceRegistries


Branch: refs/heads/2.2.x
Date: 2016-06-13T19:39:55-03:00
Author: hvelarde (hvelarde) <hector.velarde@gmail.com>
Commit: https://github.com/plone/Products.ResourceRegistries/commit/e94b0bb11844dabd92be0126f9e4403df7bb3b14

Fix validation of an external resource id

Files changed:
M CHANGES.rst
M Products/ResourceRegistries/tests/testJSRegistry.py
M Products/ResourceRegistries/tools/BaseRegistry.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 52584cb..7c3964a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,13 @@ Changelog
 2.2.12 (unreleased)
 -------------------
 
-- Nothing changed yet.
+New:
+
+- *add item here*
+
+Fixes:
+
+- ``_setId`` was incorrectly rising ``ValueError`` making it impossible to rename an external resource.
 
 
 2.2.11 (2014-10-13)
diff --git a/Products/ResourceRegistries/tests/testJSRegistry.py b/Products/ResourceRegistries/tests/testJSRegistry.py
index 296cffa..0304674 100644
--- a/Products/ResourceRegistries/tests/testJSRegistry.py
+++ b/Products/ResourceRegistries/tests/testJSRegistry.py
@@ -113,6 +113,14 @@ def testRenamingIdClash(self):
         self.tool.registerScript('eggs')
         self.assertRaises(ValueError, self.tool.renameResource, 'spam', 'eggs')
 
+    def testRenamingExternal(self):
+        old = '//example.org/foo.js'
+        new = '//example.org/bar.js'
+        self.tool.registerScript(old)
+        self.tool.renameResource(old, new)
+        self.assertNotIn(old, self.tool.getResourceIds())
+        self.assertIn(new, self.tool.getResourceIds())
+
     def testDoubleRenaming(self):
         self.tool.registerScript('ham')
         self.tool.registerScript('spam')
diff --git a/Products/ResourceRegistries/tools/BaseRegistry.py b/Products/ResourceRegistries/tools/BaseRegistry.py
index aed0700..1b40900 100644
--- a/Products/ResourceRegistries/tools/BaseRegistry.py
+++ b/Products/ResourceRegistries/tools/BaseRegistry.py
@@ -129,8 +129,8 @@ def getQuotedId(self):
 
     security.declareProtected(permissions.ManagePortal, '_setId')
     def _setId(self, id):
-        if id.startswith('/') or id.endswith('/') or (
-                ('//' in id) and not self.isExternalResource()):
+        extres = id.startswith('http://') or id.startswith('https://') or id.startswith('//')
+        if not extres and (id.startswith('/') or id.endswith('/') or ('//' in id)):
             raise ValueError("Invalid Resource ID: %s" %id)
         self._data['id'] = id
 


Repository: Products.ResourceRegistries


Branch: refs/heads/2.2.x
Date: 2016-06-14T09:49:24+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.ResourceRegistries/commit/421f4f7caf43d8a9b82ff3b59cb3b1860185b1fb

Merge pull request #20 from plone/hvelarde-rename

Fix validation of an external resource id

Files changed:
M CHANGES.rst
M Products/ResourceRegistries/tests/testJSRegistry.py
M Products/ResourceRegistries/tools/BaseRegistry.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 52584cb..7c3964a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,13 @@ Changelog
 2.2.12 (unreleased)
 -------------------
 
-- Nothing changed yet.
+New:
+
+- *add item here*
+
+Fixes:
+
+- ``_setId`` was incorrectly rising ``ValueError`` making it impossible to rename an external resource.
 
 
 2.2.11 (2014-10-13)
diff --git a/Products/ResourceRegistries/tests/testJSRegistry.py b/Products/ResourceRegistries/tests/testJSRegistry.py
index 296cffa..0304674 100644
--- a/Products/ResourceRegistries/tests/testJSRegistry.py
+++ b/Products/ResourceRegistries/tests/testJSRegistry.py
@@ -113,6 +113,14 @@ def testRenamingIdClash(self):
         self.tool.registerScript('eggs')
         self.assertRaises(ValueError, self.tool.renameResource, 'spam', 'eggs')
 
+    def testRenamingExternal(self):
+        old = '//example.org/foo.js'
+        new = '//example.org/bar.js'
+        self.tool.registerScript(old)
+        self.tool.renameResource(old, new)
+        self.assertNotIn(old, self.tool.getResourceIds())
+        self.assertIn(new, self.tool.getResourceIds())
+
     def testDoubleRenaming(self):
         self.tool.registerScript('ham')
         self.tool.registerScript('spam')
diff --git a/Products/ResourceRegistries/tools/BaseRegistry.py b/Products/ResourceRegistries/tools/BaseRegistry.py
index aed0700..1b40900 100644
--- a/Products/ResourceRegistries/tools/BaseRegistry.py
+++ b/Products/ResourceRegistries/tools/BaseRegistry.py
@@ -129,8 +129,8 @@ def getQuotedId(self):
 
     security.declareProtected(permissions.ManagePortal, '_setId')
     def _setId(self, id):
-        if id.startswith('/') or id.endswith('/') or (
-                ('//' in id) and not self.isExternalResource()):
+        extres = id.startswith('http://') or id.startswith('https://') or id.startswith('//')
+        if not extres and (id.startswith('/') or id.endswith('/') or ('//' in id)):
             raise ValueError("Invalid Resource ID: %s" %id)
         self._data['id'] = id
 


