Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/1.5.x
Date: 2017-03-08T11:49:36+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/28d8ad71f86793f25a1e490d7bf7bc15be92c17a

Fixed reinstall.

Deactivating and then activating the add-on led to a missing tool and control panel icon.
Another deactivation would then fail.
Solution is to mark our base profile as uninstalled in the uninstall method.
This requires `Products.GenericSetup` 1.8.1 or higher.
Fixes https://github.com/plone/Products.CMFPlone/issues/1959.

Files changed:
M CHANGES.rst
M Products/CMFPlacefulWorkflow/Extensions/Install.py
M Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3bcae28..af6b618 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,13 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed reinstall.  Deactivating and then activating the add-on
+  led to a missing tool and control panel icon.  Another deactivation
+  would then fail.  Solution is to mark our base profile as uninstalled
+  in the uninstall method.
+  This requires ``Products.GenericSetup`` 1.8.1 or higher.
+  Fixes `issue 1959 <https://github.com/plone/Products.CMFPlone/issues/1959>`_.
+  [maurits]
 
 
 1.5.14 (2017-01-17)
diff --git a/Products/CMFPlacefulWorkflow/Extensions/Install.py b/Products/CMFPlacefulWorkflow/Extensions/Install.py
index 5436d6e..a2763d8 100644
--- a/Products/CMFPlacefulWorkflow/Extensions/Install.py
+++ b/Products/CMFPlacefulWorkflow/Extensions/Install.py
@@ -53,4 +53,11 @@ def uninstall(self, reinstall=False, out=None):
     if IPlacefulMarker.providedBy(wf_tool):
         noLongerProvides(wf_tool, IPlacefulMarker)
 
+    # We need to tell portal_setup that the base profile
+    # has been unapplied, otherwise a reinstall will fail.
+    # See https://github.com/plone/Products.CMFPlone/issues/1959
+    portal_setup = getToolByName(self, 'portal_setup')
+    portal_setup.unsetLastVersionForProfile(
+        'profile-Products.CMFPlacefulWorkflow:base')
+
     return out.getvalue()
diff --git a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
index 88922cf..83be7a7 100644
--- a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
+++ b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
@@ -128,6 +128,20 @@ def test_reinstall(self):
         """
         self.qi = self.portal.portal_quickinstaller
         self.qi.installProduct('CMFPlacefulWorkflow', reinstall=True)
+        self.assertTrue('portal_placeful_workflow' in self.portal)
+
+    def test_activation_reactivation(self):
+        """
+        Test if upgrade is going the good way
+        """
+        self.loginAsPortalOwner()
+        self.qi = self.portal.portal_quickinstaller
+        self.qi.uninstallProducts(['CMFPlacefulWorkflow'])
+        self.assertFalse('portal_placeful_workflow' in self.portal)
+        self.qi.installProduct('CMFPlacefulWorkflow')
+        self.assertTrue('portal_placeful_workflow' in self.portal)
+        self.qi.uninstallProducts(['CMFPlacefulWorkflow'])
+        self.assertFalse('portal_placeful_workflow' in self.portal)
 
     def test_prefs_workflow_policy_mapping_set_PostOnly(self):
         """
diff --git a/setup.py b/setup.py
index d41a342..8bed409 100644
--- a/setup.py
+++ b/setup.py
@@ -38,6 +38,6 @@
           'zope.i18nmessageid',
           'Products.CMFCore',
           'Products.CMFPlone',
-          'Products.GenericSetup',
+          'Products.GenericSetup>=1.8.1',
       ],
       )


Repository: Products.CMFPlacefulWorkflow


Branch: refs/heads/1.5.x
Date: 2017-03-08T13:18:40+01:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/Products.CMFPlacefulWorkflow/commit/fa86345562e74b2352e3fb2f1927eba53c871154

Merge pull request #15 from plone/uninstall-base-15x

Fixed reinstall. [1.5.x]

Files changed:
M CHANGES.rst
M Products/CMFPlacefulWorkflow/Extensions/Install.py
M Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3bcae28..af6b618 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,13 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed reinstall.  Deactivating and then activating the add-on
+  led to a missing tool and control panel icon.  Another deactivation
+  would then fail.  Solution is to mark our base profile as uninstalled
+  in the uninstall method.
+  This requires ``Products.GenericSetup`` 1.8.1 or higher.
+  Fixes `issue 1959 <https://github.com/plone/Products.CMFPlone/issues/1959>`_.
+  [maurits]
 
 
 1.5.14 (2017-01-17)
diff --git a/Products/CMFPlacefulWorkflow/Extensions/Install.py b/Products/CMFPlacefulWorkflow/Extensions/Install.py
index 5436d6e..a2763d8 100644
--- a/Products/CMFPlacefulWorkflow/Extensions/Install.py
+++ b/Products/CMFPlacefulWorkflow/Extensions/Install.py
@@ -53,4 +53,11 @@ def uninstall(self, reinstall=False, out=None):
     if IPlacefulMarker.providedBy(wf_tool):
         noLongerProvides(wf_tool, IPlacefulMarker)
 
+    # We need to tell portal_setup that the base profile
+    # has been unapplied, otherwise a reinstall will fail.
+    # See https://github.com/plone/Products.CMFPlone/issues/1959
+    portal_setup = getToolByName(self, 'portal_setup')
+    portal_setup.unsetLastVersionForProfile(
+        'profile-Products.CMFPlacefulWorkflow:base')
+
     return out.getvalue()
diff --git a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
index 88922cf..83be7a7 100644
--- a/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
+++ b/Products/CMFPlacefulWorkflow/tests/testCMFPlacefulWorkflow.py
@@ -128,6 +128,20 @@ def test_reinstall(self):
         """
         self.qi = self.portal.portal_quickinstaller
         self.qi.installProduct('CMFPlacefulWorkflow', reinstall=True)
+        self.assertTrue('portal_placeful_workflow' in self.portal)
+
+    def test_activation_reactivation(self):
+        """
+        Test if upgrade is going the good way
+        """
+        self.loginAsPortalOwner()
+        self.qi = self.portal.portal_quickinstaller
+        self.qi.uninstallProducts(['CMFPlacefulWorkflow'])
+        self.assertFalse('portal_placeful_workflow' in self.portal)
+        self.qi.installProduct('CMFPlacefulWorkflow')
+        self.assertTrue('portal_placeful_workflow' in self.portal)
+        self.qi.uninstallProducts(['CMFPlacefulWorkflow'])
+        self.assertFalse('portal_placeful_workflow' in self.portal)
 
     def test_prefs_workflow_policy_mapping_set_PostOnly(self):
         """
diff --git a/setup.py b/setup.py
index d41a342..8bed409 100644
--- a/setup.py
+++ b/setup.py
@@ -38,6 +38,6 @@
           'zope.i18nmessageid',
           'Products.CMFCore',
           'Products.CMFPlone',
-          'Products.GenericSetup',
+          'Products.GenericSetup>=1.8.1',
       ],
       )


