Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2017-02-07T17:33:38+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/0b27c8866f2d30510543a5d88461c0ad7aacf9e5

Fixed SafeFormatter import in mixins.py.

Clarified safe_format, which is renamed to _safe_format to discourage importing it outside CMFPlone.

Files changed:
M Products/CMFPlone/__init__.py
M Products/CMFPlone/resources/browser/mixins.py
M Products/CMFPlone/utils.py

diff --git a/Products/CMFPlone/__init__.py b/Products/CMFPlone/__init__.py
index df2fd2c..58c76f0 100644
--- a/Products/CMFPlone/__init__.py
+++ b/Products/CMFPlone/__init__.py
@@ -117,14 +117,14 @@ def initialize(context):
 
     # We want to allow all methods on string type except 'format'.
     # That one needs special handling to avoid access to attributes.
-    from Products.CMFPlone.utils import safe_format
+    from Products.CMFPlone.utils import _safe_format
     rules = dict([(m, True) for m in dir(str) if not m.startswith('_')])
-    rules['format'] = safe_format
+    rules['format'] = _safe_format
     allow_type(str, rules)
 
     # Same for unicode instead of str.
     rules = dict([(m, True) for m in dir(unicode) if not m.startswith('_')])
-    rules['format'] = safe_format
+    rules['format'] = _safe_format
     allow_type(unicode, rules)
 
     # Apply monkey patches
diff --git a/Products/CMFPlone/resources/browser/mixins.py b/Products/CMFPlone/resources/browser/mixins.py
index 47f1753..f9ffaf3 100644
--- a/Products/CMFPlone/resources/browser/mixins.py
+++ b/Products/CMFPlone/resources/browser/mixins.py
@@ -1,5 +1,5 @@
 from Products.CMFPlone.interfaces import IResourceRegistry
-from Products.CMFPlone.utils import safe_format
+from Products.CMFPlone.utils import SafeFormatter
 from Products.Five.browser import BrowserView
 from plone.registry.interfaces import IRegistry
 from urlparse import urlparse
diff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py
index abcd1a6..ebdb08e 100644
--- a/Products/CMFPlone/utils.py
+++ b/Products/CMFPlone/utils.py
@@ -789,8 +789,10 @@ def safe_format(self, *args, **kwargs):
         return self.vformat(self.value, args, kwargs)
 
 
-def safe_format(inst, method):
-    """
-    Use our SafeFormatter that uses guarded_getattr for attribute access
+def _safe_format(inst, method):
+    """Use our SafeFormatter that uses guarded_getattr for attribute access.
+
+    This is for use with AccessControl.allow_type,
+    as we do in CMFPlone/__init__.py.
     """
     return SafeFormatter(inst).safe_format


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2017-02-07T20:42:55+01:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/7c1eb701f1b72966e5c09be79bdbdc8feecf7bf3

Merge pull request #1944 from plone/clarify-hotfix-formatter-50

Fixed SafeFormatter import in mixins.py. [5.0]

Files changed:
M Products/CMFPlone/__init__.py
M Products/CMFPlone/resources/browser/mixins.py
M Products/CMFPlone/utils.py

diff --git a/Products/CMFPlone/__init__.py b/Products/CMFPlone/__init__.py
index df2fd2c..58c76f0 100644
--- a/Products/CMFPlone/__init__.py
+++ b/Products/CMFPlone/__init__.py
@@ -117,14 +117,14 @@ def initialize(context):
 
     # We want to allow all methods on string type except 'format'.
     # That one needs special handling to avoid access to attributes.
-    from Products.CMFPlone.utils import safe_format
+    from Products.CMFPlone.utils import _safe_format
     rules = dict([(m, True) for m in dir(str) if not m.startswith('_')])
-    rules['format'] = safe_format
+    rules['format'] = _safe_format
     allow_type(str, rules)
 
     # Same for unicode instead of str.
     rules = dict([(m, True) for m in dir(unicode) if not m.startswith('_')])
-    rules['format'] = safe_format
+    rules['format'] = _safe_format
     allow_type(unicode, rules)
 
     # Apply monkey patches
diff --git a/Products/CMFPlone/resources/browser/mixins.py b/Products/CMFPlone/resources/browser/mixins.py
index 47f1753..f9ffaf3 100644
--- a/Products/CMFPlone/resources/browser/mixins.py
+++ b/Products/CMFPlone/resources/browser/mixins.py
@@ -1,5 +1,5 @@
 from Products.CMFPlone.interfaces import IResourceRegistry
-from Products.CMFPlone.utils import safe_format
+from Products.CMFPlone.utils import SafeFormatter
 from Products.Five.browser import BrowserView
 from plone.registry.interfaces import IRegistry
 from urlparse import urlparse
diff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py
index abcd1a6..ebdb08e 100644
--- a/Products/CMFPlone/utils.py
+++ b/Products/CMFPlone/utils.py
@@ -789,8 +789,10 @@ def safe_format(self, *args, **kwargs):
         return self.vformat(self.value, args, kwargs)
 
 
-def safe_format(inst, method):
-    """
-    Use our SafeFormatter that uses guarded_getattr for attribute access
+def _safe_format(inst, method):
+    """Use our SafeFormatter that uses guarded_getattr for attribute access.
+
+    This is for use with AccessControl.allow_type,
+    as we do in CMFPlone/__init__.py.
     """
     return SafeFormatter(inst).safe_format


