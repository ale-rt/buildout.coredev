Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2016-01-28T16:34:32+01:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/4594d9f80708ecee3af5afde17a8f05675c00989

Fix cleanUpProductRegistry to not break when Control_Panel cannot be found.  Fixes test failures with Zope 4.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v40/alphas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b182d9b..c774eca 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,9 @@ New:
 
 Fixes:
 
-- *add item here*
+- Fix ``cleanUpProductRegistry`` to not break when ``Control_Panel`` cannot be found.
+  Fixes test failures with Zope 4.
+  [thet]
 
 
 1.3.20 (2016-01-08)
diff --git a/plone/app/upgrade/v40/alphas.py b/plone/app/upgrade/v40/alphas.py
index a5abb63..a43fbd7 100644
--- a/plone/app/upgrade/v40/alphas.py
+++ b/plone/app/upgrade/v40/alphas.py
@@ -385,12 +385,14 @@ def cleanUpSkinsTool(context):
 
 
 def cleanUpProductRegistry(context):
-    control = getattr(context, 'Control_Panel')
-    products = control.Products
-
-    # Remove all product entries
-    for name in products.keys():
-        products._delObject(name)
+    control = getattr(context, 'Control_Panel', None)
+    if control:
+        products = control.Products
+
+        # Remove all product entries
+        for name in products.keys():
+            products._delObject(name)
+    # else: pass  # Zope 4 doesn't have the Control_Panel anymore
 
 
 def migrateStaticTextPortlets(context):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2016-01-29T02:23:42+01:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/558e507f2625656de9295396f4c63ad462556e7b

Merge pull request #66 from plone/thet-zope4

Zope4

Files changed:
M CHANGES.rst
M plone/app/upgrade/v40/alphas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b182d9b..c774eca 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,9 @@ New:
 
 Fixes:
 
-- *add item here*
+- Fix ``cleanUpProductRegistry`` to not break when ``Control_Panel`` cannot be found.
+  Fixes test failures with Zope 4.
+  [thet]
 
 
 1.3.20 (2016-01-08)
diff --git a/plone/app/upgrade/v40/alphas.py b/plone/app/upgrade/v40/alphas.py
index a5abb63..a43fbd7 100644
--- a/plone/app/upgrade/v40/alphas.py
+++ b/plone/app/upgrade/v40/alphas.py
@@ -385,12 +385,14 @@ def cleanUpSkinsTool(context):
 
 
 def cleanUpProductRegistry(context):
-    control = getattr(context, 'Control_Panel')
-    products = control.Products
-
-    # Remove all product entries
-    for name in products.keys():
-        products._delObject(name)
+    control = getattr(context, 'Control_Panel', None)
+    if control:
+        products = control.Products
+
+        # Remove all product entries
+        for name in products.keys():
+            products._delObject(name)
+    # else: pass  # Zope 4 doesn't have the Control_Panel anymore
 
 
 def migrateStaticTextPortlets(context):


