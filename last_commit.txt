Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2016-08-28T21:25:33-05:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/0a65db107f64a75e0e44df981b1972e862fd4535

Change RelatedItemsFieldWidget configuration from ``@@add_translations`` view to support Mockup 2.4.0, so that the widget is able to navigate beyond the INavigationRoot boundary and to access other translation trees.
This change keeps compatibility with older versions of Mockup or Mockup-less setups.

Files changed:
M CHANGES.rst
M src/plone/app/multilingual/browser/interfaces.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5281cf2..3ea74b8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Change RelatedItemsFieldWidget configuration from ``@@add_translations`` view to support Mockup 2.4.0, so that the widget is able to navigate beyond the INavigationRoot boundary and to access other translation trees.
+  This change keeps compatibility with older versions of Mockup or Mockup-less setups.
+  [thet]
 
 
 4.0.3 (2016-08-15)
diff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py
index b05ebad..0e3cabc 100644
--- a/src/plone/app/multilingual/browser/interfaces.py
+++ b/src/plone/app/multilingual/browser/interfaces.py
@@ -1,15 +1,36 @@
 # -*- coding: utf-8 -*-
+from Acquisition import aq_parent
 from plone.app.multilingual import _
 from plone.app.multilingual.browser.vocabularies import deletable_languages
 from plone.app.multilingual.browser.vocabularies import untranslated_languages
+from plone.app.z3cform.widget import RelatedItemsFieldWidget
 from plone.autoform import directives
 from plone.autoform.interfaces import IFormFieldProvider
 from plone.supermodel import model
+from Products.CMFPlone.interfaces import IPloneSiteRoot
 from z3c.relationfield.schema import RelationChoice
 from zope import interface
 from zope import schema
 from zope.browsermenu.interfaces import IBrowserMenu
 from zope.browsermenu.interfaces import IBrowserSubMenuItem
+from zope.component.hooks import getSite
+
+import pkg_resources
+
+
+HAS_MOCKUP_240 = False
+try:
+    pkg_mockup = pkg_resources.get_distribution('mockup')
+    HAS_MOCKUP_240 = pkg_mockup.parsed_version >= pkg_resources.parse_version('2.4.0')  # noqa
+except pkg_resources.DistributionNotFound:
+    pass
+
+
+def make_relation_root_path(context):
+    ctx = getSite()
+    if not IPloneSiteRoot.providedBy(ctx):
+        ctx = aq_parent(ctx)
+    return u'/'.join(ctx.getPhysicalPath())
 
 
 class IMultilingualLayer(interface.Interface):
@@ -60,6 +81,15 @@ class IAddTranslation(model.Schema):
         required=True,
     )
 
+    if HAS_MOCKUP_240:
+        directives.widget(
+            'content',
+            RelatedItemsFieldWidget,
+            pattern_options={
+                'basePath': make_relation_root_path,
+            }
+        )
+
 
 class IRemoveTranslation(model.Schema):
 


Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2016-08-29T12:50:50+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/a4b76a44fa5a3c55e3baa59fd7c3506a85d05ea6

Merge pull request #245 from plone/thet-relateditemschanges

RelatedItems widget changes for Mockp 2.3.0

Files changed:
M CHANGES.rst
M src/plone/app/multilingual/browser/interfaces.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5281cf2..3ea74b8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Change RelatedItemsFieldWidget configuration from ``@@add_translations`` view to support Mockup 2.4.0, so that the widget is able to navigate beyond the INavigationRoot boundary and to access other translation trees.
+  This change keeps compatibility with older versions of Mockup or Mockup-less setups.
+  [thet]
 
 
 4.0.3 (2016-08-15)
diff --git a/src/plone/app/multilingual/browser/interfaces.py b/src/plone/app/multilingual/browser/interfaces.py
index b05ebad..0e3cabc 100644
--- a/src/plone/app/multilingual/browser/interfaces.py
+++ b/src/plone/app/multilingual/browser/interfaces.py
@@ -1,15 +1,36 @@
 # -*- coding: utf-8 -*-
+from Acquisition import aq_parent
 from plone.app.multilingual import _
 from plone.app.multilingual.browser.vocabularies import deletable_languages
 from plone.app.multilingual.browser.vocabularies import untranslated_languages
+from plone.app.z3cform.widget import RelatedItemsFieldWidget
 from plone.autoform import directives
 from plone.autoform.interfaces import IFormFieldProvider
 from plone.supermodel import model
+from Products.CMFPlone.interfaces import IPloneSiteRoot
 from z3c.relationfield.schema import RelationChoice
 from zope import interface
 from zope import schema
 from zope.browsermenu.interfaces import IBrowserMenu
 from zope.browsermenu.interfaces import IBrowserSubMenuItem
+from zope.component.hooks import getSite
+
+import pkg_resources
+
+
+HAS_MOCKUP_240 = False
+try:
+    pkg_mockup = pkg_resources.get_distribution('mockup')
+    HAS_MOCKUP_240 = pkg_mockup.parsed_version >= pkg_resources.parse_version('2.4.0')  # noqa
+except pkg_resources.DistributionNotFound:
+    pass
+
+
+def make_relation_root_path(context):
+    ctx = getSite()
+    if not IPloneSiteRoot.providedBy(ctx):
+        ctx = aq_parent(ctx)
+    return u'/'.join(ctx.getPhysicalPath())
 
 
 class IMultilingualLayer(interface.Interface):
@@ -60,6 +81,15 @@ class IAddTranslation(model.Schema):
         required=True,
     )
 
+    if HAS_MOCKUP_240:
+        directives.widget(
+            'content',
+            RelatedItemsFieldWidget,
+            pattern_options={
+                'basePath': make_relation_root_path,
+            }
+        )
+
 
 class IRemoveTranslation(model.Schema):
 


