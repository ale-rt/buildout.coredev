Repository: Products.PlonePAS


Branch: refs/heads/master
Date: 2016-04-27T11:54:11+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.PlonePAS/commit/9a6ddc2ab76e54a23562f36b12c490daf7fb1b60

Fix UnicodeDecodeError in searchForMembers by using safe_unicode

Files changed:
M CHANGES.rst
M src/Products/PlonePAS/tests/test_membershiptool.py
M src/Products/PlonePAS/tools/membership.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ea4c923..82f8e91 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New:
 
 Fixes:
 
-- *add item here*
+- Fix UnicodeDecodeError in searchForMembers by using safe_unicode.
+  [pbauer]
 
 
 5.0.9 (2016-03-03)
@@ -22,7 +23,7 @@ Fixes:
 
 New:
 
-- Notify new IGroupDeletedEvent when deleting a group.  
+- Notify new IGroupDeletedEvent when deleting a group.
   [DieKatze]
 
 
diff --git a/src/Products/PlonePAS/tests/test_membershiptool.py b/src/Products/PlonePAS/tests/test_membershiptool.py
index fb8396f..69ff2a2 100644
--- a/src/Products/PlonePAS/tests/test_membershiptool.py
+++ b/src/Products/PlonePAS/tests/test_membershiptool.py
@@ -851,8 +851,11 @@ def testSearchByRequestObj(self):
                        'juergen@example.com', ['Member'],
                        '2014-02-03')
 
-        self.assertEqual(len(search(
-            REQUEST=dict(name=u'jürgen'))), 1)
+        self.assertEqual(
+            len(search(REQUEST=dict(name=u'jürgen'))), 1)
+
+        self.assertEqual(
+            len(search(REQUEST=dict(name='jürgen'))), 1)
 
     def beforeTearDown(self):
         self._free_warning_output()
diff --git a/src/Products/PlonePAS/tools/membership.py b/src/Products/PlonePAS/tools/membership.py
index 22e516f..3771a75 100644
--- a/src/Products/PlonePAS/tools/membership.py
+++ b/src/Products/PlonePAS/tools/membership.py
@@ -27,6 +27,7 @@
 from Products.PlonePAS.events import UserLoggedOutEvent
 from Products.PlonePAS.interfaces import membership
 from Products.PlonePAS.utils import cleanId
+from Products.PlonePAS.utils import safe_unicode
 from Products.PlonePAS.utils import scale_image
 from ZODB.POSException import ConflictError
 from cStringIO import StringIO
@@ -53,7 +54,7 @@ def _unicodify_structure(value, charset=_marker):
         charset = ptool.getProperty('default_charset', None)
 
     if isinstance(value, str):
-        return charset and unicode(value, charset) or unicode(value)
+        return charset and safe_unicode(value, charset) or safe_unicode(value)
     if isinstance(value, list):
         return [_unicodify_structure(val, charset) for val in value]
     if isinstance(value, tuple):


