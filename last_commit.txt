Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-29T15:20:35+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/878d63824a5adb27948f324fa8da8c020d281e37

Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
Fixes https://github.com/plone/Products.CMFPlone/issues/2129

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6258004..f8d1055 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,7 +18,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
+  [pbauer]
 
 
 2.0.6 (2017-08-05)
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index d3ac232..d246b8c 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -17,7 +17,9 @@
 from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
+
 import logging
+import pkg_resources
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -364,6 +366,18 @@ def to50rc1(context):
         qi = get_installer(portal)
         if not qi.is_product_installed('plone.app.linkintegrity'):
             qi.install_product('plone.app.linkintegrity')
+
+    # If Products.PortalTransforms is >= 3.0.1.dev0 it has the new safe_html.
+    # Register and migrate the registry settings needed for it.
+    # Linkintegrity calls the transform when retrieving links from html-fields.
+    pt = pkg_resources.get_distribution('Products.PortalTransforms')
+    if pt.version >= '3.0.1.dev0':
+        from plone.app.upgrade.v51.betas import move_safe_html_settings_to_registry  # noqa: E501
+        from Products.CMFPlone.interfaces import IFilterSchema
+        registry = getUtility(IRegistry)
+        registry.registerInterface(IFilterSchema, prefix='plone')
+        move_safe_html_settings_to_registry(context)
+
     migrate_linkintegrity_relations(portal)
 
     upgrade_usergroups_controlpanel_settings(context)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-29T19:35:28+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/c70c97f077a7e0405db8b32396512fe40477e5b6

Merge pull request #132 from plone/fix_safe_html_before_linkintegrity_migration

Register settings for safe_html-Transform

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6258004..f8d1055 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,7 +18,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
+  [pbauer]
 
 
 2.0.6 (2017-08-05)
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index d3ac232..d246b8c 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -17,7 +17,9 @@
 from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
+
 import logging
+import pkg_resources
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -364,6 +366,18 @@ def to50rc1(context):
         qi = get_installer(portal)
         if not qi.is_product_installed('plone.app.linkintegrity'):
             qi.install_product('plone.app.linkintegrity')
+
+    # If Products.PortalTransforms is >= 3.0.1.dev0 it has the new safe_html.
+    # Register and migrate the registry settings needed for it.
+    # Linkintegrity calls the transform when retrieving links from html-fields.
+    pt = pkg_resources.get_distribution('Products.PortalTransforms')
+    if pt.version >= '3.0.1.dev0':
+        from plone.app.upgrade.v51.betas import move_safe_html_settings_to_registry  # noqa: E501
+        from Products.CMFPlone.interfaces import IFilterSchema
+        registry = getUtility(IRegistry)
+        registry.registerInterface(IFilterSchema, prefix='plone')
+        move_safe_html_settings_to_registry(context)
+
     migrate_linkintegrity_relations(portal)
 
     upgrade_usergroups_controlpanel_settings(context)


