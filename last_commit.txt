Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-12-03T17:55:50+01:00
Author: Gagaro (Gagaro) <gagaro42@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/24de09550cffc93337ac062a550de7aeaf4f8df9

fix: update getIcon metadata only in to501

Files changed:
M plone/app/upgrade/v50/final.py

diff --git a/plone/app/upgrade/v50/final.py b/plone/app/upgrade/v50/final.py
index 15b5dbb..01beec8 100644
--- a/plone/app/upgrade/v50/final.py
+++ b/plone/app/upgrade/v50/final.py
@@ -57,20 +57,27 @@ def refresh_getIcon_catalog_metadata(context):
         # get the more hidden, inner (real) catalog implementation
         catalog = zcatalog._catalog
         try:
+            # Get the getIcon index value and
             # check if there is a getIcon at all, this may not exist in some
             # customizations, who knows, but always exists in default Plone
-            catalog.names.index('getIcon')
+            metadata_index = catalog.names.index('getIcon')
         except ValueError:
             logger.info('`getIcon` not in metadata, skip upgrade step')
             return
+
+
         cnt = 0
         # search whole catalog
         for brain in zcatalog.unrestrictedSearchResults():
-            # create and apply metadata
-            catalog.data[brain.getRID()] = catalog.recordify(
-                # wake up object
-                brain._unrestrictedGetObject()
-            )
+            # First get the new value
+            obj = brain._unrestrictedGetObject()
+            new_value = bool(getattr(obj.aq_base, 'image', False))
+
+            # We can now update the record with the new getIcon value
+            record = list(catalog.data[brain.getRID()])
+            record[metadata_index] = new_value
+            catalog.data[brain.getRID()] = tuple(record)
+
             cnt += 1  # we are curious
         # done
         logger.info('Reindexed `getIcon` for %s items' % str(cnt))


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-12-04T15:26:56+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/c6bb01d8122fd28dadc10c903caefbab3739e3b9

Merge pull request #62 from plone/fix-getIcon-to501

fix: update getIcon metadata only in to501

Files changed:
M plone/app/upgrade/v50/final.py

diff --git a/plone/app/upgrade/v50/final.py b/plone/app/upgrade/v50/final.py
index 15b5dbb..01beec8 100644
--- a/plone/app/upgrade/v50/final.py
+++ b/plone/app/upgrade/v50/final.py
@@ -57,20 +57,27 @@ def refresh_getIcon_catalog_metadata(context):
         # get the more hidden, inner (real) catalog implementation
         catalog = zcatalog._catalog
         try:
+            # Get the getIcon index value and
             # check if there is a getIcon at all, this may not exist in some
             # customizations, who knows, but always exists in default Plone
-            catalog.names.index('getIcon')
+            metadata_index = catalog.names.index('getIcon')
         except ValueError:
             logger.info('`getIcon` not in metadata, skip upgrade step')
             return
+
+
         cnt = 0
         # search whole catalog
         for brain in zcatalog.unrestrictedSearchResults():
-            # create and apply metadata
-            catalog.data[brain.getRID()] = catalog.recordify(
-                # wake up object
-                brain._unrestrictedGetObject()
-            )
+            # First get the new value
+            obj = brain._unrestrictedGetObject()
+            new_value = bool(getattr(obj.aq_base, 'image', False))
+
+            # We can now update the record with the new getIcon value
+            record = list(catalog.data[brain.getRID()])
+            record[metadata_index] = new_value
+            catalog.data[brain.getRID()] = tuple(record)
+
             cnt += 1  # we are curious
         # done
         logger.info('Reindexed `getIcon` for %s items' % str(cnt))


