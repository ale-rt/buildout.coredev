Repository: plone.outputfilters


Branch: refs/heads/1.x
Date: 2017-01-31T16:35:24+01:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.outputfilters/commit/886e471014ed0d87a8973c3ee698c46c619fea44

Do not transform a and img tags when inside script tag.

Files changed:
M CHANGES.rst
M plone/outputfilters/filters/resolveuid_and_caption.py
M plone/outputfilters/tests/test_resolveuid_and_caption.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0bc08c7..39369f9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Do not transform a and img tags when inside script tag.
+  [gotcha]
 
 
 1.15.2 (2016-11-09)
diff --git a/plone/outputfilters/filters/resolveuid_and_caption.py b/plone/outputfilters/filters/resolveuid_and_caption.py
index e1839a9..0d1450e 100644
--- a/plone/outputfilters/filters/resolveuid_and_caption.py
+++ b/plone/outputfilters/filters/resolveuid_and_caption.py
@@ -79,6 +79,7 @@ def __init__(self, context=None, request=None):
         self.request = request
         self.pieces = []
         self.in_link = False
+        self.in_script = False
 
     # IFilter implementation
     order = 800
@@ -317,7 +318,9 @@ def unknown_starttag(self, tag, attrs):
 
         Convert UUID's to absolute URLs, and process captioned images to HTML.
         """
-        if tag in ['a', 'img', 'area']:
+        if tag == 'script':
+            self.in_script = True
+        if tag in ['a', 'img', 'area'] and not self.in_script:
             # Only do something if tag is a link, image, or image map area.
 
             attributes = dict(attrs)
@@ -381,6 +384,8 @@ def unknown_endtag(self, tag):
         """Add the endtag unmodified"""
         if tag == 'a':
             self.in_link = False
+        if tag == 'script':
+            self.in_script = False
         self.append_data("</%s>" % tag)
 
     def parse_declaration(self, i):
diff --git a/plone/outputfilters/tests/test_resolveuid_and_caption.py b/plone/outputfilters/tests/test_resolveuid_and_caption.py
index 1959366..09d6e8f 100644
--- a/plone/outputfilters/tests/test_resolveuid_and_caption.py
+++ b/plone/outputfilters/tests/test_resolveuid_and_caption.py
@@ -424,5 +424,13 @@ def test_resolve_uids_with_bigU(self):
     def test_singleton_elements(self):
         self._assertTransformsTo('<hr/>\r\n<p>foo</p><br/>', '<hr />\r\n<p>foo</p><br />')
 
+    def test_no_change_when_a_in_script(self):
+        text_in = """<script>a='<a href="">test</a>';</script>"""
+        self._assertTransformsTo(text_in, text_in)
+
+    def test_no_change_when_img_in_script(self):
+        text_in = """<script>a='<img src="image.jpg" />';</script>"""
+        self._assertTransformsTo(text_in, text_in)
+
 def test_suite():
     return unittest.defaultTestLoader.loadTestsFromName(__name__)


Repository: plone.outputfilters


Branch: refs/heads/1.x
Date: 2017-01-31T16:37:00+01:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.outputfilters/commit/e1ee4131ea84c1080a806eb23f09351dcfb340e8

tune MANIFEST

Files changed:
M MANIFEST.in

diff --git a/MANIFEST.in b/MANIFEST.in
index 6acb23e..89f400a 100644
--- a/MANIFEST.in
+++ b/MANIFEST.in
@@ -4,3 +4,5 @@ recursive-include docs *
 recursive-include plone *
 
 global-exclude *pyc
+exclude bootstrap.py
+exclude buildout.cfg


Repository: plone.outputfilters


Branch: refs/heads/1.x
Date: 2017-01-31T16:38:13+01:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.outputfilters/commit/0a9c7847a81f27cb65b26d96e6d89bd5319c2768

Preparing release 1.15.3

Files changed:
M CHANGES.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 39369f9..b5f1078 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,17 +1,9 @@
 Changelog
 =========
 
-1.15.3 (unreleased)
+1.15.3 (2017-01-31)
 -------------------
 
-Breaking changes:
-
-- *add item here*
-
-New features:
-
-- *add item here*
-
 Bug fixes:
 
 - Do not transform a and img tags when inside script tag.
diff --git a/setup.py b/setup.py
index 66353f9..3a77f49 100644
--- a/setup.py
+++ b/setup.py
@@ -1,7 +1,7 @@
 from setuptools import setup, find_packages
 import os
 
-version = '1.15.3.dev0'
+version = '1.15.3'
 
 setup(name='plone.outputfilters',
       version=version,


Repository: plone.outputfilters


Branch: refs/heads/1.x
Date: 2017-01-31T16:38:49+01:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.outputfilters/commit/01ca312c880d8c2787d4866d8712677744e69f0a

Back to development: 1.15.4

Files changed:
M CHANGES.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b5f1078..1eedf43 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,6 +1,12 @@
 Changelog
 =========
 
+1.15.4 (unreleased)
+-------------------
+
+- Nothing changed yet.
+
+
 1.15.3 (2017-01-31)
 -------------------
 
diff --git a/setup.py b/setup.py
index 3a77f49..f3b8c83 100644
--- a/setup.py
+++ b/setup.py
@@ -1,7 +1,7 @@
 from setuptools import setup, find_packages
 import os
 
-version = '1.15.3'
+version = '1.15.4.dev0'
 
 setup(name='plone.outputfilters',
       version=version,


