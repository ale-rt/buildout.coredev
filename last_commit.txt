Repository: plone.outputfilters


Branch: refs/heads/master
Date: 2017-01-31T16:39:49+01:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.outputfilters/commit/b41fd294f1ea3d96e4911bbed1678e04ec58601e

tune MANIFEST

Files changed:
M MANIFEST.in

diff --git a/MANIFEST.in b/MANIFEST.in
index 01911b5..fb5c151 100644
--- a/MANIFEST.in
+++ b/MANIFEST.in
@@ -4,3 +4,5 @@ graft docs
 graft plone
 
 global-exclude *pyc
+exclude bootstrap.py
+exclude buildout.cfg


Repository: plone.outputfilters


Branch: refs/heads/master
Date: 2017-01-31T16:41:37+01:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.outputfilters/commit/6a1bf87101dfc43a95285a2bfc4593591181f48b

Do not transform a and img tags when inside script tag.

Files changed:
M CHANGES.rst
M plone/outputfilters/filters/resolveuid_and_caption.py
M plone/outputfilters/tests/test_resolveuid_and_caption.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ab4d39f..5a7f147 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Do not transform a and img tags when inside script tag.
+  [gotcha]
 
 
 3.0.0 (2016-08-19)
diff --git a/plone/outputfilters/filters/resolveuid_and_caption.py b/plone/outputfilters/filters/resolveuid_and_caption.py
index 2972073..0eb1160 100644
--- a/plone/outputfilters/filters/resolveuid_and_caption.py
+++ b/plone/outputfilters/filters/resolveuid_and_caption.py
@@ -75,6 +75,7 @@ def __init__(self, context=None, request=None):
         self.request = request
         self.pieces = []
         self.in_link = False
+        self.in_script = False
 
     # IFilter implementation
     order = 800
@@ -320,7 +321,9 @@ def unknown_starttag(self, tag, attrs):
 
         Convert UUID's to absolute URLs, and process captioned images to HTML.
         """
-        if tag in ['a', 'img', 'area']:
+        if tag == 'script':
+            self.in_script = True
+        if tag in ['a', 'img', 'area'] and not self.in_script:
             # Only do something if tag is a link, image, or image map area.
 
             attributes = dict(attrs)
@@ -393,6 +396,8 @@ def unknown_endtag(self, tag):
         """Add the endtag unmodified"""
         if tag == 'a':
             self.in_link = False
+        if tag == 'script':
+            self.in_script = False
         self.append_data("</%s>" % tag)
 
     def parse_declaration(self, i):
diff --git a/plone/outputfilters/tests/test_resolveuid_and_caption.py b/plone/outputfilters/tests/test_resolveuid_and_caption.py
index d817424..46a0d76 100644
--- a/plone/outputfilters/tests/test_resolveuid_and_caption.py
+++ b/plone/outputfilters/tests/test_resolveuid_and_caption.py
@@ -433,3 +433,11 @@ def test_resolve_uids_with_bigU(self):
     def test_singleton_elements(self):
         self._assertTransformsTo(
             '<hr/>\r\n<p>foo</p><br/>', '<hr />\r\n<p>foo</p><br />')
+
+    def test_no_change_when_a_in_script(self):
+        text_in = """<script>a='<a href="">test</a>';</script>"""
+        self._assertTransformsTo(text_in, text_in)
+
+    def test_no_change_when_img_in_script(self):
+        text_in = """<script>a='<img src="image.jpg" />';</script>"""
+        self._assertTransformsTo(text_in, text_in)


