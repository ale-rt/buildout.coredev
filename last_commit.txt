Repository: plone.app.search


Branch: refs/heads/1.1.x
Date: 2016-12-06T22:51:54+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.search/commit/8a291c44e78b86c8d3d09d06ea94518503a3446d

Fixed sometimes failing search order tests.

Files changed:
M CHANGES.rst
M plone/app/search/tests/base.py
M plone/app/search/tests/test_integration.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c0bfc2d..6f6fc70 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed sometimes failing search order tests.  [maurits]
 
 
 1.1.10 (2016-12-02)
diff --git a/plone/app/search/tests/base.py b/plone/app/search/tests/base.py
index e706942..82ec247 100644
--- a/plone/app/search/tests/base.py
+++ b/plone/app/search/tests/base.py
@@ -1,4 +1,5 @@
 import sys
+import time
 import unittest2 as unittest
 
 from zope.configuration import xmlconfig
@@ -56,12 +57,15 @@ def setUpPloneSite(self, portal):
         applyProfile(portal, 'plone.app.search:default')
         setRoles(portal, TEST_USER_ID, ['Manager'])
         login(portal, TEST_USER_NAME)
-        for i in range(0, 100):
+        for i in range(0, 12):
             portal.invokeFactory(
                 'Document',
                 'my-page' + str(i),
                 text='spam spam ham eggs'
             )
+            # Sleep before creating the next one, otherwise ordering by date is
+            # not deterministic.
+            time.sleep(0.1)
         setRoles(portal, TEST_USER_ID, ['Member'])
 
         # Commit so that the test browser sees these objects
diff --git a/plone/app/search/tests/test_integration.py b/plone/app/search/tests/test_integration.py
index b6d88a6..0e13f0f 100644
--- a/plone/app/search/tests/test_integration.py
+++ b/plone/app/search/tests/test_integration.py
@@ -76,8 +76,8 @@ def test_default_search_order_relevance(self):
         res = portal.restrictedTraverse('@@search').results(query=q)
         ids = [r.getId() for r in res]
         expected = [
-            'my-page99', 'my-page98', 'my-page97', 'my-page96', 'my-page95',
-            'my-page94', 'my-page93', 'my-page92', 'my-page91', 'my-page90'
+            'my-page11', 'my-page10', 'my-page9', 'my-page8', 'my-page7',
+            'my-page6', 'my-page5', 'my-page4', 'my-page3', 'my-page2'
         ]
         self.assertEqual(ids, expected)
 
@@ -96,8 +96,8 @@ def test_default_search_order_date(self):
         res = portal.restrictedTraverse('@@search').results(query=q)
         ids = [r.getId() for r in res]
         expected = [
-            'my-page10', 'my-page9', 'my-page8', 'my-page7', 'my-page6',
-            'my-page4', 'my-page3', 'my-page2', 'my-page1', 'my-page0'
+            'my-page11', 'my-page10', 'my-page9', 'my-page8', 'my-page7',
+            'my-page6', 'my-page4', 'my-page3', 'my-page2', 'my-page1'
         ]
         self.assertEqual(ids, expected)
 


Repository: plone.app.search


Branch: refs/heads/1.1.x
Date: 2016-12-06T23:29:16+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.search/commit/d7e6e43911fe1e85b634a5084d1226996b63c529

Merge pull request #21 from plone/fix-search-order-tests-11

Fixed sometimes failing search order tests.

Files changed:
M CHANGES.rst
M plone/app/search/tests/base.py
M plone/app/search/tests/test_integration.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c0bfc2d..6f6fc70 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed sometimes failing search order tests.  [maurits]
 
 
 1.1.10 (2016-12-02)
diff --git a/plone/app/search/tests/base.py b/plone/app/search/tests/base.py
index e706942..82ec247 100644
--- a/plone/app/search/tests/base.py
+++ b/plone/app/search/tests/base.py
@@ -1,4 +1,5 @@
 import sys
+import time
 import unittest2 as unittest
 
 from zope.configuration import xmlconfig
@@ -56,12 +57,15 @@ def setUpPloneSite(self, portal):
         applyProfile(portal, 'plone.app.search:default')
         setRoles(portal, TEST_USER_ID, ['Manager'])
         login(portal, TEST_USER_NAME)
-        for i in range(0, 100):
+        for i in range(0, 12):
             portal.invokeFactory(
                 'Document',
                 'my-page' + str(i),
                 text='spam spam ham eggs'
             )
+            # Sleep before creating the next one, otherwise ordering by date is
+            # not deterministic.
+            time.sleep(0.1)
         setRoles(portal, TEST_USER_ID, ['Member'])
 
         # Commit so that the test browser sees these objects
diff --git a/plone/app/search/tests/test_integration.py b/plone/app/search/tests/test_integration.py
index b6d88a6..0e13f0f 100644
--- a/plone/app/search/tests/test_integration.py
+++ b/plone/app/search/tests/test_integration.py
@@ -76,8 +76,8 @@ def test_default_search_order_relevance(self):
         res = portal.restrictedTraverse('@@search').results(query=q)
         ids = [r.getId() for r in res]
         expected = [
-            'my-page99', 'my-page98', 'my-page97', 'my-page96', 'my-page95',
-            'my-page94', 'my-page93', 'my-page92', 'my-page91', 'my-page90'
+            'my-page11', 'my-page10', 'my-page9', 'my-page8', 'my-page7',
+            'my-page6', 'my-page5', 'my-page4', 'my-page3', 'my-page2'
         ]
         self.assertEqual(ids, expected)
 
@@ -96,8 +96,8 @@ def test_default_search_order_date(self):
         res = portal.restrictedTraverse('@@search').results(query=q)
         ids = [r.getId() for r in res]
         expected = [
-            'my-page10', 'my-page9', 'my-page8', 'my-page7', 'my-page6',
-            'my-page4', 'my-page3', 'my-page2', 'my-page1', 'my-page0'
+            'my-page11', 'my-page10', 'my-page9', 'my-page8', 'my-page7',
+            'my-page6', 'my-page4', 'my-page3', 'my-page2', 'my-page1'
         ]
         self.assertEqual(ids, expected)
 


