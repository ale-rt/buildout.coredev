Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2016-05-08T23:06:32+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/2e0be405c803aace1d82d258d72fdfccd6086fa5

deferred initialize to reduce costs of adapter lookup.

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/collection.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0df3471..a9fe553 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,11 @@ New:
 
 Fixes:
 
+- Deferred adapter lookup in collection view.
+  This was looked up for contentmenu/toolbar at every authenticated request.
+  It also had side effects if custom collection behaviors are used.
+  [jensens]
+
 - Fixed unstable robot test for location criterion.  [maurits]
 
 - Don't fail for ``utils.replace_link_variables_by_paths``, if value is ``None``.
diff --git a/plone/app/contenttypes/browser/collection.py b/plone/app/contenttypes/browser/collection.py
index 55b3333..8ce752f 100644
--- a/plone/app/contenttypes/browser/collection.py
+++ b/plone/app/contenttypes/browser/collection.py
@@ -10,11 +10,18 @@
 
 class CollectionView(FolderView):
 
-    def __init__(self, *args, **kwargs):
-        super(CollectionView, self).__init__(*args, **kwargs)
-        context = aq_inner(self.context)
-        self.collection_behavior = ICollection(context)
-        self.b_size = self.collection_behavior.item_count
+    @property
+    def collection_behavior(self):
+        return ICollection(aq_inner(self.context))
+
+    @property
+    def b_size(self):
+        return getattr(self, '_b_size', self.collection_behavior.item_count)
+
+    @b_size.setter
+    def b_size(self, value):
+        # ignore, FolderView tries to set on init
+        pass
 
     def results(self, **kwargs):
         """Return a content listing based result set with results from the


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2016-05-09T01:16:01+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/1ec22b9556879741a630ff4b72bec86838da8990

Merge pull request #348 from plone/jensens-deferred-adapter-lookup

deferred initialize to reduce costs of adapter lookup.

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/collection.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0df3471..a9fe553 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,11 @@ New:
 
 Fixes:
 
+- Deferred adapter lookup in collection view.
+  This was looked up for contentmenu/toolbar at every authenticated request.
+  It also had side effects if custom collection behaviors are used.
+  [jensens]
+
 - Fixed unstable robot test for location criterion.  [maurits]
 
 - Don't fail for ``utils.replace_link_variables_by_paths``, if value is ``None``.
diff --git a/plone/app/contenttypes/browser/collection.py b/plone/app/contenttypes/browser/collection.py
index 55b3333..8ce752f 100644
--- a/plone/app/contenttypes/browser/collection.py
+++ b/plone/app/contenttypes/browser/collection.py
@@ -10,11 +10,18 @@
 
 class CollectionView(FolderView):
 
-    def __init__(self, *args, **kwargs):
-        super(CollectionView, self).__init__(*args, **kwargs)
-        context = aq_inner(self.context)
-        self.collection_behavior = ICollection(context)
-        self.b_size = self.collection_behavior.item_count
+    @property
+    def collection_behavior(self):
+        return ICollection(aq_inner(self.context))
+
+    @property
+    def b_size(self):
+        return getattr(self, '_b_size', self.collection_behavior.item_count)
+
+    @b_size.setter
+    def b_size(self, value):
+        # ignore, FolderView tries to set on init
+        pass
 
     def results(self, **kwargs):
         """Return a content listing based result set with results from the


