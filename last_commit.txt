Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-04-13T23:56:44+02:00
Author: root (fgrcon) <franz@fgrcon.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/9c708b5e863cf971f31b899d8250bfaa928c88e3

new metadata catalog column mime_type

https://github.com/plone/Products.CMFPlone/issues/1995

Files changed:
A plone/app/upgrade/v51/profiles/to_beta4/catalog.xml
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 3460c0c..d9609cc 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -13,6 +13,10 @@ New features:
 - Add Plone 5.1 beta 4 upgrade profile.
   [thet]
 
+- new metadata catalog column mime_type
+  https://github.com/plone/Products.CMFPlone/issues/1995
+  [fgrcon]
+
 Bug fixes:
 
 - Do not convert/fail on None while update_social_media_fields
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 4585b5e..40b1646 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -134,3 +134,36 @@ def update_social_media_fields(context):
     if settings.facebook_username:
         settings.facebook_username = str(settings.facebook_username)
     logger.log(logging.INFO, 'Field types updated on social media schema')
+
+
+def reindex_mime_type(context):
+    # Attention, this relies heavily on catalog internals.
+    # get the more visible zcatalog
+    zcatalog = getToolByName(context, 'portal_catalog')
+    # get the more hidden, inner (real) catalog implementation
+    catalog = zcatalog._catalog
+    try:
+        metadata_index = catalog.names.index('mime_type')
+    except ValueError:
+        logger.info('`mime_type` not in metadata, skip upgrade step')
+        return
+    # we are interested in dexterity and archtetype images and files:
+    ifaces = ['plone.app.contenttypes.interfaces.IImage',
+              'plone.app.contenttypes.interfaces.IFile',
+              'Products.ATContentTypes.interfaces.file.IFileContent',
+              'Products.ATContentTypes.interfaces.image.IImageContent']
+    cnt = 0
+    for brain in zcatalog.unrestrictedSearchResults(object_provides=ifaces):
+        obj = brain._unrestrictedGetObject()
+        # First get the new value:
+        new_value = ''
+        try:  # Dexterity
+            new_value = obj.content_type()
+        except TypeError:  # Archetypes
+            new_value = obj.content_type
+        # We can now update the record with the new mime_type value
+        record = list(catalog.data[brain.getRID()])
+        record[metadata_index] = new_value
+        catalog.data[brain.getRID()] = tuple(record)
+        cnt += 1
+    logger.info('Reindexed `mime_type` for %s items' % str(cnt))
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index c6c7e9a..58188b5 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -133,17 +133,21 @@ Add image scaling options to image handling control panel.
         destination="5107"
         profile="Products.CMFPlone:plone">
 
+        <gs:upgradeDepends
+            title="Run to51beta4 upgrade profile."
+            description="New metadata column `mime_type`.
+                         Update plone-logged-in bundle."
+            import_profile="plone.app.upgrade.v51:to51beta4"
+            />
+
         <gs:upgradeStep
             title="Fix double shared maxage"
             handler="..v50.final.fix_double_smaxage"
             />
 
-        <gs:upgradeDepends
-            title="Run to51beta4 upgrade profile."
-            description="
-Update plone-logged-in bundle.
-            "
-            import_profile="plone.app.upgrade.v51:to51beta4"
+        <gs:upgradeStep
+            title="Reindex mime_type"
+            handler=".betas.reindex_mime_type"
             />
 
     </gs:upgradeSteps>
diff --git a/plone/app/upgrade/v51/profiles/to_beta4/catalog.xml b/plone/app/upgrade/v51/profiles/to_beta4/catalog.xml
new file mode 100644
index 0000000..3cf2162
--- /dev/null
+++ b/plone/app/upgrade/v51/profiles/to_beta4/catalog.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<object name="portal_catalog" meta_type="Plone Catalog Tool">
+  <column value="mime_type"/>
+</object>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-04-14T01:23:06+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/cf9ae8859a3ee2072727a5e0f71bcbcf3800ea2a

Merge pull request #111 from plone/fgrcon-1995

new metadata catalog column mime_type

Files changed:
A plone/app/upgrade/v51/profiles/to_beta4/catalog.xml
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 3460c0c..d9609cc 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -13,6 +13,10 @@ New features:
 - Add Plone 5.1 beta 4 upgrade profile.
   [thet]
 
+- new metadata catalog column mime_type
+  https://github.com/plone/Products.CMFPlone/issues/1995
+  [fgrcon]
+
 Bug fixes:
 
 - Do not convert/fail on None while update_social_media_fields
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 4585b5e..40b1646 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -134,3 +134,36 @@ def update_social_media_fields(context):
     if settings.facebook_username:
         settings.facebook_username = str(settings.facebook_username)
     logger.log(logging.INFO, 'Field types updated on social media schema')
+
+
+def reindex_mime_type(context):
+    # Attention, this relies heavily on catalog internals.
+    # get the more visible zcatalog
+    zcatalog = getToolByName(context, 'portal_catalog')
+    # get the more hidden, inner (real) catalog implementation
+    catalog = zcatalog._catalog
+    try:
+        metadata_index = catalog.names.index('mime_type')
+    except ValueError:
+        logger.info('`mime_type` not in metadata, skip upgrade step')
+        return
+    # we are interested in dexterity and archtetype images and files:
+    ifaces = ['plone.app.contenttypes.interfaces.IImage',
+              'plone.app.contenttypes.interfaces.IFile',
+              'Products.ATContentTypes.interfaces.file.IFileContent',
+              'Products.ATContentTypes.interfaces.image.IImageContent']
+    cnt = 0
+    for brain in zcatalog.unrestrictedSearchResults(object_provides=ifaces):
+        obj = brain._unrestrictedGetObject()
+        # First get the new value:
+        new_value = ''
+        try:  # Dexterity
+            new_value = obj.content_type()
+        except TypeError:  # Archetypes
+            new_value = obj.content_type
+        # We can now update the record with the new mime_type value
+        record = list(catalog.data[brain.getRID()])
+        record[metadata_index] = new_value
+        catalog.data[brain.getRID()] = tuple(record)
+        cnt += 1
+    logger.info('Reindexed `mime_type` for %s items' % str(cnt))
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index c6c7e9a..58188b5 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -133,17 +133,21 @@ Add image scaling options to image handling control panel.
         destination="5107"
         profile="Products.CMFPlone:plone">
 
+        <gs:upgradeDepends
+            title="Run to51beta4 upgrade profile."
+            description="New metadata column `mime_type`.
+                         Update plone-logged-in bundle."
+            import_profile="plone.app.upgrade.v51:to51beta4"
+            />
+
         <gs:upgradeStep
             title="Fix double shared maxage"
             handler="..v50.final.fix_double_smaxage"
             />
 
-        <gs:upgradeDepends
-            title="Run to51beta4 upgrade profile."
-            description="
-Update plone-logged-in bundle.
-            "
-            import_profile="plone.app.upgrade.v51:to51beta4"
+        <gs:upgradeStep
+            title="Reindex mime_type"
+            handler=".betas.reindex_mime_type"
             />
 
     </gs:upgradeSteps>
diff --git a/plone/app/upgrade/v51/profiles/to_beta4/catalog.xml b/plone/app/upgrade/v51/profiles/to_beta4/catalog.xml
new file mode 100644
index 0000000..3cf2162
--- /dev/null
+++ b/plone/app/upgrade/v51/profiles/to_beta4/catalog.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<object name="portal_catalog" meta_type="Plone Catalog Tool">
+  <column value="mime_type"/>
+</object>


