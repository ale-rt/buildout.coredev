Repository: Products.PlonePAS


Branch: refs/heads/master
Date: 2016-05-13T15:01:10+02:00
Author: Rene Jochum (pcdummy) <rene@jochums.at>
Commit: https://github.com/plone/Products.PlonePAS/commit/f3eb8c0dae3de161f6348d329ebb7f6ec3c45899

Use the _marker from CMFCore for MemberDataTool.

Signed-off-by: Rene Jochum &lt;rene@jochums.at&gt;

Files changed:
M CHANGES.rst
M src/Products/PlonePAS/tools/memberdata.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5c3721c..aa4910f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Use the _marker from CMFCore for MemberDataTool.getProperty,
+  this makes sure that we never return the _marker from PlonePAS
+  but an error.
+  [pcdummy]
 
 
 5.0.10 (2016-05-02)
diff --git a/src/Products/PlonePAS/tools/memberdata.py b/src/Products/PlonePAS/tools/memberdata.py
index 3115f8f..fda3f21 100644
--- a/src/Products/PlonePAS/tools/memberdata.py
+++ b/src/Products/PlonePAS/tools/memberdata.py
@@ -4,6 +4,7 @@
 from Acquisition import aq_base
 from App.class_init import InitializeClass
 from Products.BTreeFolder2.BTreeFolder2 import BTreeFolder2
+from Products.CMFCore.MemberDataTool import _marker
 from Products.CMFCore.MemberDataTool import MemberData as BaseMemberData
 from Products.CMFCore.MemberDataTool import MemberDataTool as BaseTool
 from Products.CMFCore.permissions import ManagePortal
@@ -23,8 +24,6 @@
     IRoleAssignerPlugin
 from zope.interface import implementer
 
-_marker = object()
-
 
 class MemberDataTool(BaseTool):
     """PAS-specific implementation of memberdata tool.


Repository: Products.PlonePAS


Branch: refs/heads/master
Date: 2016-05-13T21:12:06+02:00
Author: Rene Jochum (pcdummy) <rene@jochums.at>
Commit: https://github.com/plone/Products.PlonePAS/commit/34d2c86432c6c22d144c1414816a84b1d3d062f3

Don't raise a ValueError if a property doesn't exists.

Signed-off-by: Rene Jochum &lt;rene@jochums.at&gt;

Files changed:
M CHANGES.rst
M src/Products/PlonePAS/tools/memberdata.py

diff --git a/CHANGES.rst b/CHANGES.rst
index aa4910f..b5ed7f2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -19,6 +19,10 @@ Bug fixes:
   but an error.
   [pcdummy]
 
+- Don't raise an ValueError if a property doesn't exists for a ZOPE
+  user.
+  [pcdummy]
+
 
 5.0.10 (2016-05-02)
 -------------------
diff --git a/src/Products/PlonePAS/tools/memberdata.py b/src/Products/PlonePAS/tools/memberdata.py
index fda3f21..3458f6d 100644
--- a/src/Products/PlonePAS/tools/memberdata.py
+++ b/src/Products/PlonePAS/tools/memberdata.py
@@ -301,7 +301,13 @@ def getProperty(self, id, default=_marker):
             # we won't always have PlonePAS users, due to acquisition,
             # nor are guaranteed property sheets
             if not sheets:
-                return BaseMemberData.getProperty(self, id, default)
+                try:
+                    return BaseMemberData.getProperty(self, id, default)
+                except ValueError:
+                    # Zope users don't have PropertySheets,
+                    # return an empty string for them if the property
+                    # doesn't exists.
+                    return ''
 
         # If we made this far, we found a PAS and some property sheets.
         for sheet in sheets:


Repository: Products.PlonePAS


Branch: refs/heads/master
Date: 2016-05-17T10:13:25+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/Products.PlonePAS/commit/089fca605b5ac7cea013c906dbcafb2b53a05191

Merge pull request #18 from plone/marker_fix

Use the _marker from CMFCore for MemberDataTool.

Files changed:
M CHANGES.rst
M src/Products/PlonePAS/tools/memberdata.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5c3721c..b5ed7f2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,14 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Use the _marker from CMFCore for MemberDataTool.getProperty,
+  this makes sure that we never return the _marker from PlonePAS
+  but an error.
+  [pcdummy]
+
+- Don't raise an ValueError if a property doesn't exists for a ZOPE
+  user.
+  [pcdummy]
 
 
 5.0.10 (2016-05-02)
diff --git a/src/Products/PlonePAS/tools/memberdata.py b/src/Products/PlonePAS/tools/memberdata.py
index 3115f8f..3458f6d 100644
--- a/src/Products/PlonePAS/tools/memberdata.py
+++ b/src/Products/PlonePAS/tools/memberdata.py
@@ -4,6 +4,7 @@
 from Acquisition import aq_base
 from App.class_init import InitializeClass
 from Products.BTreeFolder2.BTreeFolder2 import BTreeFolder2
+from Products.CMFCore.MemberDataTool import _marker
 from Products.CMFCore.MemberDataTool import MemberData as BaseMemberData
 from Products.CMFCore.MemberDataTool import MemberDataTool as BaseTool
 from Products.CMFCore.permissions import ManagePortal
@@ -23,8 +24,6 @@
     IRoleAssignerPlugin
 from zope.interface import implementer
 
-_marker = object()
-
 
 class MemberDataTool(BaseTool):
     """PAS-specific implementation of memberdata tool.
@@ -302,7 +301,13 @@ def getProperty(self, id, default=_marker):
             # we won't always have PlonePAS users, due to acquisition,
             # nor are guaranteed property sheets
             if not sheets:
-                return BaseMemberData.getProperty(self, id, default)
+                try:
+                    return BaseMemberData.getProperty(self, id, default)
+                except ValueError:
+                    # Zope users don't have PropertySheets,
+                    # return an empty string for them if the property
+                    # doesn't exists.
+                    return ''
 
         # If we made this far, we found a PAS and some property sheets.
         for sheet in sheets:


