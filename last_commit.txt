Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-05-05T16:34:52+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/12f4bcd673af202ad70cec8aeac0d4f7993e78eb

Catch warning the pythonic way

Files changed:
M CHANGES.rst
M plone/app/upgrade/tests/base.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ce8e180..5ca7279 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,6 +15,10 @@ New features:
 
 Bug fixes:
 
+- Catch warning the pythonic way. 
+  Makes it work with latest CMFCore.
+  [jensens]
+
 - Fix and ``AttributeError`` for the Plone 5.1 beta 4 upgrade.
   [thet]
 
diff --git a/plone/app/upgrade/tests/base.py b/plone/app/upgrade/tests/base.py
index 69578ce..a9a58b5 100644
--- a/plone/app/upgrade/tests/base.py
+++ b/plone/app/upgrade/tests/base.py
@@ -9,13 +9,13 @@
 from plone.app.testing.bbb import PloneTestCase
 from Products.CMFCore.interfaces import IActionCategory
 from Products.CMFCore.interfaces import IActionInfo
-from Products.CMFCore.tests.base.testcase import WarningInterceptor
 from Products.CMFCore.utils import getToolByName
 from Products.GenericSetup.context import TarballImportContext
 from zope.configuration import xmlconfig
 from zope.site.hooks import setSite
 
 import transaction
+import warnings
 
 #
 # Base TestCase for upgrades
@@ -150,7 +150,7 @@ def removeSkinLayer(self, layer, skin='Plone Default'):
             skins.addSkinSelection(skin, ','.join(path))
 
 
-class FunctionalUpgradeTestCase(PloneTestCase, WarningInterceptor):
+class FunctionalUpgradeTestCase(PloneTestCase):
 
     _setup_fixture = 0
     site_id = 'test'
@@ -168,9 +168,8 @@ def beforeTearDown(self):
 
     def importFile(self, context, name):
         path = join(abspath(dirname(context)), 'data', name)
-        self._trap_warning_output()
-        self.app._importObjectFromFile(path, verify=0)
-        self._free_warning_output()
+        with warnings.catch_warnings():
+            self.app._importObjectFromFile(path, verify=0)
 
     def migrate(self):
         oldsite = getattr(self.app, self.site_id)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-05-08T09:33:15+02:00
Author: agitator (agitator) <agitator@users.noreply.github.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/9caddc34a1264ea22df5e9be29f2a68e02f4cfdc

Merge pull request #120 from plone/remove-WarningsInterceptor

Catch warning the pythonic way

Files changed:
M CHANGES.rst
M plone/app/upgrade/tests/base.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ce8e180..5ca7279 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,6 +15,10 @@ New features:
 
 Bug fixes:
 
+- Catch warning the pythonic way. 
+  Makes it work with latest CMFCore.
+  [jensens]
+
 - Fix and ``AttributeError`` for the Plone 5.1 beta 4 upgrade.
   [thet]
 
diff --git a/plone/app/upgrade/tests/base.py b/plone/app/upgrade/tests/base.py
index 69578ce..a9a58b5 100644
--- a/plone/app/upgrade/tests/base.py
+++ b/plone/app/upgrade/tests/base.py
@@ -9,13 +9,13 @@
 from plone.app.testing.bbb import PloneTestCase
 from Products.CMFCore.interfaces import IActionCategory
 from Products.CMFCore.interfaces import IActionInfo
-from Products.CMFCore.tests.base.testcase import WarningInterceptor
 from Products.CMFCore.utils import getToolByName
 from Products.GenericSetup.context import TarballImportContext
 from zope.configuration import xmlconfig
 from zope.site.hooks import setSite
 
 import transaction
+import warnings
 
 #
 # Base TestCase for upgrades
@@ -150,7 +150,7 @@ def removeSkinLayer(self, layer, skin='Plone Default'):
             skins.addSkinSelection(skin, ','.join(path))
 
 
-class FunctionalUpgradeTestCase(PloneTestCase, WarningInterceptor):
+class FunctionalUpgradeTestCase(PloneTestCase):
 
     _setup_fixture = 0
     site_id = 'test'
@@ -168,9 +168,8 @@ def beforeTearDown(self):
 
     def importFile(self, context, name):
         path = join(abspath(dirname(context)), 'data', name)
-        self._trap_warning_output()
-        self.app._importObjectFromFile(path, verify=0)
-        self._free_warning_output()
+        with warnings.catch_warnings():
+            self.app._importObjectFromFile(path, verify=0)
 
     def migrate(self):
         oldsite = getattr(self.app, self.site_id)


