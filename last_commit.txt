Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2017-06-13T17:29:39+01:00
Author: Jon Pentland (instification) <jon@iomedia.co.uk>
Commit: https://github.com/plone/Products.CMFPlone/commit/42e925321d066b7a8cc84ce5d30ab9b2491eb1c3

Load patterns when using AJAX/iframe, improve AJAX template

Files changed:
M Products/CMFPlone/browser/templates/ajax_main_template.pt
M Products/CMFPlone/static/plone.js

diff --git a/Products/CMFPlone/browser/templates/ajax_main_template.pt b/Products/CMFPlone/browser/templates/ajax_main_template.pt
index 729ec5610..fc3d03076 100644
--- a/Products/CMFPlone/browser/templates/ajax_main_template.pt
+++ b/Products/CMFPlone/browser/templates/ajax_main_template.pt
@@ -2,6 +2,9 @@
 <tal:doctype tal:replace="structure string:&lt;!DOCTYPE html&gt;" />
 
 <html xmlns="http://www.w3.org/1999/xhtml"
+    xmlns:tal="http://xml.zope.org/namespaces/tal"
+    xmlns:metal="http://xml.zope.org/namespaces/metal"
+    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
     tal:define="portal_state context/@@plone_portal_state;
         context_state context/@@plone_context_state;
         plone_view context/@@plone;
@@ -12,6 +15,7 @@
         portal_url portal_state/portal_url;
         checkPermission nocall: context/portal_membership/checkPermission;
         site_properties context/portal_properties/site_properties;
+        ajax_include_head request/ajax_include_head | nothing;
         ajax_load python:True;"
     i18n:domain="plone"
     tal:attributes="lang lang;">
@@ -21,6 +25,23 @@
 <head>
     <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 
+    <tal:ajaxhead condition="ajax_include_head">
+        <div tal:replace="structure provider:plone.htmlhead" />
+
+        <tal:comment replace="nothing">
+            Various slots where you can insert elements in the header from a template.
+        </tal:comment>
+        <metal:topslot define-slot="top_slot" />
+        <metal:headslot define-slot="head_slot" />
+        <metal:styleslot define-slot="style_slot" />
+
+        <div tal:replace="structure provider:plone.scripts" />
+        <metal:javascriptslot define-slot="javascript_head_slot" />
+
+        <link tal:replace="structure provider:plone.htmlhead.links" />
+        <meta name="generator" content="Plone - http://plone.com" />
+    </tal:ajaxhead>
+
 </head>
 
 <body tal:define="isRTL portal_state/is_rtl;
@@ -28,8 +49,11 @@
                   sr python:plone_layout.have_portlets('plone.rightcolumn', view);
                   body_class python:plone_layout.bodyClass(template, view);"
     tal:attributes="class string: ${body_class} ajax_load;
-                    dir python:isRTL and 'rtl' or 'ltr'">
+                    dir python:isRTL and 'rtl' or 'ltr';
+                    python:plone_view.patterns_settings()"
+            id="visual-portal-wrapper">
 
+    <header id="portal-top" i18n:domain="plone"/>
     <aside id="global_statusmessage">
       <tal:message tal:content="provider:plone.globalstatusmessage"/>
       <div metal:define-slot="global_statusmessage">
diff --git a/Products/CMFPlone/static/plone.js b/Products/CMFPlone/static/plone.js
index 9afbbf13c..41a764904 100644
--- a/Products/CMFPlone/static/plone.js
+++ b/Products/CMFPlone/static/plone.js
@@ -46,7 +46,8 @@ require([
   'use strict';
 
   // initialize only if we are in top frame
-  if (window.parent === window) {
+  if ((window.parent === window) ||
+        (window.frameElement.nodeName === 'IFRAME')) {
     $(document).ready(function() {
       $('body').addClass('pat-plone');
       if (!registry.initialized) {


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2017-06-13T17:29:48+01:00
Author: Jon Pentland (instification) <jon@iomedia.co.uk>
Commit: https://github.com/plone/Products.CMFPlone/commit/c229ac7467bf6d9191d1830e6055728414498af1

Use structure for status message

Signed-off-by: Jon Pentland &lt;jon@iomedia.co.uk&gt;

Files changed:
M Products/CMFPlone/browser/templates/ajax_main_template.pt

diff --git a/Products/CMFPlone/browser/templates/ajax_main_template.pt b/Products/CMFPlone/browser/templates/ajax_main_template.pt
index fc3d03076..eaa472fe4 100644
--- a/Products/CMFPlone/browser/templates/ajax_main_template.pt
+++ b/Products/CMFPlone/browser/templates/ajax_main_template.pt
@@ -55,7 +55,7 @@
 
     <header id="portal-top" i18n:domain="plone"/>
     <aside id="global_statusmessage">
-      <tal:message tal:content="provider:plone.globalstatusmessage"/>
+      <tal:message tal:content="structure provider:plone.globalstatusmessage"/>
       <div metal:define-slot="global_statusmessage">
       </div>
     </aside>


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2017-06-14T09:20:49+01:00
Author: Jon Pentland (instification) <jon@iomedia.co.uk>
Commit: https://github.com/plone/Products.CMFPlone/commit/de44ccaa8acd4345613a94923fd1d8a598750d85

Update changes.rst

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 5b768b5cb..cd70f8a4d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Include JS Patterns when loading a page via ajax or an iframe
+  [displacedaussie, instification]
 
 Bug fixes:
 


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2017-06-14T12:28:22+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/5ad21532b875035dd07387fcfbea3d56b6a0f208

Merge pull request #2070 from plone/5.0.x-include-ajax-haed

5.0.x include ajax head

Files changed:
M CHANGES.rst
M Products/CMFPlone/browser/templates/ajax_main_template.pt
M Products/CMFPlone/static/plone.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 5b768b5cb..cd70f8a4d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Include JS Patterns when loading a page via ajax or an iframe
+  [displacedaussie, instification]
 
 Bug fixes:
 
diff --git a/Products/CMFPlone/browser/templates/ajax_main_template.pt b/Products/CMFPlone/browser/templates/ajax_main_template.pt
index 729ec5610..eaa472fe4 100644
--- a/Products/CMFPlone/browser/templates/ajax_main_template.pt
+++ b/Products/CMFPlone/browser/templates/ajax_main_template.pt
@@ -2,6 +2,9 @@
 <tal:doctype tal:replace="structure string:&lt;!DOCTYPE html&gt;" />
 
 <html xmlns="http://www.w3.org/1999/xhtml"
+    xmlns:tal="http://xml.zope.org/namespaces/tal"
+    xmlns:metal="http://xml.zope.org/namespaces/metal"
+    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
     tal:define="portal_state context/@@plone_portal_state;
         context_state context/@@plone_context_state;
         plone_view context/@@plone;
@@ -12,6 +15,7 @@
         portal_url portal_state/portal_url;
         checkPermission nocall: context/portal_membership/checkPermission;
         site_properties context/portal_properties/site_properties;
+        ajax_include_head request/ajax_include_head | nothing;
         ajax_load python:True;"
     i18n:domain="plone"
     tal:attributes="lang lang;">
@@ -21,6 +25,23 @@
 <head>
     <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 
+    <tal:ajaxhead condition="ajax_include_head">
+        <div tal:replace="structure provider:plone.htmlhead" />
+
+        <tal:comment replace="nothing">
+            Various slots where you can insert elements in the header from a template.
+        </tal:comment>
+        <metal:topslot define-slot="top_slot" />
+        <metal:headslot define-slot="head_slot" />
+        <metal:styleslot define-slot="style_slot" />
+
+        <div tal:replace="structure provider:plone.scripts" />
+        <metal:javascriptslot define-slot="javascript_head_slot" />
+
+        <link tal:replace="structure provider:plone.htmlhead.links" />
+        <meta name="generator" content="Plone - http://plone.com" />
+    </tal:ajaxhead>
+
 </head>
 
 <body tal:define="isRTL portal_state/is_rtl;
@@ -28,10 +49,13 @@
                   sr python:plone_layout.have_portlets('plone.rightcolumn', view);
                   body_class python:plone_layout.bodyClass(template, view);"
     tal:attributes="class string: ${body_class} ajax_load;
-                    dir python:isRTL and 'rtl' or 'ltr'">
+                    dir python:isRTL and 'rtl' or 'ltr';
+                    python:plone_view.patterns_settings()"
+            id="visual-portal-wrapper">
 
+    <header id="portal-top" i18n:domain="plone"/>
     <aside id="global_statusmessage">
-      <tal:message tal:content="provider:plone.globalstatusmessage"/>
+      <tal:message tal:content="structure provider:plone.globalstatusmessage"/>
       <div metal:define-slot="global_statusmessage">
       </div>
     </aside>
diff --git a/Products/CMFPlone/static/plone.js b/Products/CMFPlone/static/plone.js
index 9afbbf13c..41a764904 100644
--- a/Products/CMFPlone/static/plone.js
+++ b/Products/CMFPlone/static/plone.js
@@ -46,7 +46,8 @@ require([
   'use strict';
 
   // initialize only if we are in top frame
-  if (window.parent === window) {
+  if ((window.parent === window) ||
+        (window.frameElement.nodeName === 'IFRAME')) {
     $(document).ready(function() {
       $('body').addClass('pat-plone');
       if (!registry.initialized) {


