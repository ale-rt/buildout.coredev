Repository: Products.Archetypes


Branch: refs/heads/1.9.x
Date: 2017-05-30T17:43:16+02:00
Author: Malthe Borch (malthe) <mborch@gmail.com>
Commit: https://github.com/plone/Products.Archetypes/commit/b1fac18df9a682117ac64e89269ec8a321be6861

Look up view using lower-level API to check for existence

Files changed:
M CHANGES.rst
M Products/Archetypes/BaseObject.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a81f7479..03930f79 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,10 @@ Changelog
 1.9.17 (unreleased)
 -------------------
 
-- Nothing changed yet.
+Bug fixes:
+
+- Don't instantiate browser view to check for existence.
+  [malthe]
 
 
 1.9.16 (2017-05-23)
diff --git a/Products/Archetypes/BaseObject.py b/Products/Archetypes/BaseObject.py
index 6e69ec7d..cff9cb3b 100644
--- a/Products/Archetypes/BaseObject.py
+++ b/Products/Archetypes/BaseObject.py
@@ -53,9 +53,9 @@
 from webdav.NullResource import NullResource
 
 from zope import event
-from zope.interface import implements, Interface
+from zope.interface import implementer, Interface, providedBy
+from zope.component import getSiteManager
 from zope.component import subscribers
-from zope.component import queryMultiAdapter
 from zope.component import queryUtility
 
 # Import conditionally, so we don't introduce a hard depdendency
@@ -1082,8 +1082,11 @@ def __bobo_traverse__(self, REQUEST, name):
             if shasattr(self, name):  # attributes of self come first
                 target = getattr(self, name)
             else:  # then views
-                target = queryMultiAdapter((self, REQUEST), Interface, name)
-                if target is not None:
+                gsm = getSiteManager()
+                factory = gsm.adapters.lookup(
+                    (providedBy(self), providedBy(REQUEST)), Interface, name
+                )
+                if factory is not None:
                     # We don't return the view, we raise an
                     # AttributeError instead (below)
                     target = None


