Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-02-05T22:36:16+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/7e285935c2d6613ff6c4f98b5ac09d4afcaf171a

adapt to changes in zope4

Files changed:
M plone/app/upgrade/v41/alphas.py
M plone/app/upgrade/v50/alphas.py

diff --git a/plone/app/upgrade/v41/alphas.py b/plone/app/upgrade/v41/alphas.py
index ced720d..db50b12 100644
--- a/plone/app/upgrade/v41/alphas.py
+++ b/plone/app/upgrade/v41/alphas.py
@@ -49,10 +49,8 @@ def add_siteadmin_role(context):
     rolemap_exporter = RolemapExportConfigurator(portal)
     permissions = rolemap_exporter.listPermissions()
     extra_permissions = set([
-        'Access arbitrary user session data',
         'Access contents information',
         'Access inactive portal content',
-        'Access session data',
         'Add portal content',
         'Add portal events',
         'Change local roles',
diff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py
index 60544ff..7fab2ee 100644
--- a/plone/app/upgrade/v50/alphas.py
+++ b/plone/app/upgrade/v50/alphas.py
@@ -52,7 +52,8 @@ def to50alpha1(context):
 
     # remove obsolete tools
     tools = [t for t in TOOLS_TO_REMOVE if t in portal]
-    portal.manage_delObjects(tools)
+    if tools:
+        portal.manage_delObjects(tools)
 
     cleanUpToolRegistry(context)
 


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-02-05T22:36:16+01:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/9601ec40fe42720e83e4dc98ff7f15b46858d976

check whether avoiding exception in RealUpgradeLayer setup avoids polluting test environment

Files changed:
M plone/app/upgrade/v50/testing.py

diff --git a/plone/app/upgrade/v50/testing.py b/plone/app/upgrade/v50/testing.py
index 4d34916..52c1c2b 100644
--- a/plone/app/upgrade/v50/testing.py
+++ b/plone/app/upgrade/v50/testing.py
@@ -3,8 +3,11 @@
 from plone.testing.z2 import FunctionalTesting, login
 from zope.component.hooks import setSite
 from zope.configuration import xmlconfig
+import logging
 import os
 
+logger = logging.getLogger(__file__)
+
 
 class RealUpgradeLayer(PloneSandboxLayer):
     defaultBases = (PLONE_FIXTURE,)
@@ -25,15 +28,18 @@ def setUpPloneSite(self, portal):
         login(app['acl_users'], 'admin')
 
         # import old ZEXP
-        path = os.path.join(os.path.abspath(
-            os.path.dirname(__file__)), 'data', 'test-full.zexp')
-        app._importObjectFromFile(path, verify=0)
-
-        # run upgrades
-        self['portal'] = portal = app.test
-        setSite(portal)
-        portal.portal_migration.upgrade(swallow_errors=False)
-        setSite(None)
+        try:
+            path = os.path.join(os.path.abspath(
+                os.path.dirname(__file__)), 'data', 'test-full.zexp')
+            app._importObjectFromFile(path, verify=0)
+        except:
+            logger.exception('Failed to import ZEXP from old site.')
+        else:
+            # run upgrades
+            self['portal'] = portal = app.test
+            setSite(portal)
+            portal.portal_migration.upgrade(swallow_errors=False)
+            setSite(None)
 
     def tearDownPloneSite(self, portal):
         del self['portal']


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-02-05T22:46:40+01:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/2a4077059b0b9cde0bf04e7794c805b6735baaaf

avoid error in layer teardown

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/testing.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 748090a..9a78236 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -45,6 +45,9 @@ New features:
   *Note: Pending password resets are deleted.*
   [tomgross]
 
+- Adopt to changes in Zope4
+  [pbauer]
+
 Bug fixes:
 
 - Remove displayContentsTab from action expressions in 5.1.
@@ -94,6 +97,11 @@ Bug fixes:
 - Fix upgrade step for PasswordResetTool if there was never da different value than the default was set.
   [jensens]
 
+- Check whether avoiding exception in RealUpgradeLayer setup avoids polluting test environment.
+  [davisagli]
+
+- avoid error in layer teardown
+  [davisagli]
 
 1.3.27 (2016-08-16)
 -------------------
diff --git a/plone/app/upgrade/v50/testing.py b/plone/app/upgrade/v50/testing.py
index 52c1c2b..d52f8e5 100644
--- a/plone/app/upgrade/v50/testing.py
+++ b/plone/app/upgrade/v50/testing.py
@@ -42,7 +42,10 @@ def setUpPloneSite(self, portal):
             setSite(None)
 
     def tearDownPloneSite(self, portal):
-        del self['portal']
+        try:
+            del self['portal']
+        except KeyError:
+            pass
 
 
 REAL_UPGRADE_FIXTURE = RealUpgradeLayer()


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-02-05T23:50:09+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/b1c2e2c14cfeaad34bbb490d3da47b02249cfea5

Merge pull request #103 from plone/plonezope4

Plonezope4

Files changed:
M CHANGES.rst
M plone/app/upgrade/v41/alphas.py
M plone/app/upgrade/v50/alphas.py
M plone/app/upgrade/v50/testing.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 748090a..9a78236 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -45,6 +45,9 @@ New features:
   *Note: Pending password resets are deleted.*
   [tomgross]
 
+- Adopt to changes in Zope4
+  [pbauer]
+
 Bug fixes:
 
 - Remove displayContentsTab from action expressions in 5.1.
@@ -94,6 +97,11 @@ Bug fixes:
 - Fix upgrade step for PasswordResetTool if there was never da different value than the default was set.
   [jensens]
 
+- Check whether avoiding exception in RealUpgradeLayer setup avoids polluting test environment.
+  [davisagli]
+
+- avoid error in layer teardown
+  [davisagli]
 
 1.3.27 (2016-08-16)
 -------------------
diff --git a/plone/app/upgrade/v41/alphas.py b/plone/app/upgrade/v41/alphas.py
index ced720d..db50b12 100644
--- a/plone/app/upgrade/v41/alphas.py
+++ b/plone/app/upgrade/v41/alphas.py
@@ -49,10 +49,8 @@ def add_siteadmin_role(context):
     rolemap_exporter = RolemapExportConfigurator(portal)
     permissions = rolemap_exporter.listPermissions()
     extra_permissions = set([
-        'Access arbitrary user session data',
         'Access contents information',
         'Access inactive portal content',
-        'Access session data',
         'Add portal content',
         'Add portal events',
         'Change local roles',
diff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py
index 60544ff..7fab2ee 100644
--- a/plone/app/upgrade/v50/alphas.py
+++ b/plone/app/upgrade/v50/alphas.py
@@ -52,7 +52,8 @@ def to50alpha1(context):
 
     # remove obsolete tools
     tools = [t for t in TOOLS_TO_REMOVE if t in portal]
-    portal.manage_delObjects(tools)
+    if tools:
+        portal.manage_delObjects(tools)
 
     cleanUpToolRegistry(context)
 
diff --git a/plone/app/upgrade/v50/testing.py b/plone/app/upgrade/v50/testing.py
index 4d34916..d52f8e5 100644
--- a/plone/app/upgrade/v50/testing.py
+++ b/plone/app/upgrade/v50/testing.py
@@ -3,8 +3,11 @@
 from plone.testing.z2 import FunctionalTesting, login
 from zope.component.hooks import setSite
 from zope.configuration import xmlconfig
+import logging
 import os
 
+logger = logging.getLogger(__file__)
+
 
 class RealUpgradeLayer(PloneSandboxLayer):
     defaultBases = (PLONE_FIXTURE,)
@@ -25,18 +28,24 @@ def setUpPloneSite(self, portal):
         login(app['acl_users'], 'admin')
 
         # import old ZEXP
-        path = os.path.join(os.path.abspath(
-            os.path.dirname(__file__)), 'data', 'test-full.zexp')
-        app._importObjectFromFile(path, verify=0)
-
-        # run upgrades
-        self['portal'] = portal = app.test
-        setSite(portal)
-        portal.portal_migration.upgrade(swallow_errors=False)
-        setSite(None)
+        try:
+            path = os.path.join(os.path.abspath(
+                os.path.dirname(__file__)), 'data', 'test-full.zexp')
+            app._importObjectFromFile(path, verify=0)
+        except:
+            logger.exception('Failed to import ZEXP from old site.')
+        else:
+            # run upgrades
+            self['portal'] = portal = app.test
+            setSite(portal)
+            portal.portal_migration.upgrade(swallow_errors=False)
+            setSite(None)
 
     def tearDownPloneSite(self, portal):
-        del self['portal']
+        try:
+            del self['portal']
+        except KeyError:
+            pass
 
 
 REAL_UPGRADE_FIXTURE = RealUpgradeLayer()


