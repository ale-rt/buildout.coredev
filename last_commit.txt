Repository: plone.app.blob


Branch: refs/heads/master
Date: 2017-05-23T09:53:56+02:00
Author: Bert Vanderbauwhede (batlock666) <batlock666@gmail.com>
Commit: https://github.com/plone/plone.app.blob/commit/56ab7b221ff70ca6b5728706be0c1c3c9e68c868

Handle ValueError exceptions when doing a range request.

Files changed:
M CHANGES.rst
M src/plone/app/blob/download.py
M src/plone/app/blob/tests/test_integration.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6fa0223..235e2f4 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Handle ``ValueError`` exceptions when doing a range request.
+  This fixes `issue #39 <https://github.com/plone/plone.app.blob/issues/39>`_.
+  [batlock666]
 
 
 1.7.1 (2017-05-16)
diff --git a/src/plone/app/blob/download.py b/src/plone/app/blob/download.py
index 808bece..0151e20 100644
--- a/src/plone/app/blob/download.py
+++ b/src/plone/app/blob/download.py
@@ -73,12 +73,15 @@ def handleRequestRange(instance, length, REQUEST, RESPONSE):
                         ranges = None
             RESPONSE.setHeader('Accept-Ranges', 'bytes')
         if ranges and len(ranges) == 1:
-            [(start, end)] = expandRanges(ranges, length)
-            size = end - start
-            RESPONSE.setHeader('Content-Length', size)
-            RESPONSE.setHeader(
-                'Content-Range',
-                'bytes {0}-{1}/{2}'.format(start, end - 1, length))
-            RESPONSE.setStatus(206)  # Partial content
-            return dict(start=start, end=end)
+            try:
+                [(start, end)] = expandRanges(ranges, length)
+                size = end - start
+                RESPONSE.setHeader('Content-Length', size)
+                RESPONSE.setHeader(
+                    'Content-Range',
+                    'bytes {0}-{1}/{2}'.format(start, end - 1, length))
+                RESPONSE.setStatus(206)  # Partial content
+                return dict(start=start, end=end)
+            except ValueError:
+                return {}
     return {}
diff --git a/src/plone/app/blob/tests/test_integration.py b/src/plone/app/blob/tests/test_integration.py
index 57bd15a..2dca3dd 100644
--- a/src/plone/app/blob/tests/test_integration.py
+++ b/src/plone/app/blob/tests/test_integration.py
@@ -153,6 +153,21 @@ def testRangeSupport(self):
         iterator = blob.download(request)
         self.assertEqual(data[-20:], ''.join(iterator))
 
+    def testOutsideRange(self):
+        # ranges outside the file size also have to work
+        blob = self.folder['blob']
+        blob.setTitle('foo')
+        blob.setFile(getData('plone.pdf'))
+        data = blob.getFile().getBlob().open('r').read()
+        l = len(data)
+        request = self.folder.REQUEST
+        request.environ['HTTP_RANGE'] = 'bytes={}-{}'.format(l * 2, l * 3)
+        iterator = blob.download(request)
+        self.assertEqual(data, ''.join(iterator))
+        request.environ['HTTP_RANGE'] = 'bytes={}-'.format(l * 2)
+        iterator = blob.download(request)
+        self.assertEqual(data, ''.join(iterator))
+
     def testIcon(self):
         blob = self.folder.blob
         blob.update(file=getImage())


Repository: plone.app.blob


Branch: refs/heads/master
Date: 2017-05-29T10:05:04+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.blob/commit/e5ebaaa1c45dd70c4a206144c07bee6a71591a50

Merge pull request #41 from batlock666/master

Handle ValueError exceptions when doing a range request. (Fixes issue #39)

Files changed:
M CHANGES.rst
M src/plone/app/blob/download.py
M src/plone/app/blob/tests/test_integration.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6fa0223..235e2f4 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Handle ``ValueError`` exceptions when doing a range request.
+  This fixes `issue #39 <https://github.com/plone/plone.app.blob/issues/39>`_.
+  [batlock666]
 
 
 1.7.1 (2017-05-16)
diff --git a/src/plone/app/blob/download.py b/src/plone/app/blob/download.py
index 808bece..0151e20 100644
--- a/src/plone/app/blob/download.py
+++ b/src/plone/app/blob/download.py
@@ -73,12 +73,15 @@ def handleRequestRange(instance, length, REQUEST, RESPONSE):
                         ranges = None
             RESPONSE.setHeader('Accept-Ranges', 'bytes')
         if ranges and len(ranges) == 1:
-            [(start, end)] = expandRanges(ranges, length)
-            size = end - start
-            RESPONSE.setHeader('Content-Length', size)
-            RESPONSE.setHeader(
-                'Content-Range',
-                'bytes {0}-{1}/{2}'.format(start, end - 1, length))
-            RESPONSE.setStatus(206)  # Partial content
-            return dict(start=start, end=end)
+            try:
+                [(start, end)] = expandRanges(ranges, length)
+                size = end - start
+                RESPONSE.setHeader('Content-Length', size)
+                RESPONSE.setHeader(
+                    'Content-Range',
+                    'bytes {0}-{1}/{2}'.format(start, end - 1, length))
+                RESPONSE.setStatus(206)  # Partial content
+                return dict(start=start, end=end)
+            except ValueError:
+                return {}
     return {}
diff --git a/src/plone/app/blob/tests/test_integration.py b/src/plone/app/blob/tests/test_integration.py
index 57bd15a..2dca3dd 100644
--- a/src/plone/app/blob/tests/test_integration.py
+++ b/src/plone/app/blob/tests/test_integration.py
@@ -153,6 +153,21 @@ def testRangeSupport(self):
         iterator = blob.download(request)
         self.assertEqual(data[-20:], ''.join(iterator))
 
+    def testOutsideRange(self):
+        # ranges outside the file size also have to work
+        blob = self.folder['blob']
+        blob.setTitle('foo')
+        blob.setFile(getData('plone.pdf'))
+        data = blob.getFile().getBlob().open('r').read()
+        l = len(data)
+        request = self.folder.REQUEST
+        request.environ['HTTP_RANGE'] = 'bytes={}-{}'.format(l * 2, l * 3)
+        iterator = blob.download(request)
+        self.assertEqual(data, ''.join(iterator))
+        request.environ['HTTP_RANGE'] = 'bytes={}-'.format(l * 2)
+        iterator = blob.download(request)
+        self.assertEqual(data, ''.join(iterator))
+
     def testIcon(self):
         blob = self.folder.blob
         blob.update(file=getImage())


