Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-03-29T16:06:44+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/30526328c3a999b209481cf884ed57923fc7ab27

In the combine-bundles import step do not set Content Type header.

It would be set to application/javascript.  This would result
in the plone-upgrade result page being shown in plain text.

Fixes #1436

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/exportimport/bundles.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a416405..f410409 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,7 +18,11 @@ New:
 
 Fixes:
 
-- *add item here*
+- In the ``combine-bundles`` import step, make sure the Content Type
+  header is not set to ``application/javascript``.  This would result
+  in the ``plone-upgrade`` result page being shown in plain text.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/1436
+  [maurits]
 
 
 5.0.3 (2016-03-16)
diff --git a/Products/CMFPlone/resources/exportimport/bundles.py b/Products/CMFPlone/resources/exportimport/bundles.py
index a51042c..756474b 100644
--- a/Products/CMFPlone/resources/exportimport/bundles.py
+++ b/Products/CMFPlone/resources/exportimport/bundles.py
@@ -1,5 +1,6 @@
 from plone.registry.interfaces import IRegistry
 from zope.component import queryUtility
+from zope.globalrequest import getRequest
 
 from ..browser.combine import combine_bundles
 
@@ -16,4 +17,20 @@ def combine(context):
     body = context.readDataFile('registry.xml')
     if body and "IBundleRegistry" in body:
         site = context.getSite()
+        # Calling combine_bundles will have as side effect that the
+        # Content-Type header of the response is set to application/javascript,
+        # which we do not want.  So we reset it to the original at the end.
+        site = context.getSite()
+        request = getattr(site, 'REQUEST', getRequest())
+        if request is not None:
+            # Easily happens in tests.
+            orig_header = request.response.getHeader('Content-Type')
         combine_bundles(site)
+        if request is not None:
+            new_header = request.response.getHeader('Content-Type')
+            if new_header != orig_header:
+                if orig_header is None:
+                    # Setting it to None would result in the string 'None'.
+                    # So pick a saner one.
+                    orig_header = 'text/html'
+                request.response.setHeader('Content-Type', orig_header)


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-03-29T16:17:12+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.CMFPlone/commit/9e2864de6555ba117cd4f36f1a5efb63528d054d

Preparing release 5.0.3.1

Files changed:
M CHANGES.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f410409..c223bd6 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -5,16 +5,8 @@
 Changelog
 =========
 
-5.0.4 (unreleased)
-------------------
-
-Incompatibilities:
-
-- *add item here*
-
-New:
-
-- *add item here*
+5.0.3.1 (2016-03-29)
+--------------------
 
 Fixes:
 
diff --git a/setup.py b/setup.py
index 8203719..ec3c1e5 100644
--- a/setup.py
+++ b/setup.py
@@ -1,7 +1,7 @@
 from setuptools import setup
 from setuptools import find_packages
 
-version = '5.0.4.dev0'
+version = '5.0.3.1'
 
 setup(
     name='Products.CMFPlone',


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-03-29T16:22:41+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.CMFPlone/commit/33a5567a75d37b776947b33e949725ca92460294

bump release

Files changed:
M CHANGES.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c223bd6..8f7963a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -5,6 +5,22 @@
 Changelog
 =========
 
+5.0.4 (unreleased)
+------------------
+
+Incompatibilities:
+
+- *add item here*
+
+New:
+
+- *add item here*
+
+Fixes:
+
+- *add item here*
+
+
 5.0.3.1 (2016-03-29)
 --------------------
 
diff --git a/setup.py b/setup.py
index ec3c1e5..8203719 100644
--- a/setup.py
+++ b/setup.py
@@ -1,7 +1,7 @@
 from setuptools import setup
 from setuptools import find_packages
 
-version = '5.0.3.1'
+version = '5.0.4.dev0'
 
 setup(
     name='Products.CMFPlone',


