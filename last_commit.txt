Repository: Products.CMFQuickInstallerTool


Branch: refs/heads/master
Date: 2015-12-22T21:33:42+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFQuickInstallerTool/commit/d476b7f5d57693736017b45dd986702f9a58e67b

Use unsetLastVersionForProfile from Products.GenericSetup 1.8.1.

Files changed:
M CHANGES.rst
M Products/CMFQuickInstallerTool/QuickInstallerTool.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b273d3e..3ea4adf 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,7 +6,8 @@ Changelog
 
 New:
 
-- *add item here*
+- Use ``unsetLastVersionForProfile`` from Products.GenericSetup 1.8.1.
+  [maurits]
 
 Fixes:
 
diff --git a/Products/CMFQuickInstallerTool/QuickInstallerTool.py b/Products/CMFQuickInstallerTool/QuickInstallerTool.py
index 937c1f6..7ce20bd 100644
--- a/Products/CMFQuickInstallerTool/QuickInstallerTool.py
+++ b/Products/CMFQuickInstallerTool/QuickInstallerTool.py
@@ -747,18 +747,7 @@ def uninstallProducts(
                 if profile is not None:
                     # Mark profile as uninstalled/unknown.
                     profile_id = profile['id']
-                    # XXX We want to use unsetLastVersionForProfile,
-                    # but that requires a merge and release of this
-                    # GenericSetup pull request:
-                    # https://github.com/zopefoundation/Products.GenericSetup/pull/18
-                    # portal_setup.unsetLastVersionForProfile(profile_id)
-                    # Instead we must copy and set the
-                    # (non-persistent) profile upgrade versions.
-                    prof_versions = portal_setup._profile_upgrade_versions.copy()
-                    if profile_id not in prof_versions:
-                        continue
-                    del prof_versions[profile_id]
-                    portal_setup._profile_upgrade_versions = prof_versions
+                    portal_setup.unsetLastVersionForProfile(profile_id)
 
         if REQUEST:
             return REQUEST.RESPONSE.redirect(REQUEST['HTTP_REFERER'])
diff --git a/setup.py b/setup.py
index bbf500b..c4a11f8 100644
--- a/setup.py
+++ b/setup.py
@@ -45,7 +45,7 @@
       'zope.i18nmessageid',
       'zope.interface',
       'Products.CMFCore',
-      'Products.GenericSetup',
+      'Products.GenericSetup>=1.8.1',
       'Acquisition',
       'DateTime',
       'Zope2',


Repository: Products.CMFQuickInstallerTool


Branch: refs/heads/master
Date: 2016-01-08T17:33:39+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFQuickInstallerTool/commit/b0f88bd5e4eed1d58323a54e42f367da60965226

Merge pull request #13 from plone/use-gs-181

Use unsetLastVersionForProfile from Products.GenericSetup 1.8.1.

Files changed:
M CHANGES.rst
M Products/CMFQuickInstallerTool/QuickInstallerTool.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b273d3e..3ea4adf 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,7 +6,8 @@ Changelog
 
 New:
 
-- *add item here*
+- Use ``unsetLastVersionForProfile`` from Products.GenericSetup 1.8.1.
+  [maurits]
 
 Fixes:
 
diff --git a/Products/CMFQuickInstallerTool/QuickInstallerTool.py b/Products/CMFQuickInstallerTool/QuickInstallerTool.py
index 937c1f6..7ce20bd 100644
--- a/Products/CMFQuickInstallerTool/QuickInstallerTool.py
+++ b/Products/CMFQuickInstallerTool/QuickInstallerTool.py
@@ -747,18 +747,7 @@ def uninstallProducts(
                 if profile is not None:
                     # Mark profile as uninstalled/unknown.
                     profile_id = profile['id']
-                    # XXX We want to use unsetLastVersionForProfile,
-                    # but that requires a merge and release of this
-                    # GenericSetup pull request:
-                    # https://github.com/zopefoundation/Products.GenericSetup/pull/18
-                    # portal_setup.unsetLastVersionForProfile(profile_id)
-                    # Instead we must copy and set the
-                    # (non-persistent) profile upgrade versions.
-                    prof_versions = portal_setup._profile_upgrade_versions.copy()
-                    if profile_id not in prof_versions:
-                        continue
-                    del prof_versions[profile_id]
-                    portal_setup._profile_upgrade_versions = prof_versions
+                    portal_setup.unsetLastVersionForProfile(profile_id)
 
         if REQUEST:
             return REQUEST.RESPONSE.redirect(REQUEST['HTTP_REFERER'])
diff --git a/setup.py b/setup.py
index bbf500b..c4a11f8 100644
--- a/setup.py
+++ b/setup.py
@@ -45,7 +45,7 @@
       'zope.i18nmessageid',
       'zope.interface',
       'Products.CMFCore',
-      'Products.GenericSetup',
+      'Products.GenericSetup>=1.8.1',
       'Acquisition',
       'DateTime',
       'Zope2',


