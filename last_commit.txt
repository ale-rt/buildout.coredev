Repository: Products.PortalTransforms


Branch: refs/heads/2.1.x
Date: 2016-06-27T17:39:15+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.PortalTransforms/commit/9278d35f56e3e0e613d813227bcd7b4b2a71932b

Adapted tests to work on Pillow 3.

Required ``Pillow&gt;=3.1.0`` in tests.

TIFF output in Pillow &gt;= 3.1.0 tiff expects a dword instead of a word as type in the IFD header for width.

This is a backport from master.

Files changed:
M CHANGES.rst
M Products/PortalTransforms/libtransforms/piltransform.py
M Products/PortalTransforms/tests/output/logo.tiff
M Products/PortalTransforms/tests/test_transforms.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index e2c8581..61a8ad5 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,13 +4,10 @@ Changelog
 2.1.12 (unreleased)
 -------------------
 
-New:
+Bug fixes:
 
-- *add item here*
-
-Fixes:
-
-- *add item here*
+- Adapted tests to work on newer Pillow.  Required ``Pillow>=3.1.0`` in tests.
+  [jensens]
 
 
 2.1.11 (2016-02-12)
diff --git a/Products/PortalTransforms/libtransforms/piltransform.py b/Products/PortalTransforms/libtransforms/piltransform.py
index cf31947..d08ffc5 100644
--- a/Products/PortalTransforms/libtransforms/piltransform.py
+++ b/Products/PortalTransforms/libtransforms/piltransform.py
@@ -29,7 +29,7 @@ def convert(self, orig, data, **kwargs):
         if(newwidth or newheight):
             pil_img.thumbnail((newwidth, newheight), PIL.Image.ANTIALIAS)
         pil_img.save(imgio, self.format)
-        data.setData(imgio. getvalue())
+        data.setData(imgio.getvalue())
         return data
 
 
diff --git a/Products/PortalTransforms/tests/output/logo.tiff b/Products/PortalTransforms/tests/output/logo.tiff
index d7cf599..712141f 100644
Binary files a/Products/PortalTransforms/tests/output/logo.tiff and b/Products/PortalTransforms/tests/output/logo.tiff differ
diff --git a/Products/PortalTransforms/tests/test_transforms.py b/Products/PortalTransforms/tests/test_transforms.py
index 9939e5c..5399109 100644
--- a/Products/PortalTransforms/tests/test_transforms.py
+++ b/Products/PortalTransforms/tests/test_transforms.py
@@ -43,9 +43,8 @@ def do_convert(self, filename=None):
             output = self.output + '.nofilename'
         else:
             output = self.output
-        input = open(self.input)
-        orig = input.read()
-        input.close()
+        with open(self.input) as fp:
+            orig = fp.read()
         data = datastream(self.transform.name())
         res_data = self.transform.convert(orig, data, filename=filename)
         self.assert_(IDataStream.providedBy(res_data))
diff --git a/setup.py b/setup.py
index b2b4dae..c58c6de 100644
--- a/setup.py
+++ b/setup.py
@@ -28,7 +28,7 @@
           test=[
               'zope.testing',
               'Products.Archetypes [test]',
-              'Pillow',
+              'Pillow>=3.1.0',
           ],
       ),
       install_requires=[
@@ -43,4 +43,4 @@
           'Zope2',
           'Markdown>=1.7',
       ],
-      )
+)


