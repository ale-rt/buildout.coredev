Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-12-13T12:46:23-05:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/1f3b880f1d7cdc919763273b5f4f3af93aaec580

log progress and ignore bad catalog entries during catalog metadata updates

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/final.py
M plone/app/upgrade/v51/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c9826f13..8c445806 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Log progress and ignore bad catalog entries while updating catalog metadata.
+  [davisagli]
 
 
 2.0.10 (2017-12-13)
diff --git a/plone/app/upgrade/v50/final.py b/plone/app/upgrade/v50/final.py
index 7785528e..ab980353 100644
--- a/plone/app/upgrade/v50/final.py
+++ b/plone/app/upgrade/v50/final.py
@@ -4,6 +4,8 @@
 from plone.registry.interfaces import IRegistry
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.utils import safe_unicode
+from Products.ZCatalog.ProgressHandler import ZLogHandler
+from zExceptions import NotFound
 from zope.component import getUtility
 from zope.component.hooks import getSite
 
@@ -68,9 +70,17 @@ def refresh_getIcon_catalog_metadata(context):
 
         cnt = 0
         # search whole catalog
-        for brain in zcatalog.unrestrictedSearchResults():
+        results = zcatalog.unrestrictedSearchResults()
+        num_objects = len(results)
+        pghandler = ZLogHandler(1000)
+        pghandler.init('Updating getIcon metadata', num_objects)
+        for brain in results:
+            pghandler.report(cnt)
             # First get the new value
-            obj = brain._unrestrictedGetObject()
+            try:
+                obj = brain._unrestrictedGetObject()
+            except (AttributeError, KeyError, TypeError, NotFound):
+                continue
             new_value = bool(getattr(aq_base(obj), 'image', False))
 
             # We can now update the record with the new getIcon value
@@ -80,6 +90,7 @@ def refresh_getIcon_catalog_metadata(context):
 
             cnt += 1  # we are curious
         # done
+        pghandler.finish()
         logger.info('Reindexed `getIcon` for %s items' % str(cnt))
 
     refresh_getIcon_catalog_metadata(context)
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 57eca92c..b0d45ffb 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -5,6 +5,8 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import IFilterSchema
 from Products.CMFPlone.interfaces import ISearchSchema
+from Products.ZCatalog.ProgressHandler import ZLogHandler
+from zExceptions import NotFound
 from zope.component import getUtility
 import logging
 
@@ -152,8 +154,16 @@ def reindex_mime_type(context):
               'Products.ATContentTypes.interfaces.file.IFileContent',
               'Products.ATContentTypes.interfaces.image.IImageContent']
     cnt = 0
-    for brain in zcatalog.unrestrictedSearchResults(object_provides=ifaces):
-        obj = brain._unrestrictedGetObject()
+    results = zcatalog.unrestrictedSearchResults(object_provides=ifaces)
+    num_objects = len(results)
+    pghandler = ZLogHandler(1000)
+    pghandler.init('Updating mime_type metadata', num_objects)
+    for brain in results:
+        pghandler.report(cnt)
+        try:
+            obj = brain._unrestrictedGetObject()
+        except (AttributeError, KeyError, TypeError, NotFound):
+            continue
         if not obj:
             continue
         # First get the new value:
@@ -169,6 +179,7 @@ def reindex_mime_type(context):
         record[metadata_index] = new_value
         catalog.data[brain.getRID()] = tuple(record)
         cnt += 1
+    pghandler.finish()
     logger.info('Reindexed `mime_type` for %s items' % str(cnt))
 
 


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-12-13T14:09:27-05:00
Author: David Glick (davisagli) <david.glick@plone.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/887926f419651afabf4b9a21ba209491d150b385

Merge pull request #146 from plone/davisagli-catalog-updates

Log progress and ignore bad catalog entries during catalog metadata updates

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/final.py
M plone/app/upgrade/v51/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c9826f13..8c445806 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Log progress and ignore bad catalog entries while updating catalog metadata.
+  [davisagli]
 
 
 2.0.10 (2017-12-13)
diff --git a/plone/app/upgrade/v50/final.py b/plone/app/upgrade/v50/final.py
index 7785528e..ab980353 100644
--- a/plone/app/upgrade/v50/final.py
+++ b/plone/app/upgrade/v50/final.py
@@ -4,6 +4,8 @@
 from plone.registry.interfaces import IRegistry
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.utils import safe_unicode
+from Products.ZCatalog.ProgressHandler import ZLogHandler
+from zExceptions import NotFound
 from zope.component import getUtility
 from zope.component.hooks import getSite
 
@@ -68,9 +70,17 @@ def refresh_getIcon_catalog_metadata(context):
 
         cnt = 0
         # search whole catalog
-        for brain in zcatalog.unrestrictedSearchResults():
+        results = zcatalog.unrestrictedSearchResults()
+        num_objects = len(results)
+        pghandler = ZLogHandler(1000)
+        pghandler.init('Updating getIcon metadata', num_objects)
+        for brain in results:
+            pghandler.report(cnt)
             # First get the new value
-            obj = brain._unrestrictedGetObject()
+            try:
+                obj = brain._unrestrictedGetObject()
+            except (AttributeError, KeyError, TypeError, NotFound):
+                continue
             new_value = bool(getattr(aq_base(obj), 'image', False))
 
             # We can now update the record with the new getIcon value
@@ -80,6 +90,7 @@ def refresh_getIcon_catalog_metadata(context):
 
             cnt += 1  # we are curious
         # done
+        pghandler.finish()
         logger.info('Reindexed `getIcon` for %s items' % str(cnt))
 
     refresh_getIcon_catalog_metadata(context)
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 57eca92c..b0d45ffb 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -5,6 +5,8 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import IFilterSchema
 from Products.CMFPlone.interfaces import ISearchSchema
+from Products.ZCatalog.ProgressHandler import ZLogHandler
+from zExceptions import NotFound
 from zope.component import getUtility
 import logging
 
@@ -152,8 +154,16 @@ def reindex_mime_type(context):
               'Products.ATContentTypes.interfaces.file.IFileContent',
               'Products.ATContentTypes.interfaces.image.IImageContent']
     cnt = 0
-    for brain in zcatalog.unrestrictedSearchResults(object_provides=ifaces):
-        obj = brain._unrestrictedGetObject()
+    results = zcatalog.unrestrictedSearchResults(object_provides=ifaces)
+    num_objects = len(results)
+    pghandler = ZLogHandler(1000)
+    pghandler.init('Updating mime_type metadata', num_objects)
+    for brain in results:
+        pghandler.report(cnt)
+        try:
+            obj = brain._unrestrictedGetObject()
+        except (AttributeError, KeyError, TypeError, NotFound):
+            continue
         if not obj:
             continue
         # First get the new value:
@@ -169,6 +179,7 @@ def reindex_mime_type(context):
         record[metadata_index] = new_value
         catalog.data[brain.getRID()] = tuple(record)
         cnt += 1
+    pghandler.finish()
     logger.info('Reindexed `mime_type` for %s items' % str(cnt))
 
 


