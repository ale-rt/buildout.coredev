Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-10-23T15:47:48-04:00
Author: Alec Mitchell (alecpm) <alecpm@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/b13ed43a9823b93dfafab95eb3d3d0538dd5d783

Miscellaneous toolbar layout bugfixes. Position correctly on resize refs #1127, fix user menu position with zoomed browser, mobile/desktop menu event handlers not properly unbound.

Files changed:
M CHANGES.rst
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 79c10f1..ee2e2cf 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -23,6 +23,10 @@ Bug fixes:
 
 - Add default icon for top-level contentview and contentmenu toolbar entries [alecm]
 
+Bug fixes:
+
+- Fix various layout issues in toolbar [alecm]
+
 - Fix TinyMCE table styles [vangheem]
 
 - Apply security hotfix 20160830 for ``z3c.form`` widgets.  [maurits]
diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 0bdfd0c..694f818 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -53,6 +53,9 @@ define([
           $( 'html' ).css('margin-right', '120px');
         }
       });
+      // Remove desktop event binding
+      $('nav > ul > li', that.$container).has( 'a .plone-toolbar-caret' ).off('click');
+      // Add sub-menu events
       $('nav li a', that.$container).has('.plone-toolbar-caret').off('click').on('click', function(e) {
         e.preventDefault();
         e.stopPropagation();
@@ -81,6 +84,14 @@ define([
         $('body').removeClass(that.options.classNames.expanded);
       }
 
+      if (!that.state.left) {
+        $('body').addClass(that.options.classNames.top);
+        $('body').addClass(that.state.expanded ? that.options.classNames.topExpanded : that.options.classNames.topDefault);
+        $('body').removeClass(that.options.classNames.left);
+        $('body').removeClass(that.options.classNames.leftDefault);
+        $('body').removeClass(that.options.classNames.leftExpanded);
+      }
+
       $('.' + that.options.classNames.logo, that.$container).off('click').on('click', function() {
         if (that.state.expanded) {
           // currently expanded, need to compress
@@ -120,6 +131,8 @@ define([
         event.stopImmediatePropagation();
       });
 
+      // Remove mobile event binding
+      $('nav li a', that.$container).has('.plone-toolbar-caret').off('click');
       // content menu activated
       $('nav > ul > li', that.$container).has( 'a .plone-toolbar-caret' ).off('click').on('click', function(event) {
         var $this = $(this);
@@ -179,7 +192,9 @@ define([
       var insideHeight = ($last.position().top - $first.position().top) + $last.outerHeight();
       var height = $content.outerHeight();
 
-      var itemLocation = $li.position().top || $li.offset().top;  // depends on positioning
+      // WebKit seems to set top position to very very small float value when zoomed,
+      // so check if the position top is less than 1px rather than 0.
+      var itemLocation = $li.position().top > 1 ? $li.position().top : $li.offset().top;  // depends on positioning
       // margin-top + insideHeight should equal total height
       $content.css({
         'margin-top': Math.min(itemLocation, height - insideHeight)


