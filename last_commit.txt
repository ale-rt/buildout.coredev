Repository: plone.api


Branch: refs/heads/master
Date: 2017-09-24T11:39:39+02:00
Author: Roel Bruggink (jaroel) <roel@jaroel.nl>
Commit: https://github.com/plone/plone.api/commit/c4faab1330d2e0a8d0d1d6a84f11fd49dc622e2d

Don't rename an object when the id already is the target id.

Files changed:
M CHANGES.rst
M src/plone/api/content.py
M src/plone/api/tests/test_content.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b88dc19..a2678b9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,9 @@ New features:
 
 Bug fixes:
 
+- Don't rename an object when the id already is the target id. Refs #361.
+  [jaroel]
+
 - Let ``zope.i18n`` do the language negotiation for our ``translate`` function.
   Our ``get_current_translation`` does not always give the correct one, especially with combined languages:
   ``nl-be`` (Belgian/Flemish) should fall back to ``nl`` (Dutch).
diff --git a/src/plone/api/content.py b/src/plone/api/content.py
index 7bfb219..9fd60f6 100644
--- a/src/plone/api/content.py
+++ b/src/plone/api/content.py
@@ -193,9 +193,9 @@ def move(source=None, target=None, id=None, safe_id=False):
 
     # If no target is given the object is probably renamed
     if target and source.aq_parent is not target:
-            target.manage_pasteObjects(
-                source.aq_parent.manage_cutObjects(source_id),
-            )
+        target.manage_pasteObjects(
+            source.aq_parent.manage_cutObjects(source_id),
+        )
     else:
         target = source.aq_parent
 
@@ -227,7 +227,8 @@ def rename(obj=None, new_id=None, safe_id=False):
         chooser = INameChooser(container)
         new_id = chooser.chooseName(new_id, obj)
 
-    container.manage_renameObject(obj_id, new_id)
+    if obj_id != new_id:
+        container.manage_renameObject(obj_id, new_id)
     return container[new_id]
 
 
diff --git a/src/plone/api/tests/test_content.py b/src/plone/api/tests/test_content.py
index df00abc..18c747a 100644
--- a/src/plone/api/tests/test_content.py
+++ b/src/plone/api/tests/test_content.py
@@ -550,6 +550,9 @@ def recordEvent(event):
                 container['about']['link-to-blog-1-1'] == linktoblog11)
         assert 'link-to-blog' not in container.keys()
 
+    def test_rename_same_id(self):
+        api.content.rename(obj=self.contact, new_id=self.contact.getId())
+
     def test_rename_same_folder(self):
         # When renaming a folderish item with safe_id=True, and there is
         # already an existing folderish item with that id, it should choose


Repository: plone.api


Branch: refs/heads/master
Date: 2017-09-25T09:36:39+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.api/commit/b99b5d093ff7fb6b498c9e8c83da82fe8e51e336

Merge branch '361-rename-same-id'

Files changed:
M CHANGES.rst
M src/plone/api/content.py
M src/plone/api/tests/test_content.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 24f9569..48d0485 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,12 @@ New features:
 
 Bug fixes:
 
-- Change content.delete to allow both obj=None and objects=[] or objects=None. Fixes #383
+- Don't rename an object when the id already is the target id.
+  Fixes `issue 361 <https://github.com/plone/plone.api/issues/361>`_.
+  [jaroel]
+
+- Change content.delete to allow both obj=None and objects=[] or objects=None.
+  Fixes `issue 383 <https://github.com/plone/plone.api/issues/383>`_.
   [jaroel]
 
 - Let ``zope.i18n`` do the language negotiation for our ``translate`` function.
diff --git a/src/plone/api/content.py b/src/plone/api/content.py
index 0516a97..03913c9 100644
--- a/src/plone/api/content.py
+++ b/src/plone/api/content.py
@@ -227,7 +227,8 @@ def rename(obj=None, new_id=None, safe_id=False):
         chooser = INameChooser(container)
         new_id = chooser.chooseName(new_id, obj)
 
-    container.manage_renameObject(obj_id, new_id)
+    if obj_id != new_id:
+        container.manage_renameObject(obj_id, new_id)
     return container[new_id]
 
 
diff --git a/src/plone/api/tests/test_content.py b/src/plone/api/tests/test_content.py
index 3b347c2..1662e8f 100644
--- a/src/plone/api/tests/test_content.py
+++ b/src/plone/api/tests/test_content.py
@@ -550,6 +550,9 @@ def recordEvent(event):
                 container['about']['link-to-blog-1-1'] == linktoblog11)
         assert 'link-to-blog' not in container.keys()
 
+    def test_rename_same_id(self):
+        api.content.rename(obj=self.contact, new_id=self.contact.getId())
+
     def test_rename_same_folder(self):
         # When renaming a folderish item with safe_id=True, and there is
         # already an existing folderish item with that id, it should choose


