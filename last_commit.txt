Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-04-07T12:51:24-03:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/a99df813fabff4e4cb4988d29592f8b50b16d65a

Fix #1511 when aggregating bundles, use ++plone++static overrided versions if any

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py
M Products/CMFPlone/tests/test_metabundles.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bda95d1..6a2c1ca 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -20,6 +20,9 @@ Fixes:
 
 - *add item here*
 
+- Bundle aggregation must use ++plone++static overrided versions if any.
+  [ebrehault]
+
 
 5.0.4 (2016-04-06)
 ------------------
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 289a98d..2ba659a 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -30,6 +30,14 @@ def get_production_resource_directory():
 
 
 def get_resource(context, path):
+    if path.startswith('++plone++'):
+        # ++plone++ resources can be customized, we return their override
+        # value if any
+        overrides = get_override_directory(context)
+        filepath = path[9:]
+        if overrides.isFile(filepath):
+            return overrides.readFile(filepath)
+
     resource = context.unrestrictedTraverse(path)
     if isinstance(resource, FilesystemFile):
         (directory, sep, filename) = path.rpartition('/')
@@ -87,13 +95,17 @@ def write_css(context, folder, meta_bundle):
     folder.writeFile(meta_bundle + ".css", fi)
 
 
-def combine_bundles(context):
+def get_override_directory(context):
     persistent_directory = queryUtility(IResourceDirectory, name="persistent")
     if persistent_directory is None:
         return
     if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:
         persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)
-    container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+    return persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+
+
+def combine_bundles(context):
+    container = get_override_directory(context)
     if PRODUCTION_RESOURCE_DIRECTORY not in container:
         container.makeDirectory(PRODUCTION_RESOURCE_DIRECTORY)
     production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]
diff --git a/Products/CMFPlone/tests/test_metabundles.py b/Products/CMFPlone/tests/test_metabundles.py
index 35d2346..3b29e6c 100644
--- a/Products/CMFPlone/tests/test_metabundles.py
+++ b/Products/CMFPlone/tests/test_metabundles.py
@@ -38,3 +38,16 @@ def test_default_js_bundle(self):
             "jQuery",
             self.production_folder.readFile('default.js')
         )
+
+    def test_overrides(self):
+        persistent_directory = getUtility(
+            IResourceDirectory, name="persistent")
+        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+        container.makeDirectory('static')
+        static = container['static']
+        static.writeFile('plone-legacy-compiled.js', 'alert("Overrided legacy!");')
+        combine_bundles(self.portal)
+        self.assertIn(
+            'alert("Overrided legacy!");',
+            self.production_folder.readFile('default.js')
+        )


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-04-07T14:33:32-03:00
Author: HÃ©ctor Velarde (hvelarde) <hvelarde@yahoo.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/41c12ba389b7e2ba6f39df34cadd16b0286de149

Merge pull request #1515 from plone/issue_1511_plone50

when aggregating bundles, use ++plone++static overrided versions if any

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/combine.py
M Products/CMFPlone/tests/test_metabundles.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bda95d1..6a2c1ca 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -20,6 +20,9 @@ Fixes:
 
 - *add item here*
 
+- Bundle aggregation must use ++plone++static overrided versions if any.
+  [ebrehault]
+
 
 5.0.4 (2016-04-06)
 ------------------
diff --git a/Products/CMFPlone/resources/browser/combine.py b/Products/CMFPlone/resources/browser/combine.py
index 289a98d..2ba659a 100644
--- a/Products/CMFPlone/resources/browser/combine.py
+++ b/Products/CMFPlone/resources/browser/combine.py
@@ -30,6 +30,14 @@ def get_production_resource_directory():
 
 
 def get_resource(context, path):
+    if path.startswith('++plone++'):
+        # ++plone++ resources can be customized, we return their override
+        # value if any
+        overrides = get_override_directory(context)
+        filepath = path[9:]
+        if overrides.isFile(filepath):
+            return overrides.readFile(filepath)
+
     resource = context.unrestrictedTraverse(path)
     if isinstance(resource, FilesystemFile):
         (directory, sep, filename) = path.rpartition('/')
@@ -87,13 +95,17 @@ def write_css(context, folder, meta_bundle):
     folder.writeFile(meta_bundle + ".css", fi)
 
 
-def combine_bundles(context):
+def get_override_directory(context):
     persistent_directory = queryUtility(IResourceDirectory, name="persistent")
     if persistent_directory is None:
         return
     if OVERRIDE_RESOURCE_DIRECTORY_NAME not in persistent_directory:
         persistent_directory.makeDirectory(OVERRIDE_RESOURCE_DIRECTORY_NAME)
-    container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+    return persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+
+
+def combine_bundles(context):
+    container = get_override_directory(context)
     if PRODUCTION_RESOURCE_DIRECTORY not in container:
         container.makeDirectory(PRODUCTION_RESOURCE_DIRECTORY)
     production_folder = container[PRODUCTION_RESOURCE_DIRECTORY]
diff --git a/Products/CMFPlone/tests/test_metabundles.py b/Products/CMFPlone/tests/test_metabundles.py
index 35d2346..3b29e6c 100644
--- a/Products/CMFPlone/tests/test_metabundles.py
+++ b/Products/CMFPlone/tests/test_metabundles.py
@@ -38,3 +38,16 @@ def test_default_js_bundle(self):
             "jQuery",
             self.production_folder.readFile('default.js')
         )
+
+    def test_overrides(self):
+        persistent_directory = getUtility(
+            IResourceDirectory, name="persistent")
+        container = persistent_directory[OVERRIDE_RESOURCE_DIRECTORY_NAME]
+        container.makeDirectory('static')
+        static = container['static']
+        static.writeFile('plone-legacy-compiled.js', 'alert("Overrided legacy!");')
+        combine_bundles(self.portal)
+        self.assertIn(
+            'alert("Overrided legacy!");',
+            self.production_folder.readFile('default.js')
+        )


