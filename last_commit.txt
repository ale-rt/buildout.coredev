Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2016-12-09T18:42:01Z
Author: Daniel Jowett (djowett) <daniel@jowettenterprises.com>
Commit: https://github.com/plone/plone.app.layout/commit/3c0593c9ef252666afdc903c82fd314857fd12ed

Rework sitemap.xml.gz to allow filtering of sitemap elements; and supply such a filter if LinguaPlone is installed.

The filter could (and probably should) be moved to LinguaPlone, but this is an improvement on previous code that assumed
LinguaPlone was the only multilingual addon for Plone

Files changed:
M plone/app/layout/sitemap/configure.zcml
M plone/app/layout/sitemap/sitemap.py

diff --git a/plone/app/layout/sitemap/configure.zcml b/plone/app/layout/sitemap/configure.zcml
index 992f5e8..1162b53 100644
--- a/plone/app/layout/sitemap/configure.zcml
+++ b/plone/app/layout/sitemap/configure.zcml
@@ -1,6 +1,7 @@
 <configure
     xmlns="http://namespaces.zope.org/zope"
-    xmlns:browser="http://namespaces.zope.org/browser">
+    xmlns:browser="http://namespaces.zope.org/browser"
+    xmlns:zcml="http://namespaces.zope.org/zcml">
 
   <browser:page
       name="sitemap.xml.gz"
@@ -9,4 +10,14 @@
       permission="zope2.Public"
      />
 
+  <configure zcml:condition="installed Products.LinguaPlone">
+      <browser:page
+          name="sitemap.xml.gz"
+          for="plone.app.layout.navigation.interfaces.INavigationRoot"
+          class=".sitemap.LinguaPloneSiteMapView"
+          permission="zope2.Public"
+          layer="Products.LinguaPlone.interfaces.ILinguaPloneProductLayer"
+         />
+  </configure>
+
 </configure>
diff --git a/plone/app/layout/sitemap/sitemap.py b/plone/app/layout/sitemap/sitemap.py
index 926869e..fa6295a 100644
--- a/plone/app/layout/sitemap/sitemap.py
+++ b/plone/app/layout/sitemap/sitemap.py
@@ -54,7 +54,10 @@ def objects(self):
 
         query['is_default_page'] = True
         default_page_modified = OOBTree()
-        for item in catalog.searchResults(query, Language='all'):
+
+        keywords = self.extra_search_parameters()
+        
+        for item in catalog.searchResults(query, **keywords):
             key = item.getURL().rsplit('/', 1)[0]
             value = (item.modified.micros(), item.modified.ISO8601())
             default_page_modified[key] = value
@@ -77,7 +80,8 @@ def objects(self):
             }
 
         query['is_default_page'] = False
-        for item in catalog.searchResults(query, Language='all'):
+
+        for item in catalog.searchResults(query, **keywords):
             loc = item.getURL()
             date = item.modified
             # Comparison must be on GMT value
@@ -116,3 +120,22 @@ def __call__(self):
         self.request.response.setHeader('Content-Type',
                                         'application/octet-stream')
         return self.generate()
+        
+    def extra_search_parameters(self):
+        """Allows extra filtering of the sitemap 
+        for use (in particular) by LinguaPlone
+        
+        :returns: a dictionary of keyword parameters to pass into 
+        catalog.searchResults()
+        """
+        return {}
+
+
+class LinguaPloneSiteMapView(SiteMapView):
+    """Overrides SiteMapView with patch for LinguaPlone
+    """
+
+    def extra_search_parameters(self):
+        """Work around LinguaPlone's catalog patch."""
+        # see https://github.com/plone/Products.LinguaPlone/blob/master/Products/LinguaPlone/catalog.py
+        return {Language:'all'}


Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2016-12-09T18:42:01Z
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.layout/commit/45809440844afe318d4332581fa0b807d111d42b

Fix the dict key

Files changed:
M plone/app/layout/sitemap/sitemap.py

diff --git a/plone/app/layout/sitemap/sitemap.py b/plone/app/layout/sitemap/sitemap.py
index fa6295a..8460f7a 100644
--- a/plone/app/layout/sitemap/sitemap.py
+++ b/plone/app/layout/sitemap/sitemap.py
@@ -138,4 +138,4 @@ class LinguaPloneSiteMapView(SiteMapView):
     def extra_search_parameters(self):
         """Work around LinguaPlone's catalog patch."""
         # see https://github.com/plone/Products.LinguaPlone/blob/master/Products/LinguaPlone/catalog.py
-        return {Language:'all'}
+        return {'Language':'all'}


Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2016-12-09T18:43:12Z
Author: Daniel Jowett (djowett) <daniel@jowettenterprises.com>
Commit: https://github.com/plone/plone.app.layout/commit/ca6c2d995af428d5642074a926baeb990ee193ed

Update changelog

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index f79e29d..faeee23 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,11 @@ Changelog
 2.3.16 (unreleased)
 -------------------
 
-- Nothing changed yet.
+Fixes:
+
+- Rework sitemap.xml.gz to allow filtering of sitemap elements; and supply such
+  a filter if LinguaPlone is installed.
+  [djowett]
 
 
 2.3.15 (2016-06-28)


Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2016-12-19T12:14:58+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/facd91fdba603884e8116bddb03e09e88a3272fe

Merge pull request #92 from plone/2.3.x_issue_91

Rework sitemap.xml.gz view to fix it for plone.app.multilingual [2.3.x]

Files changed:
M CHANGES.rst
M plone/app/layout/sitemap/configure.zcml
M plone/app/layout/sitemap/sitemap.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bb093c1..d0f309f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,11 @@ Changelog
 2.3.16 (unreleased)
 -------------------
 
-- Nothing changed yet.
+Fixes:
+
+- Rework sitemap.xml.gz to allow filtering of sitemap elements; and supply such
+  a filter if LinguaPlone is installed.
+  [djowett]
 
 
 2.3.15 (2016-06-28)
diff --git a/plone/app/layout/sitemap/configure.zcml b/plone/app/layout/sitemap/configure.zcml
index 992f5e8..1162b53 100644
--- a/plone/app/layout/sitemap/configure.zcml
+++ b/plone/app/layout/sitemap/configure.zcml
@@ -1,6 +1,7 @@
 <configure
     xmlns="http://namespaces.zope.org/zope"
-    xmlns:browser="http://namespaces.zope.org/browser">
+    xmlns:browser="http://namespaces.zope.org/browser"
+    xmlns:zcml="http://namespaces.zope.org/zcml">
 
   <browser:page
       name="sitemap.xml.gz"
@@ -9,4 +10,14 @@
       permission="zope2.Public"
      />
 
+  <configure zcml:condition="installed Products.LinguaPlone">
+      <browser:page
+          name="sitemap.xml.gz"
+          for="plone.app.layout.navigation.interfaces.INavigationRoot"
+          class=".sitemap.LinguaPloneSiteMapView"
+          permission="zope2.Public"
+          layer="Products.LinguaPlone.interfaces.ILinguaPloneProductLayer"
+         />
+  </configure>
+
 </configure>
diff --git a/plone/app/layout/sitemap/sitemap.py b/plone/app/layout/sitemap/sitemap.py
index 926869e..8460f7a 100644
--- a/plone/app/layout/sitemap/sitemap.py
+++ b/plone/app/layout/sitemap/sitemap.py
@@ -54,7 +54,10 @@ def objects(self):
 
         query['is_default_page'] = True
         default_page_modified = OOBTree()
-        for item in catalog.searchResults(query, Language='all'):
+
+        keywords = self.extra_search_parameters()
+        
+        for item in catalog.searchResults(query, **keywords):
             key = item.getURL().rsplit('/', 1)[0]
             value = (item.modified.micros(), item.modified.ISO8601())
             default_page_modified[key] = value
@@ -77,7 +80,8 @@ def objects(self):
             }
 
         query['is_default_page'] = False
-        for item in catalog.searchResults(query, Language='all'):
+
+        for item in catalog.searchResults(query, **keywords):
             loc = item.getURL()
             date = item.modified
             # Comparison must be on GMT value
@@ -116,3 +120,22 @@ def __call__(self):
         self.request.response.setHeader('Content-Type',
                                         'application/octet-stream')
         return self.generate()
+        
+    def extra_search_parameters(self):
+        """Allows extra filtering of the sitemap 
+        for use (in particular) by LinguaPlone
+        
+        :returns: a dictionary of keyword parameters to pass into 
+        catalog.searchResults()
+        """
+        return {}
+
+
+class LinguaPloneSiteMapView(SiteMapView):
+    """Overrides SiteMapView with patch for LinguaPlone
+    """
+
+    def extra_search_parameters(self):
+        """Work around LinguaPlone's catalog patch."""
+        # see https://github.com/plone/Products.LinguaPlone/blob/master/Products/LinguaPlone/catalog.py
+        return {'Language':'all'}


