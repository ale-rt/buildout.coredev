Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-06-14T13:16:44-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/d7354eb44dde06c73b968c9f211306257708137e

Add option to wrap storage configuration with arbitrary new configuration

Files changed:
M CHANGES.rst
M README.rst
M src/plone/recipe/zope2instance/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f8425c3..6711156 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Added ``storage-wrapper`` option to wrap storage configuration.
+  [davisagli]
 
 Bug fixes:
 
diff --git a/README.rst b/README.rst
index 7318f30..c774bdc 100644
--- a/README.rst
+++ b/README.rst
@@ -371,6 +371,10 @@ demo-blob-storage
   used with the default memory-based demo storage (in this case you
   might want to use a temporary directory).
 
+storage-wrapper
+  Template for arbitrary configuration to be wrapped around the main storage.
+  %s will be replaced with the existing storage configuration.
+
 effective-user
   The name of the effective user for the Zope process. Defaults to not setting
   an effective user.
diff --git a/src/plone/recipe/zope2instance/__init__.py b/src/plone/recipe/zope2instance/__init__.py
index e01d9e6..19b2bd4 100644
--- a/src/plone/recipe/zope2instance/__init__.py
+++ b/src/plone/recipe/zope2instance/__init__.py
@@ -541,6 +541,9 @@ def is_rs_option(name):
             else:
                 storage_snippet = demo_storage_template % storage_snippet
 
+        if options.get('storage-wrapper'):
+            storage_snippet = indent(options['storage-wrapper'] % storage_snippet, 4)
+
         zodb_tmp_storage = options.get('zodb-temporary-storage',
                                        zodb_temporary_storage_template)
 


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-06-15T23:55:04-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/a2f7204ee1410bcf976e1ed1f6c8cc2869bea6f4

Add test for storage-wrapper option

Files changed:
M src/plone/recipe/zope2instance/tests/zope2instance.txt

diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt
index 5eb1346..d429631 100644
--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt
+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt
@@ -1315,6 +1315,57 @@ We should have a zope instance, with a basic zope.conf::
     ...
     <BLANKLINE>
 
+Custom storage wrapper
+======================
+
+To add custom configuration around the storage,
+use the `storage-wrapper` option::
+
+    >>> write('buildout.cfg',
+    ... '''
+    ... [buildout]
+    ... parts = instance
+    ... find-links = %(sample_buildout)s/eggs
+    ...
+    ... [instance]
+    ... recipe = plone.recipe.zope2instance
+    ... eggs =
+    ... user = me:me
+    ... storage-wrapper =
+    ...   <foo>
+    ...   %%s
+    ...   </foo>
+    ... ''' % options)
+
+Let's run it::
+
+    >>> print system(join('bin', 'buildout')),
+    Uninstalling instance.
+    Installing instance.
+    Generated script '...instance'.
+    Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
+
+Now zope.conf should include the custom storage wrapper::
+
+    >>> instance = os.path.join(sample_buildout, 'parts', 'instance')
+    >>> zope_conf = open(os.path.join(instance, 'etc', 'zope.conf')).read()
+    >>> zope_conf = zope_conf.replace('\\', '/')
+    >>> print zope_conf
+    %define INSTANCEHOME .../sample-buildout/parts/instance
+    ...
+    <zodb_db main>
+        ...
+        <foo>
+            # Blob-enabled FileStorage database
+            ...
+        </foo>
+        ...
+    </zodb_db>
+    ...
+    <BLANKLINE>
+
+
 Custom Event log
 ================
 


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-06-16T11:16:05+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/ffd977628e8e5f5793f25931c579ead085d1185c

Merge pull request #27 from plone/storage-wrapper

Add option to wrap storage configuration with arbitrary new configuration

Files changed:
M CHANGES.rst
M README.rst
M src/plone/recipe/zope2instance/__init__.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index f8425c3..6711156 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Added ``storage-wrapper`` option to wrap storage configuration.
+  [davisagli]
 
 Bug fixes:
 
diff --git a/README.rst b/README.rst
index 7318f30..c774bdc 100644
--- a/README.rst
+++ b/README.rst
@@ -371,6 +371,10 @@ demo-blob-storage
   used with the default memory-based demo storage (in this case you
   might want to use a temporary directory).
 
+storage-wrapper
+  Template for arbitrary configuration to be wrapped around the main storage.
+  %s will be replaced with the existing storage configuration.
+
 effective-user
   The name of the effective user for the Zope process. Defaults to not setting
   an effective user.
diff --git a/src/plone/recipe/zope2instance/__init__.py b/src/plone/recipe/zope2instance/__init__.py
index e01d9e6..19b2bd4 100644
--- a/src/plone/recipe/zope2instance/__init__.py
+++ b/src/plone/recipe/zope2instance/__init__.py
@@ -541,6 +541,9 @@ def is_rs_option(name):
             else:
                 storage_snippet = demo_storage_template % storage_snippet
 
+        if options.get('storage-wrapper'):
+            storage_snippet = indent(options['storage-wrapper'] % storage_snippet, 4)
+
         zodb_tmp_storage = options.get('zodb-temporary-storage',
                                        zodb_temporary_storage_template)
 
diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt
index 5eb1346..d429631 100644
--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt
+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt
@@ -1315,6 +1315,57 @@ We should have a zope instance, with a basic zope.conf::
     ...
     <BLANKLINE>
 
+Custom storage wrapper
+======================
+
+To add custom configuration around the storage,
+use the `storage-wrapper` option::
+
+    >>> write('buildout.cfg',
+    ... '''
+    ... [buildout]
+    ... parts = instance
+    ... find-links = %(sample_buildout)s/eggs
+    ...
+    ... [instance]
+    ... recipe = plone.recipe.zope2instance
+    ... eggs =
+    ... user = me:me
+    ... storage-wrapper =
+    ...   <foo>
+    ...   %%s
+    ...   </foo>
+    ... ''' % options)
+
+Let's run it::
+
+    >>> print system(join('bin', 'buildout')),
+    Uninstalling instance.
+    Installing instance.
+    Generated script '...instance'.
+    Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
+
+Now zope.conf should include the custom storage wrapper::
+
+    >>> instance = os.path.join(sample_buildout, 'parts', 'instance')
+    >>> zope_conf = open(os.path.join(instance, 'etc', 'zope.conf')).read()
+    >>> zope_conf = zope_conf.replace('\\', '/')
+    >>> print zope_conf
+    %define INSTANCEHOME .../sample-buildout/parts/instance
+    ...
+    <zodb_db main>
+        ...
+        <foo>
+            # Blob-enabled FileStorage database
+            ...
+        </foo>
+        ...
+    </zodb_db>
+    ...
+    <BLANKLINE>
+
+
 Custom Event log
 ================
 


