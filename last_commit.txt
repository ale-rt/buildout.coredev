Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-07-06T16:23:42+02:00
Author: Lennard Huiskes (lhuiskes) <l.huiskes@zestsoftware.nl>
Commit: https://github.com/plone/Products.TinyMCE/commit/6c50812e9f36a4312f5fc7c48809be2b62335689

Changed vertical align and text align to style instead of attribute.

Align and vertical align are not supported in html5.

Files changed:
M HISTORY.rst
M Products/TinyMCE/profiles.zcml
M Products/TinyMCE/profiles/default/metadata.xml
M Products/TinyMCE/setuphandlers.py
M Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
M Products/TinyMCE/upgrades.py

diff --git a/HISTORY.rst b/HISTORY.rst
index d3b0e12..eef84cf 100644
--- a/HISTORY.rst
+++ b/HISTORY.rst
@@ -15,7 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Changed vertical align and text align to style instead of attribute,
+  since align and vertical align are not supported in html5.
+  [lhuiskes, jladage]
 
 
 1.3.21 (2016-05-25)
diff --git a/Products/TinyMCE/profiles.zcml b/Products/TinyMCE/profiles.zcml
index 5bcf793..35ef096 100644
--- a/Products/TinyMCE/profiles.zcml
+++ b/Products/TinyMCE/profiles.zcml
@@ -100,6 +100,15 @@
         handler=".upgrades.upgrade_to_profile_7"
         />
 
+   <genericsetup:upgradeStep
+        title="Upgrade TinyMCE 1.3.21 to 1.3.22"
+        description="Allow vertical aligning in table rows"
+        source="7"
+        destination="8"
+        profile="Products.TinyMCE:TinyMCE"
+        handler=".upgrades.upgrade_to_profile_8"
+        />
+
     <genericsetup:upgradeStep
         title="Install plone.outputfilters"
         description="This replaces the old TinyMCE-specific resolveuid and captioning transform."
diff --git a/Products/TinyMCE/profiles/default/metadata.xml b/Products/TinyMCE/profiles/default/metadata.xml
index d7bd03b..2960b02 100644
--- a/Products/TinyMCE/profiles/default/metadata.xml
+++ b/Products/TinyMCE/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>7</version>
+  <version>8</version>
   <dependencies>
     <dependency>profile-plone.outputfilters:default</dependency>
     <dependency>profile-plone.app.imaging:default</dependency>
diff --git a/Products/TinyMCE/setuphandlers.py b/Products/TinyMCE/setuphandlers.py
index bbd08d1..f09702b 100644
--- a/Products/TinyMCE/setuphandlers.py
+++ b/Products/TinyMCE/setuphandlers.py
@@ -58,6 +58,7 @@ def unregisterUtility(context):
 
     transaction.commit()
 
+
 # BBB deprecated in Plone 4.1
 deprecatedFrom("Please import from plone.outputfilters.setuphandlers instead.",
                'plone.outputfilters.setuphandlers',
diff --git a/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js b/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
index 0c678de..73c96ef 100644
--- a/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
+++ b/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
@@ -11,11 +11,25 @@ function init() {
 	var trElm = dom.getParent(inst.selection.getStart(), "tr");
 	var formObj = document.forms[0];
 	var st = dom.parseStyle(dom.getAttrib(trElm, "style"));
+  var managedStyles = ['text-align', 'vertical-align']
+  var currentStyle = [];
+
+  for (var item in st) {
+    if (st.hasOwnProperty(item)) {
+      if (managedStyles.indexOf(item) < 0) {
+        currentStyle[item] = st[item];
+      }
+      else if (item === 'text-align') {
+        var align = st[item];
+      }
+      else if (item === 'vertical-align') {
+        var valign = st[item];
+      }
+    }
+  }
 
 	// Get table row data
 	var rowtype = trElm.parentNode.nodeName.toLowerCase();
-	var align = dom.getAttrib(trElm, 'align');
-	var valign = dom.getAttrib(trElm, 'valign');
 	var height = trimSize(getStyle(trElm, 'height', 'height'));
 	var className = dom.getAttrib(trElm, 'class');
 	var bgcolor = convertRGBToHex(getStyle(trElm, 'bgcolor', 'backgroundColor'));
@@ -38,7 +52,7 @@ function init() {
 		formObj.height.value = height;
 		formObj.id.value = id;
 		formObj.lang.value = lang;
-		formObj.style.value = dom.serializeStyle(st);
+		formObj.style.value = dom.serializeStyle(currentStyle);
 		selectByValue(formObj, 'align', align);
 		selectByValue(formObj, 'valign', valign);
 		selectByValue(formObj, 'class', className, true, true);
@@ -124,26 +138,26 @@ function updateRow(tr_elm, skip_id, skip_parent) {
 	var curRowType = tr_elm.parentNode.nodeName.toLowerCase();
 	var rowtype = getSelectValue(formObj, 'rowtype');
 	var doc = inst.getDoc();
-
+ 
 	// Update row element
 	if (!skip_id)
 		dom.setAttrib(tr_elm, 'id', formObj.id.value);
-
-	dom.setAttrib(tr_elm, 'align', getSelectValue(formObj, 'align'));
-	dom.setAttrib(tr_elm, 'vAlign', getSelectValue(formObj, 'valign'));
+ 
 	dom.setAttrib(tr_elm, 'lang', formObj.lang.value);
 	dom.setAttrib(tr_elm, 'dir', getSelectValue(formObj, 'dir'));
 	dom.setAttrib(tr_elm, 'style', dom.serializeStyle(dom.parseStyle(formObj.style.value)));
 	dom.setAttrib(tr_elm, 'class', getSelectValue(formObj, 'class'));
-
+ 
 	// Clear deprecated attributes
 	dom.setAttrib(tr_elm, 'background', '');
 	dom.setAttrib(tr_elm, 'bgColor', '');
 	dom.setAttrib(tr_elm, 'height', '');
-
+ 
 	// Set styles
 	tr_elm.style.height = getCSSSize(formObj.height.value);
 	tr_elm.style.backgroundColor = formObj.bgcolor.value;
+  tr_elm.style.textAlign = formObj.align.value; 
+  tr_elm.style.verticalAlign = formObj.valign.value; 
 
 	if (formObj.backgroundimage.value != "")
 		tr_elm.style.backgroundImage = "url('" + formObj.backgroundimage.value + "')";
@@ -182,7 +196,6 @@ function updateRow(tr_elm, skip_id, skip_parent) {
 		// set tr_elm to the new node
 		tr_elm = newRow;
 	}
-
 	dom.setAttrib(tr_elm, 'style', dom.serializeStyle(dom.parseStyle(tr_elm.style.cssText)));
 }
 
@@ -251,4 +264,5 @@ function setActionforRowType(formObj, rowtype) {
 		formObj.action.disabled = true;
 	}
 }
+
 tinyMCEPopup.onInit.add(init);
diff --git a/Products/TinyMCE/upgrades.py b/Products/TinyMCE/upgrades.py
index 098dceb..4095e47 100644
--- a/Products/TinyMCE/upgrades.py
+++ b/Products/TinyMCE/upgrades.py
@@ -93,3 +93,13 @@ def upgrade_to_profile_7(setuptool):
     tinymce.styles = tinymce.styles.replace(u'Definition term|dt| ', u'Definition term|dt|')
     tinymce.styles = tinymce.styles.replace(u'Definition description|dd| ', u'Definition description|dd|')
     tinymce.styles = tinymce.styles.replace(u'Heading cell|th| ', u'Heading cell|th|')
+
+
+def upgrade_to_profile_8(context):
+    """Update the safe_html transform, add vertical-align to style_whitelist."""
+    transform = getToolByName(context, 'portal_transforms').safe_html
+    transform._tr_init(1)  # load new config items
+    tdata = transform._config['style_whitelist']
+    tdata.append('vertical-align')
+    transform._p_changed = True
+    transform.reload()


Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2016-07-07T23:43:13+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.TinyMCE/commit/e4a37f8678f4158d8f2e78fd5dc023d85b3ee6eb

Merge pull request #145 from plone/zest-vertical-align

Changed vertical align and text align to style instead of attribute.

Files changed:
M HISTORY.rst
M Products/TinyMCE/profiles.zcml
M Products/TinyMCE/profiles/default/metadata.xml
M Products/TinyMCE/setuphandlers.py
M Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
M Products/TinyMCE/upgrades.py

diff --git a/HISTORY.rst b/HISTORY.rst
index d3b0e12..eef84cf 100644
--- a/HISTORY.rst
+++ b/HISTORY.rst
@@ -15,7 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Changed vertical align and text align to style instead of attribute,
+  since align and vertical align are not supported in html5.
+  [lhuiskes, jladage]
 
 
 1.3.21 (2016-05-25)
diff --git a/Products/TinyMCE/profiles.zcml b/Products/TinyMCE/profiles.zcml
index 5bcf793..35ef096 100644
--- a/Products/TinyMCE/profiles.zcml
+++ b/Products/TinyMCE/profiles.zcml
@@ -100,6 +100,15 @@
         handler=".upgrades.upgrade_to_profile_7"
         />
 
+   <genericsetup:upgradeStep
+        title="Upgrade TinyMCE 1.3.21 to 1.3.22"
+        description="Allow vertical aligning in table rows"
+        source="7"
+        destination="8"
+        profile="Products.TinyMCE:TinyMCE"
+        handler=".upgrades.upgrade_to_profile_8"
+        />
+
     <genericsetup:upgradeStep
         title="Install plone.outputfilters"
         description="This replaces the old TinyMCE-specific resolveuid and captioning transform."
diff --git a/Products/TinyMCE/profiles/default/metadata.xml b/Products/TinyMCE/profiles/default/metadata.xml
index d7bd03b..2960b02 100644
--- a/Products/TinyMCE/profiles/default/metadata.xml
+++ b/Products/TinyMCE/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>7</version>
+  <version>8</version>
   <dependencies>
     <dependency>profile-plone.outputfilters:default</dependency>
     <dependency>profile-plone.app.imaging:default</dependency>
diff --git a/Products/TinyMCE/setuphandlers.py b/Products/TinyMCE/setuphandlers.py
index bbd08d1..f09702b 100644
--- a/Products/TinyMCE/setuphandlers.py
+++ b/Products/TinyMCE/setuphandlers.py
@@ -58,6 +58,7 @@ def unregisterUtility(context):
 
     transaction.commit()
 
+
 # BBB deprecated in Plone 4.1
 deprecatedFrom("Please import from plone.outputfilters.setuphandlers instead.",
                'plone.outputfilters.setuphandlers',
diff --git a/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js b/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
index 0c678de..73c96ef 100644
--- a/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
+++ b/Products/TinyMCE/skins/tinymce/plugins/table/js/row.js
@@ -11,11 +11,25 @@ function init() {
 	var trElm = dom.getParent(inst.selection.getStart(), "tr");
 	var formObj = document.forms[0];
 	var st = dom.parseStyle(dom.getAttrib(trElm, "style"));
+  var managedStyles = ['text-align', 'vertical-align']
+  var currentStyle = [];
+
+  for (var item in st) {
+    if (st.hasOwnProperty(item)) {
+      if (managedStyles.indexOf(item) < 0) {
+        currentStyle[item] = st[item];
+      }
+      else if (item === 'text-align') {
+        var align = st[item];
+      }
+      else if (item === 'vertical-align') {
+        var valign = st[item];
+      }
+    }
+  }
 
 	// Get table row data
 	var rowtype = trElm.parentNode.nodeName.toLowerCase();
-	var align = dom.getAttrib(trElm, 'align');
-	var valign = dom.getAttrib(trElm, 'valign');
 	var height = trimSize(getStyle(trElm, 'height', 'height'));
 	var className = dom.getAttrib(trElm, 'class');
 	var bgcolor = convertRGBToHex(getStyle(trElm, 'bgcolor', 'backgroundColor'));
@@ -38,7 +52,7 @@ function init() {
 		formObj.height.value = height;
 		formObj.id.value = id;
 		formObj.lang.value = lang;
-		formObj.style.value = dom.serializeStyle(st);
+		formObj.style.value = dom.serializeStyle(currentStyle);
 		selectByValue(formObj, 'align', align);
 		selectByValue(formObj, 'valign', valign);
 		selectByValue(formObj, 'class', className, true, true);
@@ -124,26 +138,26 @@ function updateRow(tr_elm, skip_id, skip_parent) {
 	var curRowType = tr_elm.parentNode.nodeName.toLowerCase();
 	var rowtype = getSelectValue(formObj, 'rowtype');
 	var doc = inst.getDoc();
-
+ 
 	// Update row element
 	if (!skip_id)
 		dom.setAttrib(tr_elm, 'id', formObj.id.value);
-
-	dom.setAttrib(tr_elm, 'align', getSelectValue(formObj, 'align'));
-	dom.setAttrib(tr_elm, 'vAlign', getSelectValue(formObj, 'valign'));
+ 
 	dom.setAttrib(tr_elm, 'lang', formObj.lang.value);
 	dom.setAttrib(tr_elm, 'dir', getSelectValue(formObj, 'dir'));
 	dom.setAttrib(tr_elm, 'style', dom.serializeStyle(dom.parseStyle(formObj.style.value)));
 	dom.setAttrib(tr_elm, 'class', getSelectValue(formObj, 'class'));
-
+ 
 	// Clear deprecated attributes
 	dom.setAttrib(tr_elm, 'background', '');
 	dom.setAttrib(tr_elm, 'bgColor', '');
 	dom.setAttrib(tr_elm, 'height', '');
-
+ 
 	// Set styles
 	tr_elm.style.height = getCSSSize(formObj.height.value);
 	tr_elm.style.backgroundColor = formObj.bgcolor.value;
+  tr_elm.style.textAlign = formObj.align.value; 
+  tr_elm.style.verticalAlign = formObj.valign.value; 
 
 	if (formObj.backgroundimage.value != "")
 		tr_elm.style.backgroundImage = "url('" + formObj.backgroundimage.value + "')";
@@ -182,7 +196,6 @@ function updateRow(tr_elm, skip_id, skip_parent) {
 		// set tr_elm to the new node
 		tr_elm = newRow;
 	}
-
 	dom.setAttrib(tr_elm, 'style', dom.serializeStyle(dom.parseStyle(tr_elm.style.cssText)));
 }
 
@@ -251,4 +264,5 @@ function setActionforRowType(formObj, rowtype) {
 		formObj.action.disabled = true;
 	}
 }
+
 tinyMCEPopup.onInit.add(init);
diff --git a/Products/TinyMCE/upgrades.py b/Products/TinyMCE/upgrades.py
index 098dceb..4095e47 100644
--- a/Products/TinyMCE/upgrades.py
+++ b/Products/TinyMCE/upgrades.py
@@ -93,3 +93,13 @@ def upgrade_to_profile_7(setuptool):
     tinymce.styles = tinymce.styles.replace(u'Definition term|dt| ', u'Definition term|dt|')
     tinymce.styles = tinymce.styles.replace(u'Definition description|dd| ', u'Definition description|dd|')
     tinymce.styles = tinymce.styles.replace(u'Heading cell|th| ', u'Heading cell|th|')
+
+
+def upgrade_to_profile_8(context):
+    """Update the safe_html transform, add vertical-align to style_whitelist."""
+    transform = getToolByName(context, 'portal_transforms').safe_html
+    transform._tr_init(1)  # load new config items
+    tdata = transform._config['style_whitelist']
+    tdata.append('vertical-align')
+    transform._p_changed = True
+    transform.reload()


