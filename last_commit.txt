Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-10-20T12:18:22+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/9d7b47b195c3a9defdc5be7caa2905196b72bb5f

Adapt to changes in CMF 2.4 and Zope 4

Files changed:
M CHANGES.rst
M plone/app/upgrade/utils.py
M plone/app/upgrade/v40/alphas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 47b6d40..fb5b336 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -17,6 +17,8 @@ Bug fixes:
 - Fixed WrongType exception when migrating installed Iterate to 5.0.
   [maurits]
 
+- Adapt to changes in CMF 2.4 (getCurrentKeyFormat removed) and Zope 4 (not Products in Control Panel).
+  [pbauer]
 
 2.0.8 (2017-09-25)
 ------------------
diff --git a/plone/app/upgrade/utils.py b/plone/app/upgrade/utils.py
index e482bca..fe81240 100644
--- a/plone/app/upgrade/utils.py
+++ b/plone/app/upgrade/utils.py
@@ -125,7 +125,9 @@ def cleanUpSkinsTool(context):
             # not a directory view, but a persistent folder
             continue
         try:
-            reg_key = _dirreg.getCurrentKeyFormat(reg_key)
+            # Removed in CMF 2.3
+            if getattr(_dirreg, 'getCurrentKeyFormat', None):
+                reg_key = _dirreg.getCurrentKeyFormat(reg_key)
             _dirreg.getDirectoryInfo(reg_key)
         except ValueError:
             skins._delObject(name)
diff --git a/plone/app/upgrade/v40/alphas.py b/plone/app/upgrade/v40/alphas.py
index c1aee55..b2bbc3b 100644
--- a/plone/app/upgrade/v40/alphas.py
+++ b/plone/app/upgrade/v40/alphas.py
@@ -400,13 +400,13 @@ def cleanUpSkinsTool(context):
 
 def cleanUpProductRegistry(context):
     control = getattr(context, 'Control_Panel', None)
-    if control:
+    # Zope 4 has no Products anymore
+    if control and getattr(control, 'Products', None):
         products = control.Products
 
         # Remove all product entries
         for name in products.keys():
             products._delObject(name)
-    # else: pass  # Zope 4 doesn't have the Control_Panel anymore
 
 
 def migrateStaticTextPortlets(context):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-10-21T13:24:17+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/82f13e2dca15384c1a9c874198cfda950553f223

Add upgrade space for 5.2

Files changed:
A plone/app/upgrade/v52/__init__.py
A plone/app/upgrade/v52/alphas.py
A plone/app/upgrade/v52/configure.zcml
A plone/app/upgrade/v52/profiles.zcml
A plone/app/upgrade/v52/tests.py

diff --git a/plone/app/upgrade/v52/__init__.py b/plone/app/upgrade/v52/__init__.py
new file mode 100644
index 0000000..40a96af
--- /dev/null
+++ b/plone/app/upgrade/v52/__init__.py
@@ -0,0 +1 @@
+# -*- coding: utf-8 -*-
diff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py
new file mode 100644
index 0000000..b005c75
--- /dev/null
+++ b/plone/app/upgrade/v52/alphas.py
@@ -0,0 +1,14 @@
+# -*- coding: utf-8 -*-
+from plone.app.upgrade.utils import loadMigrationProfile
+from plone.registry.interfaces import IRegistry
+from zope.component import getUtility
+
+import logging
+
+
+logger = logging.getLogger('plone.app.upgrade')
+
+def to52alpha1(context):
+    loadMigrationProfile(context, 'profile-plone.app.upgrade.v52:to52alpha1')
+    _fix_typo_in_toolbar_less_variable(context)
+
diff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml
new file mode 100644
index 0000000..0c17e68
--- /dev/null
+++ b/plone/app/upgrade/v52/configure.zcml
@@ -0,0 +1,23 @@
+<configure
+    xmlns="http://namespaces.zope.org/zope"
+    xmlns:gs="http://namespaces.zope.org/genericsetup"
+    xmlns:zcml="http://namespaces.zope.org/zcml"
+    i18n_domain="plone">
+
+    <include file="profiles.zcml" />
+
+    <gs:upgradeSteps
+        source="5199"
+        destination="5200"
+        profile="Products.CMFPlone:plone">
+
+      <gs:upgradeStep
+           title="Run to52alpha1 upgrade profile."
+           description=""
+           handler="plone.app.upgrade.utils.null_upgrade_step"
+           />
+
+    </gs:upgradeSteps>
+
+
+</configure>
diff --git a/plone/app/upgrade/v52/profiles.zcml b/plone/app/upgrade/v52/profiles.zcml
new file mode 100644
index 0000000..93c6f7f
--- /dev/null
+++ b/plone/app/upgrade/v52/profiles.zcml
@@ -0,0 +1,15 @@
+<configure
+    xmlns="http://namespaces.zope.org/zope"
+    xmlns:genericsetup="http://namespaces.zope.org/genericsetup"
+    i18n_domain="plone">
+
+  <genericsetup:registerProfile
+      name="to52alpha1"
+      title="Upgrade profile for Plone 5.1.x to Plone 5.2alpha1"
+      description=""
+      directory="profiles/to_alpha1"
+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      />
+
+</configure>
diff --git a/plone/app/upgrade/v52/tests.py b/plone/app/upgrade/v52/tests.py
new file mode 100644
index 0000000..b4b2b2b
--- /dev/null
+++ b/plone/app/upgrade/v52/tests.py
@@ -0,0 +1,26 @@
+# -*- coding: utf-8 -*-
+from plone.app.testing import PLONE_INTEGRATION_TESTING
+from plone.app.upgrade.v50.testing import REAL_UPGRADE_FUNCTIONAL
+from zope.component import getUtility
+from plone.registry.interfaces import IRegistry
+from Products.CMFPlone.interfaces import IFilterSchema
+
+import unittest
+
+try:
+    from Products.CMFPlone.factory import _IMREALLYPLONE5
+    _IMREALLYPLONE5  # pyflakes
+except ImportError:
+    PLONE_5 = False
+else:
+    PLONE_5 = True
+
+
+
+def test_suite():
+    # Skip these tests on Plone 4
+    if not PLONE_5:
+        return unittest.TestSuite()
+
+    suite = unittest.TestSuite()
+    return suite


