Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-09-11T09:13:57+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/7f93c42aef0d426167d23f47e75105a01601da09

Register settings for safe_html-Transform when migrating from 5107 to 5108

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c3e54b7..bdc8e5d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Register settings for safe_html-Transform when migrating from 5107 to 5108
+  [pbauer]
 
 
 2.0.7 (2017-09-10)
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index cc26234..cd3abf6 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -185,7 +185,12 @@ def move_safe_html_settings_to_registry(context):
     """ Move safe_html settings from portal_transforms to Plone registry.
     """
     registry = getUtility(IRegistry)
-    settings = registry.forInterface(IFilterSchema, prefix='plone')
+    try:
+        settings = registry.forInterface(IFilterSchema, prefix='plone')
+    except KeyError:
+        # Catch case where valid_tags is not yet registered
+        registry.registerInterface(IFilterSchema, prefix='plone')
+        settings = registry.forInterface(IFilterSchema, prefix='plone')
     pt = getToolByName(context, 'portal_transforms')
     disable_filtering = pt.safe_html._config.get('disable_transform')
     raw_valid_tags = pt.safe_html._config.get('valid_tags') or {}


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-09-11T14:53:36+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/df778e3e999c7736e945af2e881633cf97bf2753

Merge pull request #135 from plone/register_safe_html_settings

Register safe_html-Transform settings when migrating from 5107 to 5108

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c3e54b7..bdc8e5d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Register settings for safe_html-Transform when migrating from 5107 to 5108
+  [pbauer]
 
 
 2.0.7 (2017-09-10)
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index cc26234..cd3abf6 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -185,7 +185,12 @@ def move_safe_html_settings_to_registry(context):
     """ Move safe_html settings from portal_transforms to Plone registry.
     """
     registry = getUtility(IRegistry)
-    settings = registry.forInterface(IFilterSchema, prefix='plone')
+    try:
+        settings = registry.forInterface(IFilterSchema, prefix='plone')
+    except KeyError:
+        # Catch case where valid_tags is not yet registered
+        registry.registerInterface(IFilterSchema, prefix='plone')
+        settings = registry.forInterface(IFilterSchema, prefix='plone')
     pt = getToolByName(context, 'portal_transforms')
     disable_filtering = pt.safe_html._config.get('disable_transform')
     raw_valid_tags = pt.safe_html._config.get('valid_tags') or {}


