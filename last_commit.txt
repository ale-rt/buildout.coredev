Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2016-08-31T22:24:29+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/f83d28493eb8c77ae6a7c718ec6e59ebb8f394db

Use transaction savepoints

Files changed:
M CHANGES.rst
M plone/app/linkintegrity/browser/update.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1039ad4..0abd5e2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Use transaction savepoints while calling @@updateLinkIntegrityInformation
+  to keep memory usage under control.
+  [ale-rt]
 
 
 3.0.6 (2016-08-17)
diff --git a/plone/app/linkintegrity/browser/update.py b/plone/app/linkintegrity/browser/update.py
index 109293d..0cd5323 100644
--- a/plone/app/linkintegrity/browser/update.py
+++ b/plone/app/linkintegrity/browser/update.py
@@ -1,12 +1,13 @@
 # -*- coding: utf-8 -*-
 from Acquisition import aq_inner
+from datetime import datetime
+from datetime import timedelta
+from plone.app.linkintegrity.handlers import modifiedContent
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone import PloneMessageFactory as _
 from Products.Five import BrowserView
 from Products.statusmessages.interfaces import IStatusMessage
-from datetime import datetime
-from datetime import timedelta
-from plone.app.linkintegrity.handlers import modifiedContent
+from transaction import savepoint
 from zExceptions import NotFound
 import logging
 import pkg_resources
@@ -73,10 +74,12 @@ def update(self):
                 msg = "Catalog inconsistency: {} not found!"
                 logger.error(msg.format(brain.getPath()), exc_info=1)
                 continue
-	    try:
-		modifiedContent(obj, 'dummy event parameter')
-		count += 1
-	    except Exception:
-		msg = "Error updating linkintegrity-info for {}."
-		logger.error(msg.format(obj.absolute_url()), exc_info=1)
+            try:
+                modifiedContent(obj, 'dummy event parameter')
+                count += 1
+            except Exception:
+                msg = "Error updating linkintegrity-info for {}."
+                logger.error(msg.format(obj.absolute_url()), exc_info=1)
+            if count % 1000 == 0:
+                savepoint(optimistic=True)
         return count


Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2016-09-03T00:29:45+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/9c9ba3768a749eb0d9a832add0931bf8df162560

Merge pull request #42 from plone/use-savepoints

Use transaction savepoints

Files changed:
M CHANGES.rst
M plone/app/linkintegrity/browser/update.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1039ad4..0abd5e2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Use transaction savepoints while calling @@updateLinkIntegrityInformation
+  to keep memory usage under control.
+  [ale-rt]
 
 
 3.0.6 (2016-08-17)
diff --git a/plone/app/linkintegrity/browser/update.py b/plone/app/linkintegrity/browser/update.py
index 109293d..0cd5323 100644
--- a/plone/app/linkintegrity/browser/update.py
+++ b/plone/app/linkintegrity/browser/update.py
@@ -1,12 +1,13 @@
 # -*- coding: utf-8 -*-
 from Acquisition import aq_inner
+from datetime import datetime
+from datetime import timedelta
+from plone.app.linkintegrity.handlers import modifiedContent
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone import PloneMessageFactory as _
 from Products.Five import BrowserView
 from Products.statusmessages.interfaces import IStatusMessage
-from datetime import datetime
-from datetime import timedelta
-from plone.app.linkintegrity.handlers import modifiedContent
+from transaction import savepoint
 from zExceptions import NotFound
 import logging
 import pkg_resources
@@ -73,10 +74,12 @@ def update(self):
                 msg = "Catalog inconsistency: {} not found!"
                 logger.error(msg.format(brain.getPath()), exc_info=1)
                 continue
-	    try:
-		modifiedContent(obj, 'dummy event parameter')
-		count += 1
-	    except Exception:
-		msg = "Error updating linkintegrity-info for {}."
-		logger.error(msg.format(obj.absolute_url()), exc_info=1)
+            try:
+                modifiedContent(obj, 'dummy event parameter')
+                count += 1
+            except Exception:
+                msg = "Error updating linkintegrity-info for {}."
+                logger.error(msg.format(obj.absolute_url()), exc_info=1)
+            if count % 1000 == 0:
+                savepoint(optimistic=True)
         return count


