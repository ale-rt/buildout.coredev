Repository: Products.CMFDynamicViewFTI


Branch: refs/heads/master
Date: 2017-02-03T11:32:38+01:00
Author: Malthe Borch (malthe) <mborch@gmail.com>
Commit: https://github.com/plone/Products.CMFDynamicViewFTI/commit/670128dd5ccf1d0b915ef6d502f1878aa6c07b5f

Look up view using lower-level API to check for existence

Files changed:
M CHANGES.rst
M Products/CMFDynamicViewFTI/browserdefault.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3895840..cd7e554 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Don't instantiate browser view to check for existence.
+  [malthe]
 
 
 4.1.4 (2016-05-06)
diff --git a/Products/CMFDynamicViewFTI/browserdefault.py b/Products/CMFDynamicViewFTI/browserdefault.py
index 230b555..ccc8e34 100644
--- a/Products/CMFDynamicViewFTI/browserdefault.py
+++ b/Products/CMFDynamicViewFTI/browserdefault.py
@@ -16,8 +16,8 @@
 from Products.CMFDynamicViewFTI.interfaces import ISelectableBrowserDefault
 from Products.CMFDynamicViewFTI.permissions import ModifyViewTemplate
 from zope.browsermenu.interfaces import IBrowserMenu
-from zope.interface import implementer
-import zope.component
+from zope.component import getSiteManager, getUtility
+from zope.interface import Interface, implementer, providedBy
 
 _marker = object()
 fti_meta_type = DynamicViewTypeInformation.meta_type
@@ -195,15 +195,12 @@ def getAvailableLayouts(self):
             return ()
         result = []
         method_ids = fti.getAvailableViewMethods(self)
+        spec = (providedBy(self), providedBy(self.REQUEST))
+        gsm = getSiteManager()
         for mid in method_ids:
-            view = zope.component.queryMultiAdapter(
-                (self, self.REQUEST),
-                zope.interface.Interface,
-                name=mid
-            )
-
-            if view is not None:
-                menu = zope.component.getUtility(
+            factory = gsm.adapters.lookup(spec, Interface, mid)
+            if factory is not None:
+                menu = getUtility(
                     IBrowserMenu,
                     'plone_displayviews'
                 )


Repository: Products.CMFDynamicViewFTI


Branch: refs/heads/master
Date: 2017-02-03T15:05:00+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFDynamicViewFTI/commit/2441ee97d1155cdfd82203c29c07f59ad208cc86

Merge pull request #10 from plone/no-browser-view-create-on-exist-check

Look up view using lower-level API to check for existence

Files changed:
M CHANGES.rst
M Products/CMFDynamicViewFTI/browserdefault.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3895840..cd7e554 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Don't instantiate browser view to check for existence.
+  [malthe]
 
 
 4.1.4 (2016-05-06)
diff --git a/Products/CMFDynamicViewFTI/browserdefault.py b/Products/CMFDynamicViewFTI/browserdefault.py
index 230b555..ccc8e34 100644
--- a/Products/CMFDynamicViewFTI/browserdefault.py
+++ b/Products/CMFDynamicViewFTI/browserdefault.py
@@ -16,8 +16,8 @@
 from Products.CMFDynamicViewFTI.interfaces import ISelectableBrowserDefault
 from Products.CMFDynamicViewFTI.permissions import ModifyViewTemplate
 from zope.browsermenu.interfaces import IBrowserMenu
-from zope.interface import implementer
-import zope.component
+from zope.component import getSiteManager, getUtility
+from zope.interface import Interface, implementer, providedBy
 
 _marker = object()
 fti_meta_type = DynamicViewTypeInformation.meta_type
@@ -195,15 +195,12 @@ def getAvailableLayouts(self):
             return ()
         result = []
         method_ids = fti.getAvailableViewMethods(self)
+        spec = (providedBy(self), providedBy(self.REQUEST))
+        gsm = getSiteManager()
         for mid in method_ids:
-            view = zope.component.queryMultiAdapter(
-                (self, self.REQUEST),
-                zope.interface.Interface,
-                name=mid
-            )
-
-            if view is not None:
-                menu = zope.component.getUtility(
+            factory = gsm.adapters.lookup(spec, Interface, mid)
+            if factory is not None:
+                menu = getUtility(
                     IBrowserMenu,
                     'plone_displayviews'
                 )


