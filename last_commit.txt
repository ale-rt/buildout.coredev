Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-10-11T01:05:00+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/4305ce058f08648232354cb0f78b02f9dd38b6fc

Fixed WrongType exception when migrating installed Iterate to 5.0.

This mitigates the effects from https://github.com/plone/plone.app.upgrade/pull/136

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 4e70d97..47b6d40 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed WrongType exception when migrating installed Iterate to 5.0.
+  [maurits]
 
 
 2.0.8 (2017-09-25)
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 59412f4..c7a3487 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -17,6 +17,7 @@
 from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
+from zope.schema._bootstrapinterfaces import WrongType
 
 import logging
 import pkg_resources
@@ -570,7 +571,14 @@ def to50rc3(context):
         value = site_properties.getProperty('checkout_workflow_policy')
         from plone.app.iterate.interfaces import IIterateSettings
         settings = registry.forInterface(IIterateSettings)
-        settings.checkout_workflow_policy = str(value)
+        # Some versions of plone.app.iterate require a string here,
+        # others a unicode.  Best seems to be to try both.
+        try:
+            # plone.app.iterate 3.3.2+
+            settings.checkout_workflow_policy = str(value)
+        except WrongType:
+            # plone.app.iterate 3.3.1-
+            settings.checkout_workflow_policy = safe_unicode(value)
         site_properties._delProperty('checkout_workflow_policy')
 
     if site_properties.hasProperty('default_page_types'):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-10-11T12:19:10+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/7142a0cc155ba129b9aa88f35d8ce257df9b4ff9

Merge pull request #140 from plone/iterate-both-str-unicode

Fixed WrongType exception when migrating installed Iterate to 5.0.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 4e70d97..47b6d40 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed WrongType exception when migrating installed Iterate to 5.0.
+  [maurits]
 
 
 2.0.8 (2017-09-25)
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 59412f4..c7a3487 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -17,6 +17,7 @@
 from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
+from zope.schema._bootstrapinterfaces import WrongType
 
 import logging
 import pkg_resources
@@ -570,7 +571,14 @@ def to50rc3(context):
         value = site_properties.getProperty('checkout_workflow_policy')
         from plone.app.iterate.interfaces import IIterateSettings
         settings = registry.forInterface(IIterateSettings)
-        settings.checkout_workflow_policy = str(value)
+        # Some versions of plone.app.iterate require a string here,
+        # others a unicode.  Best seems to be to try both.
+        try:
+            # plone.app.iterate 3.3.2+
+            settings.checkout_workflow_policy = str(value)
+        except WrongType:
+            # plone.app.iterate 3.3.1-
+            settings.checkout_workflow_policy = safe_unicode(value)
         site_properties._delProperty('checkout_workflow_policy')
 
     if site_properties.hasProperty('default_page_types'):


