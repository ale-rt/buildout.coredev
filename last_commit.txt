Repository: plone.app.vocabularies


Branch: refs/heads/master
Date: 2016-10-17T23:58:51-04:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.vocabularies/commit/32a4264d8d8a3971db2f74e47918324e5641291b

Remove zope.formlib dependency

Make it optional and mark all vocabularies based on it as deprecated.

This fixes https://github.com/plone/plone.app.vocabularies/issues/38

Files changed:
M CHANGES.rst
M plone/app/vocabularies/catalog.py
M plone/app/vocabularies/configure.zcml
M plone/app/vocabularies/groups.py
M plone/app/vocabularies/users.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index cc96384..3ff2bda 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,7 +6,11 @@ Changelog
 
 Breaking changes:
 
-- *add item here*
+- Make zope.formlib optional.
+  [gforcada]
+
+- Mark vocabularies based on zope.formlib as deprecated.
+  [gforcada]
 
 New features:
 
diff --git a/plone/app/vocabularies/catalog.py b/plone/app/vocabularies/catalog.py
index fa7bc7e..116d25a 100644
--- a/plone/app/vocabularies/catalog.py
+++ b/plone/app/vocabularies/catalog.py
@@ -14,7 +14,6 @@
 from Products.ZCTextIndex.ParseTree import ParseError
 from zope.browser.interfaces import ITerms
 from zope.component import queryUtility
-from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implementer
 from zope.interface import provider
 from zope.schema.interfaces import IContextSourceBinder
@@ -26,6 +25,16 @@
 
 import itertools
 import os
+import warnings
+
+
+try:
+    from zope.formlib.interfaces import ISourceQueryView
+except ImportError:
+    from zope.interface import Interface
+
+    class ISourceQueryView(Interface):
+        pass
 
 
 def parse_query(query, path_prefix=''):
@@ -317,6 +326,9 @@ class QuerySearchableTextSourceView(object):
     template = ViewPageTemplateFile('searchabletextsource.pt')
 
     def __init__(self, context, request):
+        msg = 'QuerySearchableTextSourceView is deprecated and will be ' \
+              'removed on Plone 6'
+        warnings.warn(msg, DeprecationWarning)
         self.context = context
         self.request = request
 
diff --git a/plone/app/vocabularies/configure.zcml b/plone/app/vocabularies/configure.zcml
index b54ae7d..acc8d86 100644
--- a/plone/app/vocabularies/configure.zcml
+++ b/plone/app/vocabularies/configure.zcml
@@ -168,6 +168,7 @@
       />
 
   <adapter
+      zcml:condition="installed zope.formlib"
       for=".catalog.SearchableTextSource
            zope.publisher.interfaces.browser.IBrowserRequest"
       factory=".catalog.QuerySearchableTextSourceView"
@@ -182,6 +183,7 @@
       />
 
   <adapter
+      zcml:condition="installed zope.formlib"
       for=".users.UsersSource
            zope.publisher.interfaces.browser.IBrowserRequest"
       factory=".users.UsersSourceQueryView"
@@ -196,6 +198,7 @@
       />
 
   <adapter
+      zcml:condition="installed zope.formlib"
       for=".groups.GroupsSource
            zope.publisher.interfaces.browser.IBrowserRequest"
       factory=".groups.GroupsSourceQueryView"
diff --git a/plone/app/vocabularies/groups.py b/plone/app/vocabularies/groups.py
index 9c6b0e9..bac86f6 100644
--- a/plone/app/vocabularies/groups.py
+++ b/plone/app/vocabularies/groups.py
@@ -2,13 +2,23 @@
 from Products.CMFCore.utils import getToolByName
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 from zope.browser.interfaces import ITerms
-from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implementer
 from zope.interface import provider
 from zope.schema.interfaces import IContextSourceBinder
 from zope.schema.interfaces import ISource
 from zope.schema.vocabulary import SimpleTerm
 
+import warnings
+
+
+try:
+    from zope.formlib.interfaces import ISourceQueryView
+except ImportError:
+    from zope.interface import Interface
+
+    class ISourceQueryView(Interface):
+        pass
+
 
 @implementer(ISource)
 @provider(IContextSourceBinder)
@@ -137,6 +147,9 @@ class GroupsSourceQueryView(object):
     template = ViewPageTemplateFile('searchabletextsource.pt')
 
     def __init__(self, context, request):
+        msg = 'GroupsSourceQueryView is deprecated and will be removed on ' \
+              'Plone 6'
+        warnings.warn(msg, DeprecationWarning)
         self.context = context
         self.request = request
 
diff --git a/plone/app/vocabularies/users.py b/plone/app/vocabularies/users.py
index 8f4b082..7b96227 100644
--- a/plone/app/vocabularies/users.py
+++ b/plone/app/vocabularies/users.py
@@ -4,7 +4,6 @@
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 from zope.browser.interfaces import ITerms
 from zope.component.hooks import getSite
-from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implementer
 from zope.interface import provider
 from zope.schema.interfaces import IContextSourceBinder
@@ -12,6 +11,17 @@
 from zope.schema.interfaces import IVocabularyFactory
 from zope.schema.vocabulary import SimpleTerm
 
+import warnings
+
+
+try:
+    from zope.formlib.interfaces import ISourceQueryView
+except ImportError:
+    from zope.interface import Interface
+
+    class ISourceQueryView(Interface):
+        pass
+
 
 def _createUserTerm(userid, context=None, acl_users=None):
     if acl_users is None:
@@ -184,6 +194,9 @@ class UsersSourceQueryView(object):
     template = ViewPageTemplateFile('searchabletextsource.pt')
 
     def __init__(self, context, request):
+        msg = 'UsersSourceQueryView is deprecated and will be removed on ' \
+              'Plone 6'
+        warnings.warn(msg, DeprecationWarning)
         self.context = context
         self.request = request
 
diff --git a/setup.py b/setup.py
index 3b13076..2a6b6af 100644
--- a/setup.py
+++ b/setup.py
@@ -41,7 +41,6 @@
         'setuptools',
         'zope.browser',
         'zope.component',
-        'zope.formlib',
         'zope.i18n',
         'zope.i18nmessageid',
         'zope.interface',


Repository: plone.app.vocabularies


Branch: refs/heads/master
Date: 2016-10-18T17:41:24-04:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.app.vocabularies/commit/53c193bcccf5044e5ceb2bce2458f2dca7c763cd

Merge pull request #42 from plone/gforcada-remove-formlib

Remove zope.formlib dependency

Files changed:
M CHANGES.rst
M plone/app/vocabularies/catalog.py
M plone/app/vocabularies/configure.zcml
M plone/app/vocabularies/groups.py
M plone/app/vocabularies/users.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index cc96384..3ff2bda 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,7 +6,11 @@ Changelog
 
 Breaking changes:
 
-- *add item here*
+- Make zope.formlib optional.
+  [gforcada]
+
+- Mark vocabularies based on zope.formlib as deprecated.
+  [gforcada]
 
 New features:
 
diff --git a/plone/app/vocabularies/catalog.py b/plone/app/vocabularies/catalog.py
index fa7bc7e..116d25a 100644
--- a/plone/app/vocabularies/catalog.py
+++ b/plone/app/vocabularies/catalog.py
@@ -14,7 +14,6 @@
 from Products.ZCTextIndex.ParseTree import ParseError
 from zope.browser.interfaces import ITerms
 from zope.component import queryUtility
-from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implementer
 from zope.interface import provider
 from zope.schema.interfaces import IContextSourceBinder
@@ -26,6 +25,16 @@
 
 import itertools
 import os
+import warnings
+
+
+try:
+    from zope.formlib.interfaces import ISourceQueryView
+except ImportError:
+    from zope.interface import Interface
+
+    class ISourceQueryView(Interface):
+        pass
 
 
 def parse_query(query, path_prefix=''):
@@ -317,6 +326,9 @@ class QuerySearchableTextSourceView(object):
     template = ViewPageTemplateFile('searchabletextsource.pt')
 
     def __init__(self, context, request):
+        msg = 'QuerySearchableTextSourceView is deprecated and will be ' \
+              'removed on Plone 6'
+        warnings.warn(msg, DeprecationWarning)
         self.context = context
         self.request = request
 
diff --git a/plone/app/vocabularies/configure.zcml b/plone/app/vocabularies/configure.zcml
index b54ae7d..acc8d86 100644
--- a/plone/app/vocabularies/configure.zcml
+++ b/plone/app/vocabularies/configure.zcml
@@ -168,6 +168,7 @@
       />
 
   <adapter
+      zcml:condition="installed zope.formlib"
       for=".catalog.SearchableTextSource
            zope.publisher.interfaces.browser.IBrowserRequest"
       factory=".catalog.QuerySearchableTextSourceView"
@@ -182,6 +183,7 @@
       />
 
   <adapter
+      zcml:condition="installed zope.formlib"
       for=".users.UsersSource
            zope.publisher.interfaces.browser.IBrowserRequest"
       factory=".users.UsersSourceQueryView"
@@ -196,6 +198,7 @@
       />
 
   <adapter
+      zcml:condition="installed zope.formlib"
       for=".groups.GroupsSource
            zope.publisher.interfaces.browser.IBrowserRequest"
       factory=".groups.GroupsSourceQueryView"
diff --git a/plone/app/vocabularies/groups.py b/plone/app/vocabularies/groups.py
index 9c6b0e9..bac86f6 100644
--- a/plone/app/vocabularies/groups.py
+++ b/plone/app/vocabularies/groups.py
@@ -2,13 +2,23 @@
 from Products.CMFCore.utils import getToolByName
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 from zope.browser.interfaces import ITerms
-from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implementer
 from zope.interface import provider
 from zope.schema.interfaces import IContextSourceBinder
 from zope.schema.interfaces import ISource
 from zope.schema.vocabulary import SimpleTerm
 
+import warnings
+
+
+try:
+    from zope.formlib.interfaces import ISourceQueryView
+except ImportError:
+    from zope.interface import Interface
+
+    class ISourceQueryView(Interface):
+        pass
+
 
 @implementer(ISource)
 @provider(IContextSourceBinder)
@@ -137,6 +147,9 @@ class GroupsSourceQueryView(object):
     template = ViewPageTemplateFile('searchabletextsource.pt')
 
     def __init__(self, context, request):
+        msg = 'GroupsSourceQueryView is deprecated and will be removed on ' \
+              'Plone 6'
+        warnings.warn(msg, DeprecationWarning)
         self.context = context
         self.request = request
 
diff --git a/plone/app/vocabularies/users.py b/plone/app/vocabularies/users.py
index 8f4b082..7b96227 100644
--- a/plone/app/vocabularies/users.py
+++ b/plone/app/vocabularies/users.py
@@ -4,7 +4,6 @@
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 from zope.browser.interfaces import ITerms
 from zope.component.hooks import getSite
-from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implementer
 from zope.interface import provider
 from zope.schema.interfaces import IContextSourceBinder
@@ -12,6 +11,17 @@
 from zope.schema.interfaces import IVocabularyFactory
 from zope.schema.vocabulary import SimpleTerm
 
+import warnings
+
+
+try:
+    from zope.formlib.interfaces import ISourceQueryView
+except ImportError:
+    from zope.interface import Interface
+
+    class ISourceQueryView(Interface):
+        pass
+
 
 def _createUserTerm(userid, context=None, acl_users=None):
     if acl_users is None:
@@ -184,6 +194,9 @@ class UsersSourceQueryView(object):
     template = ViewPageTemplateFile('searchabletextsource.pt')
 
     def __init__(self, context, request):
+        msg = 'UsersSourceQueryView is deprecated and will be removed on ' \
+              'Plone 6'
+        warnings.warn(msg, DeprecationWarning)
         self.context = context
         self.request = request
 
diff --git a/setup.py b/setup.py
index 3b13076..2a6b6af 100644
--- a/setup.py
+++ b/setup.py
@@ -41,7 +41,6 @@
         'setuptools',
         'zope.browser',
         'zope.component',
-        'zope.formlib',
         'zope.i18n',
         'zope.i18nmessageid',
         'zope.interface',


