Repository: plone.api


Branch: refs/heads/master
Date: 2016-11-05T23:39:10+01:00
Author: Gil Forcada (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.api/commit/1fd9016925eb04d3f6895791681c04efcc543b2a

Avoid a copy &amp; paste on api.conent.move

If source parent's is the target.

Fixes
https://github.com/plone/plone.api/issues/313

Files changed:
M docs/CHANGES.rst
M src/plone/api/content.py
M src/plone/api/tests/test_content.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 9e065f3..873a93b 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -25,6 +25,9 @@ Fixes:
 - Fix travis and coveralls.
   [gforcada]
 
+- In api.content.move if source **and** target are specified and target is already
+  source parent, skip the operation.
+
 1.5 (2016-02-20)
 ----------------
 
diff --git a/src/plone/api/content.py b/src/plone/api/content.py
index 5dad574..d7c1047 100644
--- a/src/plone/api/content.py
+++ b/src/plone/api/content.py
@@ -185,9 +185,10 @@ def move(source=None, target=None, id=None, safe_id=False):
     source_id = source.getId()
 
     # If no target is given the object is probably renamed
-    if target:
-        target.manage_pasteObjects(
-            source.aq_parent.manage_cutObjects(source_id))
+    if target and source.aq_parent is not target:
+            target.manage_pasteObjects(
+                source.aq_parent.manage_cutObjects(source_id)
+            )
     else:
         target = source.aq_parent
 
diff --git a/src/plone/api/tests/test_content.py b/src/plone/api/tests/test_content.py
index d6b3ac1..9083fd0 100644
--- a/src/plone/api/tests/test_content.py
+++ b/src/plone/api/tests/test_content.py
@@ -401,6 +401,14 @@ def test_move(self):
         assert (container['events']['about'] and
                 container['events']['about'] == about)
 
+    def test_move_no_move_if_target_is_source_parent(self):
+        """Test that trying to move an object to its parent is a noop"""
+        new_contact = api.content.move(
+            source=self.contact,
+            target=self.contact.aq_parent,
+        )
+        assert new_contact == self.contact
+
     def test_rename_constraints(self):
         """Test the constraints for rename content."""
         from plone.api.exc import MissingParameterError


Repository: plone.api


Branch: refs/heads/master
Date: 2016-11-06T01:21:39+01:00
Author: Roel Bruggink (jaroel) <roel@jaroel.nl>
Commit: https://github.com/plone/plone.api/commit/beb6f79a716f7eb932920270ff25d9d1b3eef3a4

Make sure the branch it not called

Files changed:
M src/plone/api/tests/test_content.py

diff --git a/src/plone/api/tests/test_content.py b/src/plone/api/tests/test_content.py
index 9083fd0..8e0f269 100644
--- a/src/plone/api/tests/test_content.py
+++ b/src/plone/api/tests/test_content.py
@@ -403,11 +403,15 @@ def test_move(self):
 
     def test_move_no_move_if_target_is_source_parent(self):
         """Test that trying to move an object to its parent is a noop"""
-        new_contact = api.content.move(
-            source=self.contact,
-            target=self.contact.aq_parent,
-        )
-        assert new_contact == self.contact
+
+        target = self.contact.aq_parent
+        with mock.patch.object(target, 'manage_pasteObjects'):
+            api.content.move(
+                source=self.contact,
+                target=target,
+            )
+
+            self.assertFalse(target.manage_pasteObjects.called)
 
     def test_rename_constraints(self):
         """Test the constraints for rename content."""


Repository: plone.api


Branch: refs/heads/master
Date: 2016-11-06T23:48:59+01:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.api/commit/619905a7af07ae8903446ca0256d8346e21f4e54

Merge pull request #331 from plone/gforcada-patch-1

Avoid a copy &amp; paste on api.conent.move

Files changed:
M docs/CHANGES.rst
M src/plone/api/content.py
M src/plone/api/tests/test_content.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 9e065f3..873a93b 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -25,6 +25,9 @@ Fixes:
 - Fix travis and coveralls.
   [gforcada]
 
+- In api.content.move if source **and** target are specified and target is already
+  source parent, skip the operation.
+
 1.5 (2016-02-20)
 ----------------
 
diff --git a/src/plone/api/content.py b/src/plone/api/content.py
index 5dad574..d7c1047 100644
--- a/src/plone/api/content.py
+++ b/src/plone/api/content.py
@@ -185,9 +185,10 @@ def move(source=None, target=None, id=None, safe_id=False):
     source_id = source.getId()
 
     # If no target is given the object is probably renamed
-    if target:
-        target.manage_pasteObjects(
-            source.aq_parent.manage_cutObjects(source_id))
+    if target and source.aq_parent is not target:
+            target.manage_pasteObjects(
+                source.aq_parent.manage_cutObjects(source_id)
+            )
     else:
         target = source.aq_parent
 
diff --git a/src/plone/api/tests/test_content.py b/src/plone/api/tests/test_content.py
index d6b3ac1..8e0f269 100644
--- a/src/plone/api/tests/test_content.py
+++ b/src/plone/api/tests/test_content.py
@@ -401,6 +401,18 @@ def test_move(self):
         assert (container['events']['about'] and
                 container['events']['about'] == about)
 
+    def test_move_no_move_if_target_is_source_parent(self):
+        """Test that trying to move an object to its parent is a noop"""
+
+        target = self.contact.aq_parent
+        with mock.patch.object(target, 'manage_pasteObjects'):
+            api.content.move(
+                source=self.contact,
+                target=target,
+            )
+
+            self.assertFalse(target.manage_pasteObjects.called)
+
     def test_rename_constraints(self):
         """Test the constraints for rename content."""
         from plone.api.exc import MissingParameterError


