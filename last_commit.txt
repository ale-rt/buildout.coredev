Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/848be550774b11f392a4369508512199ecb4f5a3

fix import of zopectl from ZServer

Files changed:
M CHANGES.rst
M src/plone/recipe/zope2instance/ctl.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bccc0d6..5db2d8f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fix import. zopectl moved to ZServer
+  [pbauer]
 
 
 4.3 (2017-06-28)
diff --git a/src/plone/recipe/zope2instance/ctl.py b/src/plone/recipe/zope2instance/ctl.py
index 37fbb73..ded5fae 100644
--- a/src/plone/recipe/zope2instance/ctl.py
+++ b/src/plone/recipe/zope2instance/ctl.py
@@ -33,7 +33,7 @@
 import sys
 from pkg_resources import iter_entry_points
 
-from Zope2.Startup import zopectl
+from ZServer.Zope2.Startup import zopectl
 
 if zopectl.WIN:
     import traceback


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/4b72db604bba9f05ec976b19f163d30a155b9684

changes for zdaemon&gt;=4.1.0

Files changed:
M src/plone/recipe/zope2instance/__init__.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt

diff --git a/src/plone/recipe/zope2instance/__init__.py b/src/plone/recipe/zope2instance/__init__.py
index 19b2bd4..adb0d3f 100644
--- a/src/plone/recipe/zope2instance/__init__.py
+++ b/src/plone/recipe/zope2instance/__init__.py
@@ -613,6 +613,8 @@ def install_scripts(self):
         # The instance control script
         zope_conf = os.path.join(location, 'etc', 'zope.conf')
         zope_conf_path = options.get('zope-conf', zope_conf)
+        program_name = 'interpreter'
+        program_path = os.path.join(location, 'bin', program_name)
 
         zopectl_umask = options.get('zopectl-umask', '')
 
@@ -633,8 +635,9 @@ def __repr__(self):
                             self._relative_paths
                         )
                     )
+            # XXX relativize program_path
 
-        arguments = ["-C", zope_conf_path]
+        arguments = ["-C", zope_conf_path, '-p', program_path]
         if zopectl_umask:
             arguments.extend(["--umask", int(zopectl_umask, 8)])
         script_arguments = ('\n        ' + repr(arguments) +
@@ -645,7 +648,7 @@ def __repr__(self):
             script_arguments=script_arguments)
         generated.extend(self._install_scripts(
             os.path.join(options['location'], 'bin'), ws,
-            interpreter='interpreter', extra_paths=extra_paths))
+            interpreter=program_name, extra_paths=extra_paths))
         return generated
 
     def _install_scripts(self, dest, working_set, reqs=(), interpreter=None,
diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt
index d429631..db01aa6 100644
--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt
+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt
@@ -34,7 +34,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -161,7 +160,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Our FTP server should be set up now::
 
@@ -199,7 +197,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Our WebDAV server should be set up now::
 
@@ -238,7 +235,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Our WebDAV server should be set up now::
 
@@ -281,7 +277,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -333,7 +328,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf without demostorage::
 
@@ -386,7 +380,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -447,7 +440,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -501,7 +493,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -563,7 +554,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -624,7 +614,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -688,7 +677,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -747,7 +735,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -813,7 +800,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -872,7 +858,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -923,7 +908,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -985,7 +969,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1042,7 +1025,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1099,7 +1081,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1157,7 +1138,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1227,7 +1207,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1282,7 +1261,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1402,7 +1380,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with the custom event log::
 
@@ -1460,7 +1437,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with the mailing logger::
 
@@ -1522,7 +1498,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with the custom event log::
 
@@ -1572,7 +1547,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with no access log::
 
@@ -1612,7 +1586,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with no access log::
 
@@ -1662,7 +1635,6 @@ Let's run the buildout::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Now let's check that we have a zope instance, with the custom site.zcml::
 
@@ -1704,7 +1676,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Our environment variables should be set now::
 
@@ -1744,7 +1715,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Our environment variables should be set now::
 
@@ -1778,7 +1748,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Our environment variables should be set now::
 
@@ -1815,7 +1784,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 And check it::
 
@@ -1860,7 +1828,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Relative paths in scripts
 =========================
@@ -1884,7 +1851,6 @@ The recipe supports the generation of scripts with relative paths.
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 Our generated script now has a reference to the relative path.
 
@@ -1922,7 +1888,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance script with the custom config file::
 
@@ -1930,7 +1895,7 @@ We should have a zope instance script with the custom config file::
     >>> if WINDOWS:
     ...     instance_path += '-script.py'
     >>> open(instance_path).read()
-    "...plone.recipe.zope2instance.ctl.main(...['-C', '/some/path/my.conf']..."
+    "...plone.recipe.zope2instance.ctl.main(...['-C', '/some/path/my.conf', '-p', '.../bin/interpreter']..."
 
 Custom Zope Conf Imports
 ========================
@@ -1959,7 +1924,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should have a zope instance, with custom imports::
 
@@ -1999,7 +1963,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 The directory should have been generated, and zope config created::
 
@@ -2042,7 +2005,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 The directory should have been generated, and zope config created::
 
@@ -2085,7 +2047,6 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
-    ...
 
 We should see the given initialization commands included in the instance
 script::


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/373a203f324c9b9ca01c5e7c595ef4f16f052ca5

Travis needs final ... for a RuntimeWarning

Files changed:
M src/plone/recipe/zope2instance/tests/zope2instance.txt

diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt
index db01aa6..e8224c1 100644
--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt
+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt
@@ -34,6 +34,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -160,6 +161,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Our FTP server should be set up now::
 
@@ -197,6 +199,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Our WebDAV server should be set up now::
 
@@ -235,6 +238,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Our WebDAV server should be set up now::
 
@@ -277,6 +281,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -328,6 +333,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf without demostorage::
 
@@ -380,6 +386,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -440,6 +447,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -493,6 +501,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -554,6 +563,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -614,6 +624,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -677,6 +688,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -735,6 +747,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -800,6 +813,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -858,6 +872,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -908,6 +923,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -969,6 +985,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1025,6 +1042,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1081,6 +1099,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1138,6 +1157,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1207,6 +1227,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1261,6 +1282,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with a basic zope.conf::
 
@@ -1380,6 +1402,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with the custom event log::
 
@@ -1437,6 +1460,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with the mailing logger::
 
@@ -1498,6 +1522,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with the custom event log::
 
@@ -1547,6 +1572,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with no access log::
 
@@ -1586,6 +1612,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with no access log::
 
@@ -1635,6 +1662,7 @@ Let's run the buildout::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Now let's check that we have a zope instance, with the custom site.zcml::
 
@@ -1676,6 +1704,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Our environment variables should be set now::
 
@@ -1715,6 +1744,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Our environment variables should be set now::
 
@@ -1748,6 +1778,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Our environment variables should be set now::
 
@@ -1784,6 +1815,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 And check it::
 
@@ -1828,6 +1860,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Relative paths in scripts
 =========================
@@ -1851,6 +1884,7 @@ The recipe supports the generation of scripts with relative paths.
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 Our generated script now has a reference to the relative path.
 
@@ -1888,6 +1922,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance script with the custom config file::
 
@@ -1924,6 +1959,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should have a zope instance, with custom imports::
 
@@ -1963,6 +1999,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 The directory should have been generated, and zope config created::
 
@@ -2005,6 +2042,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 The directory should have been generated, and zope config created::
 
@@ -2047,6 +2085,7 @@ Let's run it::
     Installing instance.
     Generated script '...instance'.
     Generated interpreter '.../parts/instance/bin/interpreter'.
+    ...
 
 We should see the given initialization commands included in the instance
 script::


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/2be3fc8484942f41085391ff6b0a214b335f17c9

fix relative paths

Files changed:
M src/plone/recipe/zope2instance/__init__.py

diff --git a/src/plone/recipe/zope2instance/__init__.py b/src/plone/recipe/zope2instance/__init__.py
index adb0d3f..15a83e3 100644
--- a/src/plone/recipe/zope2instance/__init__.py
+++ b/src/plone/recipe/zope2instance/__init__.py
@@ -624,18 +624,24 @@ def install_scripts(self):
                  'plone.recipe.zope2instance.ctl', 'main')]
 
         if options.get('relative-paths'):
-            class zope_conf_path(str):
+            class relative_path_str(str):
                 def __repr__(self):
                     return str(self)
 
-            zope_conf_path = zope_conf_path(
-                        zc.buildout.easy_install._relativitize(
-                            zope_conf,
-                            options['buildout-directory'] + os.sep,
-                            self._relative_paths
-                        )
+            zope_conf_path = relative_path_str(
+                zc.buildout.easy_install._relativitize(
+                    zope_conf,
+                    options['buildout-directory'] + os.sep,
+                    self._relative_paths
+                    )
+                )
+            program_path = relative_path_str(
+                zc.buildout.easy_install._relativitize(
+                    program_path,
+                    options['buildout-directory'] + os.sep,
+                    self._relative_paths
                     )
-            # XXX relativize program_path
+                )
 
         arguments = ["-C", zope_conf_path, '-p', program_path]
         if zopectl_umask:


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/5c0f15e2064d9dd5c8ccc5430abfb095b313c18d

build a wsgi part - first try

Files changed:
M src/plone/recipe/zope2instance/__init__.py

diff --git a/src/plone/recipe/zope2instance/__init__.py b/src/plone/recipe/zope2instance/__init__.py
index 15a83e3..19ecc94 100644
--- a/src/plone/recipe/zope2instance/__init__.py
+++ b/src/plone/recipe/zope2instance/__init__.py
@@ -77,6 +77,7 @@ def __init__(self, buildout, name, options):
             buildout['buildout'].get('include-site-packages', 'false')
             ) not in ('off', 'disable', 'false')
 
+        self.wsgi = options.get('wsgi') in ('waitress', 'on')
         # Get Scripts' attributes
         return Scripts.__init__(self, buildout, name, options)
 
@@ -546,8 +547,7 @@ def is_rs_option(name):
 
         zodb_tmp_storage = options.get('zodb-temporary-storage',
                                        zodb_temporary_storage_template)
-
-        template = zope_conf_template
+        template = wsgi_conf_template if self.wsgi else zope_conf_template
 
         pid_file = options.get(
             'pid-file',
@@ -620,8 +620,13 @@ def install_scripts(self):
 
         extra_paths = options.get('extra-paths', '').split()
         requirements, ws = self.egg.working_set(['plone.recipe.zope2instance'])
-        reqs = [(self.options.get('control-script', self.name),
-                 'plone.recipe.zope2instance.ctl', 'main')]
+        reqs = [self.options.get('control-script', self.name)]
+        if self.wsgi:
+            reqs.extend(['plone.recipe.zope2instance.wsgi', 'waitress_main'])
+            options['initialization'] = wsgi_initialization
+        else:
+            reqs.extend(['plone.recipe.zope2instance.ctl', 'main'])
+        reqs = [tuple(reqs)]
 
         if options.get('relative-paths'):
             class relative_path_str(str):
@@ -643,6 +648,7 @@ def __repr__(self):
                     )
                 )
 
+        options['zope-conf'] = zope_conf_path
         arguments = ["-C", zope_conf_path, '-p', program_path]
         if zopectl_umask:
             arguments.extend(["--umask", int(zopectl_umask, 8)])
@@ -652,9 +658,10 @@ def __repr__(self):
         generated = self._install_scripts(
             options['bin-directory'], ws, reqs=reqs, extra_paths=extra_paths,
             script_arguments=script_arguments)
-        generated.extend(self._install_scripts(
-            os.path.join(options['location'], 'bin'), ws,
-            interpreter=program_name, extra_paths=extra_paths))
+        if not self.wsgi:
+            generated.extend(self._install_scripts(
+                os.path.join(options['location'], 'bin'), ws,
+                interpreter=program_name, extra_paths=extra_paths))
         return generated
 
     def _install_scripts(self, dest, working_set, reqs=(), interpreter=None,
@@ -683,7 +690,7 @@ def _install_scripts(self, dest, working_set, reqs=(), interpreter=None,
                 working_set=working_set,
                 executable=options['executable'],
                 extra_paths=extra_paths,
-                initialization=options['initialization'],
+                initialization=options['initialization'] % options,
                 arguments=script_arguments,
                 interpreter=interpreter,
                 relative_paths=self._relative_paths,)
@@ -1049,6 +1056,38 @@ def render_file_storage(self, file_storage, blob_storage,
 %(zope_conf_additional)s
 """
 
+wsgi_conf_template = """\
+%(imports_lines)s
+%%define INSTANCEHOME %(instance_home)s
+instancehome $INSTANCEHOME
+%%define CLIENTHOME %(client_home)s
+clienthome $CLIENTHOME
+%(paths_lines)s
+%(products_lines)s
+debug-mode %(debug_mode)s
+security-policy-implementation %(security_implementation)s
+verbose-security %(verbose_security)s
+%(default_zpublisher_encoding)s
+%(port_base)s
+%(effective_user)s
+%(environment_vars)s
+%(deprecation_warnings)s
+
+%(mailinglogger_import)s
+
+<zodb_db main>
+    # Main database
+    %(zodb_cache_size)s
+    %(zodb_cache_size_bytes)s
+%(storage_snippet)s
+    mount-point /
+</zodb_db>
+
+%(python_check_interval)s
+
+%(zope_conf_additional)s
+"""
+
 event_log_template = """\
 <eventlog>
   %(mailinglogger_config)s
@@ -1087,3 +1126,9 @@ def render_file_storage(self, file_storage, blob_storage,
     %s
 </configure>
 """
+
+wsgi_initialization = """\
+from Zope2.Startup.run import make_wsgi_app
+wsgiapp = make_wsgi_app({}, '%(zope-conf)s')
+def application(*args, **kwargs):return wsgiapp(*args, **kwargs)
+"""


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/4c1257bacd8404ff066aa62c126b1670a38a7c0f

add wsgi.py

Files changed:
A src/plone/recipe/zope2instance/wsgi.py

diff --git a/src/plone/recipe/zope2instance/wsgi.py b/src/plone/recipe/zope2instance/wsgi.py
new file mode 100644
index 0000000..2604104
--- /dev/null
+++ b/src/plone/recipe/zope2instance/wsgi.py
@@ -0,0 +1,9 @@
+def waitress_main(args=None):
+    from paste.deploy import loadserver
+    from waitress import serve
+    from Zope2.Startup.run import make_wsgi_app
+    import pdb; pdb.set_trace()
+    wsgiapp = make_wsgi_app(
+        {'debug_mode': 'on'},
+        '/home/vagrant/plone5devel/parts/wsgi-instance/etc/zope.conf')
+    serve(wsgiapp, listen='*:8080')


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/99fdfa18e4b45a75f5bc5b90b9d19b589bc1de2d

remove breakpoint

Files changed:
M src/plone/recipe/zope2instance/wsgi.py

diff --git a/src/plone/recipe/zope2instance/wsgi.py b/src/plone/recipe/zope2instance/wsgi.py
index 2604104..392d5b6 100644
--- a/src/plone/recipe/zope2instance/wsgi.py
+++ b/src/plone/recipe/zope2instance/wsgi.py
@@ -2,7 +2,6 @@ def waitress_main(args=None):
     from paste.deploy import loadserver
     from waitress import serve
     from Zope2.Startup.run import make_wsgi_app
-    import pdb; pdb.set_trace()
     wsgiapp = make_wsgi_app(
         {'debug_mode': 'on'},
         '/home/vagrant/plone5devel/parts/wsgi-instance/etc/zope.conf')


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/c7970965578385c03ca07806c66df5f1c89ffe5e

waitress: read paste config

Files changed:
M src/plone/recipe/zope2instance/__init__.py
M src/plone/recipe/zope2instance/wsgi.py

diff --git a/src/plone/recipe/zope2instance/__init__.py b/src/plone/recipe/zope2instance/__init__.py
index 19ecc94..2206b2b 100644
--- a/src/plone/recipe/zope2instance/__init__.py
+++ b/src/plone/recipe/zope2instance/__init__.py
@@ -649,7 +649,8 @@ def __repr__(self):
                 )
 
         options['zope-conf'] = zope_conf_path
-        arguments = ["-C", zope_conf_path, '-p', program_path]
+        arguments = ["-C", zope_conf_path, '-p', program_path] \
+            if not self.wsgi else []
         if zopectl_umask:
             arguments.extend(["--umask", int(zopectl_umask, 8)])
         script_arguments = ('\n        ' + repr(arguments) +
diff --git a/src/plone/recipe/zope2instance/wsgi.py b/src/plone/recipe/zope2instance/wsgi.py
index 392d5b6..95f9ebe 100644
--- a/src/plone/recipe/zope2instance/wsgi.py
+++ b/src/plone/recipe/zope2instance/wsgi.py
@@ -1,8 +1,19 @@
+from paste.deploy.loadwsgi import ConfigLoader, SERVER, APP
+from Zope2.Startup.run import make_wsgi_app
+
+
 def waitress_main(args=None):
-    from paste.deploy import loadserver
-    from waitress import serve
-    from Zope2.Startup.run import make_wsgi_app
-    wsgiapp = make_wsgi_app(
-        {'debug_mode': 'on'},
-        '/home/vagrant/plone5devel/parts/wsgi-instance/etc/zope.conf')
-    serve(wsgiapp, listen='*:8080')
+    """
+    Configure + start Plone behind waitress from the given PasteDeploy
+    configuration
+    Waitress - unlike uwsgi - expects us to do the
+    PasteDeploy stuff on our own.
+    """
+    ini_filename = args[-1]
+    config_loader = ConfigLoader(ini_filename)
+    server_config = config_loader.get_context(SERVER)
+    serve = server_config.create()
+    app_config = config_loader.get_context(APP)
+    zope_conf = app_config.local_conf['zope_conf']
+    wsgiapp = make_wsgi_app(app_config.global_conf, zope_conf)
+    serve(wsgiapp)


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/78f4741d79a55951d538e3bef798c9283f2380f2

require ZODB instead of ZODB3 in order to fix tests

Files changed:
M setup.py

diff --git a/setup.py b/setup.py
index 727c118..754abd8 100644
--- a/setup.py
+++ b/setup.py
@@ -41,7 +41,7 @@
         'mailinglogger',
         'zc.recipe.egg',
         'Zope2 >= 2.12.1',
-        'ZODB3 >= 3.9',
+        'ZODB >= 5.1.1',
     ],
     zip_safe=False,
     entry_points={'zc.buildout': ['default = %s:Recipe' % name]},


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/9f622079d1ec1f3d7d9e6e0885df05f5b4e0c8a9

add basic wsgi test

Files changed:
A src/plone/recipe/zope2instance/tests/wsgi.txt
M src/plone/recipe/zope2instance/tests/test_docs.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt

diff --git a/src/plone/recipe/zope2instance/tests/test_docs.py b/src/plone/recipe/zope2instance/tests/test_docs.py
index 1cf050e..4cf7d9b 100644
--- a/src/plone/recipe/zope2instance/tests/test_docs.py
+++ b/src/plone/recipe/zope2instance/tests/test_docs.py
@@ -34,10 +34,15 @@ def tearDown(test):
 
 def test_suite():
     suite = []
-    flags = (doctest.ELLIPSIS | doctest.NORMALIZE_WHITESPACE |
+    flags = (
+        doctest.ELLIPSIS | doctest.NORMALIZE_WHITESPACE |
         doctest.REPORT_NDIFF)
 
-    suite.append(doctest.DocFileSuite('zope2instance.txt', optionflags=flags,
-                 setUp=setUp, tearDown=tearDown))
+    suite.append(doctest.DocFileSuite(
+        'zope2instance.txt',
+        'wsgi.txt',
+        optionflags=flags,
+        setUp=setUp,
+        tearDown=tearDown))
 
     return unittest.TestSuite(suite)
diff --git a/src/plone/recipe/zope2instance/tests/wsgi.txt b/src/plone/recipe/zope2instance/tests/wsgi.txt
new file mode 100644
index 0000000..24249ec
--- /dev/null
+++ b/src/plone/recipe/zope2instance/tests/wsgi.txt
@@ -0,0 +1,61 @@
+=====================
+Test wsgi.py creation
+=====================
+
+
+    >>> from zc.buildout.testing import *
+    >>> from os.path import join
+    >>> import sys, os
+    >>> options = globals()
+
+Let's create a minimum buildout that uses the current
+plone.recipe.zope2instance::
+
+    >>> write('buildout.cfg',
+    ... '''
+    ... [buildout]
+    ... parts = wsgi.py
+    ... find-links = %(sample_buildout)s/eggs
+    ...
+    ... [wsgi.py]
+    ... recipe = plone.recipe.zope2instance
+    ... eggs =
+    ... user = me:me
+    ... wsgi = on
+    ... ''' % options)
+
+Let's run it::
+
+    >>> print system(join('bin', 'buildout')),
+    Installing wsgi.py.
+    Generated script '...wsgi.py'.
+    ...
+
+We should have a wsgi.py part, with a basic zope.conf::
+
+    >>> instance = os.path.join(sample_buildout, 'parts', 'wsgi.py')
+    >>> zope_conf = open(os.path.join(instance, 'etc', 'zope.conf')).read()
+    >>> zope_conf = zope_conf.replace('\\', '/')
+    >>> print zope_conf
+    %define INSTANCEHOME .../sample-buildout/parts/wsgi.py
+    instancehome $INSTANCEHOME
+    %define CLIENTHOME .../sample-buildout/var/wsgi.py
+    clienthome $CLIENTHOME
+    debug-mode off
+    security-policy-implementation C
+    verbose-security off
+    default-zpublisher-encoding utf-8
+    <zodb_db main>
+        # Main database
+        cache-size 30000
+        # Blob-enabled FileStorage database
+        <blobstorage>
+           blob-dir .../sample-buildout/var/blobstorage
+           # FileStorage database
+           <filestorage>
+             path .../sample-buildout/var/filestorage/Data.fs
+           </filestorage>
+        </blobstorage>
+        mount-point /
+    </zodb_db>
+    python-check-interval 1000
diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt
index e8224c1..51c9fd2 100644
--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt
+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt
@@ -1,4 +1,4 @@
-=========================
+==========================
 plone.recipe.zope2instance
 ==========================
 


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/063a233dadb02efc22e78184fc52ddba84aa6156

bump versions (travis)

Files changed:
M .travis.yml
M buildout.cfg

diff --git a/.travis.yml b/.travis.yml
index ce74056..48b122d 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -2,6 +2,8 @@ language: python
 python:
   - 2.7
 install:
+  - pip install setuptools==33.1.1 zc.buildout==2.5.3
+  - buildout bootstrap
   - python bootstrap.py
   - bin/buildout -t 3
 script: bin/test
diff --git a/buildout.cfg b/buildout.cfg
index a754baf..f07eb29 100644
--- a/buildout.cfg
+++ b/buildout.cfg
@@ -1,12 +1,14 @@
 [buildout]
-extends = http://download.zope.org/Zope2/index/2.13.21/versions.cfg
+extends = http://dist.plone.org/versions/zope-2-13-24-versions.cfg
 
 versions = versions
 develop = .
 parts = test
 
 [versions]
-setuptools = 7.0
+setuptools = 33.1.1
+zc.buildout = 2.5.3
+transaction = 2.0.3
 
 [test]
 recipe = zc.recipe.testrunner


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/e958d3066038824b02bab563afdd4a2bfd8138aa

remove bootstrap.py step

Files changed:
M .travis.yml

diff --git a/.travis.yml b/.travis.yml
index 48b122d..3f7c5e8 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -4,6 +4,5 @@ python:
 install:
   - pip install setuptools==33.1.1 zc.buildout==2.5.3
   - buildout bootstrap
-  - python bootstrap.py
   - bin/buildout -t 3
 script: bin/test


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-09-18T12:18:38+02:00
Author: Thomas Schorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/84b418d9ab0d0fa78f3ec5edcd509d91e068c786

require ZODB (obviously not required by Zope2 yet)

Files changed:
M buildout.cfg
M src/plone/recipe/zope2instance/tests/test_docs.py

diff --git a/buildout.cfg b/buildout.cfg
index f07eb29..a06277d 100644
--- a/buildout.cfg
+++ b/buildout.cfg
@@ -9,6 +9,7 @@ parts = test
 setuptools = 33.1.1
 zc.buildout = 2.5.3
 transaction = 2.0.3
+zc.recipe.egg = 2.0.3
 
 [test]
 recipe = zc.recipe.testrunner
diff --git a/src/plone/recipe/zope2instance/tests/test_docs.py b/src/plone/recipe/zope2instance/tests/test_docs.py
index 4cf7d9b..21afea1 100644
--- a/src/plone/recipe/zope2instance/tests/test_docs.py
+++ b/src/plone/recipe/zope2instance/tests/test_docs.py
@@ -16,7 +16,7 @@ def setUp(test):
     install_develop('plone.recipe.zope2instance', test)
     install('zc.recipe.egg', test)
     install('mailinglogger', test)
-    dependencies = pkg_resources.working_set.require('Zope2')
+    dependencies = pkg_resources.working_set.require('Zope2', 'ZODB')
     for dep in dependencies:
         try:
             install(dep.project_name, test)


Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2017-10-21T12:06:48+02:00
Author: tschorr (tschorr) <t_schorr@gmx.de>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/7034f1cda9b3499c8b8ad6eef2832e3d6b80b323

update readme, changes, bump version

Files changed:
M CHANGES.rst
M README.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5db2d8f..3e24ee6 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,7 +1,9 @@
 Changelog
 =========
 
-4.3.1 (unreleased)
+
+
+5.0.0 (unreleased)
 ------------------
 
 Breaking changes:
@@ -10,7 +12,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Add wsgi support
+  [tschorr]
 
 Bug fixes:
 
diff --git a/README.rst b/README.rst
index c774bdc..a94cdb9 100644
--- a/README.rst
+++ b/README.rst
@@ -13,10 +13,6 @@ The name of the control script is the the name of the part in buildout.
 By default various runtime and log information will be stored inside the var/
 directory.
 
-*Note: This recipe is not intended to setup a Zope 2 WSGI based instance and
-will not work for this use-case. There's no special recipe required to setup
-WSGI any longer and you can use simple template recipes instead.*
-
 You can use it with a part like this::
 
   [instance]
@@ -80,6 +76,10 @@ initialization
    (Buildout < 1.5). This is very limited. In particular, be aware that leading
    whitespace is stripped from the code given. *added in version 4.2.14*
 
+wsgi
+   Use ``wsgi = on`` in a part to create a Python script that can be used as an
+   interface for a WSGI server.
+
 Theme resources
 ---------------
 
diff --git a/setup.py b/setup.py
index 754abd8..3123896 100644
--- a/setup.py
+++ b/setup.py
@@ -4,7 +4,7 @@
 
 
 name = "plone.recipe.zope2instance"
-version = '4.3.1.dev0'
+version = '5.0.dev0'
 
 setup(
     name=name,


