Repository: plone.app.content


Branch: refs/heads/master
Date: 2016-08-03T14:10:31+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/ed9af98b3a51ee1637aafca1c7cb2dcd6e1511a2

Add ``allow_upload`` JSON view.
Add ``@@allow_upload`` view, which returns a JSON string to indicate if File or Image uploads are allowed in the current container.
When the view is called with a ``path`` request parameter, then content at this path is used instead the content where the view is called.

Files changed:
M CHANGES.rst
M plone/app/content/browser/file.py
M plone/app/content/tests/test_contents.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 03a3b57..8d6e75e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -11,6 +11,7 @@ Breaking changes:
 New features:
 
 - Add ``@@allow_upload`` view, which returns a JSON string to indicate if File or Image uploads are allowed in the current container.
+  When the view is called with a ``path`` request parameter, then content at this path is used instead the content where the view is called.
   [thet]
 
 - Factor out the available columns ignored list which can be used to narrow down the available columns list to a user friendly set.
diff --git a/plone/app/content/browser/file.py b/plone/app/content/browser/file.py
index d79f4e1..a783a46 100644
--- a/plone/app/content/browser/file.py
+++ b/plone/app/content/browser/file.py
@@ -205,7 +205,10 @@ def __call__(self):
         self.request.response.setHeader(
             'Content-Type', 'application/json; charset=utf-8'
         )
-        allowed_types = [t.getId() for t in self.context.allowedContentTypes()]
+        context = self.context
+        if self.request.form.get('path'):
+            context = context.restrictedTraverse(self.request.form.get('path'))
+        allowed_types = [t.getId() for t in context.allowedContentTypes()]
         allow_images = u'Image' in allowed_types
         allow_files = u'File' in allowed_types
         return json.dumps({
diff --git a/plone/app/content/tests/test_contents.py b/plone/app/content/tests/test_contents.py
index 3a90c49..1a1d9ee 100644
--- a/plone/app/content/tests/test_contents.py
+++ b/plone/app/content/tests/test_contents.py
@@ -218,3 +218,19 @@ def test_allow_upload(self):
         self.assertEqual(allow_upload['allowUpload'], True)
         self.assertEqual(allow_upload['allowImages'], True)
         self.assertEqual(allow_upload['allowFiles'], True)
+
+        # Test files allowed, path via request variable
+        self.type1_fti.allowed_content_types = ['File']
+        # First, test on Portal root to see the difference
+        allow_upload = self.portal.restrictedTraverse('@@allow_upload')
+        allow_upload = json.loads(allow_upload())
+        self.assertEqual(allow_upload['allowUpload'], True)
+        self.assertEqual(allow_upload['allowImages'], True)
+        self.assertEqual(allow_upload['allowFiles'], True)
+        # Then, with path set to sub item
+        allow_upload = self.portal.restrictedTraverse('@@allow_upload')
+        allow_upload.request.form['path'] = '/plone/it1'
+        allow_upload = json.loads(allow_upload())
+        self.assertEqual(allow_upload['allowUpload'], True)
+        self.assertEqual(allow_upload['allowImages'], False)
+        self.assertEqual(allow_upload['allowFiles'], True)


