Repository: plone.app.iterate


Branch: refs/heads/2.1.x
Date: 2016-05-06T09:04:34-03:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/plone.app.iterate/commit/9f333f08cf31b4b1f8bb8cda31536325ba128e15

Don't render info viewlet for non authenticated user and fix exception for dexterity content types

Files changed:
M CHANGES.rst
M plone/app/iterate/browser/info.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 51e9561..bccf027 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -22,6 +22,9 @@ Bug fixes:
 
 Fixes:
 
+- Fix exception when Dexterity-based content types get a working copy (closes `#1541`_).
+  [rodfersou]
+
 - no special case that enables checkout via GET
   [gotcha]
 
@@ -352,3 +355,4 @@ Fixes:
 - First release
 
 .. _`#1451`: https://github.com/plone/Products.CMFPlone/issues/1451
+.. _`#1541`: https://github.com/plone/Products.CMFPlone/issues/1541
diff --git a/plone/app/iterate/browser/info.py b/plone/app/iterate/browser/info.py
index 8578340..2f1dfff 100644
--- a/plone/app/iterate/browser/info.py
+++ b/plone/app/iterate/browser/info.py
@@ -22,6 +22,7 @@
 
 from plone.memoize.instance import memoize
 from Products.CMFPlone.log import logger
+from Products.Archetypes.interfaces import IReferenceable
 
 class BaseInfoViewlet( BrowserView ):
 
@@ -105,9 +106,12 @@ def render(self):
             return ""
 
     @memoize
-    def working_copy( self ):
-        refs = self.context.getBRefs( WorkingCopyRelation.relationship )
-        if len( refs ) > 0:
+    def working_copy(self):
+        adapted = IReferenceable(self.context, None)
+        if adapted is None:
+            return None
+        refs = adapted.getBRefs(WorkingCopyRelation.relationship)
+        if len(refs) > 0:
             return refs[0]
         else:
             return None


Repository: plone.app.iterate


Branch: refs/heads/2.1.x
Date: 2016-05-06T10:41:00-03:00
Author: Franco Pellegrini (frapell) <frapell@gmail.com>
Commit: https://github.com/plone/plone.app.iterate/commit/d16c3355e590c8c01b70405d2b01f3c99ba974c5

Merge pull request #26 from plone/issue_1541

Issue 1541 - Fix exception for dexterity content types when get working copy

Files changed:
M CHANGES.rst
M plone/app/iterate/browser/info.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 51e9561..bccf027 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -22,6 +22,9 @@ Bug fixes:
 
 Fixes:
 
+- Fix exception when Dexterity-based content types get a working copy (closes `#1541`_).
+  [rodfersou]
+
 - no special case that enables checkout via GET
   [gotcha]
 
@@ -352,3 +355,4 @@ Fixes:
 - First release
 
 .. _`#1451`: https://github.com/plone/Products.CMFPlone/issues/1451
+.. _`#1541`: https://github.com/plone/Products.CMFPlone/issues/1541
diff --git a/plone/app/iterate/browser/info.py b/plone/app/iterate/browser/info.py
index 8578340..2f1dfff 100644
--- a/plone/app/iterate/browser/info.py
+++ b/plone/app/iterate/browser/info.py
@@ -22,6 +22,7 @@
 
 from plone.memoize.instance import memoize
 from Products.CMFPlone.log import logger
+from Products.Archetypes.interfaces import IReferenceable
 
 class BaseInfoViewlet( BrowserView ):
 
@@ -105,9 +106,12 @@ def render(self):
             return ""
 
     @memoize
-    def working_copy( self ):
-        refs = self.context.getBRefs( WorkingCopyRelation.relationship )
-        if len( refs ) > 0:
+    def working_copy(self):
+        adapted = IReferenceable(self.context, None)
+        if adapted is None:
+            return None
+        refs = adapted.getBRefs(WorkingCopyRelation.relationship)
+        if len(refs) > 0:
             return refs[0]
         else:
             return None


