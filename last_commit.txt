Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2016-10-03T09:16:23-03:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/15e821ad0a363bb6709c4b7807ba6d67fb2ba09d

Added properties sort_on and sort_reversed

Files changed:
M Products/CMFPlone/profiles/default/metadata.xml
M Products/CMFPlone/profiles/default/propertiestool.xml
M Products/CMFPlone/skins/plone_ecmascript/livesearch.js
M Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
M Products/CMFPlone/tests/testPortalCreation.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/profiles/default/metadata.xml b/Products/CMFPlone/profiles/default/metadata.xml
index 460cd47..a6853b5 100644
--- a/Products/CMFPlone/profiles/default/metadata.xml
+++ b/Products/CMFPlone/profiles/default/metadata.xml
@@ -1,4 +1,4 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>4314</version>
+  <version>4315</version>
 </metadata>
diff --git a/Products/CMFPlone/profiles/default/propertiestool.xml b/Products/CMFPlone/profiles/default/propertiestool.xml
index a6380ff..aab80bd 100644
--- a/Products/CMFPlone/profiles/default/propertiestool.xml
+++ b/Products/CMFPlone/profiles/default/propertiestool.xml
@@ -157,5 +157,6 @@
   <property name="external_login_url" type="string"/>
   <property name="external_logout_url" type="string"/>
   <property name="external_login_iframe" type="boolean"/>
+  <property name="sort_on" type="string">relevance</property>
  </object>
 </object>
diff --git a/Products/CMFPlone/skins/plone_ecmascript/livesearch.js b/Products/CMFPlone/skins/plone_ecmascript/livesearch.js
index e8d5fd3..7cc9a9b 100644
--- a/Products/CMFPlone/skins/plone_ecmascript/livesearch.js
+++ b/Products/CMFPlone/skins/plone_ecmascript/livesearch.js
@@ -36,6 +36,7 @@ var livesearch = (function () {
             $shadow = $form.find('div.LSShadow'),
             $path = $form.find('input[name="path"]');
 
+        
         function _hide() {
             // hides the result window
             $$result.hide();
@@ -56,6 +57,25 @@ var livesearch = (function () {
         }
 
         function _search() {
+            var sort_on = function() {
+                var parameters = location.search,
+                    sorton_position = parameters.indexOf('sort_on');
+                if (sorton_position === -1) {
+                    // return default sort
+                    var $searchResults = $('#search-results');
+                    if ($searchResults.length > 0) {
+                        return $searchResults.attr('data-default-sort');
+                    }
+                    return '';
+                }
+                // cut string before sort_on parameter
+                var sort_on = parameters.substring(sorton_position);
+                // cut other parameters
+                sort_on = sort_on.split('&')[0];
+                // get just the value
+                sort_on = sort_on.split('=')[1];
+                return sort_on;
+            }();
             // does the actual search
             if ($lastsearch === $inputnode.value) {
                 // do nothing if the input didn't change
@@ -79,6 +99,9 @@ var livesearch = (function () {
             if ($path.length && $path[0].checked) {
                 $$query.path = $path.val();
             }
+            if (sort_on !== '') {
+                $$query.sortOn = sort_on;
+            }
             // turn into a string for use as a cache key
             $$query = jQuery.param($$query);
 
diff --git a/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py b/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
index 03f0b56..f75d8b0 100644
--- a/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
+++ b/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
@@ -4,7 +4,7 @@
 ##bind namespace=
 ##bind script=script
 ##bind subpath=traverse_subpath
-##parameters=q,limit=10,path=None
+##parameters=q,limit=10,path=None,sortOn=None
 ##title=Determine whether to show an id in an edit form
 
 from Products.CMFCore.utils import getToolByName
@@ -72,6 +72,12 @@ def quote_bad_chars(s):
 REQUEST = context.REQUEST
 params = {'SearchableText': r,
           'sort_limit': limit + 1}
+if sortOn is None:
+    sortOn = siteProperties.getProperty('sort_on', 'relevance')
+if sortOn != 'relevance':
+    params['sort_on'] = sortOn
+if sortOn == 'Date':
+    params['sort_order'] = 'reverse'
 if 'portal_type' not in REQUEST:
     params['portal_type'] = friendly_types
 
diff --git a/Products/CMFPlone/tests/testPortalCreation.py b/Products/CMFPlone/tests/testPortalCreation.py
index e848a79..a6cc38d 100644
--- a/Products/CMFPlone/tests/testPortalCreation.py
+++ b/Products/CMFPlone/tests/testPortalCreation.py
@@ -439,6 +439,11 @@ def testTTWLockableProperty(self):
         self.assertEquals(True,
                           self.properties.site_properties.lock_on_ttw_edit)
 
+    def testSortOnProperty(self):
+        # site_properties should have sort_on property
+        self.assertTrue(
+            self.properties.site_properties.hasProperty('sort_on'))
+
     def testPortalFTIIsDynamicFTI(self):
         # Plone Site FTI should be a DynamicView FTI
         fti = self.portal.getTypeInfo()
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index f33b8a3..fa6c1b4 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -15,7 +15,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Add sort_on field to search controlpanel.
+  [rodfersou]
 
 Bug fixes:
 


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2016-10-07T15:36:37+02:00
Author: agitator (agitator) <hpeter@agitator.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/22ceb58d823caa49fe40bc26ae336690a0c89646

Merge pull request #1616 from plone/issue_1600

Issue 1600 - Plone 4.3.x - Added property sort_on

Files changed:
M Products/CMFPlone/profiles/default/metadata.xml
M Products/CMFPlone/profiles/default/propertiestool.xml
M Products/CMFPlone/skins/plone_ecmascript/livesearch.js
M Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
M Products/CMFPlone/tests/testPortalCreation.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/profiles/default/metadata.xml b/Products/CMFPlone/profiles/default/metadata.xml
index 460cd47..a6853b5 100644
--- a/Products/CMFPlone/profiles/default/metadata.xml
+++ b/Products/CMFPlone/profiles/default/metadata.xml
@@ -1,4 +1,4 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>4314</version>
+  <version>4315</version>
 </metadata>
diff --git a/Products/CMFPlone/profiles/default/propertiestool.xml b/Products/CMFPlone/profiles/default/propertiestool.xml
index a6380ff..aab80bd 100644
--- a/Products/CMFPlone/profiles/default/propertiestool.xml
+++ b/Products/CMFPlone/profiles/default/propertiestool.xml
@@ -157,5 +157,6 @@
   <property name="external_login_url" type="string"/>
   <property name="external_logout_url" type="string"/>
   <property name="external_login_iframe" type="boolean"/>
+  <property name="sort_on" type="string">relevance</property>
  </object>
 </object>
diff --git a/Products/CMFPlone/skins/plone_ecmascript/livesearch.js b/Products/CMFPlone/skins/plone_ecmascript/livesearch.js
index e8d5fd3..7cc9a9b 100644
--- a/Products/CMFPlone/skins/plone_ecmascript/livesearch.js
+++ b/Products/CMFPlone/skins/plone_ecmascript/livesearch.js
@@ -36,6 +36,7 @@ var livesearch = (function () {
             $shadow = $form.find('div.LSShadow'),
             $path = $form.find('input[name="path"]');
 
+        
         function _hide() {
             // hides the result window
             $$result.hide();
@@ -56,6 +57,25 @@ var livesearch = (function () {
         }
 
         function _search() {
+            var sort_on = function() {
+                var parameters = location.search,
+                    sorton_position = parameters.indexOf('sort_on');
+                if (sorton_position === -1) {
+                    // return default sort
+                    var $searchResults = $('#search-results');
+                    if ($searchResults.length > 0) {
+                        return $searchResults.attr('data-default-sort');
+                    }
+                    return '';
+                }
+                // cut string before sort_on parameter
+                var sort_on = parameters.substring(sorton_position);
+                // cut other parameters
+                sort_on = sort_on.split('&')[0];
+                // get just the value
+                sort_on = sort_on.split('=')[1];
+                return sort_on;
+            }();
             // does the actual search
             if ($lastsearch === $inputnode.value) {
                 // do nothing if the input didn't change
@@ -79,6 +99,9 @@ var livesearch = (function () {
             if ($path.length && $path[0].checked) {
                 $$query.path = $path.val();
             }
+            if (sort_on !== '') {
+                $$query.sortOn = sort_on;
+            }
             // turn into a string for use as a cache key
             $$query = jQuery.param($$query);
 
diff --git a/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py b/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
index 03f0b56..f75d8b0 100644
--- a/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
+++ b/Products/CMFPlone/skins/plone_scripts/livesearch_reply.py
@@ -4,7 +4,7 @@
 ##bind namespace=
 ##bind script=script
 ##bind subpath=traverse_subpath
-##parameters=q,limit=10,path=None
+##parameters=q,limit=10,path=None,sortOn=None
 ##title=Determine whether to show an id in an edit form
 
 from Products.CMFCore.utils import getToolByName
@@ -72,6 +72,12 @@ def quote_bad_chars(s):
 REQUEST = context.REQUEST
 params = {'SearchableText': r,
           'sort_limit': limit + 1}
+if sortOn is None:
+    sortOn = siteProperties.getProperty('sort_on', 'relevance')
+if sortOn != 'relevance':
+    params['sort_on'] = sortOn
+if sortOn == 'Date':
+    params['sort_order'] = 'reverse'
 if 'portal_type' not in REQUEST:
     params['portal_type'] = friendly_types
 
diff --git a/Products/CMFPlone/tests/testPortalCreation.py b/Products/CMFPlone/tests/testPortalCreation.py
index e848a79..a6cc38d 100644
--- a/Products/CMFPlone/tests/testPortalCreation.py
+++ b/Products/CMFPlone/tests/testPortalCreation.py
@@ -439,6 +439,11 @@ def testTTWLockableProperty(self):
         self.assertEquals(True,
                           self.properties.site_properties.lock_on_ttw_edit)
 
+    def testSortOnProperty(self):
+        # site_properties should have sort_on property
+        self.assertTrue(
+            self.properties.site_properties.hasProperty('sort_on'))
+
     def testPortalFTIIsDynamicFTI(self):
         # Plone Site FTI should be a DynamicView FTI
         fti = self.portal.getTypeInfo()
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index f33b8a3..fa6c1b4 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -15,7 +15,8 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Add sort_on field to search controlpanel.
+  [rodfersou]
 
 Bug fixes:
 


