Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-05-01T21:41:46-05:00
Author: nathan.vangheem () <nathan.vangheem@wildcardcorp.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/69fa1a5f10252cf6d22a8c61b68542235e2fafdd

Fix issue where incorrectly configured formats would cause TinyMCE to error

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0ae1618..47444a3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,9 @@ New:
 
 Fixes:
 
+- Fix issue where incorrectly configured formats would cause TinyMCE to error
+  [vangheem]
+
 - Fixed displaying the body text of a feed item.  This is when
   ``render_body`` is switched on in the Syndication settings.
   [maurits]
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index 41440cb..ab2e299 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -64,6 +64,15 @@ def get_style_format(self, txt, _type='format', base=None):
             val['icon'] = parts[2]
         return val
 
+    def get_styles(self, styles, _type='format', base=None):
+        result = []
+        for style in styles:
+            style = self.get_style_format(style, _type, base)
+            if not style:
+                continue
+            result.append(style)
+        return result
+
     def get_all_style_formats(self):
         header_styles = self.settings.header_styles or []
         block_styles = self.settings.block_styles or []
@@ -72,20 +81,19 @@ def get_all_style_formats(self):
         table_styles = self.settings.table_styles or []
         return [{
             'title': 'Headers',
-            'items': [self.get_style_format(t) for t in header_styles]
+            'items': self.get_styles(header_styles)
         }, {
             'title': 'Block',
-            'items': [self.get_style_format(t) for t in block_styles]
+            'items': self.get_styles(block_styles)
         }, {
             'title': 'Inline',
-            'items': [self.get_style_format(t) for t in inline_styles]
+            'items': self.get_styles(inline_styles)
         }, {
             'title': 'Alignment',
-            'items': [self.get_style_format(t) for t in alignment_styles]
+            'items': self.get_styles(alignment_styles)
         }, {
             'title': 'Tables',
-            'items': [self.get_style_format(t, 'classes', {'selector': 'table'})
-                      for t in table_styles]
+            'items': self.get_styles(table_styles)
         }]
 
     def get_tiny_config(self):


Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2016-05-18T15:03:18+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/52eceaa3f0d4cf195094ee8d9ca8efbdc390e79e

Merge pull request #1565 from plone/tinymce-formats

Fix issue where incorrectly configured formats

Files changed:
M CHANGES.rst
M Products/CMFPlone/patterns/__init__.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3b99285..e15cb41 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -18,6 +18,9 @@ New:
 
 Fixes:
 
+- Fix issue where incorrectly configured formats would cause TinyMCE to error
+  [vangheem]
+
 - Fixed displaying the body text of a feed item.  This is when
   ``render_body`` is switched on in the Syndication settings.
   [maurits]
diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index 41440cb..ab2e299 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -64,6 +64,15 @@ def get_style_format(self, txt, _type='format', base=None):
             val['icon'] = parts[2]
         return val
 
+    def get_styles(self, styles, _type='format', base=None):
+        result = []
+        for style in styles:
+            style = self.get_style_format(style, _type, base)
+            if not style:
+                continue
+            result.append(style)
+        return result
+
     def get_all_style_formats(self):
         header_styles = self.settings.header_styles or []
         block_styles = self.settings.block_styles or []
@@ -72,20 +81,19 @@ def get_all_style_formats(self):
         table_styles = self.settings.table_styles or []
         return [{
             'title': 'Headers',
-            'items': [self.get_style_format(t) for t in header_styles]
+            'items': self.get_styles(header_styles)
         }, {
             'title': 'Block',
-            'items': [self.get_style_format(t) for t in block_styles]
+            'items': self.get_styles(block_styles)
         }, {
             'title': 'Inline',
-            'items': [self.get_style_format(t) for t in inline_styles]
+            'items': self.get_styles(inline_styles)
         }, {
             'title': 'Alignment',
-            'items': [self.get_style_format(t) for t in alignment_styles]
+            'items': self.get_styles(alignment_styles)
         }, {
             'title': 'Tables',
-            'items': [self.get_style_format(t, 'classes', {'selector': 'table'})
-                      for t in table_styles]
+            'items': self.get_styles(table_styles)
         }]
 
     def get_tiny_config(self):


