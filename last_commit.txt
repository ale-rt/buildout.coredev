Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2017-05-30T12:10:33+02:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/5d4f645915c8958cd389db41ca2143b16524871c

fix language alternate viewlet to show the full URL of the translations

Files changed:
M src/plone/app/multilingual/browser/templates/alternate-languages.pt
M src/plone/app/multilingual/browser/viewlets.py
M src/plone/app/multilingual/tests/test_alternates.py

diff --git a/src/plone/app/multilingual/browser/templates/alternate-languages.pt b/src/plone/app/multilingual/browser/templates/alternate-languages.pt
index 68dc630..7196b96 100644
--- a/src/plone/app/multilingual/browser/templates/alternate-languages.pt
+++ b/src/plone/app/multilingual/browser/templates/alternate-languages.pt
@@ -1,4 +1,4 @@
 <link rel="alternate"
       tal:repeat="item view/alternates"
       tal:attributes="hreflang item/lang;
-                      href string:${view/site_url}/${item/lang}/${item/url}" />
+                      href string:${item/url}" />
diff --git a/src/plone/app/multilingual/browser/viewlets.py b/src/plone/app/multilingual/browser/viewlets.py
index e82519b..340032b 100644
--- a/src/plone/app/multilingual/browser/viewlets.py
+++ b/src/plone/app/multilingual/browser/viewlets.py
@@ -1,13 +1,11 @@
 # -*- coding: utf-8 -*-
 from Products.CMFCore.utils import getToolByName
-from Products.CMFPlone.interfaces import IPloneSiteRoot
 from plone.app.layout.viewlets.common import ViewletBase
 from Products.CMFPlone.interfaces import ILanguage
 from plone.app.multilingual.interfaces import ITranslatable
 from plone.app.multilingual.interfaces import ITranslationManager
 from plone.memoize import ram
 from urllib import quote_plus
-from zope.component import getUtility
 
 
 def _cache_until_catalog_change(fun, self):
@@ -146,16 +144,12 @@ def get_alternate_languages(self):
         catalog = getToolByName(self.context, 'portal_catalog')
         results = catalog(TranslationGroup=tm.query_canonical())
 
-        plone_site = getUtility(IPloneSiteRoot)
-        portal_path = '/'.join(plone_site.getPhysicalPath())
-        portal_path_len = len(portal_path)
         alternates = []
         for item in results:
-            path_len = portal_path_len + len('{0:s}/'.format(item.Language))
-            url = item.getURL(relative=1)[path_len:]
+            url = item.getURL()
             alternates.append({
                 'lang': item.Language,
-                'url': url.strip('/'),
+                'url': url,
             })
 
         return alternates
diff --git a/src/plone/app/multilingual/tests/test_alternates.py b/src/plone/app/multilingual/tests/test_alternates.py
index 68f130d..7681e7f 100644
--- a/src/plone/app/multilingual/tests/test_alternates.py
+++ b/src/plone/app/multilingual/tests/test_alternates.py
@@ -37,9 +37,6 @@ def test_alternates(self):
         for item in viewlet.alternates:
             self.assertIn(item['lang'], translations)
             self.assertEqual(
-                "{0}/{1}/{2}".format(
-                    self.portal.absolute_url(),
-                    item['lang'],
-                    item['url']),
+                item['url'],
                 translations[item['lang']].absolute_url()
             )


Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2017-05-30T12:10:33+02:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/3360be6136309d4d2f6d16785585948ba2129d35

changelog entry

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index f69ada2..f29a34a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,8 @@ New features:
 
 Bug fixes:
 
+- Fixed language alternate viewlet #153 [erral]
+
 - removed unittest2 dependency
   [kakshay21]
 


Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2017-06-01T00:24:09+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/f348289b6aa27aff7c74049c2a3d04aec10b39b2

Merge branch 'master' into issue-153

Files changed:
M CHANGES.rst
M setup.cfg
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f29a34a..4afee96 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,7 +1,7 @@
 Changelog
 =========
 
-5.0.7 (unreleased)
+5.0.8 (unreleased)
 ------------------
 
 Breaking changes:
@@ -16,6 +16,12 @@ Bug fixes:
 
 - Fixed language alternate viewlet #153 [erral]
 
+
+5.0.7 (2017-05-31)
+------------------
+
+Bug fixes:
+
 - removed unittest2 dependency
   [kakshay21]
 
diff --git a/setup.cfg b/setup.cfg
index 8263512..190e1a2 100644
--- a/setup.cfg
+++ b/setup.cfg
@@ -2,3 +2,9 @@
 ignore =
     *.cfg
     bootstrap.py
+
+[bdist_wheel]
+universal = 1
+
+[zest.releaser]
+create-wheel = yes
diff --git a/setup.py b/setup.py
index c6d9f38..8364752 100755
--- a/setup.py
+++ b/setup.py
@@ -4,7 +4,7 @@
 from setuptools import setup, find_packages
 
 
-version = '5.0.7.dev0'
+version = '5.0.8.dev0'
 
 setup(
     name='plone.app.multilingual',


Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2017-06-01T06:48:11+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/36fa7a19344b9b1a3ab8278c69677ab0fc8f9a94

Merge pull request #270 from plone/issue-153

Fixes issue #153 in pam master: alternate languages viewlet

Files changed:
M CHANGES.rst
M src/plone/app/multilingual/browser/templates/alternate-languages.pt
M src/plone/app/multilingual/browser/viewlets.py
M src/plone/app/multilingual/tests/test_alternates.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 61e456f..4afee96 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,7 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Fixed language alternate viewlet #153 [erral]
 
 
 5.0.7 (2017-05-31)
diff --git a/src/plone/app/multilingual/browser/templates/alternate-languages.pt b/src/plone/app/multilingual/browser/templates/alternate-languages.pt
index 68dc630..7196b96 100644
--- a/src/plone/app/multilingual/browser/templates/alternate-languages.pt
+++ b/src/plone/app/multilingual/browser/templates/alternate-languages.pt
@@ -1,4 +1,4 @@
 <link rel="alternate"
       tal:repeat="item view/alternates"
       tal:attributes="hreflang item/lang;
-                      href string:${view/site_url}/${item/lang}/${item/url}" />
+                      href string:${item/url}" />
diff --git a/src/plone/app/multilingual/browser/viewlets.py b/src/plone/app/multilingual/browser/viewlets.py
index e82519b..340032b 100644
--- a/src/plone/app/multilingual/browser/viewlets.py
+++ b/src/plone/app/multilingual/browser/viewlets.py
@@ -1,13 +1,11 @@
 # -*- coding: utf-8 -*-
 from Products.CMFCore.utils import getToolByName
-from Products.CMFPlone.interfaces import IPloneSiteRoot
 from plone.app.layout.viewlets.common import ViewletBase
 from Products.CMFPlone.interfaces import ILanguage
 from plone.app.multilingual.interfaces import ITranslatable
 from plone.app.multilingual.interfaces import ITranslationManager
 from plone.memoize import ram
 from urllib import quote_plus
-from zope.component import getUtility
 
 
 def _cache_until_catalog_change(fun, self):
@@ -146,16 +144,12 @@ def get_alternate_languages(self):
         catalog = getToolByName(self.context, 'portal_catalog')
         results = catalog(TranslationGroup=tm.query_canonical())
 
-        plone_site = getUtility(IPloneSiteRoot)
-        portal_path = '/'.join(plone_site.getPhysicalPath())
-        portal_path_len = len(portal_path)
         alternates = []
         for item in results:
-            path_len = portal_path_len + len('{0:s}/'.format(item.Language))
-            url = item.getURL(relative=1)[path_len:]
+            url = item.getURL()
             alternates.append({
                 'lang': item.Language,
-                'url': url.strip('/'),
+                'url': url,
             })
 
         return alternates
diff --git a/src/plone/app/multilingual/tests/test_alternates.py b/src/plone/app/multilingual/tests/test_alternates.py
index 68f130d..7681e7f 100644
--- a/src/plone/app/multilingual/tests/test_alternates.py
+++ b/src/plone/app/multilingual/tests/test_alternates.py
@@ -37,9 +37,6 @@ def test_alternates(self):
         for item in viewlet.alternates:
             self.assertIn(item['lang'], translations)
             self.assertEqual(
-                "{0}/{1}/{2}".format(
-                    self.portal.absolute_url(),
-                    item['lang'],
-                    item['url']),
+                item['url'],
                 translations[item['lang']].absolute_url()
             )


