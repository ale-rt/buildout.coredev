Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-30T15:34:24+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/87ae4aa4f5f8ab76edf4e0eefea4ac87bf13ff6b

Fix migration if safe_html-Settings to not drop tags without a closing tag
Fixes https://github.com/plone/Products.CMFPlone/issues/2088

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f8d1055..75c14d5 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -19,6 +19,11 @@ New features:
 Bug fixes:
 
 - Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
+  Fixes https://github.com/plone/Products.CMFPlone/issues/2129
+  [pbauer]
+
+- Fix migration if safe_html-Settings to not drop tags without a closing tag.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/2088
   [pbauer]
 
 
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 59a516a..2065bee 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -185,16 +185,13 @@ def move_safe_html_settings_to_registry(context):
     """ Move safe_html settings from portal_transforms to Plone registry.
     """
     registry = getUtility(IRegistry)
-    settings = registry.forInterface(
-        IFilterSchema, prefix="plone")
+    settings = registry.forInterface(IFilterSchema, prefix='plone')
     pt = getToolByName(context, 'portal_transforms')
     disable_filtering = pt.safe_html._config.get('disable_transform')
     raw_valid_tags = pt.safe_html._config.get('valid_tags') or {}
     raw_nasty_tags = pt.safe_html._config.get('nasty_tags') or {}
-    valid_tags = [
-        tag.decode() for tag, enabled in raw_valid_tags.items() if enabled]
-    nasty_tags = [
-        tag.decode() for tag, enabled in raw_nasty_tags.items() if enabled]
+    valid_tags = [tag.decode() for tag in raw_valid_tags]
+    nasty_tags = [tag.decode() for tag in raw_nasty_tags]
     settings.disable_filtering = disable_filtering
     settings.valid_tags = sorted(valid_tags)
     settings.nasty_tags = sorted(nasty_tags)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-30T15:49:49+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/d7246d58de5f28384d4167ade0dfd2e5c30e2128

add a test

Files changed:
M plone/app/upgrade/v51/tests.py

diff --git a/plone/app/upgrade/v51/tests.py b/plone/app/upgrade/v51/tests.py
index 0fad483..4070682 100644
--- a/plone/app/upgrade/v51/tests.py
+++ b/plone/app/upgrade/v51/tests.py
@@ -59,8 +59,11 @@ def setUp(self):
     def test_migrate_safe_html_settings(self):
         from plone.app.upgrade.v51.betas import \
             move_safe_html_settings_to_registry
-
+        self.pt.safe_html._config['valid_tags'] = {'b': 1, 'img': 0}
         move_safe_html_settings_to_registry(self.portal)
+        # make sure the boolean setting (used to mark open tags like img)
+        # is ignored.
+        self.assertEqual(self.settings.valid_tags, ['b', 'img'])
 
 
 def test_suite():


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-08-30T16:54:44+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/e9efd9d3ea09543a8a1fa8b8630b53cb5a426e32

fix test

Files changed:
M plone/app/upgrade/v51/tests.py

diff --git a/plone/app/upgrade/v51/tests.py b/plone/app/upgrade/v51/tests.py
index 4070682..0007e63 100644
--- a/plone/app/upgrade/v51/tests.py
+++ b/plone/app/upgrade/v51/tests.py
@@ -62,8 +62,9 @@ def test_migrate_safe_html_settings(self):
         self.pt.safe_html._config['valid_tags'] = {'b': 1, 'img': 0}
         move_safe_html_settings_to_registry(self.portal)
         # make sure the boolean setting (used to mark open tags like img)
-        # is ignored.
-        self.assertEqual(self.settings.valid_tags, ['b', 'img'])
+        # is ignored. Only works in 5.1
+        if getattr(self.settings, 'valid_tags', None):
+            self.assertEqual(self.settings.valid_tags, ['b', 'img'])
 
 
 def test_suite():


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-09-07T08:40:24+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/359b6a4fd170c3e9434b008abc994cbedb9e38fa

Merge pull request #134 from plone/fix_safe_html_before_linkintegrity_migration

Keep tags without a closing tag when migrating safe_html-settings

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/tests.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3ea71a9..5ea51e9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -19,6 +19,11 @@ New features:
 Bug fixes:
 
 - Register settings for safe_html-Transform before linkintegrity-migration in 5.0rc1
+  Fixes https://github.com/plone/Products.CMFPlone/issues/2129
+  [pbauer]
+
+- Fix migration if safe_html-Settings to not drop tags without a closing tag.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/2088
   [pbauer]
 
 - Cleanup duplicate iterate settings. See also https://github.com/plone/plone.app.iterate/pull/47
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 46f959b..cc26234 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -185,16 +185,13 @@ def move_safe_html_settings_to_registry(context):
     """ Move safe_html settings from portal_transforms to Plone registry.
     """
     registry = getUtility(IRegistry)
-    settings = registry.forInterface(
-        IFilterSchema, prefix="plone")
+    settings = registry.forInterface(IFilterSchema, prefix='plone')
     pt = getToolByName(context, 'portal_transforms')
     disable_filtering = pt.safe_html._config.get('disable_transform')
     raw_valid_tags = pt.safe_html._config.get('valid_tags') or {}
     raw_nasty_tags = pt.safe_html._config.get('nasty_tags') or {}
-    valid_tags = [
-        tag.decode() for tag, enabled in raw_valid_tags.items() if enabled]
-    nasty_tags = [
-        tag.decode() for tag, enabled in raw_nasty_tags.items() if enabled]
+    valid_tags = [tag.decode() for tag in raw_valid_tags]
+    nasty_tags = [tag.decode() for tag in raw_nasty_tags]
     settings.disable_filtering = disable_filtering
     settings.valid_tags = sorted(valid_tags)
     settings.nasty_tags = sorted(nasty_tags)
diff --git a/plone/app/upgrade/v51/tests.py b/plone/app/upgrade/v51/tests.py
index 0fad483..0007e63 100644
--- a/plone/app/upgrade/v51/tests.py
+++ b/plone/app/upgrade/v51/tests.py
@@ -59,8 +59,12 @@ def setUp(self):
     def test_migrate_safe_html_settings(self):
         from plone.app.upgrade.v51.betas import \
             move_safe_html_settings_to_registry
-
+        self.pt.safe_html._config['valid_tags'] = {'b': 1, 'img': 0}
         move_safe_html_settings_to_registry(self.portal)
+        # make sure the boolean setting (used to mark open tags like img)
+        # is ignored. Only works in 5.1
+        if getattr(self.settings, 'valid_tags', None):
+            self.assertEqual(self.settings.valid_tags, ['b', 'img'])
 
 
 def test_suite():


