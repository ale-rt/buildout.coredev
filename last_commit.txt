Repository: Products.PlonePAS


Branch: refs/heads/master
Date: 2016-10-23T12:23:06-04:00
Author: Matthew Wilkes (MatthewWilkes) <git@matthewwilkes.name>
Commit: https://github.com/plone/Products.PlonePAS/commit/6b95b3c7a9e6cb95491e0736f913778ca1149ef2

Fix https://github.com/plone/Products.CMFPlone/issues/1725 - getMemberInfo no longer fails on sites that have the location memberdata property removed.

Files changed:
M CHANGES.rst
M src/Products/PlonePAS/tests/test_membershiptool.py
M src/Products/PlonePAS/tools/membership.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 4af9194..e9ebc05 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- In getMemberInfo, if a property is not present it now returns an
+  empty string, rather than raising an exception. This fixes login for
+  sites that have location removed.
+  [MatthewWilkes]
 
 
 5.0.12 (2016-09-09)
diff --git a/src/Products/PlonePAS/tests/test_membershiptool.py b/src/Products/PlonePAS/tests/test_membershiptool.py
index 69ff2a2..28431d8 100644
--- a/src/Products/PlonePAS/tests/test_membershiptool.py
+++ b/src/Products/PlonePAS/tests/test_membershiptool.py
@@ -557,6 +557,14 @@ def testGetMemberInfo(self):
         info = self.membership.getMemberInfo('user2')
         self.assertEqual(info['fullname'], 'Second user')
 
+    def testGetMemberInfoWithMissingProperties(self):
+        self.membership.addMember('user3', 'secret', ['Member'], [],
+                                  properties={'fullname': 'Second user'})
+        self.membership.portal_memberdata._delProperty('location')
+        self.membership.portal_memberdata._delProperty('home_page')
+        info = self.membership.getMemberInfo('user3')
+        self.assertEqual(info['fullname'], 'Second user')
+
     def testGetCandidateLocalRolesIncludesLocalRolesOnObjectForManager(self):
         self.folder._addRole('my_test_role')
         self.folder.manage_setLocalRoles(TEST_USER_ID,
@@ -944,7 +952,7 @@ def testGetMemberInfoViewForAnonymous(self):
         self.assertTrue(self.membership.isAnonymousUser())
         info = self.view.info()
         self.assertEqual(info['username'], 'Anonymous User')
-        self.assertEqual(info['fullname'], None)
+        self.assertEqual(info['fullname'], '')
         self.assertEqual(info['name_or_id'], 'Anonymous User')
 
     def testSetGroupsWithUserNameIdDifference(self):
diff --git a/src/Products/PlonePAS/tools/membership.py b/src/Products/PlonePAS/tools/membership.py
index 3771a75..a7c2237 100644
--- a/src/Products/PlonePAS/tools/membership.py
+++ b/src/Products/PlonePAS/tools/membership.py
@@ -387,11 +387,11 @@ def getMemberInfo(self, memberId=None):
             return None
 
         memberinfo = {
-            'fullname': member.getProperty('fullname'),
-            'description': member.getProperty('description'),
-            'location': member.getProperty('location'),
-            'language': member.getProperty('language'),
-            'home_page': member.getProperty('home_page'),
+            'fullname': member.getProperty('fullname', ''),
+            'description': member.getProperty('description', ''),
+            'location': member.getProperty('location', ''),
+            'language': member.getProperty('language', ''),
+            'home_page': member.getProperty('home_page', ''),
             'username': member.getUserName(),
             'has_email': bool(member.getProperty('email')),
         }


Repository: Products.PlonePAS


Branch: refs/heads/master
Date: 2016-10-23T23:21:24-04:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.PlonePAS/commit/b31fca6b4aa3ec8e0c9190d54fa80576fe4b981b

Merge pull request #20 from plone/missing_property_fix

Fix login on sites without a location property

Files changed:
M CHANGES.rst
M src/Products/PlonePAS/tests/test_membershiptool.py
M src/Products/PlonePAS/tools/membership.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 4af9194..e9ebc05 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,10 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- In getMemberInfo, if a property is not present it now returns an
+  empty string, rather than raising an exception. This fixes login for
+  sites that have location removed.
+  [MatthewWilkes]
 
 
 5.0.12 (2016-09-09)
diff --git a/src/Products/PlonePAS/tests/test_membershiptool.py b/src/Products/PlonePAS/tests/test_membershiptool.py
index 69ff2a2..28431d8 100644
--- a/src/Products/PlonePAS/tests/test_membershiptool.py
+++ b/src/Products/PlonePAS/tests/test_membershiptool.py
@@ -557,6 +557,14 @@ def testGetMemberInfo(self):
         info = self.membership.getMemberInfo('user2')
         self.assertEqual(info['fullname'], 'Second user')
 
+    def testGetMemberInfoWithMissingProperties(self):
+        self.membership.addMember('user3', 'secret', ['Member'], [],
+                                  properties={'fullname': 'Second user'})
+        self.membership.portal_memberdata._delProperty('location')
+        self.membership.portal_memberdata._delProperty('home_page')
+        info = self.membership.getMemberInfo('user3')
+        self.assertEqual(info['fullname'], 'Second user')
+
     def testGetCandidateLocalRolesIncludesLocalRolesOnObjectForManager(self):
         self.folder._addRole('my_test_role')
         self.folder.manage_setLocalRoles(TEST_USER_ID,
@@ -944,7 +952,7 @@ def testGetMemberInfoViewForAnonymous(self):
         self.assertTrue(self.membership.isAnonymousUser())
         info = self.view.info()
         self.assertEqual(info['username'], 'Anonymous User')
-        self.assertEqual(info['fullname'], None)
+        self.assertEqual(info['fullname'], '')
         self.assertEqual(info['name_or_id'], 'Anonymous User')
 
     def testSetGroupsWithUserNameIdDifference(self):
diff --git a/src/Products/PlonePAS/tools/membership.py b/src/Products/PlonePAS/tools/membership.py
index 3771a75..a7c2237 100644
--- a/src/Products/PlonePAS/tools/membership.py
+++ b/src/Products/PlonePAS/tools/membership.py
@@ -387,11 +387,11 @@ def getMemberInfo(self, memberId=None):
             return None
 
         memberinfo = {
-            'fullname': member.getProperty('fullname'),
-            'description': member.getProperty('description'),
-            'location': member.getProperty('location'),
-            'language': member.getProperty('language'),
-            'home_page': member.getProperty('home_page'),
+            'fullname': member.getProperty('fullname', ''),
+            'description': member.getProperty('description', ''),
+            'location': member.getProperty('location', ''),
+            'language': member.getProperty('language', ''),
+            'home_page': member.getProperty('home_page', ''),
             'username': member.getUserName(),
             'has_email': bool(member.getProperty('email')),
         }


