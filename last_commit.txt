Repository: plone.portlet.collection


Branch: refs/heads/2.1.x
Date: 2015-12-18T18:17:15-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.portlet.collection/commit/2ce78298c96ac0e93cdfbd88508b93763648e57b

fix 'Select random items' option

Files changed:
M CHANGES.txt
M plone/portlet/collection/collection.py

diff --git a/CHANGES.txt b/CHANGES.txt
index 35617f5..1bce86f 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -10,6 +10,10 @@ New:
 
 Fixes:
 
+- Fix 'Select random items' when used with new-style collections
+  with more results than the batch size.
+  [davisagli]
+
 - Fixed sometimes failing test due to sorting.
   [maurits]
 
diff --git a/plone/portlet/collection/collection.py b/plone/portlet/collection/collection.py
index bdc75ed..b4655ee 100644
--- a/plone/portlet/collection/collection.py
+++ b/plone/portlet/collection/collection.py
@@ -172,7 +172,7 @@ def _random_results(self):
         if collection is not None:
             context_path = '/'.join(self.context.getPhysicalPath())
             exclude_context = getattr(self.data, 'exclude_context', False)
-            results = collection.queryCatalog(sort_on=None)
+            results = collection.queryCatalog(sort_on=None, batch=False)
             if results is None:
                 return []
             limit = self.data.limit and min(len(results), self.data.limit) or 1


Repository: plone.portlet.collection


Branch: refs/heads/2.1.x
Date: 2015-12-29T13:44:27+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.portlet.collection/commit/94957c6d50d1329116bbe57c3c21a2553e399c93

Merge pull request #12 from plone/davisagli-fix-random-items

Fix "select random items" for new-style collections

Files changed:
M CHANGES.txt
M plone/portlet/collection/collection.py

diff --git a/CHANGES.txt b/CHANGES.txt
index 35617f5..1bce86f 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -10,6 +10,10 @@ New:
 
 Fixes:
 
+- Fix 'Select random items' when used with new-style collections
+  with more results than the batch size.
+  [davisagli]
+
 - Fixed sometimes failing test due to sorting.
   [maurits]
 
diff --git a/plone/portlet/collection/collection.py b/plone/portlet/collection/collection.py
index bdc75ed..b4655ee 100644
--- a/plone/portlet/collection/collection.py
+++ b/plone/portlet/collection/collection.py
@@ -172,7 +172,7 @@ def _random_results(self):
         if collection is not None:
             context_path = '/'.join(self.context.getPhysicalPath())
             exclude_context = getattr(self.data, 'exclude_context', False)
-            results = collection.queryCatalog(sort_on=None)
+            results = collection.queryCatalog(sort_on=None, batch=False)
             if results is None:
                 return []
             limit = self.data.limit and min(len(results), self.data.limit) or 1


