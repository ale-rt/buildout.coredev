Repository: plone.protect


Branch: refs/heads/master
Date: 2016-09-07T17:06:17+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.protect/commit/062e1d17adbbc1dd31152db0a75cf07e21cc33c1

Only try the confirm view for urls that are in the portal.

This applies PloneHotfix20160830.

Files changed:
A plone/protect/tests/test_confirm_view.py
M CHANGES.rst
M plone/protect/views.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bd6d9ba..2a37b39 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,9 @@ New features:
 
 Bug fixes:
 
+- Only try the confirm view for urls that are in the portal.
+  This applies PloneHotfix20160830.  [maurits]
+
 - Removed ``RedirectTo`` patch.  The patch has been merged to
   ``Products.CMFFormController`` 3.0.7 (Plone 4.3 and 5.0) and 3.1.2
   (Plone 5.1).  Note that we are not requiring those versions in our
diff --git a/plone/protect/tests/test_confirm_view.py b/plone/protect/tests/test_confirm_view.py
new file mode 100644
index 0000000..73f43fe
--- /dev/null
+++ b/plone/protect/tests/test_confirm_view.py
@@ -0,0 +1,29 @@
+from plone.protect.testing import PROTECT_FUNCTIONAL_TESTING
+from zExceptions import Forbidden
+from zope.component import getMultiAdapter
+
+import unittest
+
+
+class TestAttackVector(unittest.TestCase):
+    layer = PROTECT_FUNCTIONAL_TESTING
+
+    def test_regression(self):
+        portal = self.layer['portal']
+        request = self.layer['request']
+        view = getMultiAdapter(
+            (portal, request), name=u'confirm-action')
+        request.form.update({
+            'original_url': 'foobar'
+        })
+        self.assertTrue('value="foobar"' in view())
+
+    def test_valid_url(self):
+        portal = self.layer['portal']
+        request = self.layer['request']
+        view = getMultiAdapter(
+            (portal, request), name=u'confirm-action')
+        request.form.update({
+            'original_url': 'javascript:alert(1)'
+        })
+        self.assertRaises(Forbidden, view)
diff --git a/plone/protect/views.py b/plone/protect/views.py
index 253cc83..933caa0 100644
--- a/plone/protect/views.py
+++ b/plone/protect/views.py
@@ -1,8 +1,16 @@
 from plone.protect.interfaces import IConfirmView
+from Products.CMFCore.utils import getToolByName
 from Products.Five import BrowserView
+from zExceptions import Forbidden
 from zope.interface import implementer
 
 
 @implementer(IConfirmView)
 class ConfirmView(BrowserView):
-    pass
+
+    def __call__(self):
+        urltool = getToolByName(self.context, 'portal_url')
+        original_url = getattr(self.request, 'original_url', '')
+        if not original_url or not urltool.isURLInPortal(original_url):
+            raise Forbidden('url not in portal')
+        return self.index()


Repository: plone.protect


Branch: refs/heads/master
Date: 2016-09-07T18:53:51+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.protect/commit/ec87ec3314eb0a94be1f75b8c357513bb7bef83e

Merge pull request #54 from plone/apply-hotfix-20160830

Only try the confirm view for urls that are in the portal.

Files changed:
A plone/protect/tests/test_confirm_view.py
M CHANGES.rst
M plone/protect/views.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bd6d9ba..2a37b39 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,6 +14,9 @@ New features:
 
 Bug fixes:
 
+- Only try the confirm view for urls that are in the portal.
+  This applies PloneHotfix20160830.  [maurits]
+
 - Removed ``RedirectTo`` patch.  The patch has been merged to
   ``Products.CMFFormController`` 3.0.7 (Plone 4.3 and 5.0) and 3.1.2
   (Plone 5.1).  Note that we are not requiring those versions in our
diff --git a/plone/protect/tests/test_confirm_view.py b/plone/protect/tests/test_confirm_view.py
new file mode 100644
index 0000000..73f43fe
--- /dev/null
+++ b/plone/protect/tests/test_confirm_view.py
@@ -0,0 +1,29 @@
+from plone.protect.testing import PROTECT_FUNCTIONAL_TESTING
+from zExceptions import Forbidden
+from zope.component import getMultiAdapter
+
+import unittest
+
+
+class TestAttackVector(unittest.TestCase):
+    layer = PROTECT_FUNCTIONAL_TESTING
+
+    def test_regression(self):
+        portal = self.layer['portal']
+        request = self.layer['request']
+        view = getMultiAdapter(
+            (portal, request), name=u'confirm-action')
+        request.form.update({
+            'original_url': 'foobar'
+        })
+        self.assertTrue('value="foobar"' in view())
+
+    def test_valid_url(self):
+        portal = self.layer['portal']
+        request = self.layer['request']
+        view = getMultiAdapter(
+            (portal, request), name=u'confirm-action')
+        request.form.update({
+            'original_url': 'javascript:alert(1)'
+        })
+        self.assertRaises(Forbidden, view)
diff --git a/plone/protect/views.py b/plone/protect/views.py
index 253cc83..933caa0 100644
--- a/plone/protect/views.py
+++ b/plone/protect/views.py
@@ -1,8 +1,16 @@
 from plone.protect.interfaces import IConfirmView
+from Products.CMFCore.utils import getToolByName
 from Products.Five import BrowserView
+from zExceptions import Forbidden
 from zope.interface import implementer
 
 
 @implementer(IConfirmView)
 class ConfirmView(BrowserView):
-    pass
+
+    def __call__(self):
+        urltool = getToolByName(self.context, 'portal_url')
+        original_url = getattr(self.request, 'original_url', '')
+        if not original_url or not urltool.isURLInPortal(original_url):
+            raise Forbidden('url not in portal')
+        return self.index()


