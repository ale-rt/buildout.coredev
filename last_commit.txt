Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-02-04T17:50:37+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/b2618eec0af3b32133d216397c86e9cd2fccbfc0

Remove displayContentsTab from action expressions in 5.1.

Fixes https://github.com/plone/Products.CMFPlone/issues/1935.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index b8d9491..748090a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -47,6 +47,10 @@ New features:
 
 Bug fixes:
 
+- Remove displayContentsTab from action expressions in 5.1.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/1935.
+  [maurits]
+
 - Fix move_pw_reset_tool upgrade step
   [agitator]
 
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 6a7b339..a81f078 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -89,3 +89,31 @@ def move_pw_reset_tool(context):
         pw_reset_tool._timedelta = int(old_days_timeout)
     if old_user_check is not _marker:
         pw_reset_tool._user_check = bool(old_user_check)
+
+
+def remove_displayContentsTab_from_action_expressions(context):
+    """Remove the displayContentsTab script from action expressions.
+
+    This script was removed, but it can still be in actions,
+    at least in portal_actions/object/folderContents,
+    where it makes the homepage fail to load.
+    """
+    atool = getToolByName(context, 'portal_actions')
+    actions = atool.listActions()
+    if not actions:
+        return []
+    script_name = 'displayContentsTab'
+    text = 'object/{}'.format(script_name)
+    for ac in actions:
+        if script_name not in ac.available_expr:
+            continue
+        path = '/'.join(ac.getPhysicalPath())
+        if ac.available_expr.strip() == text:
+            ac._setPropValue('available_expr', '')
+            logger.info('Removed %s from action at %s', text, path)
+            continue
+        # The script is in the expression, but it is different than what
+        # we expect.  We can only warn the user.
+        logger.warn('Action at %s references removed script %s in available. '
+                    'expression %r. Please change it',
+                    path, text, ac.available_expr)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index d05981f..9e6227f 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -87,6 +87,11 @@ was moved from the plone bundle to plone-logged-in in CMPlone 5.1a2.
            handler=".betas.move_pw_reset_tool"
            />
 
+      <gs:upgradeStep
+           title="Remove displayContentsTab from action expressions"
+           handler=".betas.remove_displayContentsTab_from_action_expressions"
+           />
+
     </gs:upgradeSteps>
 
 </configure>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2017-02-05T18:48:26+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/0ca6736d44bc13a25972499986a2cf0bb439a0ca

Merge pull request #102 from plone/remove-displayContentsTab

Remove displayContentsTab from action expressions in 5.1.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v51/betas.py
M plone/app/upgrade/v51/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index b8d9491..748090a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -47,6 +47,10 @@ New features:
 
 Bug fixes:
 
+- Remove displayContentsTab from action expressions in 5.1.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/1935.
+  [maurits]
+
 - Fix move_pw_reset_tool upgrade step
   [agitator]
 
diff --git a/plone/app/upgrade/v51/betas.py b/plone/app/upgrade/v51/betas.py
index 6a7b339..a81f078 100644
--- a/plone/app/upgrade/v51/betas.py
+++ b/plone/app/upgrade/v51/betas.py
@@ -89,3 +89,31 @@ def move_pw_reset_tool(context):
         pw_reset_tool._timedelta = int(old_days_timeout)
     if old_user_check is not _marker:
         pw_reset_tool._user_check = bool(old_user_check)
+
+
+def remove_displayContentsTab_from_action_expressions(context):
+    """Remove the displayContentsTab script from action expressions.
+
+    This script was removed, but it can still be in actions,
+    at least in portal_actions/object/folderContents,
+    where it makes the homepage fail to load.
+    """
+    atool = getToolByName(context, 'portal_actions')
+    actions = atool.listActions()
+    if not actions:
+        return []
+    script_name = 'displayContentsTab'
+    text = 'object/{}'.format(script_name)
+    for ac in actions:
+        if script_name not in ac.available_expr:
+            continue
+        path = '/'.join(ac.getPhysicalPath())
+        if ac.available_expr.strip() == text:
+            ac._setPropValue('available_expr', '')
+            logger.info('Removed %s from action at %s', text, path)
+            continue
+        # The script is in the expression, but it is different than what
+        # we expect.  We can only warn the user.
+        logger.warn('Action at %s references removed script %s in available. '
+                    'expression %r. Please change it',
+                    path, text, ac.available_expr)
diff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml
index d05981f..9e6227f 100644
--- a/plone/app/upgrade/v51/configure.zcml
+++ b/plone/app/upgrade/v51/configure.zcml
@@ -87,6 +87,11 @@ was moved from the plone bundle to plone-logged-in in CMPlone 5.1a2.
            handler=".betas.move_pw_reset_tool"
            />
 
+      <gs:upgradeStep
+           title="Remove displayContentsTab from action expressions"
+           handler=".betas.remove_displayContentsTab_from_action_expressions"
+           />
+
     </gs:upgradeSteps>
 
 </configure>


