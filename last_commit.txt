Repository: Products.TinyMCE


Branch: refs/heads/1.3.x
Date: 2017-03-02T21:04:15+01:00
Author: Harald Friessnegger (frisi) <harald@webmeisterei.com>
Commit: https://github.com/plone/Products.TinyMCE/commit/cc960d29a0f86c7e84c996f9ffaf3b3a586e451c

omit plonesite's path in the path info

Files changed:
M Products/TinyMCE/adapters/JSONFolderListing.py
M Products/TinyMCE/adapters/JSONSearch.py

diff --git a/Products/TinyMCE/adapters/JSONFolderListing.py b/Products/TinyMCE/adapters/JSONFolderListing.py
index 22967e5..2ccafec 100644
--- a/Products/TinyMCE/adapters/JSONFolderListing.py
+++ b/Products/TinyMCE/adapters/JSONFolderListing.py
@@ -120,7 +120,7 @@ def getListing(self, filter_portal_types, rooted, document_base_url, upload_type
         query.update({'portal_type': filter_portal_types,
                       'sort_on': 'getObjPositionInParent',
                       'path': {'query': path, 'depth': 1}})
-
+        portal_path = getToolByName(self.context, 'portal_url').getPortalPath()
         for brain in portal_catalog(**query):
 
             description = ''
@@ -142,7 +142,7 @@ def getListing(self, filter_portal_types, rooted, document_base_url, upload_type
                 'icon': getIcon(brain),
                 'description': description,
                 'is_folderish': brain.is_folderish,
-                'path': brain.getPath(),
+                'path': brain.getPath().replace(portal_path, ''),
                 })
 
         # add catalog_ressults
diff --git a/Products/TinyMCE/adapters/JSONSearch.py b/Products/TinyMCE/adapters/JSONSearch.py
index 0c8b299..64334ef 100644
--- a/Products/TinyMCE/adapters/JSONSearch.py
+++ b/Products/TinyMCE/adapters/JSONSearch.py
@@ -1,3 +1,5 @@
+from Products.CMFPlone.utils import getToolByName
+from Products.TinyMCE.adapters.interfaces.JSONSearch import IJSONSearch
 from zope.interface import implements
 try:
     import simplejson as json
@@ -5,8 +7,6 @@
 except ImportError:
     import json
 
-from Products.TinyMCE.adapters.interfaces.JSONSearch import IJSONSearch
-
 
 class JSONSearch(object):
     """Returns a list of search results in JSON"""
@@ -35,10 +35,12 @@ def getSearchResults(self, filter_portal_types, searchtext):
             'path': '/'.join(self.context.getPhysicalPath()),
             'Title': searchtext,
         })
+
         if searchtext:
             plone_layout = self.context.restrictedTraverse('@@plone_layout',
                                                            None)
-
+            portal_path = getToolByName(
+                self.context, 'portal_url').getPortalPath()
             getIcon = lambda brain: plone_layout.getIcon(brain)()
             brains = self.context.portal_catalog.searchResults(**query)
 
@@ -51,7 +53,7 @@ def getSearchResults(self, filter_portal_types, searchtext):
                     'icon': getIcon(brain),
                     'description': brain.Description,
                     'is_folderish': brain.is_folderish,
-                    'path': brain.getPath(),
+                    'path': brain.getPath().replace(portal_path, ''),
                     } for brain in brains if brain]
 
         # add catalog_results


